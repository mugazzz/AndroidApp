"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.exec = exec;
exports.default = void 0;

var _child_process = require("child_process");

var _shellQuote = require("shell-quote");

var _bluebird = _interopRequireDefault(require("bluebird"));

function exec(cmd, args = [], opts = {}) {
  const rep = (0, _shellQuote.quote)([cmd, ...args]);
  opts = Object.assign({
    timeout: null,
    encoding: 'utf8',
    killSignal: 'SIGTERM',
    cwd: undefined,
    env: process.env,
    ignoreOutput: false,
    stdio: "inherit",
    isBuffer: false,
    shell: undefined
  }, opts);
  return new _bluebird.default((resolve, reject) => {
    let proc = (0, _child_process.spawn)(cmd, args, {
      cwd: opts.cwd,
      env: opts.env,
      shell: opts.shell
    });
    let stdoutArr = [],
        stderrArr = [],
        timer = null;
    proc.on('error', err => {
      let msg = `Command '${rep}' errored out: ${err.stack}`;

      if (err.errno === 'ENOENT') {
        msg = `Command '${cmd}' not found. Is it installed?`;
      }

      reject(new Error(msg));
    });

    if (proc.stdin) {
      proc.stdin.on('error', err => {
        reject(new Error(`Standard input '${err.syscall}' error: ${err.stack}`));
      });
    }

    if (proc.stdout) {
      proc.stdout.on('error', err => {
        reject(new Error(`Standard output '${err.syscall}' error: ${err.stack}`));
      });
    }

    if (proc.stderr) {
      proc.stderr.on('error', err => {
        reject(new Error(`Standard error '${err.syscall}' error: ${err.stack}`));
      });
    }

    if (!opts.ignoreOutput) {
      if (proc.stdout) {
        proc.stdout.on('data', data => {
          stdoutArr.push(data);
        });
      }

      if (proc.stderr) {
        proc.stderr.on('data', data => {
          stderrArr.push(data);
        });
      }
    }

    function getStdio(isBuffer) {
      let stdout, stderr;

      if (isBuffer) {
        stdout = Buffer.concat(stdoutArr);
        stderr = Buffer.concat(stderrArr);
      } else {
        stdout = Buffer.concat(stdoutArr).toString(opts.encoding);
        stderr = Buffer.concat(stderrArr).toString(opts.encoding);
      }

      return {
        stdout,
        stderr
      };
    }

    proc.on('close', code => {
      if (timer) {
        clearTimeout(timer);
      }

      let _getStdio = getStdio(opts.isBuffer),
          stdout = _getStdio.stdout,
          stderr = _getStdio.stderr;

      if (code === 0) {
        resolve({
          stdout,
          stderr,
          code
        });
      } else {
        let err = new Error(`Command '${rep}' exited with code ${code}`);
        err = Object.assign(err, {
          stdout,
          stderr,
          code
        });
        reject(err);
      }
    });

    if (opts.timeout) {
      timer = setTimeout(() => {
        let _getStdio2 = getStdio(opts.isBuffer),
            stdout = _getStdio2.stdout,
            stderr = _getStdio2.stderr;

        let err = new Error(`Command '${rep}' timed out after ${opts.timeout}ms`);
        err = Object.assign(err, {
          stdout,
          stderr,
          code: null
        });
        reject(err);
        proc.kill(opts.killSignal);
      }, opts.timeout);
    }
  });
}

var _default = exec;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9leGVjLmpzIl0sIm5hbWVzIjpbImV4ZWMiLCJjbWQiLCJhcmdzIiwib3B0cyIsInJlcCIsIk9iamVjdCIsImFzc2lnbiIsInRpbWVvdXQiLCJlbmNvZGluZyIsImtpbGxTaWduYWwiLCJjd2QiLCJ1bmRlZmluZWQiLCJlbnYiLCJwcm9jZXNzIiwiaWdub3JlT3V0cHV0Iiwic3RkaW8iLCJpc0J1ZmZlciIsInNoZWxsIiwiQiIsInJlc29sdmUiLCJyZWplY3QiLCJwcm9jIiwic3Rkb3V0QXJyIiwic3RkZXJyQXJyIiwidGltZXIiLCJvbiIsImVyciIsIm1zZyIsInN0YWNrIiwiZXJybm8iLCJFcnJvciIsInN0ZGluIiwic3lzY2FsbCIsInN0ZG91dCIsInN0ZGVyciIsImRhdGEiLCJwdXNoIiwiZ2V0U3RkaW8iLCJCdWZmZXIiLCJjb25jYXQiLCJ0b1N0cmluZyIsImNvZGUiLCJjbGVhclRpbWVvdXQiLCJzZXRUaW1lb3V0Iiwia2lsbCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUVBOztBQUNBOztBQUNBOztBQUdBLFNBQVNBLElBQVQsQ0FBZUMsR0FBZixFQUFvQkMsSUFBSSxHQUFHLEVBQTNCLEVBQStCQyxJQUFJLEdBQUcsRUFBdEMsRUFBMEM7QUFFeEMsUUFBTUMsR0FBRyxHQUFHLHVCQUFNLENBQUNILEdBQUQsRUFBTSxHQUFHQyxJQUFULENBQU4sQ0FBWjtBQUlBQyxFQUFBQSxJQUFJLEdBQUdFLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjO0FBQ25CQyxJQUFBQSxPQUFPLEVBQUUsSUFEVTtBQUVuQkMsSUFBQUEsUUFBUSxFQUFFLE1BRlM7QUFHbkJDLElBQUFBLFVBQVUsRUFBRSxTQUhPO0FBSW5CQyxJQUFBQSxHQUFHLEVBQUVDLFNBSmM7QUFLbkJDLElBQUFBLEdBQUcsRUFBRUMsT0FBTyxDQUFDRCxHQUxNO0FBTW5CRSxJQUFBQSxZQUFZLEVBQUUsS0FOSztBQU9uQkMsSUFBQUEsS0FBSyxFQUFFLFNBUFk7QUFRbkJDLElBQUFBLFFBQVEsRUFBRSxLQVJTO0FBU25CQyxJQUFBQSxLQUFLLEVBQUVOO0FBVFksR0FBZCxFQVVKUixJQVZJLENBQVA7QUFhQSxTQUFPLElBQUllLGlCQUFKLENBQU0sQ0FBQ0MsT0FBRCxFQUFVQyxNQUFWLEtBQXFCO0FBR2hDLFFBQUlDLElBQUksR0FBRywwQkFBTXBCLEdBQU4sRUFBV0MsSUFBWCxFQUFpQjtBQUFDUSxNQUFBQSxHQUFHLEVBQUVQLElBQUksQ0FBQ08sR0FBWDtBQUFnQkUsTUFBQUEsR0FBRyxFQUFFVCxJQUFJLENBQUNTLEdBQTFCO0FBQStCSyxNQUFBQSxLQUFLLEVBQUVkLElBQUksQ0FBQ2M7QUFBM0MsS0FBakIsQ0FBWDtBQUNBLFFBQUlLLFNBQVMsR0FBRyxFQUFoQjtBQUFBLFFBQW9CQyxTQUFTLEdBQUcsRUFBaEM7QUFBQSxRQUFvQ0MsS0FBSyxHQUFHLElBQTVDO0FBR0FILElBQUFBLElBQUksQ0FBQ0ksRUFBTCxDQUFRLE9BQVIsRUFBa0JDLEdBQUQsSUFBUztBQUN4QixVQUFJQyxHQUFHLEdBQUksWUFBV3ZCLEdBQUksa0JBQWlCc0IsR0FBRyxDQUFDRSxLQUFNLEVBQXJEOztBQUNBLFVBQUlGLEdBQUcsQ0FBQ0csS0FBSixLQUFjLFFBQWxCLEVBQTRCO0FBQzFCRixRQUFBQSxHQUFHLEdBQUksWUFBVzFCLEdBQUksK0JBQXRCO0FBQ0Q7O0FBQ0RtQixNQUFBQSxNQUFNLENBQUMsSUFBSVUsS0FBSixDQUFVSCxHQUFWLENBQUQsQ0FBTjtBQUNELEtBTkQ7O0FBT0EsUUFBSU4sSUFBSSxDQUFDVSxLQUFULEVBQWdCO0FBQ2RWLE1BQUFBLElBQUksQ0FBQ1UsS0FBTCxDQUFXTixFQUFYLENBQWMsT0FBZCxFQUF3QkMsR0FBRCxJQUFTO0FBQzlCTixRQUFBQSxNQUFNLENBQUMsSUFBSVUsS0FBSixDQUFXLG1CQUFrQkosR0FBRyxDQUFDTSxPQUFRLFlBQVdOLEdBQUcsQ0FBQ0UsS0FBTSxFQUE5RCxDQUFELENBQU47QUFDRCxPQUZEO0FBR0Q7O0FBQ0QsUUFBSVAsSUFBSSxDQUFDWSxNQUFULEVBQWlCO0FBQ2ZaLE1BQUFBLElBQUksQ0FBQ1ksTUFBTCxDQUFZUixFQUFaLENBQWUsT0FBZixFQUF5QkMsR0FBRCxJQUFTO0FBQy9CTixRQUFBQSxNQUFNLENBQUMsSUFBSVUsS0FBSixDQUFXLG9CQUFtQkosR0FBRyxDQUFDTSxPQUFRLFlBQVdOLEdBQUcsQ0FBQ0UsS0FBTSxFQUEvRCxDQUFELENBQU47QUFDRCxPQUZEO0FBR0Q7O0FBQ0QsUUFBSVAsSUFBSSxDQUFDYSxNQUFULEVBQWlCO0FBQ2ZiLE1BQUFBLElBQUksQ0FBQ2EsTUFBTCxDQUFZVCxFQUFaLENBQWUsT0FBZixFQUF5QkMsR0FBRCxJQUFTO0FBQy9CTixRQUFBQSxNQUFNLENBQUMsSUFBSVUsS0FBSixDQUFXLG1CQUFrQkosR0FBRyxDQUFDTSxPQUFRLFlBQVdOLEdBQUcsQ0FBQ0UsS0FBTSxFQUE5RCxDQUFELENBQU47QUFDRCxPQUZEO0FBR0Q7O0FBR0QsUUFBSSxDQUFDekIsSUFBSSxDQUFDVyxZQUFWLEVBQXdCO0FBQ3RCLFVBQUlPLElBQUksQ0FBQ1ksTUFBVCxFQUFpQjtBQUNmWixRQUFBQSxJQUFJLENBQUNZLE1BQUwsQ0FBWVIsRUFBWixDQUFlLE1BQWYsRUFBd0JVLElBQUQsSUFBVTtBQUMvQmIsVUFBQUEsU0FBUyxDQUFDYyxJQUFWLENBQWVELElBQWY7QUFDRCxTQUZEO0FBR0Q7O0FBQ0QsVUFBSWQsSUFBSSxDQUFDYSxNQUFULEVBQWlCO0FBQ2ZiLFFBQUFBLElBQUksQ0FBQ2EsTUFBTCxDQUFZVCxFQUFaLENBQWUsTUFBZixFQUF3QlUsSUFBRCxJQUFVO0FBQy9CWixVQUFBQSxTQUFTLENBQUNhLElBQVYsQ0FBZUQsSUFBZjtBQUNELFNBRkQ7QUFHRDtBQUNGOztBQUVELGFBQVNFLFFBQVQsQ0FBbUJyQixRQUFuQixFQUE2QjtBQUMzQixVQUFJaUIsTUFBSixFQUFZQyxNQUFaOztBQUNBLFVBQUlsQixRQUFKLEVBQWM7QUFDWmlCLFFBQUFBLE1BQU0sR0FBR0ssTUFBTSxDQUFDQyxNQUFQLENBQWNqQixTQUFkLENBQVQ7QUFDQVksUUFBQUEsTUFBTSxHQUFHSSxNQUFNLENBQUNDLE1BQVAsQ0FBY2hCLFNBQWQsQ0FBVDtBQUNELE9BSEQsTUFHTztBQUNMVSxRQUFBQSxNQUFNLEdBQUdLLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjakIsU0FBZCxFQUF5QmtCLFFBQXpCLENBQWtDckMsSUFBSSxDQUFDSyxRQUF2QyxDQUFUO0FBQ0EwQixRQUFBQSxNQUFNLEdBQUdJLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjaEIsU0FBZCxFQUF5QmlCLFFBQXpCLENBQWtDckMsSUFBSSxDQUFDSyxRQUF2QyxDQUFUO0FBQ0Q7O0FBQ0QsYUFBTztBQUFDeUIsUUFBQUEsTUFBRDtBQUFTQyxRQUFBQTtBQUFULE9BQVA7QUFDRDs7QUFLRGIsSUFBQUEsSUFBSSxDQUFDSSxFQUFMLENBQVEsT0FBUixFQUFrQmdCLElBQUQsSUFBVTtBQUN6QixVQUFJakIsS0FBSixFQUFXO0FBQ1RrQixRQUFBQSxZQUFZLENBQUNsQixLQUFELENBQVo7QUFDRDs7QUFId0Isc0JBSUZhLFFBQVEsQ0FBQ2xDLElBQUksQ0FBQ2EsUUFBTixDQUpOO0FBQUEsVUFJcEJpQixNQUpvQixhQUlwQkEsTUFKb0I7QUFBQSxVQUlaQyxNQUpZLGFBSVpBLE1BSlk7O0FBS3pCLFVBQUlPLElBQUksS0FBSyxDQUFiLEVBQWdCO0FBQ2R0QixRQUFBQSxPQUFPLENBQUM7QUFBQ2MsVUFBQUEsTUFBRDtBQUFTQyxVQUFBQSxNQUFUO0FBQWlCTyxVQUFBQTtBQUFqQixTQUFELENBQVA7QUFDRCxPQUZELE1BRU87QUFDTCxZQUFJZixHQUFHLEdBQUcsSUFBSUksS0FBSixDQUFXLFlBQVcxQixHQUFJLHNCQUFxQnFDLElBQUssRUFBcEQsQ0FBVjtBQUNBZixRQUFBQSxHQUFHLEdBQUdyQixNQUFNLENBQUNDLE1BQVAsQ0FBY29CLEdBQWQsRUFBbUI7QUFBQ08sVUFBQUEsTUFBRDtBQUFTQyxVQUFBQSxNQUFUO0FBQWlCTyxVQUFBQTtBQUFqQixTQUFuQixDQUFOO0FBQ0FyQixRQUFBQSxNQUFNLENBQUNNLEdBQUQsQ0FBTjtBQUNEO0FBQ0YsS0FaRDs7QUFpQkEsUUFBSXZCLElBQUksQ0FBQ0ksT0FBVCxFQUFrQjtBQUNoQmlCLE1BQUFBLEtBQUssR0FBR21CLFVBQVUsQ0FBQyxNQUFNO0FBQUEseUJBQ0FOLFFBQVEsQ0FBQ2xDLElBQUksQ0FBQ2EsUUFBTixDQURSO0FBQUEsWUFDbEJpQixNQURrQixjQUNsQkEsTUFEa0I7QUFBQSxZQUNWQyxNQURVLGNBQ1ZBLE1BRFU7O0FBRXZCLFlBQUlSLEdBQUcsR0FBRyxJQUFJSSxLQUFKLENBQVcsWUFBVzFCLEdBQUkscUJBQW9CRCxJQUFJLENBQUNJLE9BQVEsSUFBM0QsQ0FBVjtBQUNBbUIsUUFBQUEsR0FBRyxHQUFHckIsTUFBTSxDQUFDQyxNQUFQLENBQWNvQixHQUFkLEVBQW1CO0FBQUNPLFVBQUFBLE1BQUQ7QUFBU0MsVUFBQUEsTUFBVDtBQUFpQk8sVUFBQUEsSUFBSSxFQUFFO0FBQXZCLFNBQW5CLENBQU47QUFDQXJCLFFBQUFBLE1BQU0sQ0FBQ00sR0FBRCxDQUFOO0FBR0FMLFFBQUFBLElBQUksQ0FBQ3VCLElBQUwsQ0FBVXpDLElBQUksQ0FBQ00sVUFBZjtBQUNELE9BUmlCLEVBUWZOLElBQUksQ0FBQ0ksT0FSVSxDQUFsQjtBQVNEO0FBQ0YsR0F2Rk0sQ0FBUDtBQXdGRDs7ZUFHY1AsSSIsInNvdXJjZXNDb250ZW50IjpbIi8qIGVzbGludC1kaXNhYmxlIHByb21pc2UvcHJlZmVyLWF3YWl0LXRvLWNhbGxiYWNrcyAqL1xuXG5pbXBvcnQgeyBzcGF3biB9IGZyb20gJ2NoaWxkX3Byb2Nlc3MnO1xuaW1wb3J0IHsgcXVvdGUgfSBmcm9tICdzaGVsbC1xdW90ZSc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5cblxuZnVuY3Rpb24gZXhlYyAoY21kLCBhcmdzID0gW10sIG9wdHMgPSB7fSkge1xuICAvLyBnZXQgYSBxdW90ZWQgcmVwcmVzZW50YXRpb24gb2YgdGhlIGNvbW1hbmQgZm9yIGVycm9yIHN0cmluZ3NcbiAgY29uc3QgcmVwID0gcXVvdGUoW2NtZCwgLi4uYXJnc10pO1xuXG4gIC8vIGV4dGVuZCBkZWZhdWx0IG9wdGlvbnM7IHdlJ3JlIGJhc2ljYWxseSByZS1pbXBsZW1lbnRpbmcgZXhlYydzIG9wdGlvbnNcbiAgLy8gZm9yIHVzZSBoZXJlIHdpdGggc3Bhd24gdW5kZXIgdGhlIGhvb2RcbiAgb3B0cyA9IE9iamVjdC5hc3NpZ24oe1xuICAgIHRpbWVvdXQ6IG51bGwsXG4gICAgZW5jb2Rpbmc6ICd1dGY4JyxcbiAgICBraWxsU2lnbmFsOiAnU0lHVEVSTScsXG4gICAgY3dkOiB1bmRlZmluZWQsXG4gICAgZW52OiBwcm9jZXNzLmVudixcbiAgICBpZ25vcmVPdXRwdXQ6IGZhbHNlLFxuICAgIHN0ZGlvOiBcImluaGVyaXRcIixcbiAgICBpc0J1ZmZlcjogZmFsc2UsXG4gICAgc2hlbGw6IHVuZGVmaW5lZCxcbiAgfSwgb3B0cyk7XG5cbiAgLy8gdGhpcyBpcyBhbiBhc3luYyBmdW5jdGlvbiwgc28gcmV0dXJuIGEgcHJvbWlzZVxuICByZXR1cm4gbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIC8vIHNwYXduIHRoZSBjaGlsZCBwcm9jZXNzIHdpdGggb3B0aW9uczsgd2UgZG9uJ3QgY3VycmVudGx5IGV4cG9zZSBhbnkgb2ZcbiAgICAvLyB0aGUgb3RoZXIgJ3NwYXduJyBvcHRpb25zIHRocm91Z2ggdGhlIEFQSVxuICAgIGxldCBwcm9jID0gc3Bhd24oY21kLCBhcmdzLCB7Y3dkOiBvcHRzLmN3ZCwgZW52OiBvcHRzLmVudiwgc2hlbGw6IG9wdHMuc2hlbGx9KTtcbiAgICBsZXQgc3Rkb3V0QXJyID0gW10sIHN0ZGVyckFyciA9IFtdLCB0aW1lciA9IG51bGw7XG5cbiAgICAvLyBpZiB0aGUgcHJvY2VzcyBlcnJvcnMgb3V0LCByZWplY3QgdGhlIHByb21pc2VcbiAgICBwcm9jLm9uKCdlcnJvcicsIChlcnIpID0+IHtcbiAgICAgIGxldCBtc2cgPSBgQ29tbWFuZCAnJHtyZXB9JyBlcnJvcmVkIG91dDogJHtlcnIuc3RhY2t9YDtcbiAgICAgIGlmIChlcnIuZXJybm8gPT09ICdFTk9FTlQnKSB7XG4gICAgICAgIG1zZyA9IGBDb21tYW5kICcke2NtZH0nIG5vdCBmb3VuZC4gSXMgaXQgaW5zdGFsbGVkP2A7XG4gICAgICB9XG4gICAgICByZWplY3QobmV3IEVycm9yKG1zZykpO1xuICAgIH0pO1xuICAgIGlmIChwcm9jLnN0ZGluKSB7XG4gICAgICBwcm9jLnN0ZGluLm9uKCdlcnJvcicsIChlcnIpID0+IHtcbiAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihgU3RhbmRhcmQgaW5wdXQgJyR7ZXJyLnN5c2NhbGx9JyBlcnJvcjogJHtlcnIuc3RhY2t9YCkpO1xuICAgICAgfSk7XG4gICAgfVxuICAgIGlmIChwcm9jLnN0ZG91dCkge1xuICAgICAgcHJvYy5zdGRvdXQub24oJ2Vycm9yJywgKGVycikgPT4ge1xuICAgICAgICByZWplY3QobmV3IEVycm9yKGBTdGFuZGFyZCBvdXRwdXQgJyR7ZXJyLnN5c2NhbGx9JyBlcnJvcjogJHtlcnIuc3RhY2t9YCkpO1xuICAgICAgfSk7XG4gICAgfVxuICAgIGlmIChwcm9jLnN0ZGVycikge1xuICAgICAgcHJvYy5zdGRlcnIub24oJ2Vycm9yJywgKGVycikgPT4ge1xuICAgICAgICByZWplY3QobmV3IEVycm9yKGBTdGFuZGFyZCBlcnJvciAnJHtlcnIuc3lzY2FsbH0nIGVycm9yOiAke2Vyci5zdGFja31gKSk7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBrZWVwIHRyYWNrIG9mIHN0ZG91dC9zdGRlcnIgaWYgd2UgaGF2ZW4ndCBzYWlkIG5vdCB0b1xuICAgIGlmICghb3B0cy5pZ25vcmVPdXRwdXQpIHtcbiAgICAgIGlmIChwcm9jLnN0ZG91dCkge1xuICAgICAgICBwcm9jLnN0ZG91dC5vbignZGF0YScsIChkYXRhKSA9PiB7XG4gICAgICAgICAgc3Rkb3V0QXJyLnB1c2goZGF0YSk7XG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgICAgaWYgKHByb2Muc3RkZXJyKSB7XG4gICAgICAgIHByb2Muc3RkZXJyLm9uKCdkYXRhJywgKGRhdGEpID0+IHtcbiAgICAgICAgICBzdGRlcnJBcnIucHVzaChkYXRhKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZ2V0U3RkaW8gKGlzQnVmZmVyKSB7XG4gICAgICBsZXQgc3Rkb3V0LCBzdGRlcnI7XG4gICAgICBpZiAoaXNCdWZmZXIpIHtcbiAgICAgICAgc3Rkb3V0ID0gQnVmZmVyLmNvbmNhdChzdGRvdXRBcnIpO1xuICAgICAgICBzdGRlcnIgPSBCdWZmZXIuY29uY2F0KHN0ZGVyckFycik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBzdGRvdXQgPSBCdWZmZXIuY29uY2F0KHN0ZG91dEFycikudG9TdHJpbmcob3B0cy5lbmNvZGluZyk7XG4gICAgICAgIHN0ZGVyciA9IEJ1ZmZlci5jb25jYXQoc3RkZXJyQXJyKS50b1N0cmluZyhvcHRzLmVuY29kaW5nKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB7c3Rkb3V0LCBzdGRlcnJ9O1xuICAgIH1cblxuICAgIC8vIGlmIHRoZSBwcm9jZXNzIGVuZHMsIGVpdGhlciByZXNvbHZlIG9yIHJlamVjdCB0aGUgcHJvbWlzZSBiYXNlZCBvbiB0aGVcbiAgICAvLyBleGl0IGNvZGUgb2YgdGhlIHByb2Nlc3MuIGVpdGhlciB3YXksIGF0dGFjaCBzdGRvdXQsIHN0ZGVyciwgYW5kIGNvZGUuXG4gICAgLy8gQWxzbyBjbGVhbiB1cCB0aGUgdGltZXIgaWYgaXQgZXhpc3RzXG4gICAgcHJvYy5vbignY2xvc2UnLCAoY29kZSkgPT4ge1xuICAgICAgaWYgKHRpbWVyKSB7XG4gICAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7XG4gICAgICB9XG4gICAgICBsZXQge3N0ZG91dCwgc3RkZXJyfSA9IGdldFN0ZGlvKG9wdHMuaXNCdWZmZXIpO1xuICAgICAgaWYgKGNvZGUgPT09IDApIHtcbiAgICAgICAgcmVzb2x2ZSh7c3Rkb3V0LCBzdGRlcnIsIGNvZGV9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxldCBlcnIgPSBuZXcgRXJyb3IoYENvbW1hbmQgJyR7cmVwfScgZXhpdGVkIHdpdGggY29kZSAke2NvZGV9YCk7XG4gICAgICAgIGVyciA9IE9iamVjdC5hc3NpZ24oZXJyLCB7c3Rkb3V0LCBzdGRlcnIsIGNvZGV9KTtcbiAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICAvLyBpZiB3ZSBzZXQgYSB0aW1lb3V0IG9uIHRoZSBjaGlsZCBwcm9jZXNzLCBjdXQgaW50byB0aGUgZXhlY3V0aW9uIGFuZFxuICAgIC8vIHJlamVjdCBpZiB0aGUgdGltZW91dCBpcyByZWFjaGVkLiBBdHRhY2ggdGhlIHN0ZG91dC9zdGRlcnIgd2UgY3VycmVudGx5XG4gICAgLy8gaGF2ZSBpbiBjYXNlIGl0J3MgaGVscGZ1bCBpbiBkZWJ1Z2dpbmdcbiAgICBpZiAob3B0cy50aW1lb3V0KSB7XG4gICAgICB0aW1lciA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICBsZXQge3N0ZG91dCwgc3RkZXJyfSA9IGdldFN0ZGlvKG9wdHMuaXNCdWZmZXIpO1xuICAgICAgICBsZXQgZXJyID0gbmV3IEVycm9yKGBDb21tYW5kICcke3JlcH0nIHRpbWVkIG91dCBhZnRlciAke29wdHMudGltZW91dH1tc2ApO1xuICAgICAgICBlcnIgPSBPYmplY3QuYXNzaWduKGVyciwge3N0ZG91dCwgc3RkZXJyLCBjb2RlOiBudWxsfSk7XG4gICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICAvLyByZWplY3QgYW5kIFRIRU4ga2lsbCB0byBhdm9pZCByYWNlIGNvbmRpdGlvbnMgd2l0aCB0aGUgaGFuZGxlcnNcbiAgICAgICAgLy8gYWJvdmVcbiAgICAgICAgcHJvYy5raWxsKG9wdHMua2lsbFNpZ25hbCk7XG4gICAgICB9LCBvcHRzLnRpbWVvdXQpO1xuICAgIH1cbiAgfSk7XG59XG5cbmV4cG9ydCB7IGV4ZWMgfTtcbmV4cG9ydCBkZWZhdWx0IGV4ZWM7XG4iXSwiZmlsZSI6ImxpYi9leGVjLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
