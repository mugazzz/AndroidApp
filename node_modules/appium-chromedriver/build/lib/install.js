"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.install = install;
exports.installAll = installAll;
exports.conditionalInstall = conditionalInstall;
exports.doInstall = doInstall;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _requestPromise = _interopRequireDefault(require("request-promise"));

var _asyncbox = require("asyncbox");

var _appiumSupport = require("appium-support");

var _chromedriver = require("./chromedriver");

var _utils = require("./utils");

var _fancyLog = _interopRequireDefault(require("fancy-log"));

var _semver = _interopRequireDefault(require("semver"));

function log(line) {
  (0, _fancyLog.default)(`[Chromedriver Install] ${line}`);
}

const CD_CDN = process.env.npm_config_chromedriver_cdnurl || process.env.CHROMEDRIVER_CDNURL || 'https://chromedriver.storage.googleapis.com';
const CD_PLATS = ['linux', 'win', 'mac'];
const CD_ARCHS = ['32', '64'];

function getArchAndPlatform() {
  return _getArchAndPlatform.apply(this, arguments);
}

function _getArchAndPlatform() {
  _getArchAndPlatform = (0, _asyncToGenerator2.default)(function* () {
    let arch = yield _appiumSupport.system.arch();
    let platform = (0, _utils.getCurPlatform)();

    if (platform !== 'linux' && platform !== 'mac') {
      arch = '32';
    }

    const cdVer = _semver.default.coerce(_chromedriver.CD_VER);

    if (platform === 'mac' && _semver.default.lt(cdVer, _utils.MAC_32_ONLY)) {
      arch = '32';
    }

    return {
      arch,
      platform
    };
  });
  return _getArchAndPlatform.apply(this, arguments);
}

function getDownloadUrl(version, platform, arch) {
  return `${CD_CDN}/${version}/chromedriver_${platform}${arch}.zip`;
}

function validatePlatform(platform, arch) {
  if (!_lodash.default.includes(CD_PLATS, platform)) {
    throw new Error(`Invalid platform: ${platform}`);
  }

  if (!_lodash.default.includes(CD_ARCHS, arch)) {
    throw new Error(`Invalid arch: ${arch}`);
  }

  if (arch === "64" && platform !== "linux" && platform !== 'mac') {
    throw new Error('Only linux has a 64-bit version of Chromedriver');
  }
}

function installForPlatform(_x, _x2, _x3) {
  return _installForPlatform.apply(this, arguments);
}

function _installForPlatform() {
  _installForPlatform = (0, _asyncToGenerator2.default)(function* (version, platform, arch) {
    if (version === 'LATEST') {
      version = (yield _requestPromise.default.get({
        uri: `${CD_CDN}/LATEST_RELEASE`
      })).trim();
    }

    validatePlatform(platform, arch);
    const url = getDownloadUrl(version, platform, arch);
    log(`Installing Chromedriver version '${version}' for platform '${platform}' and architecture '${arch}'`);
    const binarySpec = `chromedriver_${platform}${arch}`;
    log(`Opening temp file to write '${binarySpec}' to...`);
    const tempFile = yield _appiumSupport.tempDir.open({
      prefix: binarySpec,
      suffix: '.zip'
    });
    log(`Opened temp file '${tempFile.path}'`);
    log(`Downloading ${url}...`);
    const body = yield _requestPromise.default.get({
      url,
      encoding: 'binary'
    });
    log(`Writing binary content to ${tempFile.path}...`);
    yield _appiumSupport.fs.writeFile(tempFile.path, body, {
      encoding: 'binary'
    });
    yield _appiumSupport.fs.chmod(tempFile.path, 0o0644);

    const tempUnzipped = _path.default.resolve(_path.default.dirname(tempFile.path), binarySpec);

    log(`Extracting ${tempFile.path} to ${tempUnzipped}`);
    yield (0, _appiumSupport.mkdirp)(tempUnzipped);
    yield _appiumSupport.zip.extractAllTo(tempFile.path, tempUnzipped);

    let extractedBin = _path.default.resolve(tempUnzipped, 'chromedriver');

    if (platform === "win") {
      extractedBin += ".exe";
    }

    log(`Creating ${_path.default.resolve(_utils.CD_BASE_DIR, platform)}...`);
    yield (0, _appiumSupport.mkdirp)(_path.default.resolve(_utils.CD_BASE_DIR, platform));
    const newBin = yield (0, _utils.getChromedriverBinaryPath)(platform, arch);
    log(`Copying unzipped binary, reading from ${extractedBin}...`);
    const binContents = yield _appiumSupport.fs.readFile(extractedBin, {
      encoding: 'binary'
    });
    log(`Writing to ${newBin}...`);
    yield _appiumSupport.fs.writeFile(newBin, binContents, {
      encoding: 'binary',
      mode: 0o755
    });
    log(`${newBin} successfully put in place`);
  });
  return _installForPlatform.apply(this, arguments);
}

function install() {
  return _install.apply(this, arguments);
}

function _install() {
  _install = (0, _asyncToGenerator2.default)(function* () {
    const _ref = yield getArchAndPlatform(),
          arch = _ref.arch,
          platform = _ref.platform;

    yield installForPlatform(_chromedriver.CD_VER, platform, arch);
  });
  return _install.apply(this, arguments);
}

function conditionalInstall() {
  return _conditionalInstall.apply(this, arguments);
}

function _conditionalInstall() {
  _conditionalInstall = (0, _asyncToGenerator2.default)(function* () {
    const _ref2 = yield getArchAndPlatform(),
          arch = _ref2.arch,
          platform = _ref2.platform;

    const binPath = yield (0, _utils.getChromedriverBinaryPath)(platform, arch);

    if (!(yield _appiumSupport.fs.exists(binPath))) {
      yield installForPlatform(_chromedriver.CD_VER, platform, arch);
    } else {
      log(`No need to install chromedriver, ${binPath} exists`);
    }
  });
  return _conditionalInstall.apply(this, arguments);
}

function installAll() {
  return _installAll.apply(this, arguments);
}

function _installAll() {
  _installAll = (0, _asyncToGenerator2.default)(function* () {
    let downloads = [];
    var _iteratorNormalCompletion = true;
    var _didIteratorError = false;
    var _iteratorError = undefined;

    try {
      for (var _iterator = (0, _utils.getPlatforms)()[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
        let _step$value = (0, _slicedToArray2.default)(_step.value, 2),
            platform = _step$value[0],
            arch = _step$value[1];

        downloads.push(installForPlatform(_chromedriver.CD_VER, platform, arch));
      }
    } catch (err) {
      _didIteratorError = true;
      _iteratorError = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion && _iterator.return != null) {
          _iterator.return();
        }
      } finally {
        if (_didIteratorError) {
          throw _iteratorError;
        }
      }
    }

    yield (0, _asyncbox.parallel)(downloads);
  });
  return _installAll.apply(this, arguments);
}

function doInstall() {
  return _doInstall.apply(this, arguments);
}

function _doInstall() {
  _doInstall = (0, _asyncToGenerator2.default)(function* () {
    if (_lodash.default.includes(process.argv, '--all') || process.env.npm_config_chromedriver_install_all) {
      yield installAll();
    } else if (_lodash.default.includes(process.argv, '--conditional')) {
      yield conditionalInstall();
    } else {
      yield install();
    }
  });
  return _doInstall.apply(this, arguments);
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9pbnN0YWxsLmpzIl0sIm5hbWVzIjpbImxvZyIsImxpbmUiLCJDRF9DRE4iLCJwcm9jZXNzIiwiZW52IiwibnBtX2NvbmZpZ19jaHJvbWVkcml2ZXJfY2RudXJsIiwiQ0hST01FRFJJVkVSX0NETlVSTCIsIkNEX1BMQVRTIiwiQ0RfQVJDSFMiLCJnZXRBcmNoQW5kUGxhdGZvcm0iLCJhcmNoIiwic3lzdGVtIiwicGxhdGZvcm0iLCJjZFZlciIsInNlbXZlciIsImNvZXJjZSIsIkNEX1ZFUiIsImx0IiwiTUFDXzMyX09OTFkiLCJnZXREb3dubG9hZFVybCIsInZlcnNpb24iLCJ2YWxpZGF0ZVBsYXRmb3JtIiwiXyIsImluY2x1ZGVzIiwiRXJyb3IiLCJpbnN0YWxsRm9yUGxhdGZvcm0iLCJyZXF1ZXN0IiwiZ2V0IiwidXJpIiwidHJpbSIsInVybCIsImJpbmFyeVNwZWMiLCJ0ZW1wRmlsZSIsInRlbXBEaXIiLCJvcGVuIiwicHJlZml4Iiwic3VmZml4IiwicGF0aCIsImJvZHkiLCJlbmNvZGluZyIsImZzIiwid3JpdGVGaWxlIiwiY2htb2QiLCJ0ZW1wVW56aXBwZWQiLCJyZXNvbHZlIiwiZGlybmFtZSIsInppcCIsImV4dHJhY3RBbGxUbyIsImV4dHJhY3RlZEJpbiIsIkNEX0JBU0VfRElSIiwibmV3QmluIiwiYmluQ29udGVudHMiLCJyZWFkRmlsZSIsIm1vZGUiLCJpbnN0YWxsIiwiY29uZGl0aW9uYWxJbnN0YWxsIiwiYmluUGF0aCIsImV4aXN0cyIsImluc3RhbGxBbGwiLCJkb3dubG9hZHMiLCJwdXNoIiwiZG9JbnN0YWxsIiwiYXJndiIsIm5wbV9jb25maWdfY2hyb21lZHJpdmVyX2luc3RhbGxfYWxsIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUE7O0FBQ0E7O0FBR0EsU0FBU0EsR0FBVCxDQUFjQyxJQUFkLEVBQW9CO0FBQ2xCLHlCQUFRLDBCQUF5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LGtCQUFrQixDQUFDVCxvQkFBRCxFQUFTSixRQUFULEVBQW1CRixJQUFuQixDQUF4QjtBQUNELEtBRkQsTUFFTztBQUNMVixNQUFBQSxHQUFHLENBQUUsb0NBQW1Dd0QsT0FBUSxTQUE3QyxDQUFIO0FBQ0Q7QUFDRixHOzs7O1NBRWNFLFU7Ozs7O2dEQUFmLGFBQTZCO0FBQzNCLFFBQUlDLFNBQVMsR0FBRyxFQUFoQjtBQUQyQjtBQUFBO0FBQUE7O0FBQUE7QUFFM0IsMkJBQTZCLDBCQUE3Qiw4SEFBNkM7QUFBQTtBQUFBLFlBQW5DL0MsUUFBbUM7QUFBQSxZQUF6QkYsSUFBeUI7O0FBQzNDaUQsUUFBQUEsU0FBUyxDQUFDQyxJQUFWLENBQWVuQyxrQkFBa0IsQ0FBQ1Qsb0JBQUQsRUFBU0osUUFBVCxFQUFtQkYsSUFBbkIsQ0FBakM7QUFDRDtBQUowQjtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBOztBQUszQixVQUFNLHdCQUFHaUQsU0FBSCxDQUFOO0FBQ0QsRzs7OztTQUVjRSxTOzs7OzsrQ0FBZixhQUE0QjtBQUMxQixRQUFJdkMsZ0JBQUVDLFFBQUYsQ0FBV3BCLE9BQU8sQ0FBQzJELElBQW5CLEVBQXlCLE9BQXpCLEtBQ0EzRCxPQUFPLENBQUNDLEdBQVIsQ0FBWTJELG1DQURoQixFQUNxRDtBQUNuRCxZQUFNTCxVQUFVLEVBQWhCO0FBQ0QsS0FIRCxNQUdPLElBQUlwQyxnQkFBRUMsUUFBRixDQUFXcEIsT0FBTyxDQUFDMkQsSUFBbkIsRUFBeUIsZUFBekIsQ0FBSixFQUErQztBQUNwRCxZQUFNUCxrQkFBa0IsRUFBeEI7QUFDRCxLQUZNLE1BRUE7QUFDTCxZQUFNRCxPQUFPLEVBQWI7QUFDRDtBQUNGLEciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgcmVxdWVzdCBmcm9tICdyZXF1ZXN0LXByb21pc2UnO1xuaW1wb3J0IHsgcGFyYWxsZWwgYXMgbGwgfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgeyBzeXN0ZW0sIHRlbXBEaXIsIGZzLCB6aXAsIG1rZGlycCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IENEX1ZFUiB9IGZyb20gJy4vY2hyb21lZHJpdmVyJztcbmltcG9ydCB7IENEX0JBU0VfRElSLCBnZXRDaHJvbWVkcml2ZXJCaW5hcnlQYXRoLCBnZXRDdXJQbGF0Zm9ybSxcbiAgICAgICAgIGdldFBsYXRmb3JtcywgTUFDXzMyX09OTFkgfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCBsb2dnZXIgZnJvbSAnZmFuY3ktbG9nJztcbmltcG9ydCBzZW12ZXIgZnJvbSAnc2VtdmVyJztcblxuXG5mdW5jdGlvbiBsb2cgKGxpbmUpIHtcbiAgbG9nZ2VyKGBbQ2hyb21lZHJpdmVyIEluc3RhbGxdICR7bGluZX1gKTtcbn1cblxuY29uc3QgQ0RfQ0ROID0gcHJvY2Vzcy5lbnYubnBtX2NvbmZpZ19jaHJvbWVkcml2ZXJfY2RudXJsIHx8XG4gICAgICAgICAgICAgICBwcm9jZXNzLmVudi5DSFJPTUVEUklWRVJfQ0ROVVJMIHx8XG4gICAgICAgICAgICAgICAnaHR0cHM6Ly9jaHJvbWVkcml2ZXIuc3RvcmFnZS5nb29nbGVhcGlzLmNvbSc7XG5jb25zdCBDRF9QTEFUUyA9IFsnbGludXgnLCAnd2luJywgJ21hYyddO1xuY29uc3QgQ0RfQVJDSFMgPSBbJzMyJywgJzY0J107XG5cbmFzeW5jIGZ1bmN0aW9uIGdldEFyY2hBbmRQbGF0Zm9ybSAoKSB7XG4gIGxldCBhcmNoID0gYXdhaXQgc3lzdGVtLmFyY2goKTtcbiAgbGV0IHBsYXRmb3JtID0gZ2V0Q3VyUGxhdGZvcm0oKTtcbiAgaWYgKHBsYXRmb3JtICE9PSAnbGludXgnICYmIHBsYXRmb3JtICE9PSAnbWFjJykge1xuICAgIGFyY2ggPSAnMzInO1xuICB9XG5cbiAgY29uc3QgY2RWZXIgPSBzZW12ZXIuY29lcmNlKENEX1ZFUik7XG4gIGlmIChwbGF0Zm9ybSA9PT0gJ21hYycgJiYgc2VtdmVyLmx0KGNkVmVyLCBNQUNfMzJfT05MWSkpIHtcbiAgICBhcmNoID0gJzMyJztcbiAgfVxuICByZXR1cm4ge2FyY2gsIHBsYXRmb3JtfTtcbn1cblxuZnVuY3Rpb24gZ2V0RG93bmxvYWRVcmwgKHZlcnNpb24sIHBsYXRmb3JtLCBhcmNoKSB7XG4gIHJldHVybiBgJHtDRF9DRE59LyR7dmVyc2lvbn0vY2hyb21lZHJpdmVyXyR7cGxhdGZvcm19JHthcmNofS56aXBgO1xufVxuXG5mdW5jdGlvbiB2YWxpZGF0ZVBsYXRmb3JtIChwbGF0Zm9ybSwgYXJjaCkge1xuICBpZiAoIV8uaW5jbHVkZXMoQ0RfUExBVFMsIHBsYXRmb3JtKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBwbGF0Zm9ybTogJHtwbGF0Zm9ybX1gKTtcbiAgfVxuICBpZiAoIV8uaW5jbHVkZXMoQ0RfQVJDSFMsIGFyY2gpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIGFyY2g6ICR7YXJjaH1gKTtcbiAgfVxuICBpZiAoYXJjaCA9PT0gXCI2NFwiICYmIHBsYXRmb3JtICE9PSBcImxpbnV4XCIgJiYgcGxhdGZvcm0gIT09ICdtYWMnKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdPbmx5IGxpbnV4IGhhcyBhIDY0LWJpdCB2ZXJzaW9uIG9mIENocm9tZWRyaXZlcicpO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGluc3RhbGxGb3JQbGF0Zm9ybSAodmVyc2lvbiwgcGxhdGZvcm0sIGFyY2gpIHtcbiAgaWYgKHZlcnNpb24gPT09ICdMQVRFU1QnKSB7XG4gICAgdmVyc2lvbiA9IChhd2FpdCByZXF1ZXN0LmdldCh7dXJpOiBgJHtDRF9DRE59L0xBVEVTVF9SRUxFQVNFYH0pKS50cmltKCk7XG4gIH1cbiAgdmFsaWRhdGVQbGF0Zm9ybShwbGF0Zm9ybSwgYXJjaCk7XG5cbiAgY29uc3QgdXJsID0gZ2V0RG93bmxvYWRVcmwodmVyc2lvbiwgcGxhdGZvcm0sIGFyY2gpO1xuXG4gIGxvZyhgSW5zdGFsbGluZyBDaHJvbWVkcml2ZXIgdmVyc2lvbiAnJHt2ZXJzaW9ufScgZm9yIHBsYXRmb3JtICcke3BsYXRmb3JtfScgYW5kIGFyY2hpdGVjdHVyZSAnJHthcmNofSdgKTtcblxuICAvLyBzZXQgdXAgYSB0ZW1wIGZpbGUgdG8gZG93bmxvYWQgdGhlIGNocm9tZWRyaXZlciB6aXBmaWxlIHRvXG4gIGNvbnN0IGJpbmFyeVNwZWMgPSBgY2hyb21lZHJpdmVyXyR7cGxhdGZvcm19JHthcmNofWA7XG4gIGxvZyhgT3BlbmluZyB0ZW1wIGZpbGUgdG8gd3JpdGUgJyR7YmluYXJ5U3BlY30nIHRvLi4uYCk7XG4gIGNvbnN0IHRlbXBGaWxlID0gYXdhaXQgdGVtcERpci5vcGVuKHtcbiAgICBwcmVmaXg6IGJpbmFyeVNwZWMsXG4gICAgc3VmZml4OiAnLnppcCdcbiAgfSk7XG4gIGxvZyhgT3BlbmVkIHRlbXAgZmlsZSAnJHt0ZW1wRmlsZS5wYXRofSdgKTtcblxuICAvLyBhY3R1YWxseSBkb3dubG9hZCB0aGUgemlwZmlsZSBhbmQgd3JpdGUgaXQgd2l0aCBhcHByb3ByaWF0ZSBwZXJtc1xuICBsb2coYERvd25sb2FkaW5nICR7dXJsfS4uLmApO1xuICBjb25zdCBib2R5ID0gYXdhaXQgcmVxdWVzdC5nZXQoe3VybCwgZW5jb2Rpbmc6ICdiaW5hcnknfSk7XG4gIGxvZyhgV3JpdGluZyBiaW5hcnkgY29udGVudCB0byAke3RlbXBGaWxlLnBhdGh9Li4uYCk7XG4gIGF3YWl0IGZzLndyaXRlRmlsZSh0ZW1wRmlsZS5wYXRoLCBib2R5LCB7ZW5jb2Rpbmc6ICdiaW5hcnknfSk7XG4gIGF3YWl0IGZzLmNobW9kKHRlbXBGaWxlLnBhdGgsIDBvMDY0NCk7XG5cbiAgLy8gZXh0cmFjdCBkb3dubG9hZGVkIHppcGZpbGUgdG8gdGVtcGRpclxuICBjb25zdCB0ZW1wVW56aXBwZWQgPSBwYXRoLnJlc29sdmUocGF0aC5kaXJuYW1lKHRlbXBGaWxlLnBhdGgpLCBiaW5hcnlTcGVjKTtcbiAgbG9nKGBFeHRyYWN0aW5nICR7dGVtcEZpbGUucGF0aH0gdG8gJHt0ZW1wVW56aXBwZWR9YCk7XG4gIGF3YWl0IG1rZGlycCh0ZW1wVW56aXBwZWQpO1xuICBhd2FpdCB6aXAuZXh0cmFjdEFsbFRvKHRlbXBGaWxlLnBhdGgsIHRlbXBVbnppcHBlZCk7XG4gIGxldCBleHRyYWN0ZWRCaW4gPSBwYXRoLnJlc29sdmUodGVtcFVuemlwcGVkLCAnY2hyb21lZHJpdmVyJyk7XG4gIGlmIChwbGF0Zm9ybSA9PT0gXCJ3aW5cIikge1xuICAgIGV4dHJhY3RlZEJpbiArPSBcIi5leGVcIjtcbiAgfVxuXG4gIC8vIG1ha2UgYnVpbGQgZGlycyB0aGF0IHdpbGwgaG9sZCB0aGUgY2hyb21lZHJpdmVyIGJpbmFyeVxuICBsb2coYENyZWF0aW5nICR7cGF0aC5yZXNvbHZlKENEX0JBU0VfRElSLCBwbGF0Zm9ybSl9Li4uYCk7XG4gIGF3YWl0IG1rZGlycChwYXRoLnJlc29sdmUoQ0RfQkFTRV9ESVIsIHBsYXRmb3JtKSk7XG5cbiAgLy8gY29weSB0aGUgZXh0cmFjdGVkIGJpbmFyeSB0byB0aGUgY29ycmVjdCBidWlsZCBkaXJcbiAgY29uc3QgbmV3QmluID0gYXdhaXQgZ2V0Q2hyb21lZHJpdmVyQmluYXJ5UGF0aChwbGF0Zm9ybSwgYXJjaCk7XG4gIGxvZyhgQ29weWluZyB1bnppcHBlZCBiaW5hcnksIHJlYWRpbmcgZnJvbSAke2V4dHJhY3RlZEJpbn0uLi5gKTtcbiAgY29uc3QgYmluQ29udGVudHMgPSBhd2FpdCBmcy5yZWFkRmlsZShleHRyYWN0ZWRCaW4sIHtlbmNvZGluZzogJ2JpbmFyeSd9KTtcbiAgbG9nKGBXcml0aW5nIHRvICR7bmV3QmlufS4uLmApO1xuICBhd2FpdCBmcy53cml0ZUZpbGUobmV3QmluLCBiaW5Db250ZW50cywge2VuY29kaW5nOiAnYmluYXJ5JywgbW9kZTogMG83NTV9KTtcbiAgbG9nKGAke25ld0Jpbn0gc3VjY2Vzc2Z1bGx5IHB1dCBpbiBwbGFjZWApO1xufVxuXG5hc3luYyBmdW5jdGlvbiBpbnN0YWxsICgpIHtcbiAgY29uc3Qge2FyY2gsIHBsYXRmb3JtfSA9IGF3YWl0IGdldEFyY2hBbmRQbGF0Zm9ybSgpO1xuICBhd2FpdCBpbnN0YWxsRm9yUGxhdGZvcm0oQ0RfVkVSLCBwbGF0Zm9ybSwgYXJjaCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNvbmRpdGlvbmFsSW5zdGFsbCAoKSB7XG4gIGNvbnN0IHthcmNoLCBwbGF0Zm9ybX0gPSBhd2FpdCBnZXRBcmNoQW5kUGxhdGZvcm0oKTtcbiAgY29uc3QgYmluUGF0aCA9IGF3YWl0IGdldENocm9tZWRyaXZlckJpbmFyeVBhdGgocGxhdGZvcm0sIGFyY2gpO1xuICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhiaW5QYXRoKSkge1xuICAgIGF3YWl0IGluc3RhbGxGb3JQbGF0Zm9ybShDRF9WRVIsIHBsYXRmb3JtLCBhcmNoKTtcbiAgfSBlbHNlIHtcbiAgICBsb2coYE5vIG5lZWQgdG8gaW5zdGFsbCBjaHJvbWVkcml2ZXIsICR7YmluUGF0aH0gZXhpc3RzYCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gaW5zdGFsbEFsbCAoKSB7XG4gIGxldCBkb3dubG9hZHMgPSBbXTtcbiAgZm9yIChsZXQgW3BsYXRmb3JtLCBhcmNoXSBvZiBnZXRQbGF0Zm9ybXMoKSkge1xuICAgIGRvd25sb2Fkcy5wdXNoKGluc3RhbGxGb3JQbGF0Zm9ybShDRF9WRVIsIHBsYXRmb3JtLCBhcmNoKSk7XG4gIH1cbiAgYXdhaXQgbGwoZG93bmxvYWRzKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZG9JbnN0YWxsICgpIHtcbiAgaWYgKF8uaW5jbHVkZXMocHJvY2Vzcy5hcmd2LCAnLS1hbGwnKSB8fFxuICAgICAgcHJvY2Vzcy5lbnYubnBtX2NvbmZpZ19jaHJvbWVkcml2ZXJfaW5zdGFsbF9hbGwpIHtcbiAgICBhd2FpdCBpbnN0YWxsQWxsKCk7XG4gIH0gZWxzZSBpZiAoXy5pbmNsdWRlcyhwcm9jZXNzLmFyZ3YsICctLWNvbmRpdGlvbmFsJykpIHtcbiAgICBhd2FpdCBjb25kaXRpb25hbEluc3RhbGwoKTtcbiAgfSBlbHNlIHtcbiAgICBhd2FpdCBpbnN0YWxsKCk7XG4gIH1cbn1cblxuZXhwb3J0IHsgaW5zdGFsbCwgaW5zdGFsbEFsbCwgY29uZGl0aW9uYWxJbnN0YWxsLCBkb0luc3RhbGwgfTtcbiJdLCJmaWxlIjoibGliL2luc3RhbGwuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
