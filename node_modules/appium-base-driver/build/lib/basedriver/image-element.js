"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getImgElFromArgs = getImgElFromArgs;
exports.makeImageElementCache = makeImageElementCache;
exports.IMAGE_EL_TAP_STRATEGY_W3C = exports.IMAGE_EL_TAP_STRATEGY_MJSONWP = exports.ImageElement = void 0;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _lodash = _interopRequireDefault(require("lodash"));

var _2 = require("../..");

var _lruCache = _interopRequireDefault(require("lru-cache"));

var _protocol = require("../protocol/protocol");

var _logger = _interopRequireDefault(require("./logger"));

var _uuidJs = _interopRequireDefault(require("uuid-js"));

const MAX_CACHE_SIZE = 1024 * 1024 * 40;
const TAP_DURATION_MS = 125;
const IMAGE_EL_TAP_STRATEGY_W3C = 'w3cActions';
exports.IMAGE_EL_TAP_STRATEGY_W3C = IMAGE_EL_TAP_STRATEGY_W3C;
const IMAGE_EL_TAP_STRATEGY_MJSONWP = 'touchActions';
exports.IMAGE_EL_TAP_STRATEGY_MJSONWP = IMAGE_EL_TAP_STRATEGY_MJSONWP;
const IMAGE_TAP_STRATEGIES = [IMAGE_EL_TAP_STRATEGY_MJSONWP, IMAGE_EL_TAP_STRATEGY_W3C];

class ImageElement {
  constructor(b64Template, rect) {
    this.template = b64Template;
    this.rect = rect;
    this.id = `${_protocol.IMAGE_ELEMENT_PREFIX}${_uuidJs.default.create().hex}`;
  }

  get size() {
    return {
      width: this.rect.width,
      height: this.rect.height
    };
  }

  get location() {
    return {
      x: this.rect.x,
      y: this.rect.y
    };
  }

  get center() {
    return {
      x: this.rect.x + this.rect.width / 2,
      y: this.rect.y + this.rect.height / 2
    };
  }

  asElement(protocolKey) {
    return {
      [protocolKey]: this.id
    };
  }

  equals(other) {
    return this.rect.x === other.rect.x && this.rect.y === other.rect.y && this.rect.width === other.rect.width && this.rect.height === other.rect.height;
  }

  click(driver) {
    var _this = this;

    return (0, _asyncToGenerator2.default)(function* () {
      let newImgEl;

      const _driver$settings$getS = driver.settings.getSettings(),
            updatePos = _driver$settings$getS.autoUpdateImageElementPosition,
            checkForImageElementStaleness = _driver$settings$getS.checkForImageElementStaleness,
            imageElementTapStrategy = _driver$settings$getS.imageElementTapStrategy;

      if (!IMAGE_TAP_STRATEGIES.includes(imageElementTapStrategy)) {
        throw new Error(`Incorrect imageElementTapStrategy setting ` + `'${imageElementTapStrategy}'. Must be one of ` + JSON.stringify(IMAGE_TAP_STRATEGIES));
      }

      if (checkForImageElementStaleness || updatePos) {
        _logger.default.info('Checking image element for staleness before clicking');

        try {
          newImgEl = yield driver.findByImage(_this.template, {
            shouldCheckStaleness: true
          });
        } catch (err) {
          throw new _2.errors.StaleElementReferenceError();
        }

        if (!_this.equals(newImgEl)) {
          _logger.default.warn(`When trying to click on an image element, the image changed ` + `position from where it was originally found. It is now at ` + `${JSON.stringify(newImgEl.rect)} and was originally at ` + `${JSON.stringify(_this.rect)}.`);

          if (updatePos) {
            _logger.default.warn('Click will proceed at new coordinates');

            _this.rect = _lodash.default.clone(newImgEl.rect);
          } else {
            _logger.default.warn("Click will take place at original coordinates. If you " + "would like Appium to automatically click the new " + "coordinates, set the 'autoUpdateImageElementPosition' " + "setting to true");
          }
        }
      }

      const _this$center = _this.center,
            x = _this$center.x,
            y = _this$center.y;

      _logger.default.info(`Will tap on image element at coordinate [${x}, ${y}]`);

      if (imageElementTapStrategy === IMAGE_EL_TAP_STRATEGY_W3C) {
        _logger.default.info('Will tap using W3C actions');

        const action = {
          type: 'pointer',
          id: 'mouse',
          parameters: {
            pointerType: 'touch'
          },
          actions: [{
            type: 'pointerMove',
            x,
            y,
            duration: 0
          }, {
            type: 'pointerDown'
          }, {
            type: 'pause',
            duration: TAP_DURATION_MS
          }, {
            type: 'pointerUp'
          }]
        };

        if (driver.performActions) {
          return yield driver.performActions([action]);
        }

        _logger.default.warn('Driver does not seem to implement W3C actions, falling back ' + 'to TouchActions');
      }

      _logger.default.info('Will tap using MJSONWP TouchActions');

      const action = {
        action: 'tap',
        options: {
          x,
          y
        }
      };

      if (driver.performTouch) {
        return yield driver.performTouch([action]);
      }

      throw new Error("Driver did not implement the 'performTouch' command. " + "For drivers to support finding image elements, they " + "should support 'performTouch' and 'performActions'");
    })();
  }

  static execute(driver, cmd, imgElId) {
    return (0, _asyncToGenerator2.default)(function* () {
      if (!driver._imgElCache.has(imgElId)) {
        throw new _2.errors.NoSuchElementError();
      }

      const imgEl = driver._imgElCache.get(imgElId);

      switch (cmd) {
        case 'click':
          return yield imgEl.click(driver);

        case 'elementDisplayed':
          return true;

        case 'getSize':
          return imgEl.size;

        case 'getLocation':
        case 'getLocationInView':
          return imgEl.location;

        case 'getElementRect':
          return imgEl.rect;

        default:
          throw new _2.errors.NotYetImplementedError();
      }
    })();
  }

}

exports.ImageElement = ImageElement;

function makeImageElementCache(max = MAX_CACHE_SIZE) {
  return (0, _lruCache.default)({
    max,
    length: el => el.template.length
  });
}

function getImgElFromArgs(args) {
  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    for (var _iterator = args[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      let arg = _step.value;

      if (_lodash.default.isString(arg) && arg.startsWith(_protocol.IMAGE_ELEMENT_PREFIX)) {
        return arg;
      }
    }
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator.return != null) {
        _iterator.return();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL2ltYWdlLWVsZW1lbnQuanMiXSwibmFtZXMiOlsiTUFYX0NBQ0hFX1NJWkUiLCJUQVBfRFVSQVRJT05fTVMiLCJJTUFHRV9FTF9UQVBfU1RSQVRFR1lfVzNDIiwiSU1BR0VfRUxfVEFQX1NUUkFURUdZX01KU09OV1AiLCJJTUFHRV9UQVBfU1RSQVRFR0lFUyIsIkltYWdlRWxlbWVudCIsImNvbnN0cnVjdG9yIiwiYjY0VGVtcGxhdGUiLCJyZWN0IiwidGVtcGxhdGUiLCJpZCIsIklNQUdFX0VMRU1FTlRfUFJFRklYIiwiVVVJRCIsImNyZWF0ZSIsImhleCIsInNpemUiLCJ3aWR0aCIsImhlaWdodCIsImxvY2F0aW9uIiwieCIsInkiLCJjZW50ZXIiLCJhc0VsZW1lbnQiLCJwcm90b2NvbEtleSIsImVxdWFscyIsIm90aGVyIiwiY2xpY2siLCJkcml2ZXIiLCJuZXdJbWdFbCIsInNldHRpbmdzIiwiZ2V0U2V0dGluZ3MiLCJ1cGRhdGVQb3MiLCJhdXRvVXBkYXRlSW1hZ2VFbGVtZW50UG9zaXRpb24iLCJjaGVja0ZvckltYWdlRWxlbWVudFN0YWxlbmVzcyIsImltYWdlRWxlbWVudFRhcFN0cmF0ZWd5IiwiaW5jbHVkZXMiLCJFcnJvciIsIkpTT04iLCJzdHJpbmdpZnkiLCJsb2ciLCJpbmZvIiwiZmluZEJ5SW1hZ2UiLCJzaG91bGRDaGVja1N0YWxlbmVzcyIsImVyciIsImVycm9ycyIsIlN0YWxlRWxlbWVudFJlZmVyZW5jZUVycm9yIiwid2FybiIsIl8iLCJjbG9uZSIsImFjdGlvbiIsInR5cGUiLCJwYXJhbWV0ZXJzIiwicG9pbnRlclR5cGUiLCJhY3Rpb25zIiwiZHVyYXRpb24iLCJwZXJmb3JtQWN0aW9ucyIsIm9wdGlvbnMiLCJwZXJmb3JtVG91Y2giLCJleGVjdXRlIiwiY21kIiwiaW1nRWxJZCIsIl9pbWdFbENhY2hlIiwiaGFzIiwiTm9TdWNoRWxlbWVudEVycm9yIiwiaW1nRWwiLCJnZXQiLCJOb3RZZXRJbXBsZW1lbnRlZEVycm9yIiwibWFrZUltYWdlRWxlbWVudENhY2hlIiwibWF4IiwibGVuZ3RoIiwiZWwiLCJnZXRJbWdFbEZyb21BcmdzIiwiYXJncyIsImFyZyIsImlzU3RyaW5nIiwic3RhcnRzV2l0aCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLE1BQU1BLGNBQWMsR0FBRyxPQUFPLElBQVAsR0FBYyxFQUFyQztBQUNBLE1BQU1DLGVBQWUsR0FBRyxHQUF4QjtBQUNBLE1BQU1DLHlCQUF5QixHQUFHLFlBQWxDOztBQUNBLE1BQU1DLDZCQUE2QixHQUFHLGNBQXRDOztBQUNBLE1BQU1DLG9CQUFvQixHQUFHLENBQzNCRCw2QkFEMkIsRUFFM0JELHlCQUYyQixDQUE3Qjs7QUE2QkEsTUFBTUcsWUFBTixDQUFtQjtBQVNqQkMsRUFBQUEsV0FBVyxDQUFFQyxXQUFGLEVBQWVDLElBQWYsRUFBcUI7QUFDOUIsU0FBS0MsUUFBTCxHQUFnQkYsV0FBaEI7QUFDQSxTQUFLQyxJQUFMLEdBQVlBLElBQVo7QUFDQSxTQUFLRSxFQUFMLEdBQVcsR0FBRUMsOEJBQXFCLEdBQUVDLGdCQUFLQyxNQUFMLEdBQWNDLEdBQUksRUFBdEQ7QUFDRDs7QUFLRCxNQUFJQyxJQUFKLEdBQVk7QUFDVixXQUFPO0FBQUNDLE1BQUFBLEtBQUssRUFBRSxLQUFLUixJQUFMLENBQVVRLEtBQWxCO0FBQXlCQyxNQUFBQSxNQUFNLEVBQUUsS0FBS1QsSUFBTCxDQUFVUztBQUEzQyxLQUFQO0FBQ0Q7O0FBS0QsTUFBSUMsUUFBSixHQUFnQjtBQUNkLFdBQU87QUFBQ0MsTUFBQUEsQ0FBQyxFQUFFLEtBQUtYLElBQUwsQ0FBVVcsQ0FBZDtBQUFpQkMsTUFBQUEsQ0FBQyxFQUFFLEtBQUtaLElBQUwsQ0FBVVk7QUFBOUIsS0FBUDtBQUNEOztBQUtELE1BQUlDLE1BQUosR0FBYztBQUNaLFdBQU87QUFDTEYsTUFBQUEsQ0FBQyxFQUFFLEtBQUtYLElBQUwsQ0FBVVcsQ0FB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RyxDQUFDRSxVQUFKLENBQWVoRSw4QkFBZixDQUF2QixFQUE2RDtBQUMzRCxlQUFPOEQsR0FBUDtBQUNEO0FBQ0Y7QUFMOEI7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQU1oQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBlcnJvcnMgfSBmcm9tICcuLi8uLic7XG5pbXBvcnQgTFJVIGZyb20gJ2xydS1jYWNoZSc7XG5pbXBvcnQgeyBJTUFHRV9FTEVNRU5UX1BSRUZJWCB9IGZyb20gJy4uL3Byb3RvY29sL3Byb3RvY29sJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IFVVSUQgZnJvbSAndXVpZC1qcyc7XG5cbmNvbnN0IE1BWF9DQUNIRV9TSVpFID0gMTAyNCAqIDEwMjQgKiA0MDsgLy8gNDBtYlxuY29uc3QgVEFQX0RVUkFUSU9OX01TID0gMTI1O1xuY29uc3QgSU1BR0VfRUxfVEFQX1NUUkFURUdZX1czQyA9ICd3M2NBY3Rpb25zJztcbmNvbnN0IElNQUdFX0VMX1RBUF9TVFJBVEVHWV9NSlNPTldQID0gJ3RvdWNoQWN0aW9ucyc7XG5jb25zdCBJTUFHRV9UQVBfU1RSQVRFR0lFUyA9IFtcbiAgSU1BR0VfRUxfVEFQX1NUUkFURUdZX01KU09OV1AsXG4gIElNQUdFX0VMX1RBUF9TVFJBVEVHWV9XM0Ncbl07XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gUmVjdFxuICogQHByb3BlcnR5IHtpbnR9IHggLSB4LWNvb3JkaW5hdGUgb2YgdG9wLWxlZnQgY29ybmVyXG4gKiBAcHJvcGVydHkge2ludH0geSAtIHktY29vcmRpbmF0ZSBvZiB0b3AtbGVmdCBjb3JuZXJcbiAqIEBwcm9wZXJ0eSB7aW50fSB3aWR0aCAtIHdpZHRoIG9mIHJlY3RcbiAqIEBwcm9wZXJ0eSB7aW50fSBoZWlnaHQgLSBoZWlnaHQgb2YgcmVjdFxuICovXG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gRGltZW5zaW9uXG4gKiBAcHJvcGVydHkge2ludH0gd2lkdGggLSB3aWR0aCBvZiByZWN0XG4gKiBAcHJvcGVydHkge2ludH0gaGVpZ2h0IC0gaGVpZ2h0IG9mIHJlY3RcbiAqL1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFBvc2l0aW9uXG4gKiBAcHJvcGVydHkge2ludH0geCAtIHggY29vcmRpbmF0ZVxuICogQHByb3BlcnR5IHtpbnR9IHkgLSB5IGNvb3JkaW5hdGVcbiAqL1xuXG4vKipcbiAqIFJlcHJlc2VudGF0aW9uIG9mIGFuIFwiaW1hZ2UgZWxlbWVudFwiLCB3aGljaCBpcyBzaW1wbHkgYSBzZXQgb2YgY29vcmRpbmF0ZXNcbiAqIGFuZCBtZXRob2RzIHRoYXQgY2FuIGJlIHVzZWQgb24gdGhhdCBzZXQgb2YgY29vcmRpbmF0ZXMgdmlhIHRoZSBkcml2ZXJcbiAqL1xuY2xhc3MgSW1hZ2VFbGVtZW50IHtcblxuICAvKipcbiAgICogQHBhcmFtIHtzdHJpbmd9IGI2NFRlbXBsYXRlIC0gdGhlIGJhc2U2NC1lbmNvZGVkIGltYWdlIHdoaWNoIHdhcyB1c2VkIHRvXG4gICAqIGZpbmQgdGhpcyBJbWFnZUVsZW1lbnRcbiAgICogQHBhcmFtIHtSZWN0fSByZWN0IC0gYm91bmRzIG9mIG1hdGNoZWQgaW1hZ2UgZWxlbWVudFxuICAgKlxuICAgKiBAcmV0dXJucyB7SW1hZ2VFbGVtZW50fVxuICAgKi9cbiAgY29uc3RydWN0b3IgKGI2NFRlbXBsYXRlLCByZWN0KSB7XG4gICAgdGhpcy50ZW1wbGF0ZSA9IGI2NFRlbXBsYXRlO1xuICAgIHRoaXMucmVjdCA9IHJlY3Q7XG4gICAgdGhpcy5pZCA9IGAke0lNQUdFX0VMRU1FTlRfUFJFRklYfSR7VVVJRC5jcmVhdGUoKS5oZXh9YDtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcmV0dXJucyB7RGltZW5zaW9ufSAtIGRpbWVuc2lvbiBvZiBlbGVtZW50XG4gICAqL1xuICBnZXQgc2l6ZSAoKSB7XG4gICAgcmV0dXJuIHt3aWR0aDogdGhpcy5yZWN0LndpZHRoLCBoZWlnaHQ6IHRoaXMucmVjdC5oZWlnaHR9O1xuICB9XG5cbiAgLyoqXG4gICAqIEByZXR1cm5zIHtQb3NpdGlvbn0gLSBjb29yZGluYXRlcyBvZiB0b3AtbGVmdCBjb3JuZXIgb2YgZWxlbWVudFxuICAgKi9cbiAgZ2V0IGxvY2F0aW9uICgpIHtcbiAgICByZXR1cm4ge3g6IHRoaXMucmVjdC54LCB5OiB0aGlzLnJlY3QueX07XG4gIH1cblxuICAvKipcbiAgICogQHJldHVybnMge1Bvc2l0aW9ufSAtIGNvb3JkaW5hdGVzIG9mIGNlbnRlciBvZiBlbGVtZW50XG4gICAqL1xuICBnZXQgY2VudGVyICgpIHtcbiAgICByZXR1cm4ge1xuICAgICAgeDogdGhpcy5yZWN0LnggKyB0aGlzLnJlY3Qud2lkdGggLyAyLFxuICAgICAgeTogdGhpcy5yZWN0LnkgKyB0aGlzLnJlY3QuaGVpZ2h0IC8gMixcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBwcm90b2NvbEtleSAtIHRoZSBwcm90b2NvbC1zcGVjaWZpYyBKU09OIGtleSBmb3JcbiAgICogYSBXZWJFbGVtZW50XG4gICAqXG4gICAqIEByZXR1cm5zIHtXZWJFbGVtZW50fSAtIHRoaXMgaW1hZ2UgZWxlbWVudCBhcyBhIFdlYkVsZW1lbnRcbiAgICovXG4gIGFzRWxlbWVudCAocHJvdG9jb2xLZXkpIHtcbiAgICByZXR1cm4ge1twcm90b2NvbEtleV06IHRoaXMuaWR9O1xuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7SW1hZ2VFbGVtZW50fSBvdGhlciAtIGFuIEltYWdlRWxlbWVudCB0byBjb21wYXJlIHdpdGggdGhpcyBvbmVcbiAgICpcbiAgICogQHJldHVybnMge2Jvb2xlYW59IC0gd2hldGhlciB0aGUgb3RoZXIgZWxlbWVudCBhbmQgdGhpcyBvbmUgaGF2ZSB0aGUgc2FtZVxuICAgKiBwcm9wZXJ0aWVzXG4gICAqL1xuICBlcXVhbHMgKG90aGVyKSB7XG4gICAgcmV0dXJuIHRoaXMucmVjdC54ID09PSBvdGhlci5yZWN0LnggJiZcbiAgICAgICAgICAgdGhpcy5yZWN0LnkgPT09IG90aGVyLnJlY3QueSAmJlxuICAgICAgICAgICB0aGlzLnJlY3Qud2lkdGggPT09IG90aGVyLnJlY3Qud2lkdGggJiZcbiAgICAgICAgICAgdGhpcy5yZWN0LmhlaWdodCA9PT0gb3RoZXIucmVjdC5oZWlnaHQ7XG4gIH1cblxuICAvKipcbiAgICogVXNlIGEgZHJpdmVyIHRvIHRhcCB0aGUgc2NyZWVuIGF0IHRoZSBjZW50ZXIgb2YgdGhpcyBJbWFnZUVsZW1lbnQnc1xuICAgKiBwb3NpdGlvblxuICAgKlxuICAgKiBAcGFyYW0ge0Jhc2VEcml2ZXJ9IGRyaXZlciAtIGRyaXZlciBmb3IgY2FsbGluZyBhY3Rpb25zIHdpdGhcbiAgICovXG4gIGFzeW5jIGNsaWNrIChkcml2ZXIpIHtcbiAgICAvLyBiZWZvcmUgd2UgY2xpY2sgd2UgbmVlZCB0byBtYWtlIHN1cmUgdGhlIGVsZW1lbnQgaXMgYWN0dWFsbHkgc3RpbGwgdGhlcmVcbiAgICAvLyB3aGVyZSB3ZSBleHBlY3QgaXQgdG8gYmVcbiAgICBsZXQgbmV3SW1nRWw7XG4gICAgY29uc3Qge1xuICAgICAgYXV0b1VwZGF0ZUltYWdlRWxlbWVudFBvc2l0aW9uOiB1cGRhdGVQb3MsXG4gICAgICBjaGVja0ZvckltYWdlRWxlbWVudFN0YWxlbmVzcyxcbiAgICAgIGltYWdlRWxlbWVudFRhcFN0cmF0ZWd5LFxuICAgIH0gPSBkcml2ZXIuc2V0dGluZ3MuZ2V0U2V0dGluZ3MoKTtcblxuICAgIC8vIHZhbGlkYXRlIHRhcCBzdHJhdGVneVxuICAgIGlmICghSU1BR0VfVEFQX1NUUkFURUdJRVMuaW5jbHVkZXMoaW1hZ2VFbGVtZW50VGFwU3RyYXRlZ3kpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEluY29ycmVjdCBpbWFnZUVsZW1lbnRUYXBTdHJhdGVneSBzZXR0aW5nIGAgK1xuICAgICAgICAgICAgICAgICAgICAgIGAnJHtpbWFnZUVsZW1lbnRUYXBTdHJhdGVneX0nLiBNdXN0IGJlIG9uZSBvZiBgICtcbiAgICAgICAgICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeShJTUFHRV9UQVBfU1RSQVRFR0lFUykpO1xuICAgIH1cblxuICAgIGlmIChjaGVja0ZvckltYWdlRWxlbWVudFN0YWxlbmVzcyB8fCB1cGRhdGVQb3MpIHtcbiAgICAgIGxvZy5pbmZvKCdDaGVja2luZyBpbWFnZSBlbGVtZW50IGZvciBzdGFsZW5lc3MgYmVmb3JlIGNsaWNraW5nJyk7XG4gICAgICB0cnkge1xuICAgICAgICBuZXdJbWdFbCA9IGF3YWl0IGRyaXZlci5maW5kQnlJbWFnZSh0aGlzLnRlbXBsYXRlLCB7XG4gICAgICAgICAgc2hvdWxkQ2hlY2tTdGFsZW5lc3M6IHRydWVcbiAgICAgICAgfSk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgdGhyb3cgbmV3IGVycm9ycy5TdGFsZUVsZW1lbnRSZWZlcmVuY2VFcnJvcigpO1xuICAgICAgfVxuXG4gICAgICBpZiAoIXRoaXMuZXF1YWxzKG5ld0ltZ0VsKSkge1xuICAgICAgICBsb2cud2FybihgV2hlbiB0cnlpbmcgdG8gY2xpY2sgb24gYW4gaW1hZ2UgZWxlbWVudCwgdGhlIGltYWdlIGNoYW5nZWQgYCArXG4gICAgICAgICAgICAgICAgIGBwb3NpdGlvbiBmcm9tIHdoZXJlIGl0IHdhcyBvcmlnaW5hbGx5IGZvdW5kLiBJdCBpcyBub3cgYXQgYCArXG4gICAgICAgICAgICAgICAgIGAke0pTT04uc3RyaW5naWZ5KG5ld0ltZ0VsLnJlY3QpfSBhbmQgd2FzIG9yaWdpbmFsbHkgYXQgYCArXG4gICAgICAgICAgICAgICAgIGAke0pTT04uc3RyaW5naWZ5KHRoaXMucmVjdCl9LmApO1xuICAgICAgICBpZiAodXBkYXRlUG9zKSB7XG4gICAgICAgICAgbG9nLndhcm4oJ0NsaWNrIHdpbGwgcHJvY2VlZCBhdCBuZXcgY29vcmRpbmF0ZXMnKTtcbiAgICAgICAgICB0aGlzLnJlY3QgPSBfLmNsb25lKG5ld0ltZ0VsLnJlY3QpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGxvZy53YXJuKFwiQ2xpY2sgd2lsbCB0YWtlIHBsYWNlIGF0IG9yaWdpbmFsIGNvb3JkaW5hdGVzLiBJZiB5b3UgXCIgK1xuICAgICAgICAgICAgICAgICAgIFwid291bGQgbGlrZSBBcHBpdW0gdG8gYXV0b21hdGljYWxseSBjbGljayB0aGUgbmV3IFwiICtcbiAgICAgICAgICAgICAgICAgICBcImNvb3JkaW5hdGVzLCBzZXQgdGhlICdhdXRvVXBkYXRlSW1hZ2VFbGVtZW50UG9zaXRpb24nIFwiICtcbiAgICAgICAgICAgICAgICAgICBcInNldHRpbmcgdG8gdHJ1ZVwiKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IHt4LCB5fSA9IHRoaXMuY2VudGVyO1xuICAgIGxvZy5pbmZvKGBXaWxsIHRhcCBvbiBpbWFnZSBlbGVtZW50IGF0IGNvb3JkaW5hdGUgWyR7eH0sICR7eX1dYCk7XG5cbiAgICBpZiAoaW1hZ2VFbGVtZW50VGFwU3RyYXRlZ3kgPT09IElNQUdFX0VMX1RBUF9TVFJBVEVHWV9XM0MpIHtcbiAgICAgIC8vIHNldCB1cCBhIFczQyBhY3Rpb24gdG8gY2xpY2sgb24gdGhlIGltYWdlIGJ5IHBvc2l0aW9uXG4gICAgICBsb2cuaW5mbygnV2lsbCB0YXAgdXNpbmcgVzNDIGFjdGlvbnMnKTtcbiAgICAgIGNvbnN0IGFjdGlvbiA9IHtcbiAgICAgICAgdHlwZTogJ3BvaW50ZXInLFxuICAgICAgICBpZDogJ21vdXNlJyxcbiAgICAgICAgcGFyYW1ldGVyczoge3BvaW50ZXJUeXBlOiAndG91Y2gnfSxcbiAgICAgICAgYWN0aW9uczogW1xuICAgICAgICAgIHt0eXBlOiAncG9pbnRlck1vdmUnLCB4LCB5LCBkdXJhdGlvbjogMH0sXG4gICAgICAgICAge3R5cGU6ICdwb2ludGVyRG93bid9LFxuICAgICAgICAgIHt0eXBlOiAncGF1c2UnLCBkdXJhdGlvbjogVEFQX0RVUkFUSU9OX01TfSxcbiAgICAgICAgICB7dHlwZTogJ3BvaW50ZXJVcCd9LFxuICAgICAgICBdXG4gICAgICB9O1xuXG4gICAgICAvLyBjaGVjayBpZiB0aGUgZHJpdmVyIGhhcyB0aGUgYXBwcm9wcmlhdGUgcGVyZm9ybUFjdGlvbnMgbWV0aG9kXG4gICAgICBpZiAoZHJpdmVyLnBlcmZvcm1BY3Rpb25zKSB7XG4gICAgICAgIHJldHVybiBhd2FpdCBkcml2ZXIucGVyZm9ybUFjdGlvbnMoW2FjdGlvbl0pO1xuICAgICAgfVxuXG4gICAgICAvLyBpZiBub3QsIHdhcm4gYW5kIGZhbGwgYmFjayB0byB0aGUgb3RoZXIgbWV0aG9kXG4gICAgICBsb2cud2FybignRHJpdmVyIGRvZXMgbm90IHNlZW0gdG8gaW1wbGVtZW50IFczQyBhY3Rpb25zLCBmYWxsaW5nIGJhY2sgJyArXG4gICAgICAgICAgICAgICAndG8gVG91Y2hBY3Rpb25zJyk7XG4gICAgfVxuXG4gICAgLy8gaWYgdGhlIHczYyBzdHJhdGVneSB3YXMgbm90IHJlcXVlc3RlZCwgZG8gdGhlIG9ubHkgb3RoZXIgb3B0aW9uIChtanNvbndwXG4gICAgLy8gdG91Y2ggYWN0aW9ucylcbiAgICBsb2cuaW5mbygnV2lsbCB0YXAgdXNpbmcgTUpTT05XUCBUb3VjaEFjdGlvbnMnKTtcbiAgICBjb25zdCBhY3Rpb24gPSB7XG4gICAgICBhY3Rpb246ICd0YXAnLFxuICAgICAgb3B0aW9uczoge3gsIHl9XG4gICAgfTtcblxuICAgIGlmIChkcml2ZXIucGVyZm9ybVRvdWNoKSB7XG4gICAgICByZXR1cm4gYXdhaXQgZHJpdmVyLnBlcmZvcm1Ub3VjaChbYWN0aW9uXSk7XG4gICAgfVxuXG4gICAgdGhyb3cgbmV3IEVycm9yKFwiRHJpdmVyIGRpZCBub3QgaW1wbGVtZW50IHRoZSAncGVyZm9ybVRvdWNoJyBjb21tYW5kLiBcIiArXG4gICAgICAgICAgICAgICAgICAgIFwiRm9yIGRyaXZlcnMgdG8gc3VwcG9ydCBmaW5kaW5nIGltYWdlIGVsZW1lbnRzLCB0aGV5IFwiICtcbiAgICAgICAgICAgICAgICAgICAgXCJzaG91bGQgc3VwcG9ydCAncGVyZm9ybVRvdWNoJyBhbmQgJ3BlcmZvcm1BY3Rpb25zJ1wiKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBIYW5kbGUgdmFyaW91cyBBcHBpdW0gY29tbWFuZHMgdGhhdCBpbnZvbHZlIGFuIGltYWdlIGVsZW1lbnRcbiAgICpcbiAgICogQHBhcmFtIHtCYXNlRHJpdmVyfSBkcml2ZXIgLSB0aGUgZHJpdmVyIHRvIHVzZSBmb3IgY29tbWFuZHNcbiAgICogQHBhcmFtIHtzdHJpbmd9IGNtZCAtIHRoZSBuYW1lIG9mIHRoZSBkcml2ZXIgY29tbWFuZFxuICAgKiBAcGFyYW0ge3N0cmluZ30gaW1nRWxJZCAtIHRoZSBpZCBvZiB0aGUgSW1hZ2VFbGVtZW50IHRvIHdvcmsgd2l0aFxuICAgKlxuICAgKiBAcmV0dXJucyB7T2JqZWN0fSAtIHRoZSByZXN1bHQgb2YgcnVubmluZyBhIGNvbW1hbmRcbiAgICovXG4gIHN0YXRpYyBhc3luYyBleGVjdXRlIChkcml2ZXIsIGNtZCwgaW1nRWxJZCkge1xuICAgIGlmICghZHJpdmVyLl9pbWdFbENhY2hlLmhhcyhpbWdFbElkKSkge1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hFbGVtZW50RXJyb3IoKTtcbiAgICB9XG5cbiAgICBjb25zdCBpbWdFbCA9IGRyaXZlci5faW1nRWxDYWNoZS5nZXQoaW1nRWxJZCk7XG5cbiAgICBzd2l0Y2ggKGNtZCkge1xuICAgICAgY2FzZSAnY2xpY2snOlxuICAgICAgICByZXR1cm4gYXdhaXQgaW1nRWwuY2xpY2soZHJpdmVyKTtcbiAgICAgIGNhc2UgJ2VsZW1lbnREaXNwbGF5ZWQnOlxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIGNhc2UgJ2dldFNpemUnOlxuICAgICAgICByZXR1cm4gaW1nRWwuc2l6ZTtcbiAgICAgIGNhc2UgJ2dldExvY2F0aW9uJzpcbiAgICAgIGNhc2UgJ2dldExvY2F0aW9uSW5WaWV3JzpcbiAgICAgICAgcmV0dXJuIGltZ0VsLmxvY2F0aW9uO1xuICAgICAgY2FzZSAnZ2V0RWxlbWVudFJlY3QnOlxuICAgICAgICByZXR1cm4gaW1nRWwucmVjdDtcbiAgICAgIGRlZmF1bHQ6IHRocm93IG5ldyBlcnJvcnMuTm90WWV0SW1wbGVtZW50ZWRFcnJvcigpO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBtYWtlSW1hZ2VFbGVtZW50Q2FjaGUgKG1heCA9IE1BWF9DQUNIRV9TSVpFKSB7XG4gIHJldHVybiBMUlUoe1xuICAgIG1heCxcbiAgICBsZW5ndGg6IChlbCkgPT4gZWwudGVtcGxhdGUubGVuZ3RoLFxuICB9KTtcbn1cblxuZnVuY3Rpb24gZ2V0SW1nRWxGcm9tQXJncyAoYXJncykge1xuICBmb3IgKGxldCBhcmcgb2YgYXJncykge1xuICAgIGlmIChfLmlzU3RyaW5nKGFyZykgJiYgYXJnLnN0YXJ0c1dpdGgoSU1BR0VfRUxFTUVOVF9QUkVGSVgpKSB7XG4gICAgICByZXR1cm4gYXJnO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQge1xuICBJbWFnZUVsZW1lbnQsIGdldEltZ0VsRnJvbUFyZ3MsIG1ha2VJbWFnZUVsZW1lbnRDYWNoZSxcbiAgSU1BR0VfRUxfVEFQX1NUUkFURUdZX01KU09OV1AsIElNQUdFX0VMX1RBUF9TVFJBVEVHWV9XM0MsXG59O1xuIl0sImZpbGUiOiJsaWIvYmFzZWRyaXZlci9pbWFnZS1lbGVtZW50LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
