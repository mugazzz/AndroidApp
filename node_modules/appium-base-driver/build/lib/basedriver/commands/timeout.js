"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.helpers = exports.commands = void 0;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _logger = _interopRequireDefault(require("../logger"));

var _asyncbox = require("asyncbox");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _protocol = require("../../protocol");

let commands = {},
    helpers = {},
    extensions = {};
exports.helpers = helpers;
exports.commands = commands;
const MIN_TIMEOUT = 0;

commands.timeouts = function () {
  var _ref = (0, _asyncToGenerator2.default)(function* (type, ms, script, pageLoad, implicit) {
    if (_appiumSupport.util.hasValue(type) && _appiumSupport.util.hasValue(ms)) {
      _logger.default.debug(`MJSONWP timeout arguments: ${JSON.stringify({
        type,
        ms
      })}}`);

      switch (type) {
        case 'command':
          yield this.newCommandTimeout(ms);
          return;

        case 'implicit':
          yield this.implicitWaitMJSONWP(ms);
          return;

        case 'page load':
          yield this.pageLoadTimeoutMJSONWP(ms);
          return;

        case 'script':
          yield this.scriptTimeoutMJSONWP(ms);
          return;

        default:
          throw new Error(`'${type}' type is not supported for MJSONWP timeout`);
      }
    }

    _logger.default.debug(`W3C timeout argument: ${JSON.stringify({
      script,
      pageLoad,
      implicit
    })}}`);

    if (_appiumSupport.util.hasValue(script)) {
      yield this.scriptTimeoutW3C(script);
    }

    if (_appiumSupport.util.hasValue(pageLoad)) {
      yield this.pageLoadTimeoutW3C(pageLoad);
    }

    if (_appiumSupport.util.hasValue(implicit)) {
      yield this.implicitWaitW3C(implicit);
    }
  });

  return function (_x, _x2, _x3, _x4, _x5) {
    return _ref.apply(this, arguments);
  };
}();

commands.getTimeouts = (0, _asyncToGenerator2.default)(function* () {
  return {
    command: this.newCommandTimeoutMs,
    implicit: this.implicitWaitMs
  };
});

commands.implicitWaitW3C = function () {
  var _ref3 = (0, _asyncToGenerator2.default)(function* (ms) {
    yield this.implicitWait(ms);
  });

  return function (_x6) {
    return _ref3.apply(this, arguments);
  };
}();

commands.implicitWaitMJSONWP = function () {
  var _ref4 = (0, _asyncToGenerator2.default)(function* (ms) {
    yield this.implicitWait(ms);
  });

  return function (_x7) {
    return _ref4.apply(this, arguments);
  };
}();

commands.implicitWait = function () {
  var _ref5 = (0, _asyncToGenerator2.default)(function* (ms) {
    yield this.setImplicitWait(this.parseTimeoutArgument(ms));
  });

  return function (_x8) {
    return _ref5.apply(this, arguments);
  };
}();

helpers.setImplicitWait = function (ms) {
  this.implicitWaitMs = ms;

  _logger.default.debug(`Set implicit wait to ${ms}ms`);

  if (this.managedDrivers && this.managedDrivers.length) {
    _logger.default.debug('Setting implicit wait on managed drivers');

    var _iteratorNormalCompletion = true;
    var _didIteratorError = false;
    var _iteratorError = undefined;

    try {
      for (var _iterator = this.managedDrivers[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
        let driver = _step.value;

        if (_lodash.default.isFunction(driver.setImplicitWait)) {
          driver.setImplicitWait(ms);
        }
      }
    } catch (err) {
      _didIteratorError = true;
      _iteratorError = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion && _iterator.return != null) {
          _iterator.return();
        }
      } finally {
        if (_didIteratorError) {
          throw _iteratorError;
        }
      }
    }
  }
};

commands.pageLoadTimeoutW3C = function () {
  var _ref6 = (0, _asyncToGenerator2.default)(function* (ms) {
    throw new _protocol.errors.NotImplementedError('Not implemented yet for pageLoad.');
  });

  return function (_x9) {
    return _ref6.apply(this, arguments);
  };
}();

commands.pageLoadTimeoutMJSONWP = function () {
  var _ref7 = (0, _asyncToGenerator2.default)(function* (ms) {
    throw new _protocol.errors.NotImplementedError('Not implemented yet for pageLoad.');
  });

  return function (_x10) {
    return _ref7.apply(this, arguments);
  };
}();

commands.scriptTimeoutW3C = function () {
  var _ref8 = (0, _asyncToGenerator2.default)(function* (ms) {
    throw new _protocol.errors.NotImplementedError('Not implemented yet for script.');
  });

  return function (_x11) {
    return _ref8.apply(this, arguments);
  };
}();

commands.scriptTimeoutMJSONWP = function () {
  var _ref9 = (0, _asyncToGenerator2.default)(function* (ms) {
    throw new _protocol.errors.NotImplementedError('Not implemented yet for script.');
  });

  return function (_x12) {
    return _ref9.apply(this, arguments);
  };
}();

commands.newCommandTimeout = function () {
  var _ref10 = (0, _asyncToGenerator2.default)(function* (ms) {
    this.setNewCommandTimeout(this.parseTimeoutArgument(ms));
  });

  return function (_x13) {
    return _ref10.apply(this, arguments);
  };
}();

helpers.setNewCommandTimeout = function (ms) {
  this.newCommandTimeoutMs = ms;

  _logger.default.debug(`Set new command timeout to ${ms}ms`);

  if (this.managedDrivers && this.managedDrivers.length) {
    _logger.default.debug('Setting new command timeout on managed drivers');

    var _iteratorNormalCompletion2 = true;
    var _didIteratorError2 = false;
    var _iteratorError2 = undefined;

    try {
      for (var _iterator2 = this.managedDrivers[Symbol.iterator](), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
        let driver = _step2.value;

        if (_lodash.default.isFunction(driver.setNewCommandTimeout)) {
          driver.setNewCommandTimeout(ms);
        }
      }
    } catch (err) {
      _didIteratorError2 = true;
      _iteratorError2 = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion2 && _iterator2.return != null) {
          _iterator2.return();
        }
      } finally {
        if (_didIteratorError2) {
          throw _iteratorError2;
        }
      }
    }
  }
};

helpers.clearNewCommandTimeout = function () {
  if (this.noCommandTimer) {
    this.noCommandTimer.cancel();
    this.noCommandTimer = null;
  }
};

helpers.startNewCommandTimeout = function () {
  var _this = this;

  this.clearNewCommandTimeout();
  if (!this.newCommandTimeoutMs) return;
  this.noCommandTimer = _appiumSupport.util.cancellableDelay(this.newCommandTimeoutMs);
  this.noCommandTimer.then((0, _asyncToGenerator2.default)(function* () {
    _logger.default.warn(`Shutting down because we waited ` + `${_this.newCommandTimeoutMs / 1000} seconds for a command`);

    let errorMessage = `New Command Timeout of ` + `${_this.newCommandTimeoutMs / 1000} seconds ` + `expired. Try customizing the timeout using the ` + `'newCommandTimeout' desired capability`;
    yield _this.startUnexpectedShutdown(new Error(errorMessage));
  })).catch(_bluebird.default.CancellationError, () => {});
};

helpers.implicitWaitForCondition = function () {
  var _ref12 = (0, _asyncToGenerator2.default)(function* (condFn) {
    var _this2 = this;

    _logger.default.debug(`Waiting up to ${this.implicitWaitMs} ms for condition`);

    let wrappedCondFn = function () {
      var _ref13 = (0, _asyncToGenerator2.default)(function* (...args) {
        _this2.clearNewCommandTimeout();

        return yield condFn(...args);
      });

      return function wrappedCondFn() {
        return _ref13.apply(this, arguments);
      };
    }();

    return yield (0, _asyncbox.waitForCondition)(wrappedCondFn, {
      waitMs: this.implicitWaitMs,
      intervalMs: 500,
      logger: _logger.default
    });
  });

  return function (_x14) {
    return _ref12.apply(this, arguments);
  };
}();

helpers.parseTimeoutArgument = function (ms) {
  let duration = parseInt(ms, 10);

  if (_lodash.default.isNaN(duration) || duration < MIN_TIMEOUT) {
    throw new _protocol.errors.UnknownError(`Invalid timeout value '${ms}'`);
  }

  return duration;
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL2NvbW1hbmRzL3RpbWVvdXQuanMiXSwibmFtZXMiOlsiY29tbWFuZHMiLCJoZWxwZXJzIiwiZXh0ZW5zaW9ucyIsIk1JTl9USU1FT1VUIiwidGltZW91dHMiLCJ0eXBlIiwibXMiLCJzY3JpcHQiLCJwYWdlTG9hZCIsImltcGxpY2l0IiwidXRpbCIsImhhc1ZhbHVlIiwibG9nIiwiZGVidWciLCJKU09OIiwic3RyaW5naWZ5IiwibmV3Q29tbWFuZFRpbWVvdXQiLCJpbXBsaWNpdFdhaXRNSlNPTldQIiwicGFnZUxvYWRUaW1lb3V0TUpTT05XUCIsInNjcmlwdFRpbWVvdXRNSlNPTldQIiwiRXJyb3IiLCJzY3JpcHRUaW1lb3V0VzNDIiwicGFnZUxvYWRUaW1lb3V0VzNDIiwiaW1wbGljaXRXYWl0VzNDIiwiZ2V0VGltZW91dHMiLCJjb21tYW5kIiwibmV3Q29tbWFuZFRpbWVvdXRNcyIsImltcGxpY2l0V2FpdE1zIiwiaW1wbGljaXRXYWl0Iiwic2V0SW1wbGljaXRXYWl0IiwicGFyc2VUaW1lb3V0QXJndW1lbnQiLCJtYW5hZ2VkRHJpdmVycyIsImxlbmd0aCIsImRyaXZlciIsIl8iLCJpc0Z1bmN0aW9uIiwiZXJyb3JzIiwiTm90SW1wbGVtZW50ZWRFcnJvciIsInNldE5ld0NvbW1hbmRUaW1lb3V0IiwiY2xlYXJOZXdDb21tYW5kVGltZW91dCIsIm5vQ29tbWFuZFRpbWVyIiwiY2FuY2VsIiwic3RhcnROZXdDb21tYW5kVGltZW91dCIsImNhbmNlbGxhYmxlRGVsYXkiLCJ0aGVuIiwid2FybiIsImVycm9yTWVzc2FnZSIsInN0YXJ0VW5leHBlY3RlZFNodXRkb3duIiwiY2F0Y2giLCJCIiwiQ2FuY2VsbGF0aW9uRXJyb3IiLCJpbXBsaWNpdFdhaXRGb3JDb25kaXRpb24iLCJjb25kRm4iLCJ3cmFwcGVkQ29uZEZuIiwiYXJncyIsIndhaXRNcyIsImludGVydmFsTXMiLCJsb2dnZXIiLCJkdXJhdGlvbiIsInBhcnNlSW50Iiwi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QUFDR0MsTUFBQUEsTUFBTSxFQUFFN0M7QUFEWCxLQUFoQyxDQUFiO0FBR0QsR0FYRDs7QUFBQTtBQUFBO0FBQUE7QUFBQTs7QUFhQVgsT0FBTyxDQUFDNkIsb0JBQVIsR0FBK0IsVUFBVXhCLEVBQVYsRUFBYztBQUMzQyxNQUFJb0QsUUFBUSxHQUFHQyxRQUFRLENBQUNyRCxFQUFELEVBQUssRUFBTCxDQUF2Qjs7QUFDQSxNQUFJNEIsZ0JBQUUwQixLQUFGLENBQVFGLFFBQVIsS0FBcUJBLFFBQVEsR0FBR3ZELFdBQXBDLEVBQWlEO0FBQy9DLFVBQU0sSUFBSWlDLGlCQUFPeUIsWUFBWCxDQUF5QiwwQkFBeUJ2RCxFQUFHLEdBQXJELENBQU47QUFDRDs7QUFDRCxTQUFPb0QsUUFBUDtBQUNELENBTkQ7O0FBUUFJLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjN0QsVUFBZCxFQUEwQkYsUUFBMUIsRUFBb0NDLE9BQXBDO2VBRWVDLFUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyB3YWl0Rm9yQ29uZGl0aW9uIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBlcnJvcnMgfSBmcm9tICcuLi8uLi9wcm90b2NvbCc7XG5cblxubGV0IGNvbW1hbmRzID0ge30sIGhlbHBlcnMgPSB7fSwgZXh0ZW5zaW9ucyA9IHt9O1xuXG5jb25zdCBNSU5fVElNRU9VVCA9IDA7XG5cbmNvbW1hbmRzLnRpbWVvdXRzID0gYXN5bmMgZnVuY3Rpb24gKHR5cGUsIG1zLCBzY3JpcHQsIHBhZ2VMb2FkLCBpbXBsaWNpdCkge1xuICBpZiAodXRpbC5oYXNWYWx1ZSh0eXBlKSAmJiB1dGlsLmhhc1ZhbHVlKG1zKSkge1xuICAgIGxvZy5kZWJ1ZyhgTUpTT05XUCB0aW1lb3V0IGFyZ3VtZW50czogJHtKU09OLnN0cmluZ2lmeSh7dHlwZSwgbXN9KX19YCk7XG5cbiAgICBzd2l0Y2ggKHR5cGUpIHtcbiAgICAgIGNhc2UgJ2NvbW1hbmQnOlxuICAgICAgICBhd2FpdCB0aGlzLm5ld0NvbW1hbmRUaW1lb3V0KG1zKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgY2FzZSAnaW1wbGljaXQnOlxuICAgICAgICBhd2FpdCB0aGlzLmltcGxpY2l0V2FpdE1KU09OV1AobXMpO1xuICAgICAgICByZXR1cm47XG4gICAgICBjYXNlICdwYWdlIGxvYWQnOlxuICAgICAgICBhd2FpdCB0aGlzLnBhZ2VMb2FkVGltZW91dE1KU09OV1AobXMpO1xuICAgICAgICByZXR1cm47XG4gICAgICBjYXNlICdzY3JpcHQnOlxuICAgICAgICBhd2FpdCB0aGlzLnNjcmlwdFRpbWVvdXRNSlNPTldQKG1zKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAnJHt0eXBlfScgdHlwZSBpcyBub3Qgc3VwcG9ydGVkIGZvciBNSlNPTldQIHRpbWVvdXRgKTtcbiAgICB9XG4gIH1cblxuICAvLyBPdGhlcndpc2UgYXNzdW1lIGl0IGlzIFczQyBwcm90b2NvbFxuICBsb2cuZGVidWcoYFczQyB0aW1lb3V0IGFyZ3VtZW50OiAke0pTT04uc3RyaW5naWZ5KHtzY3JpcHQsIHBhZ2VMb2FkLCBpbXBsaWNpdH0pfX1gKTtcbiAgaWYgKHV0aWwuaGFzVmFsdWUoc2NyaXB0KSkge1xuICAgIGF3YWl0IHRoaXMuc2NyaXB0VGltZW91dFczQyhzY3JpcHQpO1xuICB9XG4gIGlmICh1dGlsLmhhc1ZhbHVlKHBhZ2VMb2FkKSkge1xuICAgIGF3YWl0IHRoaXMucGFnZUxvYWRUaW1lb3V0VzNDKHBhZ2VMb2FkKTtcbiAgfVxuICBpZiAodXRpbC5oYXNWYWx1ZShpbXBsaWNpdCkpIHtcbiAgICBhd2FpdCB0aGlzLmltcGxpY2l0V2FpdFczQyhpbXBsaWNpdCk7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmdldFRpbWVvdXRzID0gYXN5bmMgZnVuY3Rpb24gKCkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHJlcXVpcmUtYXdhaXRcbiAgcmV0dXJuIHtcbiAgICBjb21tYW5kOiB0aGlzLm5ld0NvbW1hbmRUaW1lb3V0TXMsXG4gICAgaW1wbGljaXQ6IHRoaXMuaW1wbGljaXRXYWl0TXMsXG4gIH07XG59O1xuXG4vLyBpbXBsaWNpdFxuY29tbWFuZHMuaW1wbGljaXRXYWl0VzNDID0gYXN5bmMgZnVuY3Rpb24gKG1zKSB7XG4gIGF3YWl0IHRoaXMuaW1wbGljaXRXYWl0KG1zKTtcbn07XG5cbmNvbW1hbmRzLmltcGxpY2l0V2FpdE1KU09OV1AgPSBhc3luYyBmdW5jdGlvbiAobXMpIHtcbiAgYXdhaXQgdGhpcy5pbXBsaWNpdFdhaXQobXMpO1xufTtcblxuY29tbWFuZHMuaW1wbGljaXRXYWl0ID0gYXN5bmMgZnVuY3Rpb24gKG1zKSB7XG4gIGF3YWl0IHRoaXMuc2V0SW1wbGljaXRXYWl0KHRoaXMucGFyc2VUaW1lb3V0QXJndW1lbnQobXMpKTtcbn07XG5cbmhlbHBlcnMuc2V0SW1wbGljaXRXYWl0ID0gZnVuY3Rpb24gKG1zKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcmVxdWlyZS1hd2FpdFxuICB0aGlzLmltcGxpY2l0V2FpdE1zID0gbXM7XG4gIGxvZy5kZWJ1ZyhgU2V0IGltcGxpY2l0IHdhaXQgdG8gJHttc31tc2ApO1xuICBpZiAodGhpcy5tYW5hZ2VkRHJpdmVycyAmJiB0aGlzLm1hbmFnZWREcml2ZXJzLmxlbmd0aCkge1xuICAgIGxvZy5kZWJ1ZygnU2V0dGluZyBpbXBsaWNpdCB3YWl0IG9uIG1hbmFnZWQgZHJpdmVycycpO1xuICAgIGZvciAobGV0IGRyaXZlciBvZiB0aGlzLm1hbmFnZWREcml2ZXJzKSB7XG4gICAgICBpZiAoXy5pc0Z1bmN0aW9uKGRyaXZlci5zZXRJbXBsaWNpdFdhaXQpKSB7XG4gICAgICAgIGRyaXZlci5zZXRJbXBsaWNpdFdhaXQobXMpO1xuICAgICAgfVxuICAgIH1cbiAgfVxufTtcblxuLy8gcGFnZUxvYWRcbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby11bnVzZWQtdmFyc1xuY29tbWFuZHMucGFnZUxvYWRUaW1lb3V0VzNDID0gYXN5bmMgZnVuY3Rpb24gKG1zKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcmVxdWlyZS1hd2FpdFxuICB0aHJvdyBuZXcgZXJyb3JzLk5vdEltcGxlbWVudGVkRXJyb3IoJ05vdCBpbXBsZW1lbnRlZCB5ZXQgZm9yIHBhZ2VMb2FkLicpO1xufTtcblxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVudXNlZC12YXJzXG5jb21tYW5kcy5wYWdlTG9hZFRpbWVvdXRNSlNPTldQID0gYXN5bmMgZnVuY3Rpb24gKG1zKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcmVxdWlyZS1hd2FpdFxuICB0aHJvdyBuZXcgZXJyb3JzLk5vdEltcGxlbWVudGVkRXJyb3IoJ05vdCBpbXBsZW1lbnRlZCB5ZXQgZm9yIHBhZ2VMb2FkLicpO1xufTtcblxuLy8gc2NyaXB0XG4vLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tdW51c2VkLXZhcnNcbmNvbW1hbmRzLnNjcmlwdFRpbWVvdXRXM0MgPSBhc3luYyBmdW5jdGlvbiAobXMpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZXF1aXJlLWF3YWl0XG4gIHRocm93IG5ldyBlcnJvcnMuTm90SW1wbGVtZW50ZWRFcnJvcignTm90IGltcGxlbWVudGVkIHlldCBmb3Igc2NyaXB0LicpO1xufTtcblxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVudXNlZC12YXJzXG5jb21tYW5kcy5zY3JpcHRUaW1lb3V0TUpTT05XUCA9IGFzeW5jIGZ1bmN0aW9uIChtcykgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHJlcXVpcmUtYXdhaXRcbiAgdGhyb3cgbmV3IGVycm9ycy5Ob3RJbXBsZW1lbnRlZEVycm9yKCdOb3QgaW1wbGVtZW50ZWQgeWV0IGZvciBzY3JpcHQuJyk7XG59O1xuXG4vLyBjb21tYW5kXG5jb21tYW5kcy5uZXdDb21tYW5kVGltZW91dCA9IGFzeW5jIGZ1bmN0aW9uIChtcykgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHJlcXVpcmUtYXdhaXRcbiAgdGhpcy5zZXROZXdDb21tYW5kVGltZW91dCh0aGlzLnBhcnNlVGltZW91dEFyZ3VtZW50KG1zKSk7XG59O1xuXG5oZWxwZXJzLnNldE5ld0NvbW1hbmRUaW1lb3V0ID0gZnVuY3Rpb24gKG1zKSB7XG4gIHRoaXMubmV3Q29tbWFuZFRpbWVvdXRNcyA9IG1zO1xuICBsb2cuZGVidWcoYFNldCBuZXcgY29tbWFuZCB0aW1lb3V0IHRvICR7bXN9bXNgKTtcbiAgaWYgKHRoaXMubWFuYWdlZERyaXZlcnMgJiYgdGhpcy5tYW5hZ2VkRHJpdmVycy5sZW5ndGgpIHtcbiAgICBsb2cuZGVidWcoJ1NldHRpbmcgbmV3IGNvbW1hbmQgdGltZW91dCBvbiBtYW5hZ2VkIGRyaXZlcnMnKTtcbiAgICBmb3IgKGxldCBkcml2ZXIgb2YgdGhpcy5tYW5hZ2VkRHJpdmVycykge1xuICAgICAgaWYgKF8uaXNGdW5jdGlvbihkcml2ZXIuc2V0TmV3Q29tbWFuZFRpbWVvdXQpKSB7XG4gICAgICAgIGRyaXZlci5zZXROZXdDb21tYW5kVGltZW91dChtcyk7XG4gICAgICB9XG4gICAgfVxuICB9XG59O1xuXG5oZWxwZXJzLmNsZWFyTmV3Q29tbWFuZFRpbWVvdXQgPSBmdW5jdGlvbiAoKSB7XG4gIGlmICh0aGlzLm5vQ29tbWFuZFRpbWVyKSB7XG4gICAgdGhpcy5ub0NvbW1hbmRUaW1lci5jYW5jZWwoKTtcbiAgICB0aGlzLm5vQ29tbWFuZFRpbWVyID0gbnVsbDtcbiAgfVxufTtcblxuaGVscGVycy5zdGFydE5ld0NvbW1hbmRUaW1lb3V0ID0gZnVuY3Rpb24gKCkge1xuICAvLyBtYWtlIHN1cmUgdGhlcmUgYXJlIG5vIHJvZ3VlIHRpbWVvdXRzXG4gIHRoaXMuY2xlYXJOZXdDb21tYW5kVGltZW91dCgpO1xuXG4gIC8vIGlmIGNvbW1hbmQgdGltZW91dCBpcyAwLCBpdCBpcyBkaXNhYmxlZFxuICBpZiAoIXRoaXMubmV3Q29tbWFuZFRpbWVvdXRNcykgcmV0dXJuOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGN1cmx5XG5cbiAgdGhpcy5ub0NvbW1hbmRUaW1lciA9IHV0aWwuY2FuY2VsbGFibGVEZWxheSh0aGlzLm5ld0NvbW1hbmRUaW1lb3V0TXMpO1xuICB0aGlzLm5vQ29tbWFuZFRpbWVyXG4gICAgLnRoZW4oYXN5bmMgKCkgPT4geyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHByb21pc2UvcHJlZmVyLWF3YWl0LXRvLXRoZW5cbiAgICAgIGxvZy53YXJuKGBTaHV0dGluZyBkb3duIGJlY2F1c2Ugd2Ugd2FpdGVkIGAgK1xuICAgICAgICAgICAgICAgYCR7dGhpcy5uZXdDb21tYW5kVGltZW91dE1zIC8gMTAwMH0gc2Vjb25kcyBmb3IgYSBjb21tYW5kYCk7XG4gICAgICBsZXQgZXJyb3JNZXNzYWdlID0gYE5ldyBDb21tYW5kIFRpbWVvdXQgb2YgYCArXG4gICAgICAgICAgICAgICBgJHt0aGlzLm5ld0NvbW1hbmRUaW1lb3V0TXMgLyAxMDAwfSBzZWNvbmRzIGAgK1xuICAgICAgICAgICAgICAgYGV4cGlyZWQuIFRyeSBjdXN0b21pemluZyB0aGUgdGltZW91dCB1c2luZyB0aGUgYCArXG4gICAgICAgICAgICAgICBgJ25ld0NvbW1hbmRUaW1lb3V0JyBkZXNpcmVkIGNhcGFiaWxpdHlgO1xuICAgICAgYXdhaXQgdGhpcy5zdGFydFVuZXhwZWN0ZWRTaHV0ZG93bihuZXcgRXJyb3IoZXJyb3JNZXNzYWdlKSk7XG4gICAgfSlcbiAgICAuY2F0Y2goQi5DYW5jZWxsYXRpb25FcnJvciwgKC8qZXJyKi8pID0+IHtcbiAgICAgIC8vIGlnbm9yZVxuICAgIH0pO1xufTtcblxuaGVscGVycy5pbXBsaWNpdFdhaXRGb3JDb25kaXRpb24gPSBhc3luYyBmdW5jdGlvbiAoY29uZEZuKSB7XG4gIGxvZy5kZWJ1ZyhgV2FpdGluZyB1cCB0byAke3RoaXMuaW1wbGljaXRXYWl0TXN9IG1zIGZvciBjb25kaXRpb25gKTtcbiAgbGV0IHdyYXBwZWRDb25kRm4gPSBhc3luYyAoLi4uYXJncykgPT4ge1xuICAgIC8vIHJlc2V0IGNvbW1hbmQgdGltZW91dFxuICAgIHRoaXMuY2xlYXJOZXdDb21tYW5kVGltZW91dCgpO1xuXG4gICAgcmV0dXJuIGF3YWl0IGNvbmRGbiguLi5hcmdzKTtcbiAgfTtcbiAgcmV0dXJuIGF3YWl0IHdhaXRGb3JDb25kaXRpb24od3JhcHBlZENvbmRGbiwge1xuICAgIHdhaXRNczogdGhpcy5pbXBsaWNpdFdhaXRNcywgaW50ZXJ2YWxNczogNTAwLCBsb2dnZXI6IGxvZ1xuICB9KTtcbn07XG5cbmhlbHBlcnMucGFyc2VUaW1lb3V0QXJndW1lbnQgPSBmdW5jdGlvbiAobXMpIHtcbiAgbGV0IGR1cmF0aW9uID0gcGFyc2VJbnQobXMsIDEwKTtcbiAgaWYgKF8uaXNOYU4oZHVyYXRpb24pIHx8IGR1cmF0aW9uIDwgTUlOX1RJTUVPVVQpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLlVua25vd25FcnJvcihgSW52YWxpZCB0aW1lb3V0IHZhbHVlICcke21zfSdgKTtcbiAgfVxuICByZXR1cm4gZHVyYXRpb247XG59O1xuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzLCBoZWxwZXJzKTtcbmV4cG9ydCB7IGNvbW1hbmRzLCBoZWxwZXJzIH07XG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sImZpbGUiOiJsaWIvYmFzZWRyaXZlci9jb21tYW5kcy90aW1lb3V0LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uLy4uIn0=
