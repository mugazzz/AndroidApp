"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("../logger"));

var _protocol = require("../../protocol");

var _uuidJs = _interopRequireDefault(require("uuid-js"));

var _capabilities = require("../capabilities");

let commands = {};

commands.createSession = function () {
  var _ref = (0, _asyncToGenerator2.default)(function* (jsonwpDesiredCapabilities, jsonwpRequiredCaps, w3cCapabilities) {
    if (this.sessionId !== null) {
      throw new _protocol.errors.SessionNotCreatedError('Cannot create a new session ' + 'while one is in progress');
    }

    _logger.default.debug();

    let caps;

    if (w3cCapabilities) {
      this.setProtocolW3C();

      if (jsonwpDesiredCapabilities) {
        _logger.default.debug(`W3C capabilities ${_lodash.default.truncate(JSON.stringify(w3cCapabilities))} and MJSONWP desired capabilities ${_lodash.default.truncate(JSON.stringify(jsonwpDesiredCapabilities))} were provided`);
      }

      if (jsonwpDesiredCapabilities && !_lodash.default.isPlainObject(w3cCapabilities)) {
        if (!_lodash.default.isEmpty(w3cCapabilities)) {
          _logger.default.warn(`Expected W3C "capabilities" to be a JSON Object but was provided with: ${JSON.stringify(w3cCapabilities)}`);
        }

        _logger.default.warn(`Falling back to MJSONWP desired capabilities`);

        this.setProtocolMJSONWP();
        caps = jsonwpDesiredCapabilities;
      } else {
        _logger.default.debug(`Creating session with W3C capabilities: ${_lodash.default.truncate(JSON.stringify(w3cCapabilities))}`);

        caps = (0, _capabilities.processCapabilities)(w3cCapabilities, this.desiredCapConstraints, this.shouldValidateCaps);
      }
    } else {
      this.setProtocolMJSONWP();

      _logger.default.debug(`Creating session with MJSONWP desired capabilities: ${_lodash.default.truncate(JSON.stringify(jsonwpDesiredCapabilities))}`);

      caps = jsonwpDesiredCapabilities || {};
    }

    caps = fixCaps(caps, this.desiredCapConstraints);
    this.validateDesiredCaps(caps);
    this.sessionId = _uuidJs.default.create().hex;
    this.caps = caps;
    this.opts = _lodash.default.cloneDeep(this.initialOpts);
    Object.assign(this.opts, this.caps);

    if (this.opts.noReset && this.opts.fullReset) {
      throw new Error("The 'noReset' and 'fullReset' capabilities are mutually " + "exclusive and should not both be set to true. You " + "probably meant to just use 'fullReset' on its own");
    }

    if (this.opts.noReset === true) {
      this.opts.fullReset = false;
    }

    if (this.opts.fullReset === true) {
      this.opts.noReset = false;
    }

    this.opts.fastReset = !this.opts.fullReset && !this.opts.noReset;
    this.opts.skipUninstall = this.opts.fastReset || this.opts.noReset;

    if (typeof this.opts.app === 'string' && this.opts.app.trim() === '') {
      this.opts.app = null;
    }

    if (!_lodash.default.isUndefined(this.caps.newCommandTimeout)) {
      this.newCommandTimeoutMs = this.caps.newCommandTimeout * 1000;
    }

    this.resetOnUnexpectedShutdown();

    _logger.default.info(`Session created with session id: ${this.sessionId}`);

    return [this.sessionId, caps];
  });

  return function (_x, _x2, _x3) {
    return _ref.apply(this, arguments);
  };
}();

commands.getSessions = (0, _asyncToGenerator2.default)(function* () {
  let ret = [];

  if (this.sessionId) {
    ret.push({
      id: this.sessionId,
      capabilities: this.caps
    });
  }

  return ret;
});
commands.getSession = (0, _asyncToGenerator2.default)(function* () {
  if (this.caps.eventTimings) {
    return Object.assign({}, this.caps, {
      events: this.eventHistory
    });
  }

  return this.caps;
});
commands.deleteSession = (0, _asyncToGenerator2.default)(function* () {
  this.clearNewCommandTimeout();
  this.sessionId = null;
});

function fixCaps(originalCaps, desiredCapConstraints = {}) {
  let caps = _lodash.default.clone(originalCaps);

  let booleanCaps = _lodash.default.keys(_lodash.default.pickBy(desiredCapConstraints, k => k.isBoolean === true));

  var _iteratorNormalCompletion = true;
  var _didIteratorError = false;
  var _iteratorError = undefined;

  try {
    for (var _iterator = booleanCaps[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
      let cap = _step.value;
      let value = originalCaps[cap];

      if (_lodash.default.isString(value)) {
        value = value.toLowerCase();

        if (value === 'true' || value === 'false') {
          _logger.default.warn(`Capability '${cap}' changed from string to boolean. This may cause unexpected behavior`);

          caps[cap] = value === 'true';
        }
      }
    }
  } catch (err) {
    _didIteratorError = true;
    _iteratorError = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion && _iterator.return != null) {
        _iterator.return();
      }
    } finally {
      if (_didIteratorError) {
        throw _iteratorError;
      }
    }
  }

  let intCaps = _lodash.default.keys(_lodash.default.pickBy(desiredCapConstraints, k => k.isNumber === true));

  var _iteratorNormalCompletion2 = true;
  var _didIteratorError2 = false;
  var _iteratorError2 = undefined;

  try {
    for (var _iterator2 = intCaps[Symbol.iterator](), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
      let cap = _step2.value;
      let value = originalCaps[cap];

      if (_lodash.default.isString(value) && !isNaN(value)) {
        value = value.trim();
        let newValue = parseInt(value, 10);

        if (value !== `${newValue}`) {
          newValue = parseFloat(value);
        }

        _logger.default.warn(`Capability '${cap}' changed from string ('${value}') to integer (${newValue}). This may cause unexpected behavior`);

        caps[cap] = newValue;
      }
    }
  } catch (err) {
    _didIteratorError2 = true;
    _iteratorError2 = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion2 && _iterator2.return != null) {
        _iterator2.return();
      }
    } finally {
      if (_didIteratorError2) {
        throw _iteratorError2;
      }
    }
  }

  return caps;
}

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL2NvbW1hbmRzL3Nlc3Npb24uanMiXSwibmFtZXMiOlsiY29tbWFuZHMiLCJjcmVhdGVTZXNzaW9uIiwianNvbndwRGVzaXJlZENhcGFiaWxpdGllcyIsImpzb253cFJlcXVpcmVkQ2FwcyIsInczY0NhcGFiaWxpdGllcyIsInNlc3Npb25JZCIsImVycm9ycyIsIlNlc3Npb25Ob3RDcmVhdGVkRXJyb3IiLCJsb2ciLCJkZWJ1ZyIsImNhcHMiLCJzZXRQcm90b2NvbFczQyIsIl8iLCJ0cnVuY2F0ZSIsIkpTT04iLCJzdHJpbmdpZnkiLCJpc1BsYWluT2JqZWN0IiwiaXNFbXB0eSIsIndhcm4iLCJzZXRQcm90b2NvbE1KU09OV1AiLCJkZXNpcmVkQ2FwQ29uc3RyYWludHMiLCJzaG91bGRWYWxpZGF0ZUNhcHMiLCJmaXhDYXBzIiwidmFsaWRhdGVEZXNpcmVkQ2FwcyIsIlVVSUQiLCJjcmVhdGUiLCJoZXgiLCJvcHRzIiwiY2xvbmVEZWVwIiwiaW5pdGlhbE9wdHMiLCJPYmplY3QiLCJhc3NpZ24iLCJub1Jlc2V0IiwiZnVsbFJlc2V0IiwiRXJyb3IiLCJmYXN0UmVzZXQiLCJza2lwVW5pbnN0YWxsIiwiYXBwIiwidHJpbSIsImlzVW5kZWZpbmVkIiwibmV3Q29tbWFuZFRpbWVvdXQiLCJuZXdDb21tYW5kVGltZW91dE1zIiwicmVzZXRPblVuZXhwZWN0ZWRTaHV0ZG93biIsImluZm8iLCJnZXRTZXNzaW9ucyIsInJldCIsInB1c2giLCJpZCIsImNhcGFiaWxpdGllcyIsImdldFNlc3Npb24iLCJldmVudFRpbWluZ3MiLCJldmVudHMiLCJldmVudEhpc3RvcnkiLCJkZWxldGVTZXNzaW9uIiwiY2xlYXJOZXdDb21tYW5kVGltZW91dCIsIm9yaWdpbmFsQ2FwcyIsImNsb25lIiwiYm9vbGVhbkNhcHMiLCJrZXlzIiwicGlja0J5IiwiayIsImlzQm9vbGVhbiIsImNhcCIsInZhbHVlIiwiaXNTdHJpbmciLCJ0b0xvd2VyQ2FzZSIsImlu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bXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBlcnJvcnMgfSBmcm9tICcuLi8uLi9wcm90b2NvbCc7XG5pbXBvcnQgVVVJRCBmcm9tICd1dWlkLWpzJztcbmltcG9ydCB7IHByb2Nlc3NDYXBhYmlsaXRpZXMgfSBmcm9tICcuLi9jYXBhYmlsaXRpZXMnO1xuXG5sZXQgY29tbWFuZHMgPSB7fTtcblxuY29tbWFuZHMuY3JlYXRlU2Vzc2lvbiA9IGFzeW5jIGZ1bmN0aW9uIChqc29ud3BEZXNpcmVkQ2FwYWJpbGl0aWVzLCBqc29ud3BSZXF1aXJlZENhcHMsIHczY0NhcGFiaWxpdGllcykgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHJlcXVpcmUtYXdhaXRcbiAgaWYgKHRoaXMuc2Vzc2lvbklkICE9PSBudWxsKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5TZXNzaW9uTm90Q3JlYXRlZEVycm9yKCdDYW5ub3QgY3JlYXRlIGEgbmV3IHNlc3Npb24gJyArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd3aGlsZSBvbmUgaXMgaW4gcHJvZ3Jlc3MnKTtcbiAgfVxuXG4gIGxvZy5kZWJ1ZygpO1xuXG4gIC8vIERldGVybWluZSB3ZWF0aGVyIHdlIHNob3VsZCB1c2UganNvbndwRGVzaXJlZENhcGFiaWxpdGllcyBvciB3M2NDYXBhYmlsaXRpZXMgdG8gZ2V0IGNhcHMgZnJvbVxuICBsZXQgY2FwcztcbiAgaWYgKHczY0NhcGFiaWxpdGllcykge1xuICAgIHRoaXMuc2V0UHJvdG9jb2xXM0MoKTtcbiAgICBpZiAoanNvbndwRGVzaXJlZENhcGFiaWxpdGllcykge1xuICAgICAgbG9nLmRlYnVnKGBXM0MgY2FwYWJpbGl0aWVzICR7Xy50cnVuY2F0ZShKU09OLnN0cmluZ2lmeSh3M2NDYXBhYmlsaXRpZXMpKX0gYW5kIE1KU09OV1AgZGVzaXJlZCBjYXBhYmlsaXRpZXMgJHtfLnRydW5jYXRlKEpTT04uc3RyaW5naWZ5KGpzb253cERlc2lyZWRDYXBhYmlsaXRpZXMpKX0gd2VyZSBwcm92aWRlZGApO1xuICAgIH1cblxuICAgIGlmIChqc29ud3BEZXNpcmVkQ2FwYWJpbGl0aWVzICYmICFfLmlzUGxhaW5PYmplY3QodzNjQ2FwYWJpbGl0aWVzKSkge1xuICAgICAgLy8gSWYgVzNDIENhcGFiaWxpdGllcyBhbmQgTUpTT05XUCBDYXBhYmlsaXRpZXMgd2VyZSBwcm92aWRlZCBhbmQgVzNDIGNhcHMgYXJlbid0IGEgcGxhaW4gb2JqZWN0LFxuICAgICAgLy8gbG9nIGEgd2FybmluZyBhbmQgZmFsbCBiYWNrIHRvIE1KU09OV1BcbiAgICAgIGlmICghXy5pc0VtcHR5KHczY0NhcGFiaWxpdGllcykpIHtcbiAgICAgICAgbG9nLndhcm4oYEV4cGVjdGVkIFczQyBcImNhcGFiaWxpdGllc1wiIHRvIGJlIGEgSlNPTiBPYmplY3QgYnV0IHdhcyBwcm92aWRlZCB3aXRoOiAke0pTT04uc3RyaW5naWZ5KHczY0NhcGFiaWxpdGllcyl9YCk7XG4gICAgICB9XG4gICAgICBsb2cud2FybihgRmFsbGluZyBiYWNrIHRvIE1KU09OV1AgZGVzaXJlZCBjYXBhYmlsaXRpZXNgKTtcbiAgICAgIHRoaXMuc2V0UHJvdG9jb2xNSlNPTldQKCk7XG4gICAgICBjYXBzID0ganNvbndwRGVzaXJlZENhcGFiaWxpdGllcztcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nLmRlYnVnKGBDcmVhdGluZyBzZXNzaW9uIHdpdGggVzNDIGNhcGFiaWxpdGllczogJHtfLnRydW5jYXRlKEpTT04uc3RyaW5naWZ5KHczY0NhcGFiaWxpdGllcykpfWApO1xuICAgICAgY2FwcyA9IHByb2Nlc3NDYXBhYmlsaXRpZXModzNjQ2FwYWJpbGl0aWVzLCB0aGlzLmRlc2lyZWRDYXBDb25zdHJhaW50cywgdGhpcy5zaG91bGRWYWxpZGF0ZUNhcHMpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICB0aGlzLnNldFByb3RvY29sTUpTT05XUCgpO1xuICAgIGxvZy5kZWJ1ZyhgQ3JlYXRpbmcgc2Vzc2lvbiB3aXRoIE1KU09OV1AgZGVzaXJlZCBjYXBhYmlsaXRpZXM6ICR7Xy50cnVuY2F0ZShKU09OLnN0cmluZ2lmeShqc29ud3BEZXNpcmVkQ2FwYWJpbGl0aWVzKSl9YCk7XG4gICAgY2FwcyA9IGpzb253cERlc2lyZWRDYXBhYmlsaXRpZXMgfHwge307XG4gIH1cblxuICBjYXBzID0gZml4Q2FwcyhjYXBzLCB0aGlzLmRlc2lyZWRDYXBDb25zdHJhaW50cyk7XG4gIHRoaXMudmFsaWRhdGVEZXNpcmVkQ2FwcyhjYXBzKTtcblxuICB0aGlzLnNlc3Npb25JZCA9IFVVSUQuY3JlYXRlKCkuaGV4O1xuICB0aGlzLmNhcHMgPSBjYXBzO1xuICB0aGlzLm9wdHMgPSBfLmNsb25lRGVlcCh0aGlzLmluaXRpYWxPcHRzKTtcblxuICAvLyBtZXJnZSBjYXBzIG9udG8gb3B0cyBzbyB3ZSBkb24ndCBuZWVkIHRvIHdvcnJ5IGFib3V0IHdoYXQncyB3aGVyZVxuICBPYmplY3QuYXNzaWduKHRoaXMub3B0cywgdGhpcy5jYXBzKTtcblxuICAvLyBkZWFsIHdpdGggcmVzZXRzXG4gIC8vIHNvbWUgcGVvcGxlIGxpa2UgdG8gZG8gd2VpcmQgdGhpbmdzIGJ5IHNldHRpbmcgbm9SZXNldCBhbmQgZnVsbFJlc2V0XG4gIC8vIGJvdGggdG8gdHJ1ZSwgYnV0IHRoaXMgaXMgbWlzZ3VpZGVkIGFuZCBzdHJhbmdlLCBzbyBlcnJvciBoZXJlIGluc3RlYWRcbiAgaWYgKHRoaXMub3B0cy5ub1Jlc2V0ICYmIHRoaXMub3B0cy5mdWxsUmVzZXQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJUaGUgJ25vUmVzZXQnIGFuZCAnZnVsbFJlc2V0JyBjYXBhYmlsaXRpZXMgYXJlIG11dHVhbGx5IFwiICtcbiAgICAgICAgICAgICAgICAgICAgXCJleGNsdXNpdmUgYW5kIHNob3VsZCBub3QgYm90aCBiZSBzZXQgdG8gdHJ1ZS4gWW91IFwiICtcbiAgICAgICAgICAgICAgICAgICAgXCJwcm9iYWJseSBtZWFudCB0byBqdXN0IHVzZSAnZnVsbFJlc2V0JyBvbiBpdHMgb3duXCIpO1xuICB9XG4gIGlmICh0aGlzLm9wdHMubm9SZXNldCA9PT0gdHJ1ZSkge1xuICAgIHRoaXMub3B0cy5mdWxsUmVzZXQgPSBmYWxzZTtcbiAgfVxuICBpZiAodGhpcy5vcHRzLmZ1bGxSZXNldCA9PT0gdHJ1ZSkge1xuICAgIHRoaXMub3B0cy5ub1Jlc2V0ID0gZmFsc2U7XG4gIH1cbiAgdGhpcy5vcHRzLmZhc3RSZXNldCA9ICF0aGlzLm9wdHMuZnVsbFJlc2V0ICYmICF0aGlzLm9wdHMubm9SZXNldDtcbiAgdGhpcy5vcHRzLnNraXBVbmluc3RhbGwgPSB0aGlzLm9wdHMuZmFzdFJlc2V0IHx8IHRoaXMub3B0cy5ub1Jlc2V0O1xuXG4gIC8vIFByZXZlbnRzIGVtcHR5IHN0cmluZyBjYXBzIHNvIHdlIGRvbid0IG5lZWQgdG8gdGVzdCBpdCBldmVyeXdoZXJlXG4gIGlmICh0eXBlb2YgdGhpcy5vcHRzLmFwcCA9PT0gJ3N0cmluZycgJiYgdGhpcy5vcHRzLmFwcC50cmltKCkgPT09ICcnKSB7XG4gICAgdGhpcy5vcHRzLmFwcCA9IG51bGw7XG4gIH1cblxuICBpZiAoIV8uaXNVbmRlZmluZWQodGhpcy5jYXBzLm5ld0NvbW1hbmRUaW1lb3V0KSkge1xuICAgIHRoaXMubmV3Q29tbWFuZFRpbWVvdXRNcyA9ICh0aGlzLmNhcHMubmV3Q29tbWFuZFRpbWVvdXQgKiAxMDAwKTtcbiAgfVxuXG4gIC8vIFdlIG5lZWQgdG8gaW5pbml0aWFsaXplIG9uZSBvblVuZXhwZWN0ZWRTaHV0ZG93IHByb21pc2UgcGVyIHNlc3Npb25cbiAgLy8gdG8gYXZvaWQgdGhlIHByb21pc2UgZnVsZmlsbWVudCBiZWluZyBwcm9wYWdhdGVkIGJldHdlZW4gc2Vzc2lvbnMuXG4gIHRoaXMucmVzZXRPblVuZXhwZWN0ZWRTaHV0ZG93bigpO1xuXG4gIGxvZy5pbmZvKGBTZXNzaW9uIGNyZWF0ZWQgd2l0aCBzZXNzaW9uIGlkOiAke3RoaXMuc2Vzc2lvbklkfWApO1xuXG4gIHJldHVybiBbdGhpcy5zZXNzaW9uSWQsIGNhcHNdO1xufTtcblxuY29tbWFuZHMuZ2V0U2Vzc2lvbnMgPSBhc3luYyBmdW5jdGlvbiAoKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcmVxdWlyZS1hd2FpdFxuICBsZXQgcmV0ID0gW107XG5cbiAgaWYgKHRoaXMuc2Vzc2lvbklkKSB7XG4gICAgcmV0LnB1c2goe1xuICAgICAgaWQ6IHRoaXMuc2Vzc2lvbklkLFxuICAgICAgY2FwYWJpbGl0aWVzOiB0aGlzLmNhcHNcbiAgICB9KTtcbiAgfVxuXG4gIHJldHVybiByZXQ7XG59O1xuXG5jb21tYW5kcy5nZXRTZXNzaW9uID0gYXN5bmMgZnVuY3Rpb24gKCkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHJlcXVpcmUtYXdhaXRcbiAgaWYgKHRoaXMuY2Fwcy5ldmVudFRpbWluZ3MpIHtcbiAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7fSwgdGhpcy5jYXBzLCB7ZXZlbnRzOiB0aGlzLmV2ZW50SGlzdG9yeX0pO1xuICB9XG4gIHJldHVybiB0aGlzLmNhcHM7XG59O1xuXG5jb21tYW5kcy5kZWxldGVTZXNzaW9uID0gYXN5bmMgZnVuY3Rpb24gKC8qIHNlc3Npb25JZCAqLykgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHJlcXVpcmUtYXdhaXRcbiAgdGhpcy5jbGVhck5ld0NvbW1hbmRUaW1lb3V0KCk7XG4gIHRoaXMuc2Vzc2lvbklkID0gbnVsbDtcbn07XG5cbmZ1bmN0aW9uIGZpeENhcHMgKG9yaWdpbmFsQ2FwcywgZGVzaXJlZENhcENvbnN0cmFpbnRzID0ge30pIHtcbiAgbGV0IGNhcHMgPSBfLmNsb25lKG9yaWdpbmFsQ2Fwcyk7XG5cbiAgLy8gYm9vbGVhbiBjYXBhYmlsaXRpZXMgY2FuIGJlIHBhc3NlZCBpbiBhcyBzdHJpbmdzICdmYWxzZScgYW5kICd0cnVlJ1xuICAvLyB3aGljaCB3ZSB3YW50IHRvIHRyYW5zbGF0ZSBpbnRvIGJvb2xlYW4gdmFsdWVzXG4gIGxldCBib29sZWFuQ2FwcyA9IF8ua2V5cyhfLnBpY2tCeShkZXNpcmVkQ2FwQ29uc3RyYWludHMsIChrKSA9PiBrLmlzQm9vbGVhbiA9PT0gdHJ1ZSkpO1xuICBmb3IgKGxldCBjYXAgb2YgYm9vbGVhbkNhcHMpIHtcbiAgICBsZXQgdmFsdWUgPSBvcmlnaW5hbENhcHNbY2FwXTtcbiAgICBpZiAoXy5pc1N0cmluZyh2YWx1ZSkpIHtcbiAgICAgIHZhbHVlID0gdmFsdWUudG9Mb3dlckNhc2UoKTtcbiAgICAgIGlmICh2YWx1ZSA9PT0gJ3RydWUnIHx8IHZhbHVlID09PSAnZmFsc2UnKSB7XG4gICAgICAgIGxvZy53YXJuKGBDYXBhYmlsaXR5ICcke2NhcH0nIGNoYW5nZWQgZnJvbSBzdHJpbmcgdG8gYm9vbGVhbi4gVGhpcyBtYXkgY2F1c2UgdW5leHBlY3RlZCBiZWhhdmlvcmApO1xuICAgICAgICBjYXBzW2NhcF0gPSAodmFsdWUgPT09ICd0cnVlJyk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLy8gaW50IGNhcGFiaWxpdGllcyBhcmUgb2Z0ZW4gc2VudCBpbiBhcyBzdHJpbmdzIGJ5IGZyYW1ld29ya3NcbiAgbGV0IGludENhcHMgPSBfLmtleXMoXy5waWNrQnkoZGVzaXJlZENhcENvbnN0cmFpbnRzLCAoaykgPT4gay5pc051bWJlciA9PT0gdHJ1ZSkpO1xuICBmb3IgKGxldCBjYXAgb2YgaW50Q2Fwcykge1xuICAgIGxldCB2YWx1ZSA9IG9yaWdpbmFsQ2Fwc1tjYXBdO1xuICAgIGlmIChfLmlzU3RyaW5nKHZhbHVlKSAmJiAhaXNOYU4odmFsdWUpKSB7XG4gICAgICB2YWx1ZSA9IHZhbHVlLnRyaW0oKTtcbiAgICAgIGxldCBuZXdWYWx1ZSA9IHBhcnNlSW50KHZhbHVlLCAxMCk7XG4gICAgICBpZiAodmFsdWUgIT09IGAke25ld1ZhbHVlfWApIHtcbiAgICAgICAgbmV3VmFsdWUgPSBwYXJzZUZsb2F0KHZhbHVlKTtcbiAgICAgIH1cbiAgICAgIGxvZy53YXJuKGBDYXBhYmlsaXR5ICcke2NhcH0nIGNoYW5nZWQgZnJvbSBzdHJpbmcgKCcke3ZhbHVlfScpIHRvIGludGVnZXIgKCR7bmV3VmFsdWV9KS4gVGhpcyBtYXkgY2F1c2UgdW5leHBlY3RlZCBiZWhhdmlvcmApO1xuICAgICAgY2Fwc1tjYXBdID0gbmV3VmFsdWU7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIGNhcHM7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNvbW1hbmRzO1xuIl0sImZpbGUiOiJsaWIvYmFzZWRyaXZlci9jb21tYW5kcy9zZXNzaW9uLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uLy4uIn0=
