"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.CUSTOM_STRATEGY = exports.IMAGE_STRATEGY = exports.helpers = exports.commands = void 0;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _logger = _interopRequireDefault(require("../logger"));

var _appiumSupport = require("appium-support");

var _lodash = _interopRequireDefault(require("lodash"));

var _2 = require("../../..");

var _images = require("./images");

var _protocol = require("../../protocol/protocol");

var _imageElement = require("../image-element");

const commands = {},
      helpers = {},
      extensions = {};
exports.helpers = helpers;
exports.commands = commands;
const IMAGE_STRATEGY = "-image";
exports.IMAGE_STRATEGY = IMAGE_STRATEGY;
const CUSTOM_STRATEGY = "-custom";
exports.CUSTOM_STRATEGY = CUSTOM_STRATEGY;

helpers.findElOrElsWithProcessing = function () {
  var _ref = (0, _asyncToGenerator2.default)(function* (strategy, selector, mult, context) {
    this.validateLocatorStrategy(strategy);

    try {
      return yield this.findElOrEls(strategy, selector, mult, context);
    } catch (err) {
      if (this.opts.printPageSourceOnFindFailure) {
        const src = yield this.getPageSource();

        _logger.default.debug(`Error finding element${mult ? 's' : ''}: ${err.message}`);

        _logger.default.debug(`Page source requested through 'printPageSourceOnFindFailure':`);

        _logger.default.debug(src);
      }

      throw err;
    }
  });

  return function (_x, _x2, _x3, _x4) {
    return _ref.apply(this, arguments);
  };
}();

commands.findElement = function () {
  var _ref2 = (0, _asyncToGenerator2.default)(function* (strategy, selector) {
    if (strategy === IMAGE_STRATEGY) {
      return yield this.findByImage(selector, {
        multiple: false
      });
    } else if (strategy === CUSTOM_STRATEGY) {
      return yield this.findByCustom(selector, false);
    }

    return yield this.findElOrElsWithProcessing(strategy, selector, false);
  });

  return function (_x5, _x6) {
    return _ref2.apply(this, arguments);
  };
}();

commands.findElements = function () {
  var _ref3 = (0, _asyncToGenerator2.default)(function* (strategy, selector) {
    if (strategy === IMAGE_STRATEGY) {
      return yield this.findByImage(selector, {
        multiple: true
      });
    } else if (strategy === CUSTOM_STRATEGY) {
      return yield this.findByCustom(selector, true);
    }

    return yield this.findElOrElsWithProcessing(strategy, selector, true);
  });

  return function (_x7, _x8) {
    return _ref3.apply(this, arguments);
  };
}();

commands.findElementFromElement = function () {
  var _ref4 = (0, _asyncToGenerator2.default)(function* (strategy, selector, elementId) {
    return yield this.findElOrElsWithProcessing(strategy, selector, false, elementId);
  });

  return function (_x9, _x10, _x11) {
    return _ref4.apply(this, arguments);
  };
}();

commands.findElementsFromElement = function () {
  var _ref5 = (0, _asyncToGenerator2.default)(function* (strategy, selector, elementId) {
    return yield this.findElOrElsWithProcessing(strategy, selector, true, elementId);
  });

  return function (_x12, _x13, _x14) {
    return _ref5.apply(this, arguments);
  };
}();

commands.findByCustom = function () {
  var _ref6 = (0, _asyncToGenerator2.default)(function* (selector, multiple) {
    var _this = this;

    const plugins = this.opts.customFindModules;

    if (!plugins) {
      throw new Error("Finding an element using a plugin is currently an " + "incubating feature. To use it you must manually install one or more " + "plugin modules in a way that they can be required by Appium, for " + "example installing them from the Appium directory, installing them " + "globally, or installing them elsewhere and passing an absolute path as " + "the capability. Then construct an object where the key is the shortcut " + "name for this plugin and the value is the module name or absolute path, " + "for example: {\"p1\": \"my-find-plugin\"}, and pass this in as the " + "'customFindModules' capability.");
    }

    if (!_lodash.default.isPlainObject(plugins)) {
      throw new Error("Invalid format for the 'customFindModules' capability. " + "It should be an object with keys corresponding to the short names and " + "values corresponding to the full names of the element finding plugins");
    }

    let _selector$split = selector.split(":"),
        _selector$split2 = (0, _slicedToArray2.default)(_selector$split, 2),
        plugin = _selector$split2[0],
        realSelector = _selector$split2[1];

    if (_lodash.default.size(plugins) > 1 && !realSelector) {
      throw new Error(`Multiple element finding plugins were registered ` + `(${_lodash.default.keys(plugins)}), but your selector did not indicate which plugin ` + `to use. Ensure you put the short name of the plugin followed by ':' as ` + `the initial part of the selector string.`);
    }

    if (_lodash.default.size(plugins) === 1 && !realSelector) {
      realSelector = plugin;
      plugin = _lodash.default.keys(plugins)[0];
    }

    if (!plugins[plugin]) {
      throw new Error(`Selector specified use of element finding plugin ` + `'${plugin}' but it was not registered in the 'customFindModules' ` + `capability.`);
    }

    let finder;

    try {
      _logger.default.debug(`Find plugin '${plugin}' requested; will attempt to use it ` + `from '${plugins[plugin]}'`);

      finder = require(plugins[plugin]);
    } catch (err) {
      throw new Error(`Could not load your custom find module '${plugin}'. Did ` + `you put it somewhere Appium can 'require' it? Original error: ${err}`);
    }

    if (!finder || !_lodash.default.isFunction(finder.find)) {
      throw new Error("Your custom find module did not appear to be constructed " + "correctly. It needs to export an object with a `find` method.");
    }

    const customFinderLog = _appiumSupport.logger.getLogger(plugin);

    let elements;

    const condition = function () {
      var _ref7 = (0, _asyncToGenerator2.default)(function* () {
        elements = yield finder.find(_this, customFinderLog, realSelector, multiple);

        if (!_lodash.default.isEmpty(elements) || multiple) {
          return true;
        }

        return false;
      });

      return function condition() {
        return _ref7.apply(this, arguments);
      };
    }();

    try {
      yield this.implicitWaitForCondition(condition);
    } catch (err) {
      if (err.message.match(/Condition unmet/)) {
        throw new _2.errors.NoSuchElementError();
      }

      throw err;
    }

    return multiple ? elements : elements[0];
  });

  return function (_x15, _x16) {
    return _ref6.apply(this, arguments);
  };
}();

helpers.findByImage = function () {
  var _ref8 = (0, _asyncToGenerator2.default)(function* (b64Template, {
    shouldCheckStaleness = false,
    multiple = false
  }) {
    var _this2 = this;

    const _this$settings$getSet = this.settings.getSettings(),
          threshold = _this$settings$getSet.imageMatchThreshold,
          fixImageTemplateSize = _this$settings$getSet.fixImageTemplateSize;

    _logger.default.info(`Finding image element with match threshold ${threshold}`);

    if (!this.getWindowSize) {
      throw new Error("This driver does not support the required 'getWindowSize' command");
    }

    const _ref9 = yield this.getWindowSize(),
          screenWidth = _ref9.width,
          screenHeight = _ref9.height;

    if (fixImageTemplateSize) {
      b64Template = yield this.ensureTemplateSize(b64Template, screenWidth, screenHeight);
    }

    let rect = null;

    const condition = function () {
      var _ref10 = (0, _asyncToGenerator2.default)(function* () {
        try {
          let b64Screenshot = yield _this2.getScreenshotForImageFind(screenWidth, screenHeight);
          rect = (yield _this2.compareImages(_images.MATCH_TEMPLATE_MODE, b64Screenshot, b64Template, {
            threshold
          })).rect;
          return true;
        } catch (err) {
          if (err.message.match(/Cannot find any occurrences/)) {
            return false;
          }

          throw err;
        }
      });

      return function condition() {
        return _ref10.apply(this, arguments);
      };
    }();

    try {
      yield this.implicitWaitForCondition(condition);
    } catch (err) {
      if (!err.message.match(/Condition unmet/)) {
        throw err;
      }
    }

    if (!rect) {
      if (multiple) {
        return [];
      }

      throw new _2.errors.NoSuchElementError();
    }

    _logger.default.info(`Image template matched: ${JSON.stringify(rect)}`);

    const imgEl = new _imageElement.ImageElement(b64Template, rect);

    if (shouldCheckStaleness) {
      return imgEl;
    }

    this._imgElCache.set(imgEl.id, imgEl);

    const protoKey = this.isW3CProtocol() ? _protocol.W3C_ELEMENT_KEY : _protocol.MJSONWP_ELEMENT_KEY;
    const protocolEl = imgEl.asElement(protoKey);
    return multiple ? [protocolEl] : protocolEl;
  });

  return function (_x17, _x18) {
    return _ref8.apply(this, arguments);
  };
}();

helpers.ensureTemplateSize = function () {
  var _ref11 = (0, _asyncToGenerator2.default)(function* (b64Template, screenWidth, screenHeight) {
    let imgObj = yield _appiumSupport.imageUtil.getJimpImage(b64Template);
    let _imgObj$bitmap = imgObj.bitmap,
        tplWidth = _imgObj$bitmap.width,
        tplHeight = _imgObj$bitmap.height;

    if (tplWidth <= screenWidth && tplHeight <= screenHeight) {
      return b64Template;
    }

    imgObj = imgObj.scaleToFit(screenWidth, screenHeight);
    return (yield imgObj.getBuffer(_appiumSupport.imageUtil.MIME_PNG)).toString('base64');
  });

  return function (_x19, _x20, _x21) {
    return _ref11.apply(this, arguments);
  };
}();

helpers.getScreenshotForImageFind = function () {
  var _ref12 = (0, _asyncToGenerator2.default)(function* (screenWidth, screenHeight) {
    if (!this.getScreenshot) {
      throw new Error("This driver does not support the required 'getScreenshot' command");
    }

    let b64Screenshot = yield this.getScreenshot();

    if (!this.settings.getSettings().fixImageFindScreenshotDims) {
      _logger.default.info(`Not verifying screenshot dimensions match screen`);

      return b64Screenshot;
    }

    _logger.default.info('Verifying screenshot size and aspect ratio');

    let imgObj = yield _appiumSupport.imageUtil.getJimpImage(b64Screenshot);
    let _imgObj$bitmap2 = imgObj.bitmap,
        shotWidth = _imgObj$bitmap2.width,
        shotHeight = _imgObj$bitmap2.height;

    if (screenWidth === shotWidth && screenHeight === shotHeight) {
      _logger.default.info('Screenshot size matched screen size');

      return b64Screenshot;
    }

    const screenAR = screenWidth / screenHeight;
    const shotAR = shotWidth / shotHeight;

    if (screenAR === shotAR) {
      _logger.default.info('Screenshot aspect ratio matched screen aspect ratio');
    } else {
      _logger.default.warn(`When trying to find an element, determined that the screen ` + `aspect ratio and screenshot aspect ratio are different. Screen ` + `is ${screenWidth}x${screenHeight} whereas screenshot is ` + `${shotWidth}x${shotHeight}.`);

      shotWidth = shotWidth / (shotAR / screenAR);

      _logger.default.warn(`Resizing screenshot to ${shotWidth}x${shotHeight} to match ` + `screen aspect ratio so that image element coordinates have a ` + `greater chance of being correct.`);

      imgObj = imgObj.resize(shotWidth, shotHeight);
    }

    if (screenWidth !== shotWidth) {
      _logger.default.info(`Scaling screenshot from ${shotWidth}x${shotHeight} to match ` + `screen at ${screenWidth}x${screenHeight}`);

      imgObj = imgObj.resize(screenWidth, screenHeight);
    }

    return (yield imgObj.getBuffer(_appiumSupport.imageUtil.MIME_PNG)).toString('base64');
  });

  return function (_x22, _x23) {
    return _ref12.apply(this, arguments);
  };
}();

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL2NvbW1hbmRzL2ZpbmQuanMiXSwibmFtZXMiOlsiY29tbWFuZHMiLCJoZWxwZXJzIiwiZXh0ZW5zaW9ucyIsIklNQUdFX1NUUkFURUdZIiwiQ1VTVE9NX1NUUkFURUdZIiwiZmluZEVsT3JFbHNXaXRoUHJvY2Vzc2luZyIsInN0cmF0ZWd5Iiwic2VsZWN0b3IiLCJtdWx0IiwiY29udGV4dCIsInZhbGlkYXRlTG9jYXRvclN0cmF0ZWd5IiwiZmluZEVsT3JFbHMiLCJlcnIiLCJvcHRzIiwicHJpbnRQYWdlU291cmNlT25GaW5kRmFpbHVyZSIsInNyYyIsImdldFBhZ2VTb3VyY2UiLCJsb2ciLCJkZWJ1ZyIsIm1lc3NhZ2UiLCJmaW5kRWxlbWVudCIsImZpbmRCeUltYWdlIiwibXVsdGlwbGUiLCJmaW5kQnlDdXN0b20iLCJmaW5kRWxlbWVudHMiLCJmaW5kRWxlbWVudEZyb21FbGVtZW50IiwiZWxlbWVudElkIiwiZmluZEVsZW1lbnRzRnJvbUVsZW1lbnQiLCJwbHVnaW5zIiwiY3VzdG9tRmluZE1vZHVsZXMiLCJFcnJvciIsIl8iLCJpc1BsYWluT2JqZWN0Iiwic3BsaXQiLCJwbHVnaW4iLCJyZWFsU2VsZWN0b3IiLCJzaXplIiwia2V5cyIsImZpbmRlciIsInJlcXVpcmUiLCJpc0Z1bmN0aW9uIiwiZmluZCIsImN1c3RvbUZpbmRlckxvZyIsImxvZ2dlciIsImdldExvZ2dlciIsImVsZW1lbnRzIiwiY29uZGl0aW9uIiwiaXNFbXB0eSIsImltcGxpY2l0V2FpdEZvckNvbmRpdGlvbiIsIm1hdGNoIiwiZXJyb3JzIiwiTm9TdWNoRWxlbWVudEVycm9yIiwiYjY0VGVtcGxhdGUiLCJzaG91bGRDaGVja1N0YWxlbmVzcyIsInNldHRpbmdzIiwiZ2V0U2V0dGluZ3MiLCJ0aHJlc2hvbGQiLCJpbWFnZU1hdGNoVGhyZXNob2xkIiwiZml4SW1hZ2VUZW1wbGF0ZVNpemUiLCJpbmZvIiwiZ2V0V2luZG93U2l6ZSIsInNjcmVlbldpZHRoIiwid2lkdGgiLCJzY3JlZW5IZWlnaHQiLCJoZWlnaHQiLCJlbnN1cmVUZW1wbGF0ZVNpemUiLCJyZWN0IiwiYjY0U2NyZWVuc2hvdCIsImdldFNjcmVlbnNob3RGb3JJbWFnZUZpbmQiLCJjb21wYXJlSW1hZ2VzIiwiTUFUQ0hfVEVNUExBVEVfTU9ERSIsIkpTT04iLCJzdHJpbmdpZnkiLCJpbWdFbCIsIkltYWdlRWxlbWVudCIsIl9pbWdFbENhY2hlIiwic2V0IiwiaWQiLCJwcm90b0tleSIsImlzVzNDUHJvdG9jb2wiLCJXM0NfRUxFTUVOVF9LRVkiLCJNSlNPTldQX0VMRU1FTlRfS0VZIiwicHJvdG9jb2xFbCIsImFzRWxlbWVudCIsImltZ09iaiIsImltYWdlVXRpbCIsImdldEppbXBJbWFnZSIsImJpdG1hcCIsInRwbFdpZHRoIiwidHBsSGVpZ2h0Iiwic2NhbGVUb0ZpdCIsImdldEJ1ZmZlciIsIk1JTUVfUE5HIiwidG9TdHJpbmciLCJnZXRTY3JlZW5zaG90IiwiZml4SW1hZ2VGaW5kU2NyZWVuc2hvdERpbXMiLCJzaG90V2lkdGgiLCJzaG90SGVpZ2h0Iiwic2NyZWVuQVIiLCJzaG90QVIiLCJ3YXJuIiwicmVzaXplIiwiT2JqZWN0IiwiYXNzaWduIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0EsTUFBTUEsUUFBUSxHQUFHLEVBQWpCO0FBQUEsTUFBcUJDLE9BQU8sR0FBRyxFQUEvQjtBQUFBLE1BQW1DQyxVQUFVLEdBQUcsRUFBaEQ7OztBQUVBLE1BQU1DLGNBQWMsR0FBRyxRQUF2Qjs7QUFDQSxNQUFNQyxlQUFlLEdBQUcsU0FBeEI7OztBQWNBSCxPQUFPLENBQUNJLHlCQUFSO0FBQUEsNkNBQW9DLFdBQWdCQyxRQUFoQixFQUEwQkMsUUFBMUIsRUFBb0NDLElBQXBDLEVBQTBDQyxPQUExQyxFQUFtRDtBQUNyRixTQUFLQyx1QkFBTCxDQUE2QkosUUFBN0I7O0FBQ0EsUUFBSTtBQUNGLG1CQUFhLEtB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QUNPLFNBQVAsQ0FBaUJOLHlCQUFVTyxRQUEzQixDQUFQLEVBQTZDQyxRQUE3QyxDQUFzRCxRQUF0RCxDQUFQO0FBQ0QsR0E1REQ7O0FBQUE7QUFBQTtBQUFBO0FBQUE7O0FBK0RBUyxNQUFNLENBQUNDLE1BQVAsQ0FBY3JHLFVBQWQsRUFBMEJGLFFBQTFCLEVBQW9DQyxPQUFwQztlQUVlQyxVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgbG9nZ2VyLCBpbWFnZVV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgZXJyb3JzIH0gZnJvbSAnLi4vLi4vLi4nO1xuaW1wb3J0IHsgTUFUQ0hfVEVNUExBVEVfTU9ERSB9IGZyb20gJy4vaW1hZ2VzJztcbmltcG9ydCB7IFczQ19FTEVNRU5UX0tFWSwgTUpTT05XUF9FTEVNRU5UX0tFWSB9IGZyb20gJy4uLy4uL3Byb3RvY29sL3Byb3RvY29sJztcbmltcG9ydCB7IEltYWdlRWxlbWVudCB9IGZyb20gJy4uL2ltYWdlLWVsZW1lbnQnO1xuXG5cbmNvbnN0IGNvbW1hbmRzID0ge30sIGhlbHBlcnMgPSB7fSwgZXh0ZW5zaW9ucyA9IHt9O1xuXG5jb25zdCBJTUFHRV9TVFJBVEVHWSA9IFwiLWltYWdlXCI7XG5jb25zdCBDVVNUT01fU1RSQVRFR1kgPSBcIi1jdXN0b21cIjtcblxuLy8gT3ZlcnJpZGUgdGhlIGZvbGxvd2luZyBmdW5jdGlvbiBmb3IgeW91ciBvd24gZHJpdmVyLCBhbmQgdGhlIHJlc3QgaXMgdGFrZW5cbi8vIGNhcmUgb2YhXG5cbi8vIGhlbHBlcnMuZmluZEVsT3JFbHMgPSBhc3luYyBmdW5jdGlvbiAoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KSB7fVxuLy8gICBzdHJhdGVneTogbG9jYXRvciBzdHJhdGVneVxuLy8gICBzZWxlY3RvcjogdGhlIGFjdHVhbCBzZWxlY3RvciBmb3IgZmluZGluZyBhbiBlbGVtZW50XG4vLyAgIG11bHQ6IG11bHRpcGxlIGVsZW1lbnRzIG9yIGp1c3Qgb25lP1xuLy8gICBjb250ZXh0OiBmaW5kaW5nIGFuIGVsZW1lbnQgZnJvbSB0aGUgcm9vdCBjb250ZXh0PyBvciBzdGFydGluZyBmcm9tIGFub3RoZXIgZWxlbWVudFxuLy9cbi8vIFJldHVybnMgYW4gb2JqZWN0IHdoaWNoIGFkaGVyZXMgdG8gdGhlIHdheSB0aGUgSlNPTiBXaXJlIFByb3RvY29sIHJlcHJlc2VudHMgZWxlbWVudHM6XG4vLyB7IEVMRU1FTlQ6ICMgfSAgICBlZzogeyBFTEVNRU5UOiAzIH0gIG9yIHsgRUxFTUVOVDogMS4wMjMgfVxuXG5oZWxwZXJzLmZpbmRFbE9yRWxzV2l0aFByb2Nlc3NpbmcgPSBhc3luYyBmdW5jdGlvbiAoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KSB7XG4gIHRoaXMudmFsaWRhdGVMb2NhdG9yU3RyYXRlZ3koc3RyYXRlZ3kpO1xuICB0cnkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmZpbmRFbE9yRWxzKHN0cmF0ZWd5LCBzZWxlY3RvciwgbXVsdCwgY29udGV4dCk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGlmICh0aGlzLm9wdHMucHJpbnRQYWdlU291cmNlT25GaW5kRmFpbHVyZSkge1xuICAgICAgY29uc3Qgc3JjID0gYXdhaXQgdGhpcy5nZXRQYWdlU291cmNlKCk7XG4gICAgICBsb2cuZGVidWcoYEVycm9yIGZpbmRpbmcgZWxlbWVudCR7bXVsdCA/ICdzJyA6ICcnfTogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIGxvZy5kZWJ1ZyhgUGFnZSBzb3VyY2UgcmVxdWVzdGVkIHRocm91Z2ggJ3ByaW50UGFnZVNvdXJjZU9uRmluZEZhaWx1cmUnOmApO1xuICAgICAgbG9nLmRlYnVnKHNyYyk7XG4gICAgfVxuICAgIC8vIHN0aWxsIHdhbnQgdGhlIGVycm9yIHRvIG9jY3VyXG4gICAgdGhyb3cgZXJyO1xuICB9XG59O1xuXG5jb21tYW5kcy5maW5kRWxlbWVudCA9IGFzeW5jIGZ1bmN0aW9uIChzdHJhdGVneSwgc2VsZWN0b3IpIHtcbiAgaWYgKHN0cmF0ZWd5ID09PSBJTUFHRV9TVFJBVEVHWSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmZpbmRCeUltYWdlKHNlbGVjdG9yLCB7bXVsdGlwbGU6IGZhbHNlfSk7XG4gIH0gZWxzZSBpZiAoc3RyYXRlZ3kgPT09IENVU1RPTV9TVFJBVEVHWSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmZpbmRCeUN1c3RvbShzZWxlY3RvciwgZmFsc2UpO1xuICB9XG5cbiAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZEVsT3JFbHNXaXRoUHJvY2Vzc2luZyhzdHJhdGVneSwgc2VsZWN0b3IsIGZhbHNlKTtcbn07XG5cbmNvbW1hbmRzLmZpbmRFbGVtZW50cyA9IGFzeW5jIGZ1bmN0aW9uIChzdHJhdGVneSwgc2VsZWN0b3IpIHtcbiAgaWYgKHN0cmF0ZWd5ID09PSBJTUFHRV9TVFJBVEVHWSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmZpbmRCeUltYWdlKHNlbGVjdG9yLCB7bXVsdGlwbGU6IHRydWV9KTtcbiAgfSBlbHNlIGlmIChzdHJhdGVneSA9PT0gQ1VTVE9NX1NUUkFURUdZKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZEJ5Q3VzdG9tKHNlbGVjdG9yLCB0cnVlKTtcbiAgfVxuXG4gIHJldHVybiBhd2FpdCB0aGlzLmZpbmRFbE9yRWxzV2l0aFByb2Nlc3Npbmcoc3RyYXRlZ3ksIHNlbGVjdG9yLCB0cnVlKTtcbn07XG5cbmNvbW1hbmRzLmZpbmRFbGVtZW50RnJvbUVsZW1lbnQgPSBhc3luYyBmdW5jdGlvbiAoc3RyYXRlZ3ksIHNlbGVjdG9yLCBlbGVtZW50SWQpIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZEVsT3JFbHNXaXRoUHJvY2Vzc2luZyhzdHJhdGVneSwgc2VsZWN0b3IsIGZhbHNlLCBlbGVtZW50SWQpO1xufTtcblxuY29tbWFuZHMuZmluZEVsZW1lbnRzRnJvbUVsZW1lbnQgPSBhc3luYyBmdW5jdGlvbiAoc3RyYXRlZ3ksIHNlbGVjdG9yLCBlbGVtZW50SWQpIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZEVsT3JFbHNXaXRoUHJvY2Vzc2luZyhzdHJhdGVneSwgc2VsZWN0b3IsIHRydWUsIGVsZW1lbnRJZCk7XG59O1xuXG4vKipcbiAqIEZpbmQgYW4gZWxlbWVudCB1c2luZyBhIGN1c3RvbSBwbHVnaW4gc3BlY2lmaWVkIGJ5IHRoZSBjdXN0b21GaW5kTW9kdWxlcyBjYXAuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHNlbGVjdG9yIC0gdGhlIHNlbGVjdG9yIHdoaWNoIHRoZSBwbHVnaW4gd2lsbCB1c2UgdG8gZmluZFxuICogZWxlbWVudHNcbiAqIEBwYXJhbSB7Ym9vbGVhbn0gbXVsdGlwbGUgLSB3aGV0aGVyIHdlIHdhbnQgb25lIGVsZW1lbnQgb3IgbXVsdGlwbGVcbiAqXG4gKiBAcmV0dXJucyB7V2ViRWxlbWVudH0gLSBXZWJEcml2ZXIgZWxlbWVudCBvciBsaXN0IG9mIGVsZW1lbnRzXG4gKi9cbmNvbW1hbmRzLmZpbmRCeUN1c3RvbSA9IGFzeW5jIGZ1bmN0aW9uIChzZWxlY3RvciwgbXVsdGlwbGUpIHtcbiAgY29uc3QgcGx1Z2lucyA9IHRoaXMub3B0cy5jdXN0b21GaW5kTW9kdWxlcztcblxuICAvLyBmaXJzdCBlbnN1cmUgdGhlIHVzZXIgaGFzIHJlZ2lzdGVyZWQgb25lIG9yIG1vcmUgZmluZCBwbHVnaW5zXG4gIGlmICghcGx1Z2lucykge1xuICAgIC8vIFRPRE8gdGhpcyBpbmZvIHNob3VsZCBnbyBpbiBkb2NzIGluc3RlYWQ7IHVwZGF0ZSB3aGVuIGRvY3MgZm9yIHRoaXNcbiAgICAvLyBmZWF0dXJlIGV4aXN0XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiRmluZGluZyBhbiBlbGVtZW50IHVzaW5nIGEgcGx1Z2luIGlzIGN1cnJlbnRseSBhbiBcIiArXG4gICAgICBcImluY3ViYXRpbmcgZmVhdHVyZS4gVG8gdXNlIGl0IHlvdSBtdXN0IG1hbnVhbGx5IGluc3RhbGwgb25lIG9yIG1vcmUgXCIgK1xuICAgICAgXCJwbHVnaW4gbW9kdWxlcyBpbiBhIHdheSB0aGF0IHRoZXkgY2FuIGJlIHJlcXVpcmVkIGJ5IEFwcGl1bSwgZm9yIFwiICtcbiAgICAgIFwiZXhhbXBsZSBpbnN0YWxsaW5nIHRoZW0gZnJvbSB0aGUgQXBwaXVtIGRpcmVjdG9yeSwgaW5zdGFsbGluZyB0aGVtIFwiICtcbiAgICAgIFwiZ2xvYmFsbHksIG9yIGluc3RhbGxpbmcgdGhlbSBlbHNld2hlcmUgYW5kIHBhc3NpbmcgYW4gYWJzb2x1dGUgcGF0aCBhcyBcIiArXG4gICAgICBcInRoZSBjYXBhYmlsaXR5LiBUaGVuIGNvbnN0cnVjdCBhbiBvYmplY3Qgd2hlcmUgdGhlIGtleSBpcyB0aGUgc2hvcnRjdXQgXCIgK1xuICAgICAgXCJuYW1lIGZvciB0aGlzIHBsdWdpbiBhbmQgdGhlIHZhbHVlIGlzIHRoZSBtb2R1bGUgbmFtZSBvciBhYnNvbHV0ZSBwYXRoLCBcIiArXG4gICAgICBcImZvciBleGFtcGxlOiB7XFxcInAxXFxcIjogXFxcIm15LWZpbmQtcGx1Z2luXFxcIn0sIGFuZCBwYXNzIHRoaXMgaW4gYXMgdGhlIFwiICtcbiAgICAgIFwiJ2N1c3RvbUZpbmRNb2R1bGVzJyBjYXBhYmlsaXR5LlwiKTtcbiAgfVxuXG4gIC8vIHRoZW4gZG8gc29tZSBiYXNpYyBjaGVja2luZyBvZiB0aGUgdHlwZSBvZiB0aGUgY2FwYWJpbGl0eVxuICBpZiAoIV8uaXNQbGFpbk9iamVjdChwbHVnaW5zKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIkludmFsaWQgZm9ybWF0IGZvciB0aGUgJ2N1c3RvbUZpbmRNb2R1bGVzJyBjYXBhYmlsaXR5LiBcIiArXG4gICAgICBcIkl0IHNob3VsZCBiZSBhbiBvYmplY3Qgd2l0aCBrZXlzIGNvcnJlc3BvbmRpbmcgdG8gdGhlIHNob3J0IG5hbWVzIGFuZCBcIiArXG4gICAgICBcInZhbHVlcyBjb3JyZXNwb25kaW5nIHRvIHRoZSBmdWxsIG5hbWVzIG9mIHRoZSBlbGVtZW50IGZpbmRpbmcgcGx1Z2luc1wiKTtcbiAgfVxuXG4gIC8vIGdldCB0aGUgbmFtZSBvZiB0aGUgcGFydGljdWxhciBwbHVnaW4gdXNlZCBmb3IgdGhpcyBpbnZvY2F0aW9uIG9mIGZpbmQsXG4gIC8vIGFuZCBzZXBhcmF0ZSBpdCBmcm9tIHRoZSBzZWxlY3RvciB3ZSB3aWxsIHBhc3MgdG8gdGhlIHBsdWdpblxuICBsZXQgW3BsdWdpbiwgcmVhbFNlbGVjdG9yXSA9IHNlbGVjdG9yLnNwbGl0KFwiOlwiKTtcblxuICAvLyBpZiB0aGUgdXNlciBkaWRuJ3Qgc3BlY2lmeSBhIHBsdWdpbiBmb3IgdGhpcyBmaW5kIGludm9jYXRpb24sIGFuZCB3ZSBoYWRcbiAgLy8gbXVsdGlwbGUgcGx1Z2lucyByZWdpc3RlcmVkLCB0aGF0J3MgYSBwcm9ibGVtXG4gIGlmIChfLnNpemUocGx1Z2lucykgPiAxICYmICFyZWFsU2VsZWN0b3IpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYE11bHRpcGxlIGVsZW1lbnQgZmluZGluZyBwbHVnaW5zIHdlcmUgcmVnaXN0ZXJlZCBgICtcbiAgICAgIGAoJHtfLmtleXMocGx1Z2lucyl9KSwgYnV0IHlvdXIgc2VsZWN0b3IgZGlkIG5vdCBpbmRpY2F0ZSB3aGljaCBwbHVnaW4gYCArXG4gICAgICBgdG8gdXNlLiBFbnN1cmUgeW91IHB1dCB0aGUgc2hvcnQgbmFtZSBvZiB0aGUgcGx1Z2luIGZvbGxvd2VkIGJ5ICc6JyBhcyBgICtcbiAgICAgIGB0aGUgaW5pdGlhbCBwYXJ0IG9mIHRoZSBzZWxlY3RvciBzdHJpbmcuYCk7XG4gIH1cblxuICAvLyBidXQgaWYgdGhleSBkaWQgbm90IHNwZWNpZnkgYSBwbHVnaW4gYW5kIHdlIG9ubHkgaGF2ZSBvbmUgcGx1Z2luLCBqdXN0IHVzZVxuICAvLyB0aGF0IG9uZVxuICBpZiAoXy5zaXplKHBsdWdpbnMpID09PSAxICYmICFyZWFsU2VsZWN0b3IpIHtcbiAgICByZWFsU2VsZWN0b3IgPSBwbHVnaW47XG4gICAgcGx1Z2luID0gXy5rZXlzKHBsdWdpbnMpWzBdO1xuICB9XG5cbiAgaWYgKCFwbHVnaW5zW3BsdWdpbl0pIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFNlbGVjdG9yIHNwZWNpZmllZCB1c2Ugb2YgZWxlbWVudCBmaW5kaW5nIHBsdWdpbiBgICtcbiAgICAgIGAnJHtwbHVnaW59JyBidXQgaXQgd2FzIG5vdCByZWdpc3RlcmVkIGluIHRoZSAnY3VzdG9tRmluZE1vZHVsZXMnIGAgK1xuICAgICAgYGNhcGFiaWxpdHkuYCk7XG4gIH1cblxuICBsZXQgZmluZGVyO1xuICB0cnkge1xuICAgIGxvZy5kZWJ1ZyhgRmluZCBwbHVnaW4gJyR7cGx1Z2lufScgcmVxdWVzdGVkOyB3aWxsIGF0dGVtcHQgdG8gdXNlIGl0IGAgK1xuICAgICAgYGZyb20gJyR7cGx1Z2luc1twbHVnaW5dfSdgKTtcbiAgICBmaW5kZXIgPSByZXF1aXJlKHBsdWdpbnNbcGx1Z2luXSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHRocm93IG5ldyBFcnJvcihgQ291bGQgbm90IGxvYWQgeW91ciBjdXN0b20gZmluZCBtb2R1bGUgJyR7cGx1Z2lufScuIERpZCBgICtcbiAgICAgIGB5b3UgcHV0IGl0IHNvbWV3aGVyZSBBcHBpdW0gY2FuICdyZXF1aXJlJyBpdD8gT3JpZ2luYWwgZXJyb3I6ICR7ZXJyfWApO1xuICB9XG5cbiAgaWYgKCFmaW5kZXIgfHwgIV8uaXNGdW5jdGlvbihmaW5kZXIuZmluZCkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJZb3VyIGN1c3RvbSBmaW5kIG1vZHVsZSBkaWQgbm90IGFwcGVhciB0byBiZSBjb25zdHJ1Y3RlZCBcIiArXG4gICAgICAgIFwiY29ycmVjdGx5LiBJdCBuZWVkcyB0byBleHBvcnQgYW4gb2JqZWN0IHdpdGggYSBgZmluZGAgbWV0aG9kLlwiKTtcbiAgfVxuXG4gIGNvbnN0IGN1c3RvbUZpbmRlckxvZyA9IGxvZ2dlci5nZXRMb2dnZXIocGx1Z2luKTtcblxuICBsZXQgZWxlbWVudHM7XG4gIGNvbnN0IGNvbmRpdGlvbiA9IGFzeW5jICgpID0+IHtcbiAgICAvLyBnZXQgYSBsaXN0IG9mIG1hdGNoZWQgZWxlbWVudHMgZnJvbSB0aGUgY3VzdG9tIGZpbmRlciwgd2hpY2ggY2FuXG4gICAgLy8gcG90ZW50aWFsbHkgdXNlIHRoZSBlbnRpcmUgc3VpdGUgb2YgbWV0aG9kcyB0aGUgY3VycmVudCBkcml2ZXIgcHJvdmlkZXMuXG4gICAgLy8gdGhlIGZpbmRlciBzaG91bGQgYWx3YXlzIHJldHVybiBhIGxpc3Qgb2YgZWxlbWVudHMsIGJ1dCBtYXkgdXNlIHRoZVxuICAgIC8vIGtub3dsZWRnZSBvZiB3aGV0aGVyIHdlIGFyZSBsb29raW5nIGZvciBvbmUgb3IgbWFueSB0byBwZXJmb3JtIGludGVybmFsXG4gICAgLy8gb3B0aW1pemF0aW9uc1xuICAgIGVsZW1lbnRzID0gYXdhaXQgZmluZGVyLmZpbmQodGhpcywgY3VzdG9tRmluZGVyTG9nLCByZWFsU2VsZWN0b3IsIG11bHRpcGxlKTtcblxuICAgIC8vIGlmIHdlJ3JlIGxvb2tpbmcgZm9yIG11bHRpcGxlIGVsZW1lbnRzLCBvciBpZiB3ZSdyZSBsb29raW5nIGZvciBvbmx5XG4gICAgLy8gb25lIGFuZCBmb3VuZCBpdCwgd2UncmUgZG9uZVxuICAgIGlmICghXy5pc0VtcHR5KGVsZW1lbnRzKSB8fCBtdWx0aXBsZSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgLy8gb3RoZXJ3aXNlIHdlIHNob3VsZCByZXRyeSwgc28gcmV0dXJuIGZhbHNlIHRvIHRyaWdnZXIgdGhlIHJldHJ5IGxvb3BcbiAgICByZXR1cm4gZmFsc2U7XG4gIH07XG5cbiAgdHJ5IHtcbiAgICAvLyBtYWtlIHN1cmUgd2UgcmVzcGVjdCBpbXBsaWNpdCB3YWl0XG4gICAgYXdhaXQgdGhpcy5pbXBsaWNpdFdhaXRGb3JDb25kaXRpb24oY29uZGl0aW9uKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKGVyci5tZXNzYWdlLm1hdGNoKC9Db25kaXRpb24gdW5tZXQvKSkge1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hFbGVtZW50RXJyb3IoKTtcbiAgICB9XG4gICAgdGhyb3cgZXJyO1xuICB9XG5cbiAgcmV0dXJuIG11bHRpcGxlID8gZWxlbWVudHMgOiBlbGVtZW50c1swXTtcbn07XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gRmluZEJ5SW1hZ2VPcHRpb25zXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IFtzaG91bGRDaGVja1N0YWxlbmVzcz1mYWxzZV0gLSB3aGV0aGVyIHRoaXMgY2FsbCB0byBmaW5kIGFuXG4gKiBpbWFnZSBpcyBtZXJlbHkgdG8gY2hlY2sgc3RhbGVuZXNzLiBJZiBzbyB3ZSBjYW4gYnlwYXNzIGEgbG90IG9mIGxvZ2ljXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IFttdWx0aXBsZT1mYWxzZV0gLSBXaGV0aGVyIHdlIGFyZSBmaW5kaW5nIG9uZSBlbGVtZW50IG9yXG4gKiBtdWx0aXBsZVxuICovXG5cbi8qKlxuICogRmluZCBhIHNjcmVlbiByZWN0IHJlcHJlc2VudGVkIGJ5IGFuIEltYWdlRWxlbWVudCBjb3JyZXNwb25kaW5nIHRvIGFuIGltYWdlXG4gKiB0ZW1wbGF0ZSBzZW50IGluIGJ5IHRoZSBjbGllbnRcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYjY0VGVtcGxhdGUgLSBiYXNlNjQtZW5jb2RlZCBpbWFnZSB1c2VkIGFzIGEgdGVtcGxhdGUgdG8gYmVcbiAqIG1hdGNoZWQgaW4gdGhlIHNjcmVlbnNob3RcbiAqIEBwYXJhbSB7RmluZEJ5SW1hZ2VPcHRpb25zfSAtIGFkZGl0aW9uYWwgb3B0aW9uc1xuICpcbiAqIEByZXR1cm5zIHtXZWJFbGVtZW50fSAtIFdlYkRyaXZlciBlbGVtZW50IHdpdGggYSBzcGVjaWFsIGlkIHByZWZpeFxuICovXG5oZWxwZXJzLmZpbmRCeUltYWdlID0gYXN5bmMgZnVuY3Rpb24gKGI2NFRlbXBsYXRlLCB7XG4gIHNob3VsZENoZWNrU3RhbGVuZXNzID0gZmFsc2UsXG4gIG11bHRpcGxlID0gZmFsc2UsXG59KSB7XG4gIGNvbnN0IHtcbiAgICBpbWFnZU1hdGNoVGhyZXNob2xkOiB0aHJlc2hvbGQsXG4gICAgZml4SW1hZ2VUZW1wbGF0ZVNpemVcbiAgfSA9IHRoaXMuc2V0dGluZ3MuZ2V0U2V0dGluZ3MoKTtcblxuICBsb2cuaW5mbyhgRmluZGluZyBpbWFnZSBlbGVtZW50IHdpdGggbWF0Y2ggdGhyZXNob2xkICR7dGhyZXNob2xkfWApO1xuICBpZiAoIXRoaXMuZ2V0V2luZG93U2l6ZSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIlRoaXMgZHJpdmVyIGRvZXMgbm90IHN1cHBvcnQgdGhlIHJlcXVpcmVkICdnZXRXaW5kb3dTaXplJyBjb21tYW5kXCIpO1xuICB9XG4gIGNvbnN0IHt3aWR0aDogc2NyZWVuV2lkdGgsIGhlaWdodDogc2NyZWVuSGVpZ2h0fSA9IGF3YWl0IHRoaXMuZ2V0V2luZG93U2l6ZSgpO1xuXG4gIC8vIHNvbWVvbmUgbWlnaHQgaGF2ZSBzZW50IGluIGEgdGVtcGxhdGUgdGhhdCdzIGxhcmdlciB0aGFuIHRoZSBzY3JlZW5cbiAgLy8gZGltZW5zaW9ucy4gSWYgc28gbGV0J3MgY2hlY2sgYW5kIGN1dCBpdCBkb3duIHRvIHNpemUgc2luY2UgdGhlIGFsZ29yaXRobVxuICAvLyB3aWxsIG5vdCB3b3JrIHVubGVzcyB3ZSBkby4gQnV0IGJlY2F1c2UgaXQgcmVxdWlyZXMgc29tZSBwb3RlbnRpYWxseVxuICAvLyBleHBlbnNpdmUgY29tbWFuZHMsIG9ubHkgZG8gdGhpcyBpZiB0aGUgdXNlciBoYXMgcmVxdWVzdGVkIGl0IGluIHNldHRpbmdzLlxuICBpZiAoZml4SW1hZ2VUZW1wbGF0ZVNpemUpIHtcbiAgICBiNjRUZW1wbGF0ZSA9IGF3YWl0IHRoaXMuZW5zdXJlVGVtcGxhdGVTaXplKGI2NFRlbXBsYXRlLCBzY3JlZW5XaWR0aCxcbiAgICAgIHNjcmVlbkhlaWdodCk7XG4gIH1cblxuICBsZXQgcmVjdCA9IG51bGw7XG4gIGNvbnN0IGNvbmRpdGlvbiA9IGFzeW5jICgpID0+IHtcbiAgICB0cnkge1xuICAgICAgbGV0IGI2NFNjcmVlbnNob3QgPSBhd2FpdCB0aGlzLmdldFNjcmVlbnNob3RGb3JJbWFnZUZpbmQoc2NyZWVuV2lkdGgsIHNjcmVlbkhlaWdodCk7XG4gICAgICByZWN0ID0gKGF3YWl0IHRoaXMuY29tcGFyZUltYWdlcyhNQVRDSF9URU1QTEFURV9NT0RFLCBiNjRTY3JlZW5zaG90LFxuICAgICAgICBiNjRUZW1wbGF0ZSwge3RocmVzaG9sZH0pKS5yZWN0O1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAvLyBpZiBjb21wYXJlSW1hZ2VzIGZhaWxzLCB3ZSdsbCBnZXQgYSBzcGVjaWZpYyBlcnJvciwgYnV0IHdlIHNob3VsZFxuICAgICAgLy8gcmV0cnksIHNvIHRyYXAgdGhhdCBhbmQganVzdCByZXR1cm4gZmFsc2UgdG8gdHJpZ2dlciB0aGUgbmV4dCByb3VuZCBvZlxuICAgICAgLy8gaW1wbGljaXRseSB3YWl0aW5nLiBGb3Igb3RoZXIgZXJyb3JzLCB0aHJvdyB0aGVtIHRvIGdldCBvdXQgb2YgdGhlXG4gICAgICAvLyBpbXBsaWNpdCB3YWl0IGxvb3BcbiAgICAgIGlmIChlcnIubWVzc2FnZS5tYXRjaCgvQ2Fubm90IGZpbmQgYW55IG9jY3VycmVuY2VzLykpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgfTtcblxuICB0cnkge1xuICAgIGF3YWl0IHRoaXMuaW1wbGljaXRXYWl0Rm9yQ29uZGl0aW9uKGNvbmRpdGlvbik7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIC8vIHRoaXMgYGltcGxpY2l0V2FpdEZvckNvbmRpdGlvbmAgbWV0aG9kIHdpbGwgdGhyb3cgYSAnQ29uZGl0aW9uIHVubWV0J1xuICAgIC8vIGVycm9yIGlmIGFuIGVsZW1lbnQgaXMgbm90IGZvdW5kIGV2ZW50dWFsbHkuIEluIHRoYXQgY2FzZSwgd2Ugd2lsbFxuICAgIC8vIGhhbmRsZSB0aGUgZWxlbWVudCBub3QgZm91bmQgcmVzcG9uc2UgYmVsb3cuIEluIHRoZSBjYXNlIHdoZXJlIGdldCBzb21lXG4gICAgLy8gX290aGVyXyBraW5kIG9mIGVycm9yLCBpdCBtZWFucyBzb21ldGhpbmcgYmxldyB1cCB0b3RhbGx5IGFwYXJ0IGZyb20gdGhlXG4gICAgLy8gaW1wbGljaXQgd2FpdCB0aW1lb3V0LiBXZSBzaG91bGQgbm90IG1hc2sgdGhhdCBlcnJvciBhbmQgaW5zdGVhZCB0aHJvd1xuICAgIC8vIGl0IHN0cmFpZ2h0YXdheVxuICAgIGlmICghZXJyLm1lc3NhZ2UubWF0Y2goL0NvbmRpdGlvbiB1bm1ldC8pKSB7XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICB9XG5cbiAgaWYgKCFyZWN0KSB7XG4gICAgaWYgKG11bHRpcGxlKSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoRWxlbWVudEVycm9yKCk7XG4gIH1cblxuICBsb2cuaW5mbyhgSW1hZ2UgdGVtcGxhdGUgbWF0Y2hlZDogJHtKU09OLnN0cmluZ2lmeShyZWN0KX1gKTtcbiAgY29uc3QgaW1nRWwgPSBuZXcgSW1hZ2VFbGVtZW50KGI2NFRlbXBsYXRlLCByZWN0KTtcblxuICAvLyBpZiB3ZSdyZSBqdXN0IGNoZWNraW5nIHN0YWxlbmVzcywgcmV0dXJuIHN0cmFpZ2h0YXdheSBzbyB3ZSBkb24ndCBhZGRcbiAgLy8gYSBuZXcgZWxlbWVudCB0byB0aGUgY2FjaGUuIHNob3VsZENoZWNrU3RhbGVuZXNzIGRvZXMgbm90IHN1cHBvcnQgbXVsdGlwbGVcbiAgLy8gZWxlbWVudHMsIHNpbmNlIGl0IGlzIGEgcHVyZWx5IGludGVybmFsIG1lY2hhbmlzbVxuICBpZiAoc2hvdWxkQ2hlY2tTdGFsZW5lc3MpIHtcbiAgICByZXR1cm4gaW1nRWw7XG4gIH1cblxuICB0aGlzLl9pbWdFbENhY2hlLnNldChpbWdFbC5pZCwgaW1nRWwpO1xuICBjb25zdCBwcm90b0tleSA9IHRoaXMuaXNXM0NQcm90b2NvbCgpID8gVzNDX0VMRU1FTlRfS0VZIDogTUpTT05XUF9FTEVNRU5UX0tFWTtcbiAgY29uc3QgcHJvdG9jb2xFbCA9IGltZ0VsLmFzRWxlbWVudChwcm90b0tleSk7XG4gIHJldHVybiBtdWx0aXBsZSA/IFtwcm90b2NvbEVsXSA6IHByb3RvY29sRWw7XG59O1xuXG4vKipcbiAqIEVuc3VyZSB0aGF0IHRoZSBpbWFnZSB0ZW1wbGF0ZSBzZW50IGluIGZvciBhIGZpbmQgaXMgb2YgYSBzdWl0YWJsZSBzaXplXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGI2NFRlbXBsYXRlIC0gYmFzZTY0LWVuY29kZWQgaW1hZ2VcbiAqIEBwYXJhbSB7aW50fSBzY3JlZW5XaWR0aCAtIHdpZHRoIG9mIHNjcmVlblxuICogQHBhcmFtIHtpbnR9IHNjcmVlbkhlaWdodCAtIGhlaWdodCBvZiBzY3JlZW5cbiAqXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBiYXNlNjQtZW5jb2RlZCBpbWFnZSwgcG90ZW50aWFsbHkgcmVzaXplZFxuICovXG5oZWxwZXJzLmVuc3VyZVRlbXBsYXRlU2l6ZSA9IGFzeW5jIGZ1bmN0aW9uIChiNjRUZW1wbGF0ZSwgc2NyZWVuV2lkdGgsIHNjcmVlbkhlaWdodCkge1xuICBsZXQgaW1nT2JqID0gYXdhaXQgaW1hZ2VVdGlsLmdldEppbXBJbWFnZShiNjRUZW1wbGF0ZSk7XG4gIGxldCB7d2lkdGg6IHRwbFdpZHRoLCBoZWlnaHQ6IHRwbEhlaWdodH0gPSBpbWdPYmouYml0bWFwO1xuXG4gIC8vIGlmIHRoZSB0ZW1wbGF0ZSBmaXRzIGluc2lkZSB0aGUgc2NyZWVuIGRpbWVuc2lvbnMsIHdlJ3JlIGdvb2RcbiAgaWYgKHRwbFdpZHRoIDw9IHNjcmVlbldpZHRoICYmIHRwbEhlaWdodCA8PSBzY3JlZW5IZWlnaHQpIHtcbiAgICByZXR1cm4gYjY0VGVtcGxhdGU7XG4gIH1cblxuICAvLyBvdGhlcndpc2UsIHNjYWxlIGl0IHRvIGZpdCBpbnNpZGUgdGhlIHNjcmVlbiBkaW1lbnNpb25zXG4gIGltZ09iaiA9IGltZ09iai5zY2FsZVRvRml0KHNjcmVlbldpZHRoLCBzY3JlZW5IZWlnaHQpO1xuICByZXR1cm4gKGF3YWl0IGltZ09iai5nZXRCdWZmZXIoaW1hZ2VVdGlsLk1JTUVfUE5HKSkudG9TdHJpbmcoJ2Jhc2U2NCcpO1xufTtcblxuLyoqXG4gKiBHZXQgdGhlIHNjcmVlbnNob3QgaW1hZ2UgdGhhdCB3aWxsIGJlIHVzZWQgZm9yIGZpbmQgYnkgZWxlbWVudCwgcG90ZW50aWFsbHlcbiAqIGFsdGVyaW5nIGl0IGluIHZhcmlvdXMgd2F5cyBiYXNlZCBvbiB1c2VyLXJlcXVlc3RlZCBzZXR0aW5nc1xuICpcbiAqIEBwYXJhbSB7aW50fSBzY3JlZW5XaWR0aCAtIHdpZHRoIG9mIHNjcmVlblxuICogQHBhcmFtIHtpbnR9IHNjcmVlbkhlaWdodCAtIGhlaWdodCBvZiBzY3JlZW5cbiAqXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBiYXNlNjQtZW5jb2RlZCBzY3JlZW5zaG90XG4gKi9cbmhlbHBlcnMuZ2V0U2NyZWVuc2hvdEZvckltYWdlRmluZCA9IGFzeW5jIGZ1bmN0aW9uIChzY3JlZW5XaWR0aCwgc2NyZWVuSGVpZ2h0KSB7XG4gIGlmICghdGhpcy5nZXRTY3JlZW5zaG90KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiVGhpcyBkcml2ZXIgZG9lcyBub3Qgc3VwcG9ydCB0aGUgcmVxdWlyZWQgJ2dldFNjcmVlbnNob3QnIGNvbW1hbmRcIik7XG4gIH1cblxuICBsZXQgYjY0U2NyZWVuc2hvdCA9IGF3YWl0IHRoaXMuZ2V0U2NyZWVuc2hvdCgpO1xuXG4gIC8vIGlmIHRoZSB1c2VyIGhhcyByZXF1ZXN0ZWQgbm90IHRvIGNvcnJlY3QgZm9yIGFzcGVjdCBvciBzaXplIGRpZmZlcmVuY2VzXG4gIC8vIGJldHdlZW4gdGhlIHNjcmVlbnNob3QgYW5kIHRoZSBzY3JlZW4sIGp1c3QgcmV0dXJuIHRoZSBzY3JlZW5zaG90IG5vd1xuICBpZiAoIXRoaXMuc2V0dGluZ3MuZ2V0U2V0dGluZ3MoKS5maXhJbWFnZUZpbmRTY3JlZW5zaG90RGltcykge1xuICAgIGxvZy5pbmZvKGBOb3QgdmVyaWZ5aW5nIHNjcmVlbnNob3QgZGltZW5zaW9ucyBtYXRjaCBzY3JlZW5gKTtcbiAgICByZXR1cm4gYjY0U2NyZWVuc2hvdDtcbiAgfVxuXG4gIC8vIG90aGVyd2lzZSwgZG8gc29tZSB2ZXJpZmljYXRpb24gb24gdGhlIHNjcmVlbnNob3QgdG8gbWFrZSBzdXJlIGl0IG1hdGNoZXNcbiAgLy8gdGhlIHNjcmVlbiBzaXplIGFuZCBhc3BlY3QgcmF0aW9cbiAgbG9nLmluZm8oJ1ZlcmlmeWluZyBzY3JlZW5zaG90IHNpemUgYW5kIGFzcGVjdCByYXRpbycpO1xuXG4gIGxldCBpbWdPYmogPSBhd2FpdCBpbWFnZVV0aWwuZ2V0SmltcEltYWdlKGI2NFNjcmVlbnNob3QpO1xuICBsZXQge3dpZHRoOiBzaG90V2lkdGgsIGhlaWdodDogc2hvdEhlaWdodH0gPSBpbWdPYmouYml0bWFwO1xuXG4gIGlmIChzY3JlZW5XaWR0aCA9PT0gc2hvdFdpZHRoICYmIHNjcmVlbkhlaWdodCA9PT0gc2hvdEhlaWdodCkge1xuICAgIC8vIHRoZSBoZWlnaHQgYW5kIHdpZHRoIG9mIHRoZSBzY3JlZW5zaG90IGFuZCB0aGUgZGV2aWNlIHNjcmVlbiBtYXRjaCwgd2hpY2hcbiAgICAvLyBtZWFucyB3ZSBzaG91bGQgYmUgc2FmZSB3aGVuIGRvaW5nIHRlbXBsYXRlIG1hdGNoZXNcbiAgICBsb2cuaW5mbygnU2NyZWVuc2hvdCBzaXplIG1hdGNoZWQgc2NyZWVuIHNpemUnKTtcbiAgICByZXR1cm4gYjY0U2NyZWVuc2hvdDtcbiAgfVxuXG4gIC8vIG90aGVyd2lzZSwgaWYgdGhleSBkb24ndCBtYXRjaCwgaXQgY291bGQgc3BlbGwgcHJvYmxlbXMgZm9yIHRoZSBhY2N1cmFjeVxuICAvLyBvZiBjb29yZGluYXRlcyByZXR1cm5lZCBieSB0aGUgaW1hZ2UgbWF0Y2ggYWxnb3JpdGhtLCBzaW5jZSB3ZSBtYXRjaCBiYXNlZFxuICAvLyBvbiB0aGUgc2NyZWVuc2hvdCBjb29yZGluYXRlcyBub3QgdGhlIGRldmljZSBjb29yZGluYXRlcyB0aGVtc2VsdmVzLiBUaGVyZVxuICAvLyBhcmUgdHdvIHBvdGVudGlhbCB0eXBlcyBvZiBtaXNtYXRjaDogYXNwZWN0IHJhdGlvIG1pc21hdGNoIGFuZCBzY2FsZVxuICAvLyBtaXNtYXRjaC4gd2UgbmVlZCB0byBkZXRlY3QgYW5kIGZpeCBib3RoXG5cbiAgY29uc3Qgc2NyZWVuQVIgPSBzY3JlZW5XaWR0aCAvIHNjcmVlbkhlaWdodDtcbiAgY29uc3Qgc2hvdEFSID0gc2hvdFdpZHRoIC8gc2hvdEhlaWdodDtcblxuICBpZiAoc2NyZWVuQVIgPT09IHNob3RBUikge1xuICAgIGxvZy5pbmZvKCdTY3JlZW5zaG90IGFzcGVjdCByYXRpbyBtYXRjaGVkIHNjcmVlbiBhc3BlY3QgcmF0aW8nKTtcbiAgfSBlbHNlIHtcbiAgICBsb2cud2FybihgV2hlbiB0cnlpbmcgdG8gZmluZCBhbiBlbGVtZW50LCBkZXRlcm1pbmVkIHRoYXQgdGhlIHNjcmVlbiBgICtcbiAgICAgICAgICAgICBgYXNwZWN0IHJhdGlvIGFuZCBzY3JlZW5zaG90IGFzcGVjdCByYXRpbyBhcmUgZGlmZmVyZW50LiBTY3JlZW4gYCArXG4gICAgICAgICAgICAgYGlzICR7c2NyZWVuV2lkdGh9eCR7c2NyZWVuSGVpZ2h0fSB3aGVyZWFzIHNjcmVlbnNob3QgaXMgYCArXG4gICAgICAgICAgICAgYCR7c2hvdFdpZHRofXgke3Nob3RIZWlnaHR9LmApO1xuICAgIHNob3RXaWR0aCA9IHNob3RXaWR0aCAvIChzaG90QVIgLyBzY3JlZW5BUik7XG4gICAgbG9nLndhcm4oYFJlc2l6aW5nIHNjcmVlbnNob3QgdG8gJHtzaG90V2lkdGh9eCR7c2hvdEhlaWdodH0gdG8gbWF0Y2ggYCArXG4gICAgICAgICAgICAgYHNjcmVlbiBhc3BlY3QgcmF0aW8gc28gdGhhdCBpbWFnZSBlbGVtZW50IGNvb3JkaW5hdGVzIGhhdmUgYSBgICtcbiAgICAgICAgICAgICBgZ3JlYXRlciBjaGFuY2Ugb2YgYmVpbmcgY29ycmVjdC5gKTtcbiAgICBpbWdPYmogPSBpbWdPYmoucmVzaXplKHNob3RXaWR0aCwgc2hvdEhlaWdodCk7XG4gIH1cblxuICAvLyBub3cgd2Uga25vdyB0aGUgYXNwZWN0IHJhdGlvcyBtYXRjaCwgYnV0IHRoZXJlIG1pZ2h0IHN0aWxsIGJlIGEgc2NhbGVcbiAgLy8gbWlzbWF0Y2gsIHNvIGp1c3QgcmVzaXplIGJhc2VkIG9uIHRoZSBzY3JlZW4gZGltZW5zaW9uc1xuICBpZiAoc2NyZWVuV2lkdGggIT09IHNob3RXaWR0aCkge1xuICAgIGxvZy5pbmZvKGBTY2FsaW5nIHNjcmVlbnNob3QgZnJvbSAke3Nob3RXaWR0aH14JHtzaG90SGVpZ2h0fSB0byBtYXRjaCBgICtcbiAgICAgICAgICAgICBgc2NyZWVuIGF0ICR7c2NyZWVuV2lkdGh9eCR7c2NyZWVuSGVpZ2h0fWApO1xuICAgIGltZ09iaiA9IGltZ09iai5yZXNpemUoc2NyZWVuV2lkdGgsIHNjcmVlbkhlaWdodCk7XG4gIH1cblxuICByZXR1cm4gKGF3YWl0IGltZ09iai5nZXRCdWZmZXIoaW1hZ2VVdGlsLk1JTUVfUE5HKSkudG9TdHJpbmcoJ2Jhc2U2NCcpO1xufTtcblxuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzLCBoZWxwZXJzKTtcbmV4cG9ydCB7IGNvbW1hbmRzLCBoZWxwZXJzLCBJTUFHRV9TVFJBVEVHWSwgQ1VTVE9NX1NUUkFURUdZIH07XG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sImZpbGUiOiJsaWIvYmFzZWRyaXZlci9jb21tYW5kcy9maW5kLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uLy4uIn0=
