"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _lodash = _interopRequireDefault(require("lodash"));

var _driver = _interopRequireDefault(require("../basedriver/driver"));

var _appiumSupport = require("appium-support");

const log = _appiumSupport.logger.getLogger('Protocol Converter');

const COMMAND_URLS_CONFLICTS = [{
  commandNames: ['execute', 'executeAsync'],
  jsonwpConverter: url => url.replace(/\/execute.*/, url.includes('async') ? '/execute_async' : '/execute'),
  w3cConverter: url => url.replace(/\/execute.*/, url.includes('async') ? '/execute/async' : '/execute/sync')
}, {
  commandNames: ['getElementScreenshot'],
  jsonwpConverter: url => url.replace(/\/element\/([^/]+)\/screenshot$/, '/screenshot/$1'),
  w3cConverter: url => url.replace(/\/screenshot\/([^/]+)/, '/element/$1/screenshot')
}, {
  commandNames: ['getWindowHandles', 'getWindowHandle'],
  jsonwpConverter: url => {
    return /\/window$/.test(url) ? url.replace(/\/window$/, '/window_handle') : url.replace(/\/window\/handle(s?)$/, '/window_handle$1');
  },
  w3cConverter: url => {
    return /\/window_handle$/.test(url) ? url.replace(/\/window_handle$/, '/window') : url.replace(/\/window_handles$/, '/window/handles');
  }
}];
const _BaseDriver$DRIVER_PR = _driver.default.DRIVER_PROTOCOL,
      MJSONWP = _BaseDriver$DRIVER_PR.MJSONWP,
      W3C = _BaseDriver$DRIVER_PR.W3C;

class ProtocolConverter {
  constructor(proxyFunc) {
    this.proxyFunc = proxyFunc;
    this._downstreamProtocol = null;
  }

  set downstreamProtocol(value) {
    this._downstreamProtocol = value;
  }

  get downstreamProtocol() {
    return this._downstreamProtocol;
  }

  getTimeoutRequestObjects(body) {
    if (this.downstreamProtocol === W3C && _lodash.default.has(body, 'ms') && _lodash.default.has(body, 'type')) {
      const typeToW3C = x => x === 'page load' ? 'pageLoad' : x;

      return [{
        [typeToW3C(body.type)]: body.ms
      }];
    }

    if (this.downstreamProtocol === MJSONWP && (!_lodash.default.has(body, 'ms') || !_lodash.default.has(body, 'type'))) {
      const typeToJSONWP = x => x === 'pageLoad' ? 'page load' : x;

      return _lodash.default.toPairs(body).filter(pair => !isNaN(parseFloat(pair[1]))).map(pair => {
        return {
          type: typeToJSONWP(pair[0]),
          ms: pair[1]
        };
      });
    }

    return [body];
  }

  proxySetTimeouts(url, method, body) {
    var _this = this;

    return (0, _asyncToGenerator2.default)(function* () {
      let response, resBody;

      const timeoutRequestObjects = _this.getTimeoutRequestObjects(body);

      log.debug(`Will send the following request bodies to /timeouts: ${JSON.stringify(timeoutRequestObjects)}`);
      var _iteratorNormalCompletion = true;
      var _didIteratorError = false;
      var _iteratorError = undefined;

      try {
        for (var _iterator = timeoutRequestObjects[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          const timeoutObj = _step.value;

          var _ref = yield _this.proxyFunc(url, method, timeoutObj);

          var _ref2 = (0, _slicedToArray2.default)(_ref, 2);

          response = _ref2[0];
          resBody = _ref2[1];

          if (_this.downstreamProtocol !== MJSONWP) {
            return [response, resBody];
          }

          if (response.statusCode >= 400) {
            return [response, resBody];
          }
        }
      } catch (err) {
        _didIteratorError = true;
        _iteratorError = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion && _iterator.return != null) {
            _iterator.return();
          }
        } finally {
          if (_didIteratorError) {
            throw _iteratorError;
          }
        }
      }

      return [response, resBody];
    })();
  }

  proxySetWindow(url, method, body) {
    var _this2 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      const bodyObj = _appiumSupport.util.safeJsonParse(body);

      if (_lodash.default.isPlainObject(bodyObj)) {
        if (_this2.downstreamProtocol === W3C && _lodash.default.has(bodyObj, 'name') && !_lodash.default.has(bodyObj, 'handle')) {
          log.debug(`Reassigned 'name' value '${bodyObj.name}' to 'handle' as per W3C spec`);
          return yield _this2.proxyFunc(url, method, {
            handle: bodyObj.name
          });
        }

        if (_this2.downstreamProtocol === MJSONWP && _lodash.default.has(bodyObj, 'handle') && !_lodash.default.has(bodyObj, 'name')) {
          log.debug(`Reassigned 'handle' value '${bodyObj.handle}' to 'name' as per JSONWP spec`);
          return yield _this2.proxyFunc(url, method, {
            name: bodyObj.handle
          });
        }
      }

      return yield _this2.proxyFunc(url, method, body);
    })();
  }

  convertAndProxy(commandName, url, method, body) {
    var _this3 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      if (!_this3.downstreamProtocol) {
        return yield _this3.proxyFunc(url, method, body);
      }

      switch (commandName) {
        case 'timeouts':
          return yield _this3.proxySetTimeouts(url, method, body);

        case 'setWindow':
          return yield _this3.proxySetWindow(url, method, body);

        default:
          break;
      }

      for (var _i = 0; _i < COMMAND_URLS_CONFLICTS.length; _i++) {
        const _COMMAND_URLS_CONFLIC = COMMAND_URLS_CONFLICTS[_i],
              commandNames = _COMMAND_URLS_CONFLIC.commandNames,
              jsonwpConverter = _COMMAND_URLS_CONFLIC.jsonwpConverter,
              w3cConverter = _COMMAND_URLS_CONFLIC.w3cConverter;

        if (!commandNames.includes(commandName)) {
          continue;
        }

        const rewrittenUrl = _this3.downstreamProtocol === MJSONWP ? jsonwpConverter(url) : w3cConverter(url);

        if (rewrittenUrl === url) {
          log.debug(`Did not know how to rewrite the original URL '${url}' ` + `for ${_this3.downstreamProtocol} protocol`);
          break;
        }

        log.info(`Rewrote the original URL '${url}' to '${rewrittenUrl}' ` + `for ${_this3.downstreamProtocol} protocol`);
        return yield _this3.proxyFunc(rewrittenUrl, method, body);
      }

      return yield _this3.proxyFunc(url, method, body);
    })();
  }

}

var _default = ProtocolConverter;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9qc29ud3AtcHJveHkvcHJvdG9jb2wtY29udmVydGVyLmpzIl0sIm5hbWVzIjpbImxvZyIsImxvZ2dlciIsImdldExvZ2dlciIsIkNPTU1BTkRfVVJMU19DT05GTElDVFMiLCJjb21tYW5kTmFtZXMiLCJqc29ud3BDb252ZXJ0ZXIiLCJ1cmwiLCJyZXBsYWNlIiwiaW5jbHVkZXMiLCJ3M2NDb252ZXJ0ZXIiLCJ0ZXN0IiwiQmFzZURyaXZlciIsIkRSSVZFUl9QUk9UT0NPTCIsIk1KU09OV1AiLCJXM0MiLCJQcm90b2NvbENvbnZlcnRlciIsImNvbnN0cnVjdG9yIiwicHJveHlGdW5jIiwiX2Rvd25zdHJlYW1Qcm90b2NvbCIsImRvd25zdHJlYW1Qcm90b2NvbCIsInZhbHVlIiwiZ2V0VGltZW91dFJlcXVlc3RPYmplY3RzIiwiYm9keSIsIl8iLCJoYXMiLCJ0eXBlVG9XM0MiLCJ4IiwidHlwZSIsIm1zIiwidHlwZVRvSlNPTldQIiwidG9QYWlycyIsImZpbHRlciIsInBhaXIiLCJpc05hTiIsInBhcnNlRmxvYXQiLCJtYXAiLCJwcm94eVNldFRpbWVvdXRzIiwibWV0aG9kIiwicmVzcG9uc2UiLCJyZXNCb2R5IiwidGltZW91dFJlcXVlc3RPYmplY3RzIiwiZGVidWciLCJKU09OIiwic3RyaW5naWZ5IiwidGltZW91dE9iaiIsInN0YXR1c0NvZGUiLCJwcm94eVNldFdpbmRvdyIsImJvZHlPYmoiLCJ1dGlsIiwic2FmZUpzb25QYXJzZSIsImlzUGxhaW5PYmplY3QiLCJuYW1lIiwiaGFuZGxlIiwiY29udmVydEFuZFByb3h5IiwiY29tbWFuZE5hbWUiLCJyZXdyaXR0ZW5VcmwiLCJpbmZvIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsR0FBRyxHQUFHQyxzQkFBT0MsU0FBUCxDQUFpQixvQkFBakIsQ0FBWjs7QUFHQSxNQUFNQyxzQkFBc0IsR0FBRyxDQUM3QjtBQUNFQyxFQUFBQSxZQUFZLEVB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QURFLEdBRWpCRyxZQUFZLENBQUNILEdBQUQsQ0FGaEI7O0FBR0EsWUFBSWlELFlBQVksS0FBS2pELEdBQXJCLEVBQTBCO0FBQ3hCTixVQUFBQSxHQUFHLENBQUN5QyxLQUFKLENBQVcsaURBQWdEbkMsR0FBSSxJQUFyRCxHQUNQLE9BQU0sTUFBSSxDQUFDYSxrQkFBbUIsV0FEakM7QUFFQTtBQUNEOztBQUNEbkIsUUFBQUEsR0FBRyxDQUFDd0QsSUFBSixDQUFVLDZCQUE0QmxELEdBQUksU0FBUWlELFlBQWEsSUFBdEQsR0FDTixPQUFNLE1BQUksQ0FBQ3BDLGtCQUFtQixXQURqQztBQUVBLHFCQUFhLE1BQUksQ0FBQ0YsU0FBTCxDQUFlc0MsWUFBZixFQUE2QmxCLE1BQTdCLEVBQXFDZixJQUFyQyxDQUFiO0FBQ0Q7O0FBR0QsbUJBQWEsTUFBSSxDQUFDTCxTQUFMLENBQWVYLEdBQWYsRUFBb0IrQixNQUFwQixFQUE0QmYsSUFBNUIsQ0FBYjtBQXJDcUQ7QUFzQ3REOztBQTFJcUI7O2VBNklUUCxpQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgQmFzZURyaXZlciBmcm9tICcuLi9iYXNlZHJpdmVyL2RyaXZlcic7XG5pbXBvcnQgeyBsb2dnZXIsIHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5cbmNvbnN0IGxvZyA9IGxvZ2dlci5nZXRMb2dnZXIoJ1Byb3RvY29sIENvbnZlcnRlcicpO1xuXG5cbmNvbnN0IENPTU1BTkRfVVJMU19DT05GTElDVFMgPSBbXG4gIHtcbiAgICBjb21tYW5kTmFtZXM6IFsnZXhlY3V0ZScsICdleGVjdXRlQXN5bmMnXSxcbiAgICBqc29ud3BDb252ZXJ0ZXI6ICh1cmwpID0+IHVybC5yZXBsYWNlKC9cXC9leGVjdXRlLiovLFxuICAgICAgdXJsLmluY2x1ZGVzKCdhc3luYycpID8gJy9leGVjdXRlX2FzeW5jJyA6ICcvZXhlY3V0ZScpLFxuICAgIHczY0NvbnZlcnRlcjogKHVybCkgPT4gdXJsLnJlcGxhY2UoL1xcL2V4ZWN1dGUuKi8sXG4gICAgICB1cmwuaW5jbHVkZXMoJ2FzeW5jJykgPyAnL2V4ZWN1dGUvYXN5bmMnIDogJy9leGVjdXRlL3N5bmMnKSxcbiAgfSxcbiAge1xuICAgIGNvbW1hbmROYW1lczogWydnZXRFbGVtZW50U2NyZWVuc2hvdCddLFxuICAgIGpzb253cENvbnZlcnRlcjogKHVybCkgPT4gdXJsLnJlcGxhY2UoL1xcL2VsZW1lbnRcXC8oW14vXSspXFwvc2NyZWVuc2hvdCQvLFxuICAgICAgJy9zY3JlZW5zaG90LyQxJyksXG4gICAgdzNjQ29udmVydGVyOiAodXJsKSA9PiB1cmwucmVwbGFjZSgvXFwvc2NyZWVuc2hvdFxcLyhbXi9dKykvLFxuICAgICAgJy9lbGVtZW50LyQxL3NjcmVlbnNob3QnKSxcbiAgfSxcbiAge1xuICAgIGNvbW1hbmROYW1lczogWydnZXRXaW5kb3dIYW5kbGVzJywgJ2dldFdpbmRvd0hhbmRsZSddLFxuICAgIGpzb253cENvbnZlcnRlcjogKHVybCkgPT4ge1xuICAgICAgcmV0dXJuIC9cXC93aW5kb3ckLy50ZXN0KHVybClcbiAgICAgICAgPyB1cmwucmVwbGFjZSgvXFwvd2luZG93JC8sICcvd2luZG93X2hhbmRsZScpXG4gICAgICAgIDogdXJsLnJlcGxhY2UoL1xcL3dpbmRvd1xcL2hhbmRsZShzPykkLywgJy93aW5kb3dfaGFuZGxlJDEnKTtcbiAgICB9LFxuICAgIHczY0NvbnZlcnRlcjogKHVybCkgPT4ge1xuICAgICAgcmV0dXJuIC9cXC93aW5kb3dfaGFuZGxlJC8udGVzdCh1cmwpXG4gICAgICAgID8gdXJsLnJlcGxhY2UoL1xcL3dpbmRvd19oYW5kbGUkLywgJy93aW5kb3cnKVxuICAgICAgICA6IHVybC5yZXBsYWNlKC9cXC93aW5kb3dfaGFuZGxlcyQvLCAnL3dpbmRvdy9oYW5kbGVzJyk7XG4gICAgfSxcbiAgfSxcbl07XG5cbmNvbnN0IHtNSlNPTldQLCBXM0N9ID0gQmFzZURyaXZlci5EUklWRVJfUFJPVE9DT0w7XG5cblxuY2xhc3MgUHJvdG9jb2xDb252ZXJ0ZXIge1xuICBjb25zdHJ1Y3RvciAocHJveHlGdW5jKSB7XG4gICAgdGhpcy5wcm94eUZ1bmMgPSBwcm94eUZ1bmM7XG4gICAgdGhpcy5fZG93bnN0cmVhbVByb3RvY29sID0gbnVsbDtcbiAgfVxuXG4gIHNldCBkb3duc3RyZWFtUHJvdG9jb2wgKHZhbHVlKSB7XG4gICAgdGhpcy5fZG93bnN0cmVhbVByb3RvY29sID0gdmFsdWU7XG4gIH1cblxuICBnZXQgZG93bnN0cmVhbVByb3RvY29sICgpIHtcbiAgICByZXR1cm4gdGhpcy5fZG93bnN0cmVhbVByb3RvY29sO1xuICB9XG5cbiAgLyoqXG4gICAqIFczQyAvdGltZW91dHMgY2FuIHRha2UgYXMgbWFueSBhcyAzIHRpbWVvdXQgdHlwZXMgYXQgb25jZSwgTUpTT05XUCAvdGltZW91dHMgb25seSB0YWtlcyBvbmVcbiAgICogYXQgYSB0aW1lLiBTbyBpZiB3ZSdyZSB1c2luZyBXM0MgYW5kIHByb3h5aW5nIHRvIE1KU09OV1AgYW5kIHRoZXJlJ3MgbW9yZSB0aGFuIG9uZSB0aW1lb3V0IHR5cGVcbiAgICogcHJvdmlkZWQgaW4gdGhlIHJlcXVlc3QsIHdlIG5lZWQgdG8gZG8gMyBwcm94aWVzIGFuZCBjb21iaW5lIHRoZSByZXN1bHRcbiAgICpcbiAgICogQHBhcmFtIHtPYmplY3R9IGJvZHkgUmVxdWVzdCBib2R5XG4gICAqIEByZXR1cm4ge0FycmF5fSBBcnJheSBvZiBXM0MgKyBNSlNPTldQIGNvbXBhdGlibGUgdGltZW91dCBvYmplY3RzXG4gICAqL1xuICBnZXRUaW1lb3V0UmVxdWVzdE9iamVjdHMgKGJvZHkpIHtcbiAgICBpZiAodGhpcy5kb3duc3RyZWFtUHJvdG9jb2wgPT09IFczQyAmJiBfLmhhcyhib2R5LCAnbXMnKSAmJiBfLmhhcyhib2R5LCAndHlwZScpKSB7XG4gICAgICBjb25zdCB0eXBlVG9XM0MgPSAoeCkgPT4geCA9PT0gJ3BhZ2UgbG9hZCcgPyAncGFnZUxvYWQnIDogeDtcbiAgICAgIHJldHVybiBbe1xuICAgICAgICBbdHlwZVRvVzNDKGJvZHkudHlwZSldOiBib2R5Lm1zLFxuICAgICAgfV07XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuZG93bnN0cmVhbVByb3RvY29sID09PSBNSlNPTldQICYmICghXy5oYXMoYm9keSwgJ21zJykgfHwgIV8uaGFzKGJvZHksICd0eXBlJykpKSB7XG4gICAgICBjb25zdCB0eXBlVG9KU09OV1AgPSAoeCkgPT4geCA9PT0gJ3BhZ2VMb2FkJyA/ICdwYWdlIGxvYWQnIDogeDtcbiAgICAgIHJldHVybiBfLnRvUGFpcnMoYm9keSlcbiAgICAgICAgLmZpbHRlcigocGFpcikgPT4gIWlzTmFOKHBhcnNlRmxvYXQocGFpclsxXSkpKVxuICAgICAgICAubWFwKChwYWlyKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHR5cGU6IHR5cGVUb0pTT05XUChwYWlyWzBdKSxcbiAgICAgICAgICAgIG1zOiBwYWlyWzFdLFxuICAgICAgICAgIH07XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiBbYm9keV07XG4gIH1cblxuICAvKipcbiAgICogUHJveHkgYW4gYXJyYXkgb2YgdGltZW91dCBvYmplY3RzIGFuZCBtZXJnZSB0aGUgcmVzdWx0XG4gICAqIEBwYXJhbSB7U3RyaW5nfSB1cmwgRW5kcG9pbnQgdXJsXG4gICAqIEBwYXJhbSB7U3RyaW5nfSBtZXRob2QgRW5kcG9pbnQgbWV0aG9kXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBib2R5IFJlcXVlc3QgYm9keVxuICAgKi9cbiAgYXN5bmMgcHJveHlTZXRUaW1lb3V0cyAodXJsLCBtZXRob2QsIGJvZHkpIHtcbiAgICBsZXQgcmVzcG9uc2UsIHJlc0JvZHk7XG5cbiAgICBjb25zdCB0aW1lb3V0UmVxdWVzdE9iamVjdHMgPSB0aGlzLmdldFRpbWVvdXRSZXF1ZXN0T2JqZWN0cyhib2R5KTtcbiAgICBsb2cuZGVidWcoYFdpbGwgc2VuZCB0aGUgZm9sbG93aW5nIHJlcXVlc3QgYm9kaWVzIHRvIC90aW1lb3V0czogJHtKU09OLnN0cmluZ2lmeSh0aW1lb3V0UmVxdWVzdE9iamVjdHMpfWApO1xuICAgIGZvciAoY29uc3QgdGltZW91dE9iaiBvZiB0aW1lb3V0UmVxdWVzdE9iamVjdHMpIHtcbiAgICAgIFtyZXNwb25zZSwgcmVzQm9keV0gPSBhd2FpdCB0aGlzLnByb3h5RnVuYyh1cmwsIG1ldGhvZCwgdGltZW91dE9iaik7XG5cbiAgICAgIC8vIElmIHdlIGdvdCBhIG5vbi1NSlNPTldQIHJlc3BvbnNlLCByZXR1cm4gdGhlIHJlc3VsdCwgbm90aGluZyBsZWZ0IHRvIGRvXG4gICAgICBpZiAodGhpcy5kb3duc3RyZWFtUHJvdG9jb2wgIT09IE1KU09OV1ApIHtcbiAgICAgICAgcmV0dXJuIFtyZXNwb25zZSwgcmVzQm9keV07XG4gICAgICB9XG5cbiAgICAgIC8vIElmIHdlIGdvdCBhbiBlcnJvciwgcmV0dXJuIHRoZSBlcnJvciByaWdodCBhd2F5XG4gICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzQ29kZSA+PSA0MDApIHtcbiAgICAgICAgcmV0dXJuIFtyZXNwb25zZSwgcmVzQm9keV07XG4gICAgICB9XG5cbiAgICAgIC8vIC4uLk90aGVyd2lzZSwgY29udGludWUgdG8gdGhlIG5leHQgdGltZW91dHMgY2FsbFxuICAgIH1cbiAgICByZXR1cm4gW3Jlc3BvbnNlLCByZXNCb2R5XTtcbiAgfVxuXG4gIGFzeW5jIHByb3h5U2V0V2luZG93ICh1cmwsIG1ldGhvZCwgYm9keSkge1xuICAgIGNvbnN0IGJvZHlPYmogPSB1dGlsLnNhZmVKc29uUGFyc2UoYm9keSk7XG4gICAgaWYgKF8uaXNQbGFpbk9iamVjdChib2R5T2JqKSkge1xuICAgICAgaWYgKHRoaXMuZG93bnN0cmVhbVByb3RvY29sID09PSBXM0MgJiYgXy5oYXMoYm9keU9iaiwgJ25hbWUnKSAmJiAhXy5oYXMoYm9keU9iaiwgJ2hhbmRsZScpKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgUmVhc3NpZ25lZCAnbmFtZScgdmFsdWUgJyR7Ym9keU9iai5uYW1lfScgdG8gJ2hhbmRsZScgYXMgcGVyIFczQyBzcGVjYCk7XG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnByb3h5RnVuYyh1cmwsIG1ldGhvZCwge2hhbmRsZTogYm9keU9iai5uYW1lfSk7XG4gICAgICB9XG4gICAgICBpZiAodGhpcy5kb3duc3RyZWFtUHJvdG9jb2wgPT09IE1KU09OV1AgJiYgXy5oYXMoYm9keU9iaiwgJ2hhbmRsZScpICYmICFfLmhhcyhib2R5T2JqLCAnbmFtZScpKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgUmVhc3NpZ25lZCAnaGFuZGxlJyB2YWx1ZSAnJHtib2R5T2JqLmhhbmRsZX0nIHRvICduYW1lJyBhcyBwZXIgSlNPTldQIHNwZWNgKTtcbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlGdW5jKHVybCwgbWV0aG9kLCB7bmFtZTogYm9keU9iai5oYW5kbGV9KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUZ1bmModXJsLCBtZXRob2QsIGJvZHkpO1xuICB9XG5cbiAgLyoqXG4gICAqIEhhbmRsZSBcImNyb3NzaW5nXCIgZW5kcG9pbnRzIGZvciB0aGUgY2FzZVxuICAgKiB3aGVuIHVwc3RyZWFtIGFuZCBkb3duc3RyZWFtIGRyaXZlcnMgb3BlcmF0ZSBkaWZmZXJlbnQgcHJvdG9jb2xzXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBjb21tYW5kTmFtZVxuICAgKiBAcGFyYW0ge3N0cmluZ30gdXJsXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBtZXRob2RcbiAgICogQHBhcmFtIHs/c3RyaW5nfG9iamVjdH0gYm9keVxuICAgKiBAcmV0dXJucyBUaGUgcHJveHlmeWluZyByZXN1bHQgYXMgW3Jlc3BvbnNlLCByZXNwb25zZUJvZHldIHR1cGxlXG4gICAqL1xuICBhc3luYyBjb252ZXJ0QW5kUHJveHkgKGNvbW1hbmROYW1lLCB1cmwsIG1ldGhvZCwgYm9keSkge1xuICAgIGlmICghdGhpcy5kb3duc3RyZWFtUHJvdG9jb2wpIHtcbiAgICAgIC8vIFRoZXJlIGlzIG5vIHBvaW50IHRvIGNvbnZlcnQgYW55dGhpbmcgaWYgd2UgZG8gbm90IGtub3dcbiAgICAgIC8vIGZvciB3aGljaCBwcm90b2NvbCB0aGUgY29udmVyc2lvbiBzaG91bGQgYmUgZG9uZVxuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlGdW5jKHVybCwgbWV0aG9kLCBib2R5KTtcbiAgICB9XG5cbiAgICAvLyBTYW1lIHVybCwgYnV0IGRpZmZlcmVudCBhcmd1bWVudHNcbiAgICBzd2l0Y2ggKGNvbW1hbmROYW1lKSB7XG4gICAgICBjYXNlICd0aW1lb3V0cyc6XG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnByb3h5U2V0VGltZW91dHModXJsLCBtZXRob2QsIGJvZHkpO1xuICAgICAgY2FzZSAnc2V0V2luZG93JzpcbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlTZXRXaW5kb3codXJsLCBtZXRob2QsIGJvZHkpO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgYnJlYWs7XG4gICAgfVxuXG4gICAgLy8gU2FtZSBhcmd1bWVudHMsIGJ1dCBkaWZmZXJlbnQgVVJMc1xuICAgIGZvciAoY29uc3Qge2NvbW1hbmROYW1lcywganNvbndwQ29udmVydGVyLCB3M2NDb252ZXJ0ZXJ9IG9mIENPTU1BTkRfVVJMU19DT05GTElDVFMpIHtcbiAgICAgIGlmICghY29tbWFuZE5hbWVzLmluY2x1ZGVzKGNvbW1hbmROYW1lKSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcmV3cml0dGVuVXJsID0gdGhpcy5kb3duc3RyZWFtUHJvdG9jb2wgPT09IE1KU09OV1BcbiAgICAgICAgPyBqc29ud3BDb252ZXJ0ZXIodXJsKVxuICAgICAgICA6IHczY0NvbnZlcnRlcih1cmwpO1xuICAgICAgaWYgKHJld3JpdHRlblVybCA9PT0gdXJsKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgRGlkIG5vdCBrbm93IGhvdyB0byByZXdyaXRlIHRoZSBvcmlnaW5hbCBVUkwgJyR7dXJsfScgYCArXG4gICAgICAgICAgYGZvciAke3RoaXMuZG93bnN0cmVhbVByb3RvY29sfSBwcm90b2NvbGApO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGxvZy5pbmZvKGBSZXdyb3RlIHRoZSBvcmlnaW5hbCBVUkwgJyR7dXJsfScgdG8gJyR7cmV3cml0dGVuVXJsfScgYCArXG4gICAgICAgIGBmb3IgJHt0aGlzLmRvd25zdHJlYW1Qcm90b2NvbH0gcHJvdG9jb2xgKTtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnByb3h5RnVuYyhyZXdyaXR0ZW5VcmwsIG1ldGhvZCwgYm9keSk7XG4gICAgfVxuXG4gICAgLy8gTm8gbWF0Y2hlcyBmb3VuZC4gUHJvY2VlZCBub3JtYWxseVxuICAgIHJldHVybiBhd2FpdCB0aGlzLnByb3h5RnVuYyh1cmwsIG1ldGhvZCwgYm9keSk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgUHJvdG9jb2xDb252ZXJ0ZXI7XG4iXSwiZmlsZSI6ImxpYi9qc29ud3AtcHJveHkvcHJvdG9jb2wtY29udmVydGVyLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
