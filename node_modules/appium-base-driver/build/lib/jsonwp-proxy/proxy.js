"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.JWProxy = void 0;

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _requestPromise = _interopRequireDefault(require("request-promise"));

var _status = require("../jsonwp-status/status");

var _errors = require("../protocol/errors");

var _driver = _interopRequireDefault(require("../basedriver/driver"));

var _routes = require("../protocol/routes");

var _protocolConverter = _interopRequireDefault(require("./protocol-converter"));

const log = _appiumSupport.logger.getLogger('JSONWP Proxy');

const LOG_OBJ_LENGTH = 1024;
const DEFAULT_REQUEST_TIMEOUT = 240000;
const _BaseDriver$DRIVER_PR = _driver.default.DRIVER_PROTOCOL,
      MJSONWP = _BaseDriver$DRIVER_PR.MJSONWP,
      W3C = _BaseDriver$DRIVER_PR.W3C;

class JWProxy {
  constructor(opts = {}) {
    Object.assign(this, {
      scheme: 'http',
      server: 'localhost',
      port: 4444,
      base: '/wd/hub',
      sessionId: null,
      timeout: DEFAULT_REQUEST_TIMEOUT
    }, opts);
    this.scheme = this.scheme.toLowerCase();
    this._activeRequests = [];
    this._downstreamProtocol = null;
    this.protocolConverter = new _protocolConverter.default(this.proxy.bind(this));
  }

  request(...args) {
    var _this = this;

    return (0, _asyncToGenerator2.default)(function* () {
      const currentRequest = (0, _requestPromise.default)(...args);

      _this._activeRequests.push(currentRequest);

      return yield currentRequest.finally(() => _lodash.default.pull(_this._activeRequests, currentRequest));
    })();
  }

  getActiveRequestsCount() {
    return this._activeRequests.length;
  }

  cancelActiveRequests() {
    try {
      var _iteratorNormalCompletion = true;
      var _didIteratorError = false;
      var _iteratorError = undefined;

      try {
        for (var _iterator = this._activeRequests[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          let r = _step.value;
          r.cancel();
        }
      } catch (err) {
        _didIteratorError = true;
        _iteratorError = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion && _iterator.return != null) {
            _iterator.return();
          }
        } finally {
          if (_didIteratorError) {
            throw _iteratorError;
          }
        }
      }
    } finally {
      this._activeRequests = [];
    }
  }

  endpointRequiresSessionId(endpoint) {
    return !_lodash.default.includes(['/session', '/sessions', '/status'], endpoint);
  }

  set downstreamProtocol(value) {
    this._downstreamProtocol = value;
    this.protocolConverter.downstreamProtocol = value;
  }

  get downstreamProtocol() {
    return this._downstreamProtocol;
  }

  getUrlForProxy(url) {
    if (url === '') {
      url = '/';
    }

    const proxyBase = `${this.scheme}://${this.server}:${this.port}${this.base}`;
    const endpointRe = '(/(session|status))';
    let remainingUrl = '';

    if (/^http/.test(url)) {
      const first = new RegExp(`(https?://.+)${endpointRe}`).exec(url);

      if (!first) {
        throw new Error('Got a complete url but could not extract JWP endpoint');
      }

      remainingUrl = url.replace(first[1], '');
    } else if (new RegExp('^/').test(url)) {
      remainingUrl = url;
    } else {
      throw new Error(`Did not know what to do with url '${url}'`);
    }

    const stripPrefixRe = new RegExp('^.*?(/(session|status).*)$');

    if (stripPrefixRe.test(remainingUrl)) {
      remainingUrl = stripPrefixRe.exec(remainingUrl)[1];
    }

    if (!new RegExp(endpointRe).test(remainingUrl)) {
      remainingUrl = `/session/${this.sessionId}${remainingUrl}`;
    }

    const requiresSessionId = this.endpointRequiresSessionId(remainingUrl);

    if (requiresSessionId && this.sessionId === null) {
      throw new Error('Trying to proxy a session command without session id');
    }

    const sessionBaseRe = new RegExp('^/session/([^/]+)');

    if (sessionBaseRe.test(remainingUrl)) {
      const match = sessionBaseRe.exec(remainingUrl);
      remainingUrl = remainingUrl.replace(match[1], this.sessionId);
    } else if (requiresSessionId) {
      throw new Error(`Could not find :session section for url: ${remainingUrl}`);
    }

    remainingUrl = remainingUrl.replace(/\/$/, '');
    return proxyBase + remainingUrl;
  }

  proxy(url, method, body = null) {
    var _this2 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      method = method.toUpperCase();

      const newUrl = _this2.getUrlForProxy(url);

      const reqOpts = {
        agent: false,
        url: newUrl,
        method,
        headers: {
          'content-type': 'application/json; charset=utf-8',
          'user-agent': 'appium',
          accept: 'application/json, */*'
        },
        resolveWithFullResponse: true,
        timeout: _this2.timeout
      };

      if (body !== null) {
        if (typeof body !== 'object') {
          body = JSON.parse(body);
        }

        reqOpts.json = body;
      }

      if (method === 'GET') {
        reqOpts.json = null;
      }

      log.debug(`Proxying [${method} ${url || "/"}] to [${method} ${newUrl}] ` + (body ? `with body: ${_lodash.default.truncate(JSON.stringify(body), {
        length: LOG_OBJ_LENGTH
      })}` : 'with no body'));
      let res, resBody;

      try {
        res = yield _this2.request(reqOpts);
        resBody = res.body;
        log.debug(`Got response with status ${res.statusCode}: ${_lodash.default.truncate(JSON.stringify(resBody), {
          length: LOG_OBJ_LENGTH
        })}`);

        if (/\/session$/.test(url) && method === 'POST') {
          if (res.statusCode === 200) {
            _this2.sessionId = resBody.sessionId;
          } else if (res.statusCode === 303) {
            _this2.sessionId = /\/session\/([^/]+)/.exec(resBody)[1];
          }
        }

        const resBodyObj = _appiumSupport.util.safeJsonParse(resBody);

        if (!_this2.downstreamProtocol) {
          _this2.downstreamProtocol = _this2.getProtocolFromResBody(resBodyObj);
        }

        if (res.statusCode < 400 && _this2.downstreamProtocol === MJSONWP && parseInt(resBodyObj.status, 10) !== 0) {
          const message = `The request to ${url} has failed`;
          const err = new Error(message);
          err.message = message;
          err.error = resBody;
          err.statusCode = 500;
          throw err;
        }
      } catch (e) {
        let responseError = e.error;

        try {
          responseError = JSON.parse(responseError);
        } catch (e1) {
          log.warn(`Got an unexpected response: ` + _lodash.default.truncate(_lodash.default.isString(responseError) ? responseError : JSON.stringify(responseError), {
            length: 300
          }));
        }

        throw new _errors.errors.ProxyRequestError(`Could not proxy command to remote server. ` + `Original error: ${e.message}`, responseError, e.statusCode);
      }

      return [res, resBody];
    })();
  }

  getProtocolFromResBody(resBody) {
    if (!_lodash.default.isPlainObject(resBody)) {
      try {
        resBody = JSON.parse(resBody);
      } catch (err) {
        return;
      }
    }

    if (_appiumSupport.util.hasValue(resBody.status)) {
      return MJSONWP;
    }

    if (_appiumSupport.util.hasValue(resBody.value)) {
      return W3C;
    }
  }

  requestToCommandName(url, method) {
    const extractCommandName = pattern => {
      const pathMatch = pattern.exec(url);
      return pathMatch ? (0, _routes.routeToCommandName)(pathMatch[1], method) : null;
    };

    let commandName = (0, _routes.routeToCommandName)(url, method);

    if (!commandName && _lodash.default.includes(url, '/wd/hub/session/')) {
      commandName = extractCommandName(/\/wd\/hub\/session\/[^/]+(.+)/);
    }

    if (!commandName && _lodash.default.includes(url, '/wd/hub/')) {
      commandName = extractCommandName(/\/wd\/hub(\/.+)/);
    }

    return commandName;
  }

  proxyCommand(url, method, body = null) {
    var _this3 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      const commandName = _this3.requestToCommandName(url, method);

      if (!commandName) {
        return yield _this3.proxy(url, method, body);
      }

      log.debug(`Matched '${url}' to command name '${commandName}'`);
      return yield _this3.protocolConverter.convertAndProxy(commandName, url, method, body);
    })();
  }

  command(url, method, body = null) {
    var _this4 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      let response;
      let resBody;

      try {
        var _ref = yield _this4.proxyCommand(url, method, body);

        var _ref2 = (0, _slicedToArray2.default)(_ref, 2);

        response = _ref2[0];
        resBody = _ref2[1];
      } catch (err) {
        if ((0, _errors.isErrorType)(err, _errors.errors.ProxyRequestError)) {
          throw err.getActualError();
        }

        throw new _errors.errors.UnknownError(err.message);
      }

      resBody = _appiumSupport.util.safeJsonParse(resBody);

      let protocol = _this4.getProtocolFromResBody(resBody);

      if (protocol === MJSONWP) {
        if (response.statusCode === 200 && resBody.status === 0) {
          return resBody.value;
        }

        const status = parseInt(resBody.status, 10);

        if (!isNaN(status) && status !== 0) {
          let message = resBody.value;

          if (_lodash.default.has(resBody.value, 'message')) {
            message = _lodash.default.isEmpty(message) ? resBody.value.message : `${message} ${resBody.value.message}`;
          }

          throw (0, _errors.errorFromMJSONWPStatusCode)(status, _lodash.default.isEmpty(message) ? (0, _status.getSummaryByCode)(status) : message);
        }
      } else if (protocol === W3C) {
        if (response.statusCode < 300) {
          return resBody.value;
        }

        if (_lodash.default.isPlainObject(resBody.value) && resBody.value.error) {
          throw (0, _errors.errorFromW3CJsonCode)(resBody.value.error, resBody.value.message, resBody.value.stacktrace);
        }
      } else if (response.statusCode === 200) {
        return resBody;
      }

      throw new _errors.errors.UnknownError(`Did not know what to do with response code '${response.statusCode}' ` + `and response body '${_lodash.default.truncate(JSON.stringify(resBody), {
        length: 300
      })}'`);
    })();
  }

  getSessionIdFromUrl(url) {
    const match = url.match(/\/session\/([^/]+)/);
    return match ? match[1] : null;
  }

  proxyReqRes(req, res) {
    var _this5 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      let _ref3 = yield _this5.proxyCommand(req.originalUrl, req.method, req.body),
          _ref4 = (0, _slicedToArray2.default)(_ref3, 2),
          response = _ref4[0],
          body = _ref4[1];

      res.headers = response.headers;
      res.set('content-type', response.headers['content-type']);
      body = _appiumSupport.util.safeJsonParse(body);

      if (body && body.sessionId) {
        const reqSessionId = _this5.getSessionIdFromUrl(req.originalUrl);

        if (reqSessionId) {
          log.info(`Replacing sessionId ${body.sessionId} with ${reqSessionId}`);
          body.sessionId = reqSessionId;
        } else if (_this5.sessionId) {
          log.info(`Replacing sessionId ${body.sessionId} with ${_this5.sessionId}`);
          body.sessionId = _this5.sessionId;
        }
      }

      res.status(response.statusCode).send(JSON.stringify(body));
    })();
  }

}

exports.JWProxy = JWProxy;
var _default = JWProxy;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9qc29ud3AtcHJveHkvcHJveHkuanMiXSwibmFtZXMiOlsibG9nIiwibG9nZ2VyIiwiZ2V0TG9nZ2VyIiwiTE9HX09CSl9MRU5HVEgiLCJERUZBVUxUX1JFUVVFU1RfVElNRU9VVCIsIkJhc2VEcml2ZXIiLCJEUklWRVJfUFJPVE9DT0wiLCJNSlNPTldQIiwiVzNDIiwiSldQcm94eSIsImNvbnN0cnVjdG9yIiwib3B0cyIsIk9iamVjdCIsImFzc2lnbiIsInNjaGVtZSIsInNlcnZlciIsInBvcnQiLCJiYXNlIiwic2Vzc2lvbklkIiwidGltZW91dCIsInRvTG93ZXJDYXNlIiwiX2FjdGl2ZVJlcXVlc3RzIiwiX2Rvd25zdHJlYW1Qcm90b2NvbCIsInByb3RvY29sQ29udmVydGVyIiwiUHJvdG9jb2xDb252ZXJ0ZXIiLCJwcm94eSIsImJpbmQiLCJyZXF1ZXN0IiwiYXJncyIsImN1cnJlbnRSZXF1ZXN0IiwicHVzaCIsImZpbmFsbHkiLCJfIiwicHVsbCIsImdldEFjdGl2ZVJlcXVlc3RzQ291bnQiLCJsZW5ndGgiLCJjYW5jZWxBY3RpdmVSZXF1ZXN0cyIsInIiLCJjYW5jZWwiLCJlbmRwb2ludFJlcXVpcmVzU2Vzc2lvbklkIiwiZW5kcG9pbnQiLCJpbmNsdWRlcyIsImRvd25zdHJlYW1Qcm90b2NvbCIsInZhbHVlIiwiZ2V0VXJsRm9yUHJveHkiLCJ1cmwiLCJwcm94eUJhc2UiLCJlbmRwb2ludFJlIiwicmVtYWluaW5nVXJsIiwidGVzdCIsImZpcnN0IiwiUmVnRXhwIiwiZXhlYyIsIkVycm9yIiwicmVwbGFjZSIsInN0cmlwUHJlZml4UmUiLCJyZXF1aXJlc1Nlc3Npb25JZCIsInNlc3Npb25CYXNlUmUiLCJtYXRjaCIsIm1ldGhvZCIsImJvZHkiLCJ0b1VwcGVyQ2FzZSIsIm5ld1VybCIsInJlcU9wdHMiLCJhZ2VudCIsImhlYWRlcnMiLCJhY2NlcHQiLCJyZXNvbHZlV2l0aEZ1bGxSZXNwb25zZSIsIkpTT04iLCJwYXJzZSIsImpzb24iLCJkZWJ1ZyIsInRydW5jYXRlIiwic3RyaW5naWZ5IiwicmVzIiwicmVzQm9keSIsInN0YXR1c0NvZGUiLCJyZXNCb2R5T2JqIiwidXRpbCIsInNhZmVKc29uUGFyc2UiLCJnZXRQcm90b2NvbEZyb21SZXNCb2R5IiwicGFyc2VJbnQiLCJzdGF0dXMiLCJtZXNzYWdlIiwiZXJyIiwiZXJyb3IiLCJlIiwicmVzcG9uc2VFcnJvciIsImUxIiwid2FybiIsImlzU3RyaW5nIiwiZXJyb3JzIiwiUHJveHlSZXF1ZXN0RXJyb3IiLCJpc1BsYWluT2JqZWN0IiwiaGFzVmFsdWUiLCJyZXF1ZXN0VG9Db21tYW5kTmFtZSIsImV4dHJhY3RDb21tYW5kTmFtZSIsInBhdHRlcm4iLCJwYXRoTWF0Y2giLCJjb21tYW5kTmFtZSIsInByb3h5Q29tbWFuZCIsImNvbnZlcnRBbmRQcm94eSIsImNvbW1hbmQiLCJyZXNwb25zZSIsImdldEFjdHVhbEVycm9yIiwiVW5rbm93bkVycm9yIiwicHJvdG9jb2wiLCJpc05hTiIsImhhcyIsImlzRW1wdHkiLCJzdGFja3RyYWNlIiwiZ2V0U2Vzc2lvbklkRnJvbVVybCIsInByb3h5UmVxUmVzIiwicmVxIiwib3JpZ2luYWxVcmwiLCJzZXQiLCJyZXFTZXNzaW9uSWQiLCJpbmZvIiwic2VuZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLE1BQU1BLEdBQUcsR0FBR0Msc0JBQU9DLFNBQVAsQ0FBaUIsY0FBakIsQ0FBWjs7QUFFQSxNQUFNQyxjQUFjLEdBQUcsSUFBdkI7QUFDQSxNQUFNQyx1QkFBdUIsR0FBRyxNQUFoQzs4QkFFdUJDLGdCQUFXQyxlO01BQTNCQyxPLHlCQUFBQSxPO01BQVNDLEcseUJBQUFBLEc7O0FBRWhCLE1BQU1DLE9BQU4sQ0FBYztBQUNaQyxFQUFBQSxXQUFXLENBQUVDLElBQUksR0FBRyxFQUFULEVBQWE7QUFDdEJDLElBQUFBLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjLElBQWQsRUFBb0I7QUFDbEJDLE1BQUFBLE1BQU0sRUFBRSxNQURVO0FBRWxCQyxNQUFBQSxNQUFNLEVBQUUsV0FGVTtBQUdsQkMsTUFBQUEsSUFBSSxFQUFFLElBSFk7QUFJbEJDLE1BQUFBLElBQUksRUFBRSxTQUpZO0FBS2xCQyxNQUFBQSxTQUFTLEVBQUUsSUFMTztBQU1sQkMsTUFBQUEsT0FBTyxFQUFFZjtBQU5TLEtBQXBCLEVBT0dPLElBUEg7QUFRQSxTQUFLRyxNQUFMLEdBQWMsS0FBS0EsTUFBTCxDQUFZTSxXQUFaLEVBQWQ7QUFDQSxTQUFLQyxlQUFMLEdBQXVCLEVBQXZCO0FBQ0EsU0FBS0MsbUJBQUwsR0FBMkIsSUFBM0I7QUFDQSxTQUFLQyxpQkFBTCxHQUF5QixJQUFJQywwQkFBSixDQUFzQixLQUFLQyxLQUFMLENBQVdDLElBQVgsQ0FBZ0IsSUFBaEIsQ0FBdEIsQ0FBekI7QUFDRDs7QUFJS0MsRUFBQUEsT0FBTixDQUFlLEdBQUdDLElBQWxCLEVBQXdCO0FBQUE7O0FBQUE7QUFDdEIsWUFBTUMsY0FBYyxHQUFHLDZCQUFRLEdBQUdELElBQVgsQ0FBdkI7O0FBQ0EsTUFBQSxLQUFJLENBQUNQLGVBQUwsQ0FBcUJTLElBQXJCLENBQTBCRCxjQUExQjs7QUFDQSxtQkFBYUEsY0FBYyxDQUFDRSxPQUFmLENBQXVCLE1BQU1DLGdCQUFFQyxJQUFGLENBQU8sS0FBSSxDQUFDWixlQUFaLEVBQTZCUSxjQUE3QixDQUE3QixDQUFiO0FBSHNCO0FBSXZCOztBQUVESyxFQUFBQSxzQkFBc0IsR0FBSTtBQUN4QixXQUFPLEtBQUtiLGVBQUwsQ0FBcUJjLE1BQTVCO0FBQ0Q7O0FBRURDLEVBQUFBLG9CQUFvQixHQUFJO0FBQ3RCLFFBQUk7QUFBQTtBQUFBO0FBQUE7O0FBQUE7QUFDRiw2QkFBYyxLQUFLZixlQUFuQiw4SEFBb0M7QUFBQSxjQUEzQmdCLENBQTJCO0FBQ2xDQSxVQUFBQSxDQUFDLENBQUNDLE1BQUY7QUFDRDtBQUhDO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFJSCxLQUpELFNBSVU7QUFDUixXQUFLakIsZUFBTCxHQUF1QixFQUF2QjtBQUNEO0FBQ0Y7O0FBRURrQixFQUFBQSx5QkFBeUIsQ0FBRUMsUUFBRixFQUFZO0FBQ25DLFdBQU8sQ0FBQ1IsZ0JBQUVTLFFBQUYsQ0FBVyxDQUFDLFVBQUQsRUFBYSxXQUFiLEVBQTBCLFNBQTFCLENBQVgsRUFBaURELFFBQWpELENBQVI7QUFDRDs7QUFFRCxNQUFJRSxrQkFBSixDQUF3QkMsS0FBeEIsRUFBK0I7QUFDN0IsU0FBS3JCLG1CQUFMLEdBQTJCcUIsS0FBM0I7QUFDQSxTQUFLcEIsaUJBQUwsQ0FBdUJtQixrQkFBdkIsR0FBNENDLEtBQTVDO0FBQ0Q7O0FBRUQsTUFBSUQsa0JBQUosR0FBMEI7QUFDeEIsV0FBTyxLQUFLcEIsbUJBQVo7QUFDRDs7QUFFRHNCLEVBQUFBLGNBQWMsQ0FBRUMsR0FBRixFQUFPO0FBQ25CLFFBQUlBLEdBQUcsS0FBSyxFQUFaLEVBQWdCO0FBQ2RBLE1BQUFBLEdBQUcsR0FBRyxHQUFOO0FBQ0Q7O0FBQ0QsVUFBTUMsU0FBUyxHQUFJLEdBQUUsS0FBS2hDLE1BQU8sTUFBSyxLQUFLQyxNQUFPLElBQUcsS0FBS0MsSUFBSyxHQUFFLEtBQUtDLElBQUssRUFBM0U7QUFDQSxVQUFNOEIsVUFBVSxHQUFHLHFCQUFuQjtBQUNBLFFBQUlDLFlBQVksR0FBRyxFQUFuQjs7QUFDQSxRQUFJLFFBQVFDLElBQVIsQ0FBYUosR0FBYixDQUFKLEVBQXVCO0FBQ3JCLFlBQU1LLEtBQUssR0FBSSxJQUFJQyxNQUFKLENBQVksZ0JBQWVKLFVBQVcsRUFBdEMsQ0FBRCxDQUEyQ0ssSUFBM0MsQ0FBZ0RQLEdBQWhELENBQWQ7O0FBQ0EsVUFBSSxDQUFDSyxLQUFMLEVBQVk7QUFDVixjQUFNLElBQUlHLEtBQUosQ0FBVSx1REFBVixDQUFOO0FBQ0Q7O0FBQ0RMLE1BQUFBLFlBQVksR0FBR0gsR0FBRyxDQUFDUyxPQUFKLENBQVlKLEtBQUssQ0FBQyxDQUFELENBQWpCLEVBQXNCLEVBQXRCLENBQWY7QUFDRCxLQU5ELE1BTU8sSUFBSyxJQUFJQyxNQUFKLENBQVcsSUFBWCxDQUFELENBQW1CRixJQUFuQixDQUF3QkosR0FBeEIsQ0FBSixFQUFrQztBQUN2Q0csTUFBQUEsWUFBWSxHQUFHSCxHQUFmO0FBQ0QsS0FGTSxNQUVBO0FBQ0wsWUFBTSxJQUFJUSxLQUFKLENBQVcscUNBQW9DUixHQUFJLEdBQW5ELENBQU47QUFDRDs7QUFFRCxVQUFNVSxhQUFhLEdBQUcsSUFBSUosTUFBSixDQUFXLDRCQUFYLENBQXRCOztBQUNBLFFBQUlJLGFBQWEsQ0FBQ04sSUFBZCxDQUFtQkQsWUFBbkIsQ0FBSixFQUFzQztBQUNwQ0EsTUFBQUEsWUFBWSxHQUFHTyxhQUFhLENBQUNILElBQWQsQ0FBbUJKLFlBQW5CLEVBQWlDLENBQWpDLENBQWY7QUFDRDs7QUFFRCxRQUFJLENBQUUsSUFBSUcsTUFBSixDQUFXSixVQUFYLENBQUQsQ0FBeUJFLElBQXpCLENBQThCRCxZQUE5QixDQUFMLEVBQWtEO0FBQ2hEQSxNQUFBQSxZQUFZLEdBQUksWUFBVyxLQUFLOUIsU0FBVSxHQUFFOEIsWUFBYSxFQUF6RDtBQUNEOztBQUVELFVBQU1RLGlCQUFpQixHQUFHLEtBQUtqQix5QkFBTCxDQUErQlMsWUFBL0IsQ0FBMUI7O0FBRUEsUUFBSVEsaUJBQWlCLElBQUksS0FBS3RDLFNBQUwsS0FBbUIsSUFBNUMsRUFBa0Q7QUFDaEQsWUFBTSxJQUFJbUMsS0FBSixDQUFVLHNEQUFWLENBQU47QUFDRDs7QUFFRCxVQUFNSSxhQUFhLEdBQUcsSUFBSU4sTUFBSixDQUFXLG1CQUFYLENBQXRCOztBQUNBLFFBQUlNLGFBQWEsQ0FBQ1IsSUFBZCxDQUFtQkQsWUFBbkIsQ0FBSixFQUFzQztBQUdwQyxZQUFNVSxLQUFLLEdBQUdELGFBQWEsQ0FBQ0wsSUFBZCxDQUFtQkosWUFBbkIsQ0FBZDtBQUNBQSxNQUFBQSxZQUFZLEdBQUdBLFlBQVksQ0FBQ00sT0FBYixDQUFxQkksS0FBSyxDQUFDLENBQUQsQ0FBMUIsRUFBK0IsS0FBS3hDLFNBQXBDLENBQWY7QUFDRCxLQUxELE1BS08sSUFBSXNDLGlCQUFKLEVBQXVCO0FBQzVCLFlBQU0sSUFBSUgsS0FBSixDQUFXLDRDQUEyQ0wsWUFBYSxFQUFuRSxDQUFOO0FBQ0Q7O0FBQ0RBLElBQUFBLFlBQVksR0FBR0EsWUFBWSxDQUFDTSxPQUFiLENBQXFCLEtBQXJCLEVBQTRCLEVBQTVCLENBQWY7QUFFQSxXQUFPUixTQUFTLEdBQUdFLFlBQW5CO0FBQ0Q7O0FBRUt2QixFQUFBQSxLQUFOLENBQWFvQixHQUFiLEVBQWtCYyxNQUFsQixFQUEwQkMsSUFBSSxHQUFHLElBQWpDLEVBQXVDO0FBQUE7O0FBQUE7QUFDckNELE1BQUFBLE1BQU0sR0FBR0EsTUFBTSxDQUFDRSxXQUFQLEVBQVQ7O0FBQ0EsWUFBTUMsTUFBTSxHQUFHLE1BQUksQ0FBQ2xCLGNBQUwsQ0FBb0JDLEdBQXBCLENBQWY7O0FBQ0EsWUFBTWtCLE9BQU8sR0FBRztBQUNkQyxRQUFBQSxLQUFLLEVBQUUsS0FETztBQUVkbkIsUUFBQUEsR0FBRyxFQUFFaUIsTUFGUztBQUdkSCxRQUFBQSxNQUhjO0FBSWRNLFFBQUFBLE9BQU8sRUFBRTtBQUNQLDBCQUFnQixpQ0FEVDtBQUVQLHdCQUFjLFFBRlA7QUFHUEMsVUFBQUEsTUFBTSxFQUFFO0FBSEQsU0FKSztBQVNkQyxRQUFBQSx1QkFBdUIsRUFBRSxJQVRYO0FBVWRoRCxRQUFBQSxPQUFPLEVBQUUsTUFBSSxDQUFDQTtBQVZBLE9BQWhCOztBQVlBLFVBQUl5QyxJQUFJLEtBQUssSUFBYixFQUFtQjtBQUNqQixZQUFJLE9BQU9BLElBQVAsS0FBZ0IsUUFBcEIsRUFBOEI7QUFDNUJBLFVBQUFBLElBQUksR0FBR1EsSUFBSSxDQUFDQyxLQUFMLENBQVdULElBQVgsQ0FBUDtBQUNEOztBQUNERyxRQUFBQSxPQUFPLENBQUNPLElBQVIsR0FBZVYsSUFBZjtBQUNEOztBQUdELFVBQUlELE1BQU0sS0FBSyxLQUFmLEVBQXNCO0FBQ3BCSSxRQUFBQSxPQUFPLENBQUNPLElBQVIsR0FBZSxJQUFmO0FBQ0Q7O0FBRUR0RSxNQUFBQSxHQUFHLENBQUN1RSxLQUFKLENBQVcsYUFBWVosTUFBTyxJQUFHZCxHQUFHLElBQUksR0FBSSxTQUFRYyxNQUFPLElBQUdHLE1BQU8sSUFBM0QsSUFDQUYsSUFBSSxHQUFJLGNBQWE1QixnQkFBRXdDLFFBQUYsQ0FBV0osSUFBSSxDQUFDSyxTQUFMLENBQWViLElBQWYsQ0FBWCxFQUFpQztBQUFDekIsUUFBQUEsTUFBTSxFQUFFaEM7QUFBVCxPQUFqQyxDQUEyRCxFQUE1RSxHQUFnRixjQURwRixDQUFWO0FBR0EsVUFBSXVFLEdBQUosRUFBU0MsT0FBVDs7QUFDQSxVQUFJO0FBQ0ZELFFBQUFBLEdBQUcsU0FBUyxNQUFJLENBQUMvQyxPQUFMLENBQWFvQyxPQUFiLENBQVo7QUFDQVksUUFBQUEsT0FBTyxHQUFHRCxHQUFHLENBQUNkLElBQWQ7QUFDQTVELFFBQUFBLEdBQUcsQ0FBQ3VFLEtBQUosQ0FBVyw0QkFBMkJHLEdBQUcsQ0FBQ0UsVUFBVyxLQUFJNUMsZ0JBQUV3QyxRQUFGLENBQVdKLElBQUksQ0FBQ0ssU0FBTCxDQUFlRSxPQUFmLENBQVgsRUFBb0M7QUFBQ3hDLFVBQUFBLE1BQU0sRUFBRWhDO0FBQVQsU0FBcEMsQ0FBOEQsRUFBdkg7O0FBQ0EsWUFBSSxhQUFhOEMsSUFBYixDQUFrQkosR0FBbEIsS0FBMEJjLE1BQU0sS0FBSyxNQUF6QyxFQUFpRDtBQUMvQyxjQUFJZSxHQUFHLENBQUNFLFVBQUosS0FBbUIsR0FBdkIsRUFBNEI7QUFDMUIsWUFBQSxNQUFJLENBQUMxRCxTQUFMLEdBQWlCeUQsT0FBTyxDQUFDekQsU0FBekI7QUFDRCxXQUZELE1BRU8sSUFBSXdELEdBQUcsQ0FBQ0UsVUFBSixLQUFtQixHQUF2QixFQUE0QjtBQUNqQyxZQUFBLE1BQUksQ0FBQzFELFNBQUwsR0FBaUIscUJBQXFCa0MsSUFBckIsQ0FBMEJ1QixPQUExQixFQUFtQyxDQUFuQyxDQUFqQjtBQUNEO0FBQ0Y7O0FBQ0QsY0FBTUUsVUFBVSxHQUFHQyxvQkFBS0MsYUFBTCxDQUFtQkosT0FBbkIsQ0FBbkI7O0FBQ0EsWUFBSSxDQUFDLE1BQUksQ0FBQ2pDLGtCQUFWLEVBQThCO0FBQzVCLFVBQUEsTUFBSSxDQUFDQSxrQkFBTCxHQUEwQixNQUFJLENBQUNzQyxzQkFBTCxDQUE0QkgsVUFBNUIsQ0FBMUI7QUFDRDs7QUFDRCxZQUFJSCxHQUFHLENBQUNFLFVBQUosR0FBaUIsR0FBakIsSUFBd0IsTUFBSSxDQUFDbEMsa0JBQUwsS0FBNEJuQyxPQUFwRCxJQUErRDBFLFFBQVEsQ0FBQ0osVUFBVSxDQUFDSyxNQUFaLEVBQW9CLEVBQXBCLENBQVIsS0FBb0MsQ0FBdkcsRUFBMEc7QUFFeEcsZ0JBQU1DLE9BQU8sR0FBSSxrQkFBaUJ0QyxHQUFJLGFBQXRDO0FBQ0EsZ0JBQU11QyxHQUFHLEdBQUcsSUFBSS9CLEtBQUosQ0FBVThCLE9BQVYsQ0FBWjtBQUNBQyxVQUFBQSxHQUFHLENBQUNELE9BQUosR0FBY0EsT0FBZDtBQUNBQyxVQUFBQSxHQUFHLENBQUNDLEtBQUosR0FBWVYsT0FBWjtBQUNBUyxVQUFBQSxHQUFHLENBQUNSLFVBQUosR0FBaUIsR0FBakI7QUFDQSxnQkFBTVEsR0FBTjtBQUNEO0FBQ0YsT0F4QkQsQ0F3QkUsT0FBT0UsQ0FBUCxFQUFVO0FBQ1YsWUFBSUMsYUFBYSxHQUFHRCxDQUFDLENBQUNELEtBQXRCOztBQUNBLFlBQUk7QUFDRkUsVUFBQUEsYUFBYSxHQUFHbkIsSUFBSSxDQUFDQyxLQUFMLENBQVdrQixhQUFYLENBQWhCO0FBQ0QsU0FGRCxDQUVFLE9BQU9DLEVBQVAsRUFBVztBQUNYeEYsVUFBQUEsR0FBRyxDQUFDeUYsSUFBSixDQUFVLDhCQUFELEdBQ1B6RCxnQkFBRXdDLFFBQUYsQ0FBV3hDLGdCQUFFMEQsUUFBRixDQUFXSCxhQUFYLElBQTRCQSxhQUE1QixHQUE0Q25CLElBQUksQ0FBQ0ssU0FBTCxDQUFlYyxhQUFmLENBQXZELEVBQXNGO0FBQUNwRCxZQUFBQSxNQUFNLEVBQUU7QUFBVCxXQUF0RixDQURGO0FBRUQ7O0FBQ0QsY0FBTSxJQUFJd0QsZUFBT0MsaUJBQVgsQ0FBOEIsNENBQUQsR0FDWixtQkFBa0JOLENBQUMsQ0FBQ0gsT0FBUSxFQUQ3QyxFQUNnREksYUFEaEQsRUFDK0RELENBQUMsQ0FBQ1YsVUFEakUsQ0FBTjtBQUVEOztBQUNELGFBQU8sQ0FBQ0YsR0FBRCxFQUFNQyxPQUFOLENBQVA7QUFsRXFDO0FBbUV0Qzs7QUFFREssRUFBQUEsc0JBQXNCLENBQUVMLE9BQUYsRUFBVztBQUMvQixRQUFJLENBQUMzQyxnQkFBRTZELGFBQUYsQ0FBZ0JsQixPQUFoQixDQUFMLEVBQStCO0FBQzdCLFVBQUk7QUFDRkEsUUFBQUEsT0FBTyxHQUFHUCxJQUFJLENBQUNDLEtBQUwsQ0FBV00sT0FBWCxDQUFWO0FBQ0QsT0FGRCxDQUVFLE9BQU9TLEdBQVAsRUFBWTtBQUNaO0FBQ0Q7QUFDRjs7QUFDRCxRQUFJTixvQkFBS2dCLFFBQUwsQ0FBY25CLE9BQU8sQ0FBQ08sTUFBdEIsQ0FBSixFQUFtQztBQUNqQyxhQUFPM0UsT0FBUDtBQUNEOztBQUNELFFBQUl1RSxvQkFBS2dCLFFBQUwsQ0FBY25CLE9BQU8sQ0FBQ2hDLEtBQXRCLENBQUosRUFBa0M7QUFDaEMsYUFBT25DLEdBQVA7QUFDRDtBQUNGOztBQUVEdUYsRUFBQUEsb0JBQW9CLENBQUVsRCxHQUFGLEVBQU9jLE1BQVAsRUFBZTtBQUNqQyxVQUFNcUMsa0JBQWtCLEdBQUlDLE9BQUQsSUFBYTtBQUN0QyxZQUFNQyxTQUFTLEdBQUdELE9BQU8sQ0FBQzdDLElBQVIsQ0FBYVAsR0FBYixDQUFsQjtBQUNBLGFBQU9xRCxTQUFTLEdBQUcsZ0NBQW1CQSxTQUFTLENBQUMsQ0FBRCxDQUE1QixFQUFpQ3ZDLE1BQWpDLENBQUgsR0FBOEMsSUFBOUQ7QUFDRCxLQUhEOztBQUlBLFFBQUl3QyxXQUFXLEdBQUcsZ0NBQW1CdEQsR0FBbkIsRUFBd0JjLE1BQXhCLENBQWxCOztBQUNBLFFBQUksQ0FBQ3dDLFdBQUQsSUFBZ0JuRSxnQkFBRVMsUUFBRixDQUFXSSxHQUFYLEVBQWdCLGtCQUFoQixDQUFwQixFQUF5RDtBQUN2RHNELE1BQUFBLFdBQVcsR0FBR0gsa0JBQWtCLENBQUMsK0JBQUQsQ0FBaEM7QUFDRDs7QUFDRCxRQUFJLENBQUNHLFdBQUQsSUFBZ0JuRSxnQkFBRVMsUUFBRixDQUFXSSxHQUFYLEVBQWdCLFVBQWhCLENBQXBCLEVBQWlEO0FBQy9Dc0QsTUFBQUEsV0FBVyxHQUFHSCxrQkFBa0IsQ0FBQyxpQkFBRCxDQUFoQztBQUNEOztBQUNELFdBQU9HLFdBQVA7QUFDRDs7QUFFS0MsRUFBQUEsWUFBTixDQUFvQnZELEdBQXBCLEVBQXlCYyxNQUF6QixFQUFpQ0MsSUFBSSxHQUFHLElBQXhDLEVBQThDO0FBQUE7O0FBQUE7QUFDNUMsWUFBTXVDLFdBQVcsR0FBRyxNQUFJLENBQUNKLG9CQUFMLENBQTBCbEQsR0FBMUIsRUFBK0JjLE1BQS9CLENBQXBCOztBQUNBLFVBQUksQ0FBQ3dDLFdBQUwsRUFBa0I7QUFDaEIscUJBQWEsTUFBSSxDQUFDMUUsS0FBTCxDQUFXb0IsR0FBWCxFQUFnQmMsTUFBaEIsRUFBd0JDLElBQXhCLENBQWI7QUFDRDs7QUFDRDVELE1BQUFBLEdBQUcsQ0FBQ3VFLEtBQUosQ0FBVyxZQUFXMUIsR0FBSSxzQkFBcUJzRCxXQUFZLEdBQTNEO0FBRUEsbUJBQWEsTUFBSSxDQUFDNUUsaUJBQUwsQ0FBdUI4RSxlQUF2QixDQUF1Q0YsV0FBdkMsRUFBb0R0RCxHQUFwRCxFQUF5RGMsTUFBekQsRUFBaUVDLElBQWpFLENBQWI7QUFQNEM7QUFRN0M7O0FBRUswQyxFQUFBQSxPQUFOLENBQWV6RCxHQUFmLEVBQW9CYyxNQUFwQixFQUE0QkMsSUFBSSxHQUFHLElBQW5DLEVBQXlDO0FBQUE7O0FBQUE7QUFDdkMsVUFBSTJDLFFBQUo7QUFDQSxVQUFJNUIsT0FBSjs7QUFDQSxVQUFJO0FBQUEseUJBQzBCLE1BQUksQ0FBQ3lCLFlBQUwsQ0FBa0J2RCxHQUFsQixFQUF1QmMsTUFBdkIsRUFBK0JDLElBQS9CLENBRDFCOztBQUFBOztBQUNEMkMsUUFBQUEsUUFEQztBQUNTNUIsUUFBQUEsT0FEVDtBQUVILE9BRkQsQ0FFRSxPQUFPUyxHQUFQLEVBQVk7QUFDWixZQUFJLHlCQUFZQSxHQUFaLEVBQWlCTyxlQUFPQyxpQkFBeEIsQ0FBSixFQUFnRDtBQUM5QyxnQkFBTVIsR0FBRyxDQUFDb0IsY0FBSixFQUFOO0FBQ0Q7O0FBQ0QsY0FBTSxJQUFJYixlQUFPYyxZQUFYLENBQXdCckIsR0FBRyxDQUFDRCxPQUE1QixDQUFOO0FBQ0Q7O0FBQ0RSLE1BQUFBLE9BQU8sR0FBR0csb0JBQUtDLGFBQUwsQ0FBbUJKLE9BQW5CLENBQVY7O0FBQ0EsVUFBSStCLFFBQVEsR0FBRyxNQUFJLENBQUMxQixzQkFBTCxDQUE0QkwsT0FBNUIsQ0FBZjs7QUFDQSxVQUFJK0IsUUFBUSxLQUFLbkcsT0FBakIsRUFBMEI7QUFFeEIsWUFBSWdHLFFBQVEsQ0FBQzNCLFVBQVQsS0FBd0IsR0FBeEIsSUFBK0JELE9BQU8sQ0FBQ08sTUFBUixLQUFtQixDQUF0RCxFQUF5RDtBQUN2RCxpQkFBT1AsT0FBTyxDQUFDaEMsS0FBZjtBQUNEOztBQUNELGNBQU11QyxNQUFNLEdBQUdELFFBQVEsQ0FBQ04sT0FBTyxDQUFDTyxNQUFULEVBQWlCLEVBQWpCLENBQXZCOztBQUNBLFlBQUksQ0FBQ3lCLEtBQUssQ0FBQ3pCLE1BQUQsQ0FBTixJQUFrQkEsTUFBTSxLQUFLLENBQWpDLEVBQW9DO0FBQ2xDLGNBQUlDLE9BQU8sR0FBR1IsT0FBTyxDQUFDaEMsS0FBdEI7O0FBQ0EsY0FBSVgsZ0JBQUU0RSxHQUFGLENBQU1qQyxPQUFPLENBQUNoQyxLQUFkLEVBQXFCLFNBQXJCLENBQUosRUFBcUM7QUFDbkN3QyxZQUFBQSxPQUFPLEdBQUduRCxnQkFBRTZFLE9BQUYsQ0FBVTFCLE9BQVYsSUFBcUJSLE9BQU8sQ0FBQ2hDLEtBQVIsQ0FBY3dDLE9BQW5DLEdBQThDLEdBQUVBLE9BQVEsSUFBR1IsT0FBTyxDQUFDaEMsS0FBUixDQUFjd0MsT0FBUSxFQUEzRjtBQUNEOztBQUNELGdCQUFNLHdDQUEyQkQsTUFBM0IsRUFBbUNsRCxnQkFBRTZFLE9BQUYsQ0FBVTFCLE9BQVYsSUFBcUIsOEJBQWlCRCxNQUFqQixDQUFyQixHQUFnREMsT0FBbkYsQ0FBTjtBQUNEO0FBQ0YsT0FiRCxNQWFPLElBQUl1QixRQUFRLEtBQUtsRyxHQUFqQixFQUFzQjtBQUUzQixZQUFJK0YsUUFBUSxDQUFDM0IsVUFBVCxHQUFzQixHQUExQixFQUErQjtBQUM3QixpQkFBT0QsT0FBTyxDQUFDaEMsS0FBZjtBQUNEOztBQUNELFlBQUlYLGdCQUFFNkQsYUFBRixDQUFnQmxCLE9BQU8sQ0FBQ2hDLEtBQXhCLEtBQWtDZ0MsT0FBTyxDQUFDaEMsS0FBUixDQUFjMEMsS0FBcEQsRUFBMkQ7QUFDekQsZ0JBQU0sa0NBQXFCVixPQUFPLENBQUNoQyxLQUFSLENBQWMwQyxLQUFuQyxFQUEwQ1YsT0FBTyxDQUFDaEMsS0FBUixDQUFjd0MsT0FBeEQsRUFBaUVSLE9BQU8sQ0FBQ2hDLEtBQVIsQ0FBY21FLFVBQS9FLENBQU47QUFDRDtBQUNGLE9BUk0sTUFRQSxJQUFJUCxRQUFRLENBQUMzQixVQUFULEtBQXdCLEdBQTVCLEVBQWlDO0FBRXRDLGVBQU9ELE9BQVA7QUFDRDs7QUFDRCxZQUFNLElBQUlnQixlQUFPYyxZQUFYLENBQXlCLCtDQUE4Q0YsUUFBUSxDQUFDM0IsVUFBVyxJQUFuRSxHQUNDLHNCQUFxQjVDLGdCQUFFd0MsUUFBRixDQUFXSixJQUFJLENBQUNLLFNBQUwsQ0FBZUUsT0FBZixDQUFYLEVBQW9DO0FBQUN4QyxRQUFBQSxNQUFNLEVBQUU7QUFBVCxPQUFwQyxDQUFtRCxHQURqRyxDQUFOO0FBdEN1QztBQXdDeEM7O0FBRUQ0RSxFQUFBQSxtQkFBbUIsQ0FBRWxFLEdBQUYsRUFBTztBQUN4QixVQUFNYSxLQUFLLEdBQUdiLEdBQUcsQ0FBQ2EsS0FBSixDQUFVLG9CQUFWLENBQWQ7QUFDQSxXQUFPQSxLQUFLLEdBQUdBLEtBQUssQ0FBQyxDQUFELENBQVIsR0FBYyxJQUExQjtBQUNEOztBQUVLc0QsRUFBQUEsV0FBTixDQUFtQkMsR0FBbkIsRUFBd0J2QyxHQUF4QixFQUE2QjtBQUFBOztBQUFBO0FBQUEsd0JBQ0UsTUFBSSxDQUFDMEIsWUFBTCxDQUFrQmEsR0FBRyxDQUFDQyxXQUF0QixFQUFtQ0QsR0FBRyxDQUFDdEQsTUFBdkMsRUFBK0NzRCxHQUFHLENBQUNyRCxJQUFuRCxDQURGO0FBQUE7QUFBQSxVQUN0QjJDLFFBRHNCO0FBQUEsVUFDWjNDLElBRFk7O0FBRzNCYyxNQUFBQSxHQUFHLENBQUNULE9BQUosR0FBY3NDLFFBQVEsQ0FBQ3RDLE9BQXZCO0FBQ0FTLE1BQUFBLEdBQUcsQ0FBQ3lDLEdBQUosQ0FBUSxjQUFSLEVBQXdCWixRQUFRLENBQUN0QyxPQUFULENBQWlCLGNBQWpCLENBQXhCO0FBSUFMLE1BQUFBLElBQUksR0FBR2tCLG9CQUFLQyxhQUFMLENBQW1CbkIsSUFBbkIsQ0FBUDs7QUFDQSxVQUFJQSxJQUFJLElBQUlBLElBQUksQ0FBQzFDLFNBQWpCLEVBQTRCO0FBQzFCLGNBQU1rRyxZQUFZLEdBQUcsTUFBSSxDQUFDTCxtQkFBTCxDQUF5QkUsR0FBRyxDQUFDQyxXQUE3QixDQUFyQjs7QUFDQSxZQUFJRSxZQUFKLEVBQWtCO0FBQ2hCcEgsVUFBQUEsR0FBRyxDQUFDcUgsSUFBSixDQUFVLHVCQUFzQnpELElBQUksQ0FBQzFDLFNBQVUsU0FBUWtHLFlBQWEsRUFBcEU7QUFDQXhELFVBQUFBLElBQUksQ0FBQzFDLFNBQUwsR0FBaUJrRyxZQUFqQjtBQUNELFNBSEQsTUFHTyxJQUFJLE1BQUksQ0FBQ2xHLFNBQVQsRUFBb0I7QUFDekJsQixVQUFBQSxHQUFHLENBQUNxSCxJQUFKLENBQVUsdUJBQXNCekQsSUFBSSxDQUFDMUMsU0FBVSxTQUFRLE1BQUksQ0FBQ0EsU0FBVSxFQUF0RTtBQUNBMEMsVUFBQUEsSUFBSSxDQUFDMUMsU0FBTCxHQUFpQixNQUFJLENBQUNBLFNBQXRCO0FBQ0Q7QUFDRjs7QUFDRHdELE1BQUFBLEdBQUcsQ0FBQ1EsTUFBSixDQUFXcUIsUUFBUSxDQUFDM0IsVUFBcEIsRUFBZ0MwQyxJQUFoQyxDQUFxQ2xELElBQUksQ0FBQ0ssU0FBTCxDQUFlYixJQUFmLENBQXJDO0FBbkIyQjtBQW9CNUI7O0FBcFJXOzs7ZUF3UkNuRCxPIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGxvZ2dlciwgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCByZXF1ZXN0IGZyb20gJ3JlcXVlc3QtcHJvbWlzZSc7XG5pbXBvcnQgeyBnZXRTdW1tYXJ5QnlDb2RlIH0gZnJvbSAnLi4vanNvbndwLXN0YXR1cy9zdGF0dXMnO1xuaW1wb3J0IHsgZXJyb3JzLCBpc0Vycm9yVHlwZSwgZXJyb3JGcm9tTUpTT05XUFN0YXR1c0NvZGUsIGVycm9yRnJvbVczQ0pzb25Db2RlIH0gZnJvbSAnLi4vcHJvdG9jb2wvZXJyb3JzJztcbmltcG9ydCBCYXNlRHJpdmVyIGZyb20gJy4uL2Jhc2Vkcml2ZXIvZHJpdmVyJztcbmltcG9ydCB7IHJvdXRlVG9Db21tYW5kTmFtZSB9IGZyb20gJy4uL3Byb3RvY29sL3JvdXRlcyc7XG5pbXBvcnQgUHJvdG9jb2xDb252ZXJ0ZXIgZnJvbSAnLi9wcm90b2NvbC1jb252ZXJ0ZXInO1xuXG5cbmNvbnN0IGxvZyA9IGxvZ2dlci5nZXRMb2dnZXIoJ0pTT05XUCBQcm94eScpO1xuLy8gVE9ETzogTWFrZSB0aGlzIHZhbHVlIGNvbmZpZ3VyYWJsZSBhcyBhIHNlcnZlciBzaWRlIGNhcGFiaWxpdHlcbmNvbnN0IExPR19PQkpfTEVOR1RIID0gMTAyNDsgLy8gTUFYIExFTkdUSCBMb2dnZWQgdG8gZmlsZSAvIGNvbnNvbGVcbmNvbnN0IERFRkFVTFRfUkVRVUVTVF9USU1FT1VUID0gMjQwMDAwO1xuXG5jb25zdCB7TUpTT05XUCwgVzNDfSA9IEJhc2VEcml2ZXIuRFJJVkVSX1BST1RPQ09MO1xuXG5jbGFzcyBKV1Byb3h5IHtcbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkge1xuICAgIE9iamVjdC5hc3NpZ24odGhpcywge1xuICAgICAgc2NoZW1lOiAnaHR0cCcsXG4gICAgICBzZXJ2ZXI6ICdsb2NhbGhvc3QnLFxuICAgICAgcG9ydDogNDQ0NCxcbiAgICAgIGJhc2U6ICcvd2QvaHViJyxcbiAgICAgIHNlc3Npb25JZDogbnVsbCxcbiAgICAgIHRpbWVvdXQ6IERFRkFVTFRfUkVRVUVTVF9USU1FT1VULFxuICAgIH0sIG9wdHMpO1xuICAgIHRoaXMuc2NoZW1lID0gdGhpcy5zY2hlbWUudG9Mb3dlckNhc2UoKTtcbiAgICB0aGlzLl9hY3RpdmVSZXF1ZXN0cyA9IFtdO1xuICAgIHRoaXMuX2Rvd25zdHJlYW1Qcm90b2NvbCA9IG51bGw7XG4gICAgdGhpcy5wcm90b2NvbENvbnZlcnRlciA9IG5ldyBQcm90b2NvbENvbnZlcnRlcih0aGlzLnByb3h5LmJpbmQodGhpcykpO1xuICB9XG5cbiAgLy8gYWJzdHJhY3QgdGhlIGNhbGwgYmVoaW5kIGEgbWVtYmVyIGZ1bmN0aW9uXG4gIC8vIHNvIHRoYXQgd2UgY2FuIG1vY2sgaXQgaW4gdGVzdHNcbiAgYXN5bmMgcmVxdWVzdCAoLi4uYXJncykge1xuICAgIGNvbnN0IGN1cnJlbnRSZXF1ZXN0ID0gcmVxdWVzdCguLi5hcmdzKTtcbiAgICB0aGlzLl9hY3RpdmVSZXF1ZXN0cy5wdXNoKGN1cnJlbnRSZXF1ZXN0KTtcbiAgICByZXR1cm4gYXdhaXQgY3VycmVudFJlcXVlc3QuZmluYWxseSgoKSA9PiBfLnB1bGwodGhpcy5fYWN0aXZlUmVxdWVzdHMsIGN1cnJlbnRSZXF1ZXN0KSk7XG4gIH1cblxuICBnZXRBY3RpdmVSZXF1ZXN0c0NvdW50ICgpIHtcbiAgICByZXR1cm4gdGhpcy5fYWN0aXZlUmVxdWVzdHMubGVuZ3RoO1xuICB9XG5cbiAgY2FuY2VsQWN0aXZlUmVxdWVzdHMgKCkge1xuICAgIHRyeSB7XG4gICAgICBmb3IgKGxldCByIG9mIHRoaXMuX2FjdGl2ZVJlcXVlc3RzKSB7XG4gICAgICAgIHIuY2FuY2VsKCk7XG4gICAgICB9XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIHRoaXMuX2FjdGl2ZVJlcXVlc3RzID0gW107XG4gICAgfVxuICB9XG5cbiAgZW5kcG9pbnRSZXF1aXJlc1Nlc3Npb25JZCAoZW5kcG9pbnQpIHtcbiAgICByZXR1cm4gIV8uaW5jbHVkZXMoWycvc2Vzc2lvbicsICcvc2Vzc2lvbnMnLCAnL3N0YXR1cyddLCBlbmRwb2ludCk7XG4gIH1cblxuICBzZXQgZG93bnN0cmVhbVByb3RvY29sICh2YWx1ZSkge1xuICAgIHRoaXMuX2Rvd25zdHJlYW1Qcm90b2NvbCA9IHZhbHVlO1xuICAgIHRoaXMucHJvdG9jb2xDb252ZXJ0ZXIuZG93bnN0cmVhbVByb3RvY29sID0gdmFsdWU7XG4gIH1cblxuICBnZXQgZG93bnN0cmVhbVByb3RvY29sICgpIHtcbiAgICByZXR1cm4gdGhpcy5fZG93bnN0cmVhbVByb3RvY29sO1xuICB9XG5cbiAgZ2V0VXJsRm9yUHJveHkgKHVybCkge1xuICAgIGlmICh1cmwgPT09ICcnKSB7XG4gICAgICB1cmwgPSAnLyc7XG4gICAgfVxuICAgIGNvbnN0IHByb3h5QmFzZSA9IGAke3RoaXMuc2NoZW1lfTovLyR7dGhpcy5zZXJ2ZXJ9OiR7dGhpcy5wb3J0fSR7dGhpcy5iYXNlfWA7XG4gICAgY29uc3QgZW5kcG9pbnRSZSA9ICcoLyhzZXNzaW9ufHN0YXR1cykpJztcbiAgICBsZXQgcmVtYWluaW5nVXJsID0gJyc7XG4gICAgaWYgKC9eaHR0cC8udGVzdCh1cmwpKSB7XG4gICAgICBjb25zdCBmaXJzdCA9IChuZXcgUmVnRXhwKGAoaHR0cHM/Oi8vLispJHtlbmRwb2ludFJlfWApKS5leGVjKHVybCk7XG4gICAgICBpZiAoIWZpcnN0KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignR290IGEgY29tcGxldGUgdXJsIGJ1dCBjb3VsZCBub3QgZXh0cmFjdCBKV1AgZW5kcG9pbnQnKTtcbiAgICAgIH1cbiAgICAgIHJlbWFpbmluZ1VybCA9IHVybC5yZXBsYWNlKGZpcnN0WzFdLCAnJyk7XG4gICAgfSBlbHNlIGlmICgobmV3IFJlZ0V4cCgnXi8nKSkudGVzdCh1cmwpKSB7XG4gICAgICByZW1haW5pbmdVcmwgPSB1cmw7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRGlkIG5vdCBrbm93IHdoYXQgdG8gZG8gd2l0aCB1cmwgJyR7dXJsfSdgKTtcbiAgICB9XG5cbiAgICBjb25zdCBzdHJpcFByZWZpeFJlID0gbmV3IFJlZ0V4cCgnXi4qPygvKHNlc3Npb258c3RhdHVzKS4qKSQnKTtcbiAgICBpZiAoc3RyaXBQcmVmaXhSZS50ZXN0KHJlbWFpbmluZ1VybCkpIHtcbiAgICAgIHJlbWFpbmluZ1VybCA9IHN0cmlwUHJlZml4UmUuZXhlYyhyZW1haW5pbmdVcmwpWzFdO1xuICAgIH1cblxuICAgIGlmICghKG5ldyBSZWdFeHAoZW5kcG9pbnRSZSkpLnRlc3QocmVtYWluaW5nVXJsKSkge1xuICAgICAgcmVtYWluaW5nVXJsID0gYC9zZXNzaW9uLyR7dGhpcy5zZXNzaW9uSWR9JHtyZW1haW5pbmdVcmx9YDtcbiAgICB9XG5cbiAgICBjb25zdCByZXF1aXJlc1Nlc3Npb25JZCA9IHRoaXMuZW5kcG9pbnRSZXF1aXJlc1Nlc3Npb25JZChyZW1haW5pbmdVcmwpO1xuXG4gICAgaWYgKHJlcXVpcmVzU2Vzc2lvbklkICYmIHRoaXMuc2Vzc2lvbklkID09PSBudWxsKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RyeWluZyB0byBwcm94eSBhIHNlc3Npb24gY29tbWFuZCB3aXRob3V0IHNlc3Npb24gaWQnKTtcbiAgICB9XG5cbiAgICBjb25zdCBzZXNzaW9uQmFzZVJlID0gbmV3IFJlZ0V4cCgnXi9zZXNzaW9uLyhbXi9dKyknKTtcbiAgICBpZiAoc2Vzc2lvbkJhc2VSZS50ZXN0KHJlbWFpbmluZ1VybCkpIHtcbiAgICAgIC8vIHdlIGhhdmUgc29tZXRoaW5nIGxpa2UgL3Nlc3Npb24vOmlkL2Zvb2Jhciwgc28gd2UgbmVlZCB0byByZXBsYWNlXG4gICAgICAvLyB0aGUgc2Vzc2lvbiBpZFxuICAgICAgY29uc3QgbWF0Y2ggPSBzZXNzaW9uQmFzZVJlLmV4ZWMocmVtYWluaW5nVXJsKTtcbiAgICAgIHJlbWFpbmluZ1VybCA9IHJlbWFpbmluZ1VybC5yZXBsYWNlKG1hdGNoWzFdLCB0aGlzLnNlc3Npb25JZCk7XG4gICAgfSBlbHNlIGlmIChyZXF1aXJlc1Nlc3Npb25JZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgZmluZCA6c2Vzc2lvbiBzZWN0aW9uIGZvciB1cmw6ICR7cmVtYWluaW5nVXJsfWApO1xuICAgIH1cbiAgICByZW1haW5pbmdVcmwgPSByZW1haW5pbmdVcmwucmVwbGFjZSgvXFwvJC8sICcnKTsgLy8gY2FuJ3QgaGF2ZSB0cmFpbGluZyBzbGFzaGVzXG5cbiAgICByZXR1cm4gcHJveHlCYXNlICsgcmVtYWluaW5nVXJsO1xuICB9XG5cbiAgYXN5bmMgcHJveHkgKHVybCwgbWV0aG9kLCBib2R5ID0gbnVsbCkge1xuICAgIG1ldGhvZCA9IG1ldGhvZC50b1VwcGVyQ2FzZSgpO1xuICAgIGNvbnN0IG5ld1VybCA9IHRoaXMuZ2V0VXJsRm9yUHJveHkodXJsKTtcbiAgICBjb25zdCByZXFPcHRzID0ge1xuICAgICAgYWdlbnQ6IGZhbHNlLFxuICAgICAgdXJsOiBuZXdVcmwsXG4gICAgICBtZXRob2QsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdjb250ZW50LXR5cGUnOiAnYXBwbGljYXRpb24vanNvbjsgY2hhcnNldD11dGYtOCcsXG4gICAgICAgICd1c2VyLWFnZW50JzogJ2FwcGl1bScsXG4gICAgICAgIGFjY2VwdDogJ2FwcGxpY2F0aW9uL2pzb24sICovKicsXG4gICAgICB9LFxuICAgICAgcmVzb2x2ZVdpdGhGdWxsUmVzcG9uc2U6IHRydWUsXG4gICAgICB0aW1lb3V0OiB0aGlzLnRpbWVvdXQsXG4gICAgfTtcbiAgICBpZiAoYm9keSAhPT0gbnVsbCkge1xuICAgICAgaWYgKHR5cGVvZiBib2R5ICE9PSAnb2JqZWN0Jykge1xuICAgICAgICBib2R5ID0gSlNPTi5wYXJzZShib2R5KTtcbiAgICAgIH1cbiAgICAgIHJlcU9wdHMuanNvbiA9IGJvZHk7XG4gICAgfVxuXG4gICAgLy8gR0VUIG1ldGhvZHMgc2hvdWxkbid0IGhhdmUgYW55IGJvZHkuIE1vc3Qgc2VydmVycyBhcmUgT0sgd2l0aCB0aGlzLCBidXQgV2ViRHJpdmVyQWdlbnQgdGhyb3dzIDQwMCBlcnJvcnNcbiAgICBpZiAobWV0aG9kID09PSAnR0VUJykge1xuICAgICAgcmVxT3B0cy5qc29uID0gbnVsbDtcbiAgICB9XG5cbiAgICBsb2cuZGVidWcoYFByb3h5aW5nIFske21ldGhvZH0gJHt1cmwgfHwgXCIvXCJ9XSB0byBbJHttZXRob2R9ICR7bmV3VXJsfV0gYCArXG4gICAgICAgICAgICAgKGJvZHkgPyBgd2l0aCBib2R5OiAke18udHJ1bmNhdGUoSlNPTi5zdHJpbmdpZnkoYm9keSksIHtsZW5ndGg6IExPR19PQkpfTEVOR1RIfSl9YCA6ICd3aXRoIG5vIGJvZHknKSk7XG5cbiAgICBsZXQgcmVzLCByZXNCb2R5O1xuICAgIHRyeSB7XG4gICAgICByZXMgPSBhd2FpdCB0aGlzLnJlcXVlc3QocmVxT3B0cyk7XG4gICAgICByZXNCb2R5ID0gcmVzLmJvZHk7XG4gICAgICBsb2cuZGVidWcoYEdvdCByZXNwb25zZSB3aXRoIHN0YXR1cyAke3Jlcy5zdGF0dXNDb2RlfTogJHtfLnRydW5jYXRlKEpTT04uc3RyaW5naWZ5KHJlc0JvZHkpLCB7bGVuZ3RoOiBMT0dfT0JKX0xFTkdUSH0pfWApO1xuICAgICAgaWYgKC9cXC9zZXNzaW9uJC8udGVzdCh1cmwpICYmIG1ldGhvZCA9PT0gJ1BPU1QnKSB7XG4gICAgICAgIGlmIChyZXMuc3RhdHVzQ29kZSA9PT0gMjAwKSB7XG4gICAgICAgICAgdGhpcy5zZXNzaW9uSWQgPSByZXNCb2R5LnNlc3Npb25JZDtcbiAgICAgICAgfSBlbHNlIGlmIChyZXMuc3RhdHVzQ29kZSA9PT0gMzAzKSB7XG4gICAgICAgICAgdGhpcy5zZXNzaW9uSWQgPSAvXFwvc2Vzc2lvblxcLyhbXi9dKykvLmV4ZWMocmVzQm9keSlbMV07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGNvbnN0IHJlc0JvZHlPYmogPSB1dGlsLnNhZmVKc29uUGFyc2UocmVzQm9keSk7XG4gICAgICBpZiAoIXRoaXMuZG93bnN0cmVhbVByb3RvY29sKSB7XG4gICAgICAgIHRoaXMuZG93bnN0cmVhbVByb3RvY29sID0gdGhpcy5nZXRQcm90b2NvbEZyb21SZXNCb2R5KHJlc0JvZHlPYmopO1xuICAgICAgfVxuICAgICAgaWYgKHJlcy5zdGF0dXNDb2RlIDwgNDAwICYmIHRoaXMuZG93bnN0cmVhbVByb3RvY29sID09PSBNSlNPTldQICYmIHBhcnNlSW50KHJlc0JvZHlPYmouc3RhdHVzLCAxMCkgIT09IDApIHtcbiAgICAgICAgLy8gU29tZSBzZXJ2ZXJzLCBsaWtlIGNocm9tZWRyaXZlciBtYXkgcmV0dXJuIHJlc3BvbnNlIGNvZGUgMjAwIGZvciBub24temVybyBKU09OV1Agc3RhdHVzZXNcbiAgICAgICAgY29uc3QgbWVzc2FnZSA9IGBUaGUgcmVxdWVzdCB0byAke3VybH0gaGFzIGZhaWxlZGA7XG4gICAgICAgIGNvbnN0IGVyciA9IG5ldyBFcnJvcihtZXNzYWdlKTtcbiAgICAgICAgZXJyLm1lc3NhZ2UgPSBtZXNzYWdlO1xuICAgICAgICBlcnIuZXJyb3IgPSByZXNCb2R5O1xuICAgICAgICBlcnIuc3RhdHVzQ29kZSA9IDUwMDtcbiAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGxldCByZXNwb25zZUVycm9yID0gZS5lcnJvcjtcbiAgICAgIHRyeSB7XG4gICAgICAgIHJlc3BvbnNlRXJyb3IgPSBKU09OLnBhcnNlKHJlc3BvbnNlRXJyb3IpO1xuICAgICAgfSBjYXRjaCAoZTEpIHtcbiAgICAgICAgbG9nLndhcm4oYEdvdCBhbiB1bmV4cGVjdGVkIHJlc3BvbnNlOiBgICtcbiAgICAgICAgICBfLnRydW5jYXRlKF8uaXNTdHJpbmcocmVzcG9uc2VFcnJvcikgPyByZXNwb25zZUVycm9yIDogSlNPTi5zdHJpbmdpZnkocmVzcG9uc2VFcnJvciksIHtsZW5ndGg6IDMwMH0pKTtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBlcnJvcnMuUHJveHlSZXF1ZXN0RXJyb3IoYENvdWxkIG5vdCBwcm94eSBjb21tYW5kIHRvIHJlbW90ZSBzZXJ2ZXIuIGAgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YCwgcmVzcG9uc2VFcnJvciwgZS5zdGF0dXNDb2RlKTtcbiAgICB9XG4gICAgcmV0dXJuIFtyZXMsIHJlc0JvZHldO1xuICB9XG5cbiAgZ2V0UHJvdG9jb2xGcm9tUmVzQm9keSAocmVzQm9keSkge1xuICAgIGlmICghXy5pc1BsYWluT2JqZWN0KHJlc0JvZHkpKSB7XG4gICAgICB0cnkge1xuICAgICAgICByZXNCb2R5ID0gSlNPTi5wYXJzZShyZXNCb2R5KTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfVxuICAgIGlmICh1dGlsLmhhc1ZhbHVlKHJlc0JvZHkuc3RhdHVzKSkge1xuICAgICAgcmV0dXJuIE1KU09OV1A7XG4gICAgfVxuICAgIGlmICh1dGlsLmhhc1ZhbHVlKHJlc0JvZHkudmFsdWUpKSB7XG4gICAgICByZXR1cm4gVzNDO1xuICAgIH1cbiAgfVxuXG4gIHJlcXVlc3RUb0NvbW1hbmROYW1lICh1cmwsIG1ldGhvZCkge1xuICAgIGNvbnN0IGV4dHJhY3RDb21tYW5kTmFtZSA9IChwYXR0ZXJuKSA9PiB7XG4gICAgICBjb25zdCBwYXRoTWF0Y2ggPSBwYXR0ZXJuLmV4ZWModXJsKTtcbiAgICAgIHJldHVybiBwYXRoTWF0Y2ggPyByb3V0ZVRvQ29tbWFuZE5hbWUocGF0aE1hdGNoWzFdLCBtZXRob2QpIDogbnVsbDtcbiAgICB9O1xuICAgIGxldCBjb21tYW5kTmFtZSA9IHJvdXRlVG9Db21tYW5kTmFtZSh1cmwsIG1ldGhvZCk7XG4gICAgaWYgKCFjb21tYW5kTmFtZSAmJiBfLmluY2x1ZGVzKHVybCwgJy93ZC9odWIvc2Vzc2lvbi8nKSkge1xuICAgICAgY29tbWFuZE5hbWUgPSBleHRyYWN0Q29tbWFuZE5hbWUoL1xcL3dkXFwvaHViXFwvc2Vzc2lvblxcL1teL10rKC4rKS8pO1xuICAgIH1cbiAgICBpZiAoIWNvbW1hbmROYW1lICYmIF8uaW5jbHVkZXModXJsLCAnL3dkL2h1Yi8nKSkge1xuICAgICAgY29tbWFuZE5hbWUgPSBleHRyYWN0Q29tbWFuZE5hbWUoL1xcL3dkXFwvaHViKFxcLy4rKS8pO1xuICAgIH1cbiAgICByZXR1cm4gY29tbWFuZE5hbWU7XG4gIH1cblxuICBhc3luYyBwcm94eUNvbW1hbmQgKHVybCwgbWV0aG9kLCBib2R5ID0gbnVsbCkge1xuICAgIGNvbnN0IGNvbW1hbmROYW1lID0gdGhpcy5yZXF1ZXN0VG9Db21tYW5kTmFtZSh1cmwsIG1ldGhvZCk7XG4gICAgaWYgKCFjb21tYW5kTmFtZSkge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHkodXJsLCBtZXRob2QsIGJvZHkpO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYE1hdGNoZWQgJyR7dXJsfScgdG8gY29tbWFuZCBuYW1lICcke2NvbW1hbmROYW1lfSdgKTtcblxuICAgIHJldHVybiBhd2FpdCB0aGlzLnByb3RvY29sQ29udmVydGVyLmNvbnZlcnRBbmRQcm94eShjb21tYW5kTmFtZSwgdXJsLCBtZXRob2QsIGJvZHkpO1xuICB9XG5cbiAgYXN5bmMgY29tbWFuZCAodXJsLCBtZXRob2QsIGJvZHkgPSBudWxsKSB7XG4gICAgbGV0IHJlc3BvbnNlO1xuICAgIGxldCByZXNCb2R5O1xuICAgIHRyeSB7XG4gICAgICBbcmVzcG9uc2UsIHJlc0JvZHldID0gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQodXJsLCBtZXRob2QsIGJvZHkpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgaWYgKGlzRXJyb3JUeXBlKGVyciwgZXJyb3JzLlByb3h5UmVxdWVzdEVycm9yKSkge1xuICAgICAgICB0aHJvdyBlcnIuZ2V0QWN0dWFsRXJyb3IoKTtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBlcnJvcnMuVW5rbm93bkVycm9yKGVyci5tZXNzYWdlKTtcbiAgICB9XG4gICAgcmVzQm9keSA9IHV0aWwuc2FmZUpzb25QYXJzZShyZXNCb2R5KTtcbiAgICBsZXQgcHJvdG9jb2wgPSB0aGlzLmdldFByb3RvY29sRnJvbVJlc0JvZHkocmVzQm9keSk7XG4gICAgaWYgKHByb3RvY29sID09PSBNSlNPTldQKSB7XG4gICAgICAvLyBHb3QgcmVzcG9uc2UgaW4gTUpTT05XUCBmb3JtYXRcbiAgICAgIGlmIChyZXNwb25zZS5zdGF0dXNDb2RlID09PSAyMDAgJiYgcmVzQm9keS5zdGF0dXMgPT09IDApIHtcbiAgICAgICAgcmV0dXJuIHJlc0JvZHkudmFsdWU7XG4gICAgICB9XG4gICAgICBjb25zdCBzdGF0dXMgPSBwYXJzZUludChyZXNCb2R5LnN0YXR1cywgMTApO1xuICAgICAgaWYgKCFpc05hTihzdGF0dXMpICYmIHN0YXR1cyAhPT0gMCkge1xuICAgICAgICBsZXQgbWVzc2FnZSA9IHJlc0JvZHkudmFsdWU7XG4gICAgICAgIGlmIChfLmhhcyhyZXNCb2R5LnZhbHVlLCAnbWVzc2FnZScpKSB7XG4gICAgICAgICAgbWVzc2FnZSA9IF8uaXNFbXB0eShtZXNzYWdlKSA/IHJlc0JvZHkudmFsdWUubWVzc2FnZSA6IGAke21lc3NhZ2V9ICR7cmVzQm9keS52YWx1ZS5tZXNzYWdlfWA7XG4gICAgICAgIH1cbiAgICAgICAgdGhyb3cgZXJyb3JGcm9tTUpTT05XUFN0YXR1c0NvZGUoc3RhdHVzLCBfLmlzRW1wdHkobWVzc2FnZSkgPyBnZXRTdW1tYXJ5QnlDb2RlKHN0YXR1cykgOiBtZXNzYWdlKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHByb3RvY29sID09PSBXM0MpIHtcbiAgICAgIC8vIEdvdCByZXNwb25zZSBpbiBXM0MgZm9ybWF0XG4gICAgICBpZiAocmVzcG9uc2Uuc3RhdHVzQ29kZSA8IDMwMCkge1xuICAgICAgICByZXR1cm4gcmVzQm9keS52YWx1ZTtcbiAgICAgIH1cbiAgICAgIGlmIChfLmlzUGxhaW5PYmplY3QocmVzQm9keS52YWx1ZSkgJiYgcmVzQm9keS52YWx1ZS5lcnJvcikge1xuICAgICAgICB0aHJvdyBlcnJvckZyb21XM0NKc29uQ29kZShyZXNCb2R5LnZhbHVlLmVycm9yLCByZXNCb2R5LnZhbHVlLm1lc3NhZ2UsIHJlc0JvZHkudmFsdWUuc3RhY2t0cmFjZSk7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChyZXNwb25zZS5zdGF0dXNDb2RlID09PSAyMDApIHtcbiAgICAgIC8vIFVua25vd24gcHJvdG9jb2wuIEtlZXBpbmcgaXQgYmVjYXVzZSBvZiB0aGUgYmFja3dhcmQgY29tcGF0aWJpbGl0eVxuICAgICAgcmV0dXJuIHJlc0JvZHk7XG4gICAgfVxuICAgIHRocm93IG5ldyBlcnJvcnMuVW5rbm93bkVycm9yKGBEaWQgbm90IGtub3cgd2hhdCB0byBkbyB3aXRoIHJlc3BvbnNlIGNvZGUgJyR7cmVzcG9uc2Uuc3RhdHVzQ29kZX0nIGAgK1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGBhbmQgcmVzcG9uc2UgYm9keSAnJHtfLnRydW5jYXRlKEpTT04uc3RyaW5naWZ5KHJlc0JvZHkpLCB7bGVuZ3RoOiAzMDB9KX0nYCk7XG4gIH1cblxuICBnZXRTZXNzaW9uSWRGcm9tVXJsICh1cmwpIHtcbiAgICBjb25zdCBtYXRjaCA9IHVybC5tYXRjaCgvXFwvc2Vzc2lvblxcLyhbXi9dKykvKTtcbiAgICByZXR1cm4gbWF0Y2ggPyBtYXRjaFsxXSA6IG51bGw7XG4gIH1cblxuICBhc3luYyBwcm94eVJlcVJlcyAocmVxLCByZXMpIHtcbiAgICBsZXQgW3Jlc3BvbnNlLCBib2R5XSA9IGF3YWl0IHRoaXMucHJveHlDb21tYW5kKHJlcS5vcmlnaW5hbFVybCwgcmVxLm1ldGhvZCwgcmVxLmJvZHkpO1xuXG4gICAgcmVzLmhlYWRlcnMgPSByZXNwb25zZS5oZWFkZXJzO1xuICAgIHJlcy5zZXQoJ2NvbnRlbnQtdHlwZScsIHJlc3BvbnNlLmhlYWRlcnNbJ2NvbnRlbnQtdHlwZSddKTtcbiAgICAvLyBpZiB0aGUgcHJveGllZCByZXNwb25zZSBjb250YWlucyBhIHNlc3Npb25JZCB0aGF0IHRoZSBkb3duc3RyZWFtXG4gICAgLy8gZHJpdmVyIGhhcyBnZW5lcmF0ZWQsIHdlIGRvbid0IHdhbnQgdG8gcmV0dXJuIHRoYXQgdG8gdGhlIGNsaWVudC5cbiAgICAvLyBJbnN0ZWFkLCByZXR1cm4gdGhlIGlkIGZyb20gdGhlIHJlcXVlc3Qgb3IgZnJvbSBjdXJyZW50IHNlc3Npb25cbiAgICBib2R5ID0gdXRpbC5zYWZlSnNvblBhcnNlKGJvZHkpO1xuICAgIGlmIChib2R5ICYmIGJvZHkuc2Vzc2lvbklkKSB7XG4gICAgICBjb25zdCByZXFTZXNzaW9uSWQgPSB0aGlzLmdldFNlc3Npb25JZEZyb21VcmwocmVxLm9yaWdpbmFsVXJsKTtcbiAgICAgIGlmIChyZXFTZXNzaW9uSWQpIHtcbiAgICAgICAgbG9nLmluZm8oYFJlcGxhY2luZyBzZXNzaW9uSWQgJHtib2R5LnNlc3Npb25JZH0gd2l0aCAke3JlcVNlc3Npb25JZH1gKTtcbiAgICAgICAgYm9keS5zZXNzaW9uSWQgPSByZXFTZXNzaW9uSWQ7XG4gICAgICB9IGVsc2UgaWYgKHRoaXMuc2Vzc2lvbklkKSB7XG4gICAgICAgIGxvZy5pbmZvKGBSZXBsYWNpbmcgc2Vzc2lvbklkICR7Ym9keS5zZXNzaW9uSWR9IHdpdGggJHt0aGlzLnNlc3Npb25JZH1gKTtcbiAgICAgICAgYm9keS5zZXNzaW9uSWQgPSB0aGlzLnNlc3Npb25JZDtcbiAgICAgIH1cbiAgICB9XG4gICAgcmVzLnN0YXR1cyhyZXNwb25zZS5zdGF0dXNDb2RlKS5zZW5kKEpTT04uc3RyaW5naWZ5KGJvZHkpKTtcbiAgfVxufVxuXG5leHBvcnQgeyBKV1Byb3h5IH07XG5leHBvcnQgZGVmYXVsdCBKV1Byb3h5O1xuIl0sImZpbGUiOiJsaWIvanNvbndwLXByb3h5L3Byb3h5LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
