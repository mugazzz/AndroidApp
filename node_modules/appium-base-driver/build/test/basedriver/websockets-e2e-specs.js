"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _lodash = _interopRequireDefault(require("lodash"));

var _2 = require("../..");

var _fakeDriver = require("../protocol/fake-driver");

var _chai = _interopRequireDefault(require("chai"));

var _chaiAsPromised = _interopRequireDefault(require("chai-as-promised"));

var _ws = _interopRequireDefault(require("ws"));

var _bluebird = _interopRequireDefault(require("bluebird"));

_chai.default.use(_chaiAsPromised.default);

describe('Websockets (e2e)', function () {
  let baseServer;
  let driver;
  const SESSION_ID = 'foo';
  const WS_DATA = 'Hello';
  const PORT = 8181;
  before((0, _asyncToGenerator2.default)(function* () {
    driver = new _fakeDriver.FakeDriver();
    driver.sessionId = SESSION_ID;
    baseServer = yield (0, _2.server)((0, _2.routeConfiguringFunction)(driver), PORT);
  }));
  after((0, _asyncToGenerator2.default)(function* () {
    yield baseServer.close();
  }));
  describe('web sockets support', function () {
    it('should be able to add websocket handler and remove it', (0, _asyncToGenerator2.default)(function* () {
      const wss = new _ws.default.Server({
        noServer: true
      });
      wss.on('connection', ws => {
        if (ws && ws.readyState === _ws.default.OPEN) {
          ws.send(WS_DATA);
        }
      });
      const previousListenerCount = baseServer.listenerCount('upgrade');
      const endpoint = `${_2.DEFAULT_WS_PATHNAME_PREFIX}/hello`;
      const timeout = 5000;
      yield baseServer.addWebSocketHandler(endpoint, wss);
      baseServer.listenerCount('upgrade').should.be.above(previousListenerCount);

      _lodash.default.keys((yield baseServer.getWebSocketHandlers())).length.should.eql(1);

      yield new _bluebird.default((resolve, reject) => {
        const client = new _ws.default(`ws://localhost:${PORT}${endpoint}`);
        client.on('connection', (ws, req) => {
          ws.should.not.be.empty;
          req.connection.remoteAddress.should.not.be.empty;
        });
        client.on('message', data => {
          data.should.eql(WS_DATA);
          resolve();
        });
        client.on('error', reject);
        setTimeout(() => reject(new Error('No websocket messages have been received after the timeout')), timeout);
      });
      (yield baseServer.removeWebSocketHandler(endpoint)).should.be.true;

      _lodash.default.keys((yield baseServer.getWebSocketHandlers())).length.should.eql(0);

      yield new _bluebird.default((resolve, reject) => {
        const client = new _ws.default(`ws://localhost:${PORT}${endpoint}`);
        client.on('message', data => reject(new Error(`No websocket messages are expected after the handler ` + `has been removed. '${data}' is received instead. `)));
        client.on('error', resolve);
        setTimeout(resolve, timeout);
      });
      baseServer.listenerCount('upgrade').should.be.above(previousListenerCount);
    }));
  });
});require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvYmFzZWRyaXZlci93ZWJzb2NrZXRzLWUyZS1zcGVjcy5qcyJdLCJuYW1lcyI6WyJjaGFpIiwidXNlIiwiY2hhaUFzUHJvbWlzZWQiLCJkZXNjcmliZSIsImJhc2VTZXJ2ZXIiLCJkcml2ZXIiLCJTRVNTSU9OX0lEIiwiV1NfREFUQSIsIlBPUlQiLCJiZWZvcmUiLCJGYWtlRHJpdmVyIiwic2Vzc2lvbklkIiwiYWZ0ZXIiLCJjbG9zZSIsIml0Iiwid3NzIiwiV2ViU29ja2V0IiwiU2VydmVyIiwibm9TZXJ2ZXIiLCJvbiIsIndzIiwicmVhZHlTdGF0ZSIsIk9QRU4iLCJzZW5kIiwicHJldmlvdXNMaXN0ZW5lckNvdW50IiwibGlzdGVuZXJDb3VudCIsImVuZHBvaW50IiwiREVGQVVMVF9XU19QQVRITkFNRV9QUkVGSVgiLCJ0aW1lb3V0IiwiYWRkV2ViU29ja2V0SGFuZGxlciIsInNob3VsZCIsImJlIiwiYWJvdmUiLCJfIiwia2V5cyIsImdldFdlYlNvY2tldEhhbmRsZXJzIiwibGVuZ3RoIiwiZXFsIiwiQiIsInJlc29sdmUiLCJyZWplY3QiLCJjbGllbnQiLCJyZXEiLCJub3QiLCJlbXB0eSIsImNvbm5lY3Rpb24iLCJyZW1vdGVBZGRyZXNzIiwiZGF0YSIsInNldFRpbWVvdXQiLCJFcnJvciIsInJlbW92ZVdlYlNvY2tldEhhbmRsZXIiLCJ0cnVlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQUEsY0FBS0MsR0FBTCxDQUFTQyx1QkFBVDs7QUFFQUMsUUFBUSxDQUFDLGtCQUFELEVBQXFCLFlBQVk7QUFDdkMsTUFBSUMsVUFBSjtBQUNBLE1BQUlDLE1BQUo7QUFDQSxRQUFNQyxVQUFVLEdBQUcsS0FBbkI7QUFDQSxRQUFNQyxPQUFPLEdBQUcsT0FBaEI7QUFDQSxRQUFNQyxJQUFJLEdBQUcsSUFBYjtBQUVBQyxFQUFBQSxNQUFNLGlDQUFDLGFBQWtCO0FBQ3ZCSixJQUFB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LENBQWxFOztBQUNBLFlBQU0sSUFBSUMsaUJBQUosQ0FBTSxDQUFDQyxPQUFELEVBQVVDLE1BQVYsS0FBcUI7QUFDL0IsY0FBTUMsTUFBTSxHQUFHLElBQUl6QixXQUFKLENBQWUsa0JBQWlCUixJQUFLLEdBQUVrQixRQUFTLEVBQWhELENBQWY7QUFDQWUsUUFBQUEsTUFBTSxDQUFDdEIsRUFBUCxDQUFVLFNBQVYsRUFBc0I0QixJQUFELElBQ25CUCxNQUFNLENBQUMsSUFBSVMsS0FBSixDQUFXLHVEQUFELEdBQ0Msc0JBQXFCRixJQUFLLHlCQURyQyxDQUFELENBRFI7QUFJQU4sUUFBQUEsTUFBTSxDQUFDdEIsRUFBUCxDQUFVLE9BQVYsRUFBbUJvQixPQUFuQjtBQUNBUyxRQUFBQSxVQUFVLENBQUNULE9BQUQsRUFBVVgsT0FBVixDQUFWO0FBQ0QsT0FSSyxDQUFOO0FBU0F4QixNQUFBQSxVQUFVLENBQUNxQixhQUFYLENBQXlCLFNBQXpCLEVBQW9DSyxNQUFwQyxDQUEyQ0MsRUFBM0MsQ0FBOENDLEtBQTlDLENBQW9EUixxQkFBcEQ7QUFDRCxLQTFDQyxFQUFGO0FBMkNELEdBNUNPLENBQVI7QUE2Q0QsQ0E3RE8sQ0FBUiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBzZXJ2ZXIsIHJvdXRlQ29uZmlndXJpbmdGdW5jdGlvbixcbiAgICAgICAgIERFRkFVTFRfV1NfUEFUSE5BTUVfUFJFRklYIH0gZnJvbSAnLi4vLi4nO1xuaW1wb3J0IHsgRmFrZURyaXZlciB9IGZyb20gJy4uL3Byb3RvY29sL2Zha2UtZHJpdmVyJztcbmltcG9ydCBjaGFpIGZyb20gJ2NoYWknO1xuaW1wb3J0IGNoYWlBc1Byb21pc2VkIGZyb20gJ2NoYWktYXMtcHJvbWlzZWQnO1xuaW1wb3J0IFdlYlNvY2tldCBmcm9tICd3cyc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5cbmNoYWkudXNlKGNoYWlBc1Byb21pc2VkKTtcblxuZGVzY3JpYmUoJ1dlYnNvY2tldHMgKGUyZSknLCBmdW5jdGlvbiAoKSB7XG4gIGxldCBiYXNlU2VydmVyO1xuICBsZXQgZHJpdmVyO1xuICBjb25zdCBTRVNTSU9OX0lEID0gJ2Zvbyc7XG4gIGNvbnN0IFdTX0RBVEEgPSAnSGVsbG8nO1xuICBjb25zdCBQT1JUID0gODE4MTtcblxuICBiZWZvcmUoYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgIGRyaXZlciA9IG5ldyBGYWtlRHJpdmVyKCk7XG4gICAgZHJpdmVyLnNlc3Npb25JZCA9IFNFU1NJT05fSUQ7XG4gICAgYmFzZVNlcnZlciA9IGF3YWl0IHNlcnZlcihyb3V0ZUNvbmZpZ3VyaW5nRnVuY3Rpb24oZHJpdmVyKSwgUE9SVCk7XG4gIH0pO1xuICBhZnRlcihhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgYXdhaXQgYmFzZVNlcnZlci5jbG9zZSgpO1xuICB9KTtcblxuICBkZXNjcmliZSgnd2ViIHNvY2tldHMgc3VwcG9ydCcsIGZ1bmN0aW9uICgpIHtcbiAgICBpdCgnc2hvdWxkIGJlIGFibGUgdG8gYWRkIHdlYnNvY2tldCBoYW5kbGVyIGFuZCByZW1vdmUgaXQnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBjb25zdCB3c3MgPSBuZXcgV2ViU29ja2V0LlNlcnZlcih7XG4gICAgICAgIG5vU2VydmVyOiB0cnVlLFxuICAgICAgfSk7XG4gICAgICB3c3Mub24oJ2Nvbm5lY3Rpb24nLCAod3MpID0+IHtcbiAgICAgICAgaWYgKHdzICYmIHdzLnJlYWR5U3RhdGUgPT09IFdlYlNvY2tldC5PUEVOKSB7XG4gICAgICAgICAgd3Muc2VuZChXU19EQVRBKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICBjb25zdCBwcmV2aW91c0xpc3RlbmVyQ291bnQgPSBiYXNlU2VydmVyLmxpc3RlbmVyQ291bnQoJ3VwZ3JhZGUnKTtcbiAgICAgIGNvbnN0IGVuZHBvaW50ID0gYCR7REVGQVVMVF9XU19QQVRITkFNRV9QUkVGSVh9L2hlbGxvYDtcbiAgICAgIGNvbnN0IHRpbWVvdXQgPSA1MDAwO1xuICAgICAgYXdhaXQgYmFzZVNlcnZlci5hZGRXZWJTb2NrZXRIYW5kbGVyKGVuZHBvaW50LCB3c3MpO1xuICAgICAgYmFzZVNlcnZlci5saXN0ZW5lckNvdW50KCd1cGdyYWRlJykuc2hvdWxkLmJlLmFib3ZlKHByZXZpb3VzTGlzdGVuZXJDb3VudCk7XG4gICAgICBfLmtleXMoYXdhaXQgYmFzZVNlcnZlci5nZXRXZWJTb2NrZXRIYW5kbGVycygpKS5sZW5ndGguc2hvdWxkLmVxbCgxKTtcbiAgICAgIGF3YWl0IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgY29uc3QgY2xpZW50ID0gbmV3IFdlYlNvY2tldChgd3M6Ly9sb2NhbGhvc3Q6JHtQT1JUfSR7ZW5kcG9pbnR9YCk7XG4gICAgICAgIGNsaWVudC5vbignY29ubmVjdGlvbicsICh3cywgcmVxKSA9PiB7XG4gICAgICAgICAgd3Muc2hvdWxkLm5vdC5iZS5lbXB0eTtcbiAgICAgICAgICByZXEuY29ubmVjdGlvbi5yZW1vdGVBZGRyZXNzLnNob3VsZC5ub3QuYmUuZW1wdHk7XG4gICAgICAgIH0pO1xuICAgICAgICBjbGllbnQub24oJ21lc3NhZ2UnLCAoZGF0YSkgPT4ge1xuICAgICAgICAgIGRhdGEuc2hvdWxkLmVxbChXU19EQVRBKTtcbiAgICAgICAgICByZXNvbHZlKCk7XG4gICAgICAgIH0pO1xuICAgICAgICBjbGllbnQub24oJ2Vycm9yJywgcmVqZWN0KTtcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiByZWplY3QobmV3IEVycm9yKCdObyB3ZWJzb2NrZXQgbWVzc2FnZXMgaGF2ZSBiZWVuIHJlY2VpdmVkIGFmdGVyIHRoZSB0aW1lb3V0JykpLFxuICAgICAgICAgICAgICAgICAgIHRpbWVvdXQpO1xuICAgICAgfSk7XG5cbiAgICAgIChhd2FpdCBiYXNlU2VydmVyLnJlbW92ZVdlYlNvY2tldEhhbmRsZXIoZW5kcG9pbnQpKS5zaG91bGQuYmUudHJ1ZTtcbiAgICAgIF8ua2V5cyhhd2FpdCBiYXNlU2VydmVyLmdldFdlYlNvY2tldEhhbmRsZXJzKCkpLmxlbmd0aC5zaG91bGQuZXFsKDApO1xuICAgICAgYXdhaXQgbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBjb25zdCBjbGllbnQgPSBuZXcgV2ViU29ja2V0KGB3czovL2xvY2FsaG9zdDoke1BPUlR9JHtlbmRwb2ludH1gKTtcbiAgICAgICAgY2xpZW50Lm9uKCdtZXNzYWdlJywgKGRhdGEpID0+XG4gICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihgTm8gd2Vic29ja2V0IG1lc3NhZ2VzIGFyZSBleHBlY3RlZCBhZnRlciB0aGUgaGFuZGxlciBgICtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIGBoYXMgYmVlbiByZW1vdmVkLiAnJHtkYXRhfScgaXMgcmVjZWl2ZWQgaW5zdGVhZC4gYCkpXG4gICAgICAgICk7XG4gICAgICAgIGNsaWVudC5vbignZXJyb3InLCByZXNvbHZlKTtcbiAgICAgICAgc2V0VGltZW91dChyZXNvbHZlLCB0aW1lb3V0KTtcbiAgICAgIH0pO1xuICAgICAgYmFzZVNlcnZlci5saXN0ZW5lckNvdW50KCd1cGdyYWRlJykuc2hvdWxkLmJlLmFib3ZlKHByZXZpb3VzTGlzdGVuZXJDb3VudCk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwiZmlsZSI6InRlc3QvYmFzZWRyaXZlci93ZWJzb2NrZXRzLWUyZS1zcGVjcy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
