"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _lodash = _interopRequireDefault(require("lodash"));

var _2 = require("../..");

var _requestPromise = _interopRequireDefault(require("request-promise"));

var _chai = _interopRequireDefault(require("chai"));

var _chaiAsPromised = _interopRequireDefault(require("chai-as-promised"));

var _bluebird = _interopRequireDefault(require("bluebird"));

const should = _chai.default.should();

_chai.default.use(_chaiAsPromised.default);

function baseDriverE2ETests(DriverClass, defaultCaps = {}) {
  describe('BaseDriver (e2e)', function () {
    let baseServer,
        d = new DriverClass();
    before((0, _asyncToGenerator2.default)(function* () {
      baseServer = yield (0, _2.server)((0, _2.routeConfiguringFunction)(d), 8181);
    }));
    after((0, _asyncToGenerator2.default)(function* () {
      yield baseServer.close();
    }));

    function startSession(caps) {
      return (0, _requestPromise.default)({
        url: 'http://localhost:8181/wd/hub/session',
        method: 'POST',
        json: {
          desiredCapabilities: caps,
          requiredCapabilities: {}
        }
      });
    }

    function endSession(id) {
      return (0, _requestPromise.default)({
        url: `http://localhost:8181/wd/hub/session/${id}`,
        method: 'DELETE',
        json: true,
        simple: false
      });
    }

    function getSession(id) {
      return (0, _requestPromise.default)({
        url: `http://localhost:8181/wd/hub/session/${id}`,
        method: 'GET',
        json: true,
        simple: false
      });
    }

    describe('session handling', function () {
      it('should create session and retrieve a session id, then delete it', (0, _asyncToGenerator2.default)(function* () {
        let res = yield (0, _requestPromise.default)({
          url: 'http://localhost:8181/wd/hub/session',
          method: 'POST',
          json: {
            desiredCapabilities: defaultCaps,
            requiredCapabilities: {}
          },
          simple: false,
          resolveWithFullResponse: true
        });
        res.statusCode.should.equal(200);
        res.body.status.should.equal(0);
        should.exist(res.body.sessionId);
        res.body.value.should.eql(defaultCaps);
        res = yield (0, _requestPromise.default)({
          url: `http://localhost:8181/wd/hub/session/${d.sessionId}`,
          method: 'DELETE',
          json: true,
          simple: false,
          resolveWithFullResponse: true
        });
        res.statusCode.should.equal(200);
        res.body.status.should.equal(0);
        should.equal(d.sessionId, null);
      }));
    });
    it.skip('should throw NYI for commands not implemented', (0, _asyncToGenerator2.default)(function* () {}));
    describe('command timeouts', function () {
      function startTimeoutSession(timeout) {
        let caps = _lodash.default.clone(defaultCaps);

        caps.newCommandTimeout = timeout;
        return startSession(caps);
      }

      d.findElement = function () {
        return 'foo';
      }.bind(d);

      d.findElements = (0, _asyncToGenerator2.default)(function* () {
        yield _bluebird.default.delay(200);
        return ['foo'];
      }).bind(d);
      it('should set a default commandTimeout', (0, _asyncToGenerator2.default)(function* () {
        let newSession = yield startTimeoutSession();
        d.newCommandTimeoutMs.should.be.above(0);
        yield endSession(newSession.sessionId);
      }));
      it('should timeout on commands using commandTimeout cap', (0, _asyncToGenerator2.default)(function* () {
        let newSession = yield startTimeoutSession(0.25);
        yield (0, _requestPromise.default)({
          url: `http://localhost:8181/wd/hub/session/${d.sessionId}/element`,
          method: 'POST',
          json: {
            using: 'name',
            value: 'foo'
          }
        });
        yield _bluebird.default.delay(400);
        let res = yield (0, _requestPromise.default)({
          url: `http://localhost:8181/wd/hub/session/${d.sessionId}`,
          method: 'GET',
          json: true,
          simple: false
        });
        res.status.should.equal(6);
        should.equal(d.sessionId, null);
        res = yield endSession(newSession.sessionId);
        res.status.should.equal(6);
      }));
      it('should not timeout with commandTimeout of false', (0, _asyncToGenerator2.default)(function* () {
        let newSession = yield startTimeoutSession(0.1);
        let start = Date.now();
        let res = yield (0, _requestPromise.default)({
          url: `http://localhost:8181/wd/hub/session/${d.sessionId}/elements`,
          method: 'POST',
          json: {
            using: 'name',
            value: 'foo'
          }
        });
        (Date.now() - start).should.be.above(150);
        res.value.should.eql(['foo']);
        yield endSession(newSession.sessionId);
      }));
      it('should not timeout with commandTimeout of 0', (0, _asyncToGenerator2.default)(function* () {
        d.newCommandTimeoutMs = 2;
        let newSession = yield startTimeoutSession(0);
        yield (0, _requestPromise.default)({
          url: `http://localhost:8181/wd/hub/session/${d.sessionId}/element`,
          method: 'POST',
          json: {
            using: 'name',
            value: 'foo'
          }
        });
        yield _bluebird.default.delay(400);
        let res = yield (0, _requestPromise.default)({
          url: `http://localhost:8181/wd/hub/session/${d.sessionId}`,
          method: 'GET',
          json: true,
          simple: false
        });
        res.status.should.equal(0);
        res = yield endSession(newSession.sessionId);
        res.status.should.equal(0);
        d.newCommandTimeoutMs = 60 * 1000;
      }));
      it('should not timeout if its just the command taking awhile', (0, _asyncToGenerator2.default)(function* () {
        let newSession = yield startTimeoutSession(0.25);
        yield (0, _requestPromise.default)({
          url: `http://localhost:8181/wd/hub/session/${d.sessionId}/element`,
          method: 'POST',
          json: {
            using: 'name',
            value: 'foo'
          }
        });
        yield _bluebird.default.delay(400);
        let res = yield (0, _requestPromise.default)({
          url: `http://localhost:8181/wd/hub/session/${d.sessionId}`,
          method: 'GET',
          json: true,
          simple: false
        });
        res.status.should.equal(6);
        should.equal(d.sessionId, null);
        res = yield endSession(newSession.sessionId);
        res.status.should.equal(6);
      }));
      it('should not have a timer running before or after a session', (0, _asyncToGenerator2.default)(function* () {
        should.not.exist(d.noCommandTimer);
        let newSession = yield startTimeoutSession(0.25);
        newSession.sessionId.should.equal(d.sessionId);
        should.exist(d.noCommandTimer);
        yield endSession(newSession.sessionId);
        should.not.exist(d.noCommandTimer);
      }));
    });
    describe('settings api', function () {
      before(function () {
        d.settings = new _2.DeviceSettings({
          ignoreUnimportantViews: false
        });
      });
      it('should be able to get settings object', function () {
        d.settings.getSettings().ignoreUnimportantViews.should.be.false;
      });
      it('should throw error when updateSettings method is not defined', (0, _asyncToGenerator2.default)(function* () {
        yield d.settings.update({
          ignoreUnimportantViews: true
        }).should.eventually.be.rejectedWith('onSettingsUpdate');
      }));
      it('should throw error for invalid update object', (0, _asyncToGenerator2.default)(function* () {
        yield d.settings.update('invalid json').should.eventually.be.rejectedWith('JSON');
      }));
    });
    describe('unexpected exits', function () {
      it('should reject a current command when the driver crashes', (0, _asyncToGenerator2.default)(function* () {
        d._oldGetStatus = d.getStatus;
        d.getStatus = (0, _asyncToGenerator2.default)(function* () {
          yield _bluebird.default.delay(5000);
        }).bind(d);
        let p = (0, _requestPromise.default)({
          url: 'http://localhost:8181/wd/hub/status',
          method: 'GET',
          json: true,
          simple: false
        });
        yield _bluebird.default.delay(100);
        d.startUnexpectedShutdown(new Error('Crashytimes'));
        let res = yield p;
        res.status.should.equal(13);
        res.value.message.should.contain('Crashytimes');
        yield d.onUnexpectedShutdown.should.be.rejectedWith('Crashytimes');
      }));
    });
    describe('event timings', function () {
      it('should not add timings if not using opt-in cap', (0, _asyncToGenerator2.default)(function* () {
        let session = yield startSession(defaultCaps);
        let res = yield getSession(session.sessionId);
        should.not.exist(res.events);
        yield endSession(session.sessionId);
      }));
      it('should add start session timings', (0, _asyncToGenerator2.default)(function* () {
        let caps = Object.assign({}, defaultCaps, {
          eventTimings: true
        });
        let session = yield startSession(caps);
        let res = (yield getSession(session.sessionId)).value;
        should.exist(res.events);
        should.exist(res.events.newSessionRequested);
        should.exist(res.events.newSessionStarted);
        res.events.newSessionRequested[0].should.be.a('number');
        res.events.newSessionStarted[0].should.be.a('number');
        yield endSession(session.sessionId);
      }));
    });
  });
}

var _default = baseDriverE2ETests;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvYmFzZWRyaXZlci9kcml2ZXItZTJlLXRlc3RzLmpzIl0sIm5hbWVzIjpbInNob3VsZCIsImNoYWkiLCJ1c2UiLCJjaGFpQXNQcm9taXNlZCIsImJhc2VEcml2ZXJFMkVUZXN0cyIsIkRyaXZlckNsYXNzIiwiZGVmYXVsdENhcHMiLCJkZXNjcmliZSIsImJhc2VTZXJ2ZXIiLCJkIiwiYmVmb3JlIiwiYWZ0ZXIiLCJjbG9zZSIsInN0YXJ0U2Vzc2lvbiIsImNhcHMiLCJ1cmwiLCJtZXRob2QiLCJqc29uIiwiZGVzaXJlZENhcGFiaWxpdGllcyIsInJlcXVpcmVkQ2FwYWJpbGl0aWVzIiwiZW5kU2Vzc2lvbiIsImlkIiwic2ltcGxlIiwiZ2V0U2Vzc2lvbiIsIml0IiwicmVzIiwicmVzb2x2ZVdpdGhGdWxsUmVzcG9uc2UiLCJzdGF0dXNDb2RlIiwiZXF1YWwiLCJib2R5Iiwic3RhdHVzIiwiZXhpc3QiLCJzZXNzaW9uSWQiLCJ2YWx1ZSIsImVxbCIsInNraXAiLCJzdGFydFRpbWVvdXRTZXNzaW9uIiwidGltZW91dCIsIl8iLCJjbG9uZSIsIm5ld0NvbW1hbmRUaW1lb3V0IiwiZmluZEVsZW1lbnQiLCJiaW5kIiwiZmluZEVsZW1lbnRzIiwiQiIsImRlbGF5IiwibmV3U2Vzc2lvbiIsIm5ld0NvbW1hbmRUaW1lb3V0TXMiLCJiZSIsImFib3ZlIiwidXNpbmciLCJzdGFydCIsIkRhdGUiLCJub3ciLCJub3QiLCJub0NvbW1hbmRUaW1lciIsInNldHRpbmdzIiwiRGV2aWNlU2V0dGluZ3MiLCJpZ25vcmVVbmltcG9ydGFudFZpZXdzIiwiZ2V0U2V0dGluZ3MiLCJmYWxzZSIsInVwZGF0ZSIsImV2ZW50dWFsbHkiLCJyZWplY3RlZFdpdGgiLCJfb2xkR2V0U3RhdHVzIiwiZ2V0U3RhdHVzIiwicCIsInN0YXJ0VW5leHBlY3RlZFNodXRkb3duIiwiRXJyb3IiLCJtZXNzYWdlIiwiY29udGFpbiIsIm9uVW5leHBlY3RlZFNodXRkb3duIiwic2Vzc2lvbiIsImV2ZW50cyIsIk9iamVjdCIsImFzc2lnbiIsImV2ZW50VGltaW5ncyIsIm5ld1Nlc3Npb25SZXF1ZXN0ZWQiLCJuZXdTZXNzaW9uU3RhcnRlZCIsImEiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsTUFBTSxHQUFHQyxjQUFLRCxNQUFMLEVBQWY7O0FBQ0FDLGNBQUtDLEdBQUwsQ0FBU0MsdUJBQVQ7O0FBRUEsU0FBU0Msa0JBQVQsQ0FBNkJDLFdBQTdCLEVBQTBDQyxXQUFXLEdBQUcsRUFBeEQsRUFBNEQ7QUFDMURDLEVBQUFBLFFBQVEsQ0FBQyxrQkFBRCxFQUFxQixZQUFZO0FBQ3ZDLFFBQUlDLFVBQUo7QUFBQSxRQUFnQkMsQ0FBQyxHQUFHLElBQUlKLFdBQUosRUFBcEI7QUFDQUssSUFBQUEsTUFBTSxpQ0FBQyxhQUFrQjtBQUN2QkYsTUFBQUEsVUFBVSxTQUFTLGVBQU8saUNBQXlCQyxDQUF6QixDQUFQLEVBQW9DLElBQXBDLENBQW5CO0FBQ0QsS0FGSyxFQUFOO0FBR0FFLElBQUFBLEtBQUssaUNBQUMsYUFBa0I7QUFDdEIsWUFBTUgsVUFBVSxDQUFDSSxLQUFYLEVBQU47QUFDRCxLQUZJLEVBQUw7O0FBSUEsYUFBU0MsWUFBVCxDQUF1QkMsSUFBdkIsRUFBNkI7QUFDM0IsYUFBTyw2QkFBUTtBQUNiQyxRQUFBQSxHQUFHLEVBQUUsc0NBRFE7QUFFYkMsUUFBQUEsTUFBTSxFQUFFLE1BRks7QUFHYkMsUUFBQUEsSUFBSSxFQUFFO0FBQUNDLFVBQUFBLG1CQUFtQixFQUFFSixJQUF0QjtBQUE0QkssVUFBQUEsb0JBQW9CLEVBQUU7QUFBbEQ7QUFITyxPQUFSLENBQVA7QUFLRDs7QUFFRCxhQUFTQyxVQUFULENBQXFCQyxFQUFyQixFQUF5QjtBQUN2QixhQUFPLDZCQUFRO0FBQ2JOLFFBQUFBLEdBQUcsRUFBRyx3Q0FBdUNNLEVBQUcsRUFEbkM7QUFFYkwsUUFBQUEsTUFBTSxFQUFFLFFBRks7QUFHYkMsUUFB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LCByb3V0ZUNvbmZpZ3VyaW5nRnVuY3Rpb24sIERldmljZVNldHRpbmdzIH0gZnJvbSAnLi4vLi4nO1xuaW1wb3J0IHJlcXVlc3QgZnJvbSAncmVxdWVzdC1wcm9taXNlJztcbmltcG9ydCBjaGFpIGZyb20gJ2NoYWknO1xuaW1wb3J0IGNoYWlBc1Byb21pc2VkIGZyb20gJ2NoYWktYXMtcHJvbWlzZWQnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuXG5jb25zdCBzaG91bGQgPSBjaGFpLnNob3VsZCgpO1xuY2hhaS51c2UoY2hhaUFzUHJvbWlzZWQpO1xuXG5mdW5jdGlvbiBiYXNlRHJpdmVyRTJFVGVzdHMgKERyaXZlckNsYXNzLCBkZWZhdWx0Q2FwcyA9IHt9KSB7XG4gIGRlc2NyaWJlKCdCYXNlRHJpdmVyIChlMmUpJywgZnVuY3Rpb24gKCkge1xuICAgIGxldCBiYXNlU2VydmVyLCBkID0gbmV3IERyaXZlckNsYXNzKCk7XG4gICAgYmVmb3JlKGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGJhc2VTZXJ2ZXIgPSBhd2FpdCBzZXJ2ZXIocm91dGVDb25maWd1cmluZ0Z1bmN0aW9uKGQpLCA4MTgxKTtcbiAgICB9KTtcbiAgICBhZnRlcihhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBhd2FpdCBiYXNlU2VydmVyLmNsb3NlKCk7XG4gICAgfSk7XG5cbiAgICBmdW5jdGlvbiBzdGFydFNlc3Npb24gKGNhcHMpIHtcbiAgICAgIHJldHVybiByZXF1ZXN0KHtcbiAgICAgICAgdXJsOiAnaHR0cDovL2xvY2FsaG9zdDo4MTgxL3dkL2h1Yi9zZXNzaW9uJyxcbiAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgIGpzb246IHtkZXNpcmVkQ2FwYWJpbGl0aWVzOiBjYXBzLCByZXF1aXJlZENhcGFiaWxpdGllczoge319LFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZW5kU2Vzc2lvbiAoaWQpIHtcbiAgICAgIHJldHVybiByZXF1ZXN0KHtcbiAgICAgICAgdXJsOiBgaHR0cDovL2xvY2FsaG9zdDo4MTgxL3dkL2h1Yi9zZXNzaW9uLyR7aWR9YCxcbiAgICAgICAgbWV0aG9kOiAnREVMRVRFJyxcbiAgICAgICAganNvbjogdHJ1ZSxcbiAgICAgICAgc2ltcGxlOiBmYWxzZVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZ2V0U2Vzc2lvbiAoaWQpIHtcbiAgICAgIHJldHVybiByZXF1ZXN0KHtcbiAgICAgICAgdXJsOiBgaHR0cDovL2xvY2FsaG9zdDo4MTgxL3dkL2h1Yi9zZXNzaW9uLyR7aWR9YCxcbiAgICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgICAganNvbjogdHJ1ZSxcbiAgICAgICAgc2ltcGxlOiBmYWxzZVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgZGVzY3JpYmUoJ3Nlc3Npb24gaGFuZGxpbmcnLCBmdW5jdGlvbiAoKSB7XG4gICAgICBpdCgnc2hvdWxkIGNyZWF0ZSBzZXNzaW9uIGFuZCByZXRyaWV2ZSBhIHNlc3Npb24gaWQsIHRoZW4gZGVsZXRlIGl0JywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICBsZXQgcmVzID0gYXdhaXQgcmVxdWVzdCh7XG4gICAgICAgICAgdXJsOiAnaHR0cDovL2xvY2FsaG9zdDo4MTgxL3dkL2h1Yi9zZXNzaW9uJyxcbiAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgICBqc29uOiB7ZGVzaXJlZENhcGFiaWxpdGllczogZGVmYXVsdENhcHMsIHJlcXVpcmVkQ2FwYWJpbGl0aWVzOiB7fX0sXG4gICAgICAgICAgc2ltcGxlOiBmYWxzZSxcbiAgICAgICAgICByZXNvbHZlV2l0aEZ1bGxSZXNwb25zZTogdHJ1ZVxuICAgICAgICB9KTtcblxuICAgICAgICByZXMuc3RhdHVzQ29kZS5zaG91bGQuZXF1YWwoMjAwKTtcbiAgICAgICAgcmVzLmJvZHkuc3RhdHVzLnNob3VsZC5lcXVhbCgwKTtcbiAgICAgICAgc2hvdWxkLmV4aXN0KHJlcy5ib2R5LnNlc3Npb25JZCk7XG4gICAgICAgIHJlcy5ib2R5LnZhbHVlLnNob3VsZC5lcWwoZGVmYXVsdENhcHMpO1xuXG4gICAgICAgIHJlcyA9IGF3YWl0IHJlcXVlc3Qoe1xuICAgICAgICAgIHVybDogYGh0dHA6Ly9sb2NhbGhvc3Q6ODE4MS93ZC9odWIvc2Vzc2lvbi8ke2Quc2Vzc2lvbklkfWAsXG4gICAgICAgICAgbWV0aG9kOiAnREVMRVRFJyxcbiAgICAgICAgICBqc29uOiB0cnVlLFxuICAgICAgICAgIHNpbXBsZTogZmFsc2UsXG4gICAgICAgICAgcmVzb2x2ZVdpdGhGdWxsUmVzcG9uc2U6IHRydWVcbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmVzLnN0YXR1c0NvZGUuc2hvdWxkLmVxdWFsKDIwMCk7XG4gICAgICAgIHJlcy5ib2R5LnN0YXR1cy5zaG91bGQuZXF1YWwoMCk7XG4gICAgICAgIHNob3VsZC5lcXVhbChkLnNlc3Npb25JZCwgbnVsbCk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0LnNraXAoJ3Nob3VsZCB0aHJvdyBOWUkgZm9yIGNvbW1hbmRzIG5vdCBpbXBsZW1lbnRlZCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICB9KTtcblxuICAgIGRlc2NyaWJlKCdjb21tYW5kIHRpbWVvdXRzJywgZnVuY3Rpb24gKCkge1xuICAgICAgZnVuY3Rpb24gc3RhcnRUaW1lb3V0U2Vzc2lvbiAodGltZW91dCkge1xuICAgICAgICBsZXQgY2FwcyA9IF8uY2xvbmUoZGVmYXVsdENhcHMpO1xuICAgICAgICBjYXBzLm5ld0NvbW1hbmRUaW1lb3V0ID0gdGltZW91dDtcbiAgICAgICAgcmV0dXJuIHN0YXJ0U2Vzc2lvbihjYXBzKTtcbiAgICAgIH1cblxuICAgICAgZC5maW5kRWxlbWVudCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgcmV0dXJuICdmb28nO1xuICAgICAgfS5iaW5kKGQpO1xuXG4gICAgICBkLmZpbmRFbGVtZW50cyA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgYXdhaXQgQi5kZWxheSgyMDApO1xuICAgICAgICByZXR1cm4gWydmb28nXTtcbiAgICAgIH0uYmluZChkKTtcblxuICAgICAgaXQoJ3Nob3VsZCBzZXQgYSBkZWZhdWx0IGNvbW1hbmRUaW1lb3V0JywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICBsZXQgbmV3U2Vzc2lvbiA9IGF3YWl0IHN0YXJ0VGltZW91dFNlc3Npb24oKTtcbiAgICAgICAgZC5uZXdDb21tYW5kVGltZW91dE1zLnNob3VsZC5iZS5hYm92ZSgwKTtcbiAgICAgICAgYXdhaXQgZW5kU2Vzc2lvbihuZXdTZXNzaW9uLnNlc3Npb25JZCk7XG4gICAgICB9KTtcblxuICAgICAgaXQoJ3Nob3VsZCB0aW1lb3V0IG9uIGNvbW1hbmRzIHVzaW5nIGNvbW1hbmRUaW1lb3V0IGNhcCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgbGV0IG5ld1Nlc3Npb24gPSBhd2FpdCBzdGFydFRpbWVvdXRTZXNzaW9uKDAuMjUpO1xuXG4gICAgICAgIGF3YWl0IHJlcXVlc3Qoe1xuICAgICAgICAgIHVybDogYGh0dHA6Ly9sb2NhbGhvc3Q6ODE4MS93ZC9odWIvc2Vzc2lvbi8ke2Quc2Vzc2lvbklkfS9lbGVtZW50YCxcbiAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgICBqc29uOiB7dXNpbmc6ICduYW1lJywgdmFsdWU6ICdmb28nfSxcbiAgICAgICAgfSk7XG4gICAgICAgIGF3YWl0IEIuZGVsYXkoNDAwKTtcbiAgICAgICAgbGV0IHJlcyA9IGF3YWl0IHJlcXVlc3Qoe1xuICAgICAgICAgIHVybDogYGh0dHA6Ly9sb2NhbGhvc3Q6ODE4MS93ZC9odWIvc2Vzc2lvbi8ke2Quc2Vzc2lvbklkfWAsXG4gICAgICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgICAgICBqc29uOiB0cnVlLFxuICAgICAgICAgIHNpbXBsZTogZmFsc2VcbiAgICAgICAgfSk7XG4gICAgICAgIHJlcy5zdGF0dXMuc2hvdWxkLmVxdWFsKDYpO1xuICAgICAgICBzaG91bGQuZXF1YWwoZC5zZXNzaW9uSWQsIG51bGwpO1xuICAgICAgICByZXMgPSBhd2FpdCBlbmRTZXNzaW9uKG5ld1Nlc3Npb24uc2Vzc2lvbklkKTtcbiAgICAgICAgcmVzLnN0YXR1cy5zaG91bGQuZXF1YWwoNik7XG4gICAgICB9KTtcblxuICAgICAgaXQoJ3Nob3VsZCBub3QgdGltZW91dCB3aXRoIGNvbW1hbmRUaW1lb3V0IG9mIGZhbHNlJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICBsZXQgbmV3U2Vzc2lvbiA9IGF3YWl0IHN0YXJ0VGltZW91dFNlc3Npb24oMC4xKTtcbiAgICAgICAgbGV0IHN0YXJ0ID0gRGF0ZS5ub3coKTtcbiAgICAgICAgbGV0IHJlcyA9IGF3YWl0IHJlcXVlc3Qoe1xuICAgICAgICAgIHVybDogYGh0dHA6Ly9sb2NhbGhvc3Q6ODE4MS93ZC9odWIvc2Vzc2lvbi8ke2Quc2Vzc2lvbklkfS9lbGVtZW50c2AsXG4gICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgICAganNvbjoge3VzaW5nOiAnbmFtZScsIHZhbHVlOiAnZm9vJ30sXG4gICAgICAgIH0pO1xuICAgICAgICAoRGF0ZS5ub3coKSAtIHN0YXJ0KS5zaG91bGQuYmUuYWJvdmUoMTUwKTtcbiAgICAgICAgcmVzLnZhbHVlLnNob3VsZC5lcWwoWydmb28nXSk7XG4gICAgICAgIGF3YWl0IGVuZFNlc3Npb24obmV3U2Vzc2lvbi5zZXNzaW9uSWQpO1xuICAgICAgfSk7XG5cbiAgICAgIGl0KCdzaG91bGQgbm90IHRpbWVvdXQgd2l0aCBjb21tYW5kVGltZW91dCBvZiAwJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICBkLm5ld0NvbW1hbmRUaW1lb3V0TXMgPSAyO1xuICAgICAgICBsZXQgbmV3U2Vzc2lvbiA9IGF3YWl0IHN0YXJ0VGltZW91dFNlc3Npb24oMCk7XG5cbiAgICAgICAgYXdhaXQgcmVxdWVzdCh7XG4gICAgICAgICAgdXJsOiBgaHR0cDovL2xvY2FsaG9zdDo4MTgxL3dkL2h1Yi9zZXNzaW9uLyR7ZC5zZXNzaW9uSWR9L2VsZW1lbnRgLFxuICAgICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICAgIGpzb246IHt1c2luZzogJ25hbWUnLCB2YWx1ZTogJ2Zvbyd9LFxuICAgICAgICB9KTtcbiAgICAgICAgYXdhaXQgQi5kZWxheSg0MDApO1xuICAgICAgICBsZXQgcmVzID0gYXdhaXQgcmVxdWVzdCh7XG4gICAgICAgICAgdXJsOiBgaHR0cDovL2xvY2FsaG9zdDo4MTgxL3dkL2h1Yi9zZXNzaW9uLyR7ZC5zZXNzaW9uSWR9YCxcbiAgICAgICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgICAgIGpzb246IHRydWUsXG4gICAgICAgICAgc2ltcGxlOiBmYWxzZVxuICAgICAgICB9KTtcbiAgICAgICAgcmVzLnN0YXR1cy5zaG91bGQuZXF1YWwoMCk7XG4gICAgICAgIHJlcyA9IGF3YWl0IGVuZFNlc3Npb24obmV3U2Vzc2lvbi5zZXNzaW9uSWQpO1xuICAgICAgICByZXMuc3RhdHVzLnNob3VsZC5lcXVhbCgwKTtcblxuICAgICAgICBkLm5ld0NvbW1hbmRUaW1lb3V0TXMgPSA2MCAqIDEwMDA7XG4gICAgICB9KTtcblxuICAgICAgaXQoJ3Nob3VsZCBub3QgdGltZW91dCBpZiBpdHMganVzdCB0aGUgY29tbWFuZCB0YWtpbmcgYXdoaWxlJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICBsZXQgbmV3U2Vzc2lvbiA9IGF3YWl0IHN0YXJ0VGltZW91dFNlc3Npb24oMC4yNSk7XG4gICAgICAgIGF3YWl0IHJlcXVlc3Qoe1xuICAgICAgICAgIHVybDogYGh0dHA6Ly9sb2NhbGhvc3Q6ODE4MS93ZC9odWIvc2Vzc2lvbi8ke2Quc2Vzc2lvbklkfS9lbGVtZW50YCxcbiAgICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICAgICAgICBqc29uOiB7dXNpbmc6ICduYW1lJywgdmFsdWU6ICdmb28nfSxcbiAgICAgICAgfSk7XG4gICAgICAgIGF3YWl0IEIuZGVsYXkoNDAwKTtcbiAgICAgICAgbGV0IHJlcyA9IGF3YWl0IHJlcXVlc3Qoe1xuICAgICAgICAgIHVybDogYGh0dHA6Ly9sb2NhbGhvc3Q6ODE4MS93ZC9odWIvc2Vzc2lvbi8ke2Quc2Vzc2lvbklkfWAsXG4gICAgICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgICAgICBqc29uOiB0cnVlLFxuICAgICAgICAgIHNpbXBsZTogZmFsc2VcbiAgICAgICAgfSk7XG4gICAgICAgIHJlcy5zdGF0dXMuc2hvdWxkLmVxdWFsKDYpO1xuICAgICAgICBzaG91bGQuZXF1YWwoZC5zZXNzaW9uSWQsIG51bGwpO1xuICAgICAgICByZXMgPSBhd2FpdCBlbmRTZXNzaW9uKG5ld1Nlc3Npb24uc2Vzc2lvbklkKTtcbiAgICAgICAgcmVzLnN0YXR1cy5zaG91bGQuZXF1YWwoNik7XG4gICAgICB9KTtcblxuICAgICAgaXQoJ3Nob3VsZCBub3QgaGF2ZSBhIHRpbWVyIHJ1bm5pbmcgYmVmb3JlIG9yIGFmdGVyIGEgc2Vzc2lvbicsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgc2hvdWxkLm5vdC5leGlzdChkLm5vQ29tbWFuZFRpbWVyKTtcbiAgICAgICAgbGV0IG5ld1Nlc3Npb24gPSBhd2FpdCBzdGFydFRpbWVvdXRTZXNzaW9uKDAuMjUpO1xuICAgICAgICBuZXdTZXNzaW9uLnNlc3Npb25JZC5zaG91bGQuZXF1YWwoZC5zZXNzaW9uSWQpO1xuICAgICAgICBzaG91bGQuZXhpc3QoZC5ub0NvbW1hbmRUaW1lcik7XG4gICAgICAgIGF3YWl0IGVuZFNlc3Npb24obmV3U2Vzc2lvbi5zZXNzaW9uSWQpO1xuICAgICAgICBzaG91bGQubm90LmV4aXN0KGQubm9Db21tYW5kVGltZXIpO1xuICAgICAgfSk7XG5cbiAgICB9KTtcblxuICAgIGRlc2NyaWJlKCdzZXR0aW5ncyBhcGknLCBmdW5jdGlvbiAoKSB7XG4gICAgICBiZWZvcmUoZnVuY3Rpb24gKCkge1xuICAgICAgICBkLnNldHRpbmdzID0gbmV3IERldmljZVNldHRpbmdzKHtpZ25vcmVVbmltcG9ydGFudFZpZXdzOiBmYWxzZX0pO1xuICAgICAgfSk7XG4gICAgICBpdCgnc2hvdWxkIGJlIGFibGUgdG8gZ2V0IHNldHRpbmdzIG9iamVjdCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgZC5zZXR0aW5ncy5nZXRTZXR0aW5ncygpLmlnbm9yZVVuaW1wb3J0YW50Vmlld3Muc2hvdWxkLmJlLmZhbHNlO1xuICAgICAgfSk7XG4gICAgICBpdCgnc2hvdWxkIHRocm93IGVycm9yIHdoZW4gdXBkYXRlU2V0dGluZ3MgbWV0aG9kIGlzIG5vdCBkZWZpbmVkJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICBhd2FpdCBkLnNldHRpbmdzLnVwZGF0ZSh7aWdub3JlVW5pbXBvcnRhbnRWaWV3czogdHJ1ZX0pLnNob3VsZC5ldmVudHVhbGx5XG4gICAgICAgICAgICAgICAgLmJlLnJlamVjdGVkV2l0aCgnb25TZXR0aW5nc1VwZGF0ZScpO1xuICAgICAgfSk7XG4gICAgICBpdCgnc2hvdWxkIHRocm93IGVycm9yIGZvciBpbnZhbGlkIHVwZGF0ZSBvYmplY3QnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGF3YWl0IGQuc2V0dGluZ3MudXBkYXRlKCdpbnZhbGlkIGpzb24nKS5zaG91bGQuZXZlbnR1YWxseVxuICAgICAgICAgICAgICAgIC5iZS5yZWplY3RlZFdpdGgoJ0pTT04nKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoJ3VuZXhwZWN0ZWQgZXhpdHMnLCBmdW5jdGlvbiAoKSB7XG4gICAgICBpdCgnc2hvdWxkIHJlamVjdCBhIGN1cnJlbnQgY29tbWFuZCB3aGVuIHRoZSBkcml2ZXIgY3Jhc2hlcycsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgZC5fb2xkR2V0U3RhdHVzID0gZC5nZXRTdGF0dXM7XG4gICAgICAgIGQuZ2V0U3RhdHVzID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICAgIGF3YWl0IEIuZGVsYXkoNTAwMCk7XG4gICAgICAgIH0uYmluZChkKTtcbiAgICAgICAgbGV0IHAgPSByZXF1ZXN0KHtcbiAgICAgICAgICB1cmw6ICdodHRwOi8vbG9jYWxob3N0OjgxODEvd2QvaHViL3N0YXR1cycsXG4gICAgICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgICAgICBqc29uOiB0cnVlLFxuICAgICAgICAgIHNpbXBsZTogZmFsc2VcbiAgICAgICAgfSk7XG4gICAgICAgIC8vIG1ha2Ugc3VyZSB0aGF0IHRoZSByZXF1ZXN0IGdldHMgdG8gdGhlIHNlcnZlciBiZWZvcmUgb3VyIHNodXRkb3duXG4gICAgICAgIGF3YWl0IEIuZGVsYXkoMTAwKTtcbiAgICAgICAgZC5zdGFydFVuZXhwZWN0ZWRTaHV0ZG93bihuZXcgRXJyb3IoJ0NyYXNoeXRpbWVzJykpO1xuICAgICAgICBsZXQgcmVzID0gYXdhaXQgcDtcbiAgICAgICAgcmVzLnN0YXR1cy5zaG91bGQuZXF1YWwoMTMpO1xuICAgICAgICByZXMudmFsdWUubWVzc2FnZS5zaG91bGQuY29udGFpbignQ3Jhc2h5dGltZXMnKTtcbiAgICAgICAgYXdhaXQgZC5vblVuZXhwZWN0ZWRTaHV0ZG93bi5zaG91bGQuYmUucmVqZWN0ZWRXaXRoKCdDcmFzaHl0aW1lcycpO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZSgnZXZlbnQgdGltaW5ncycsIGZ1bmN0aW9uICgpIHtcbiAgICAgIGl0KCdzaG91bGQgbm90IGFkZCB0aW1pbmdzIGlmIG5vdCB1c2luZyBvcHQtaW4gY2FwJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICBsZXQgc2Vzc2lvbiA9IGF3YWl0IHN0YXJ0U2Vzc2lvbihkZWZhdWx0Q2Fwcyk7XG4gICAgICAgIGxldCByZXMgPSBhd2FpdCBnZXRTZXNzaW9uKHNlc3Npb24uc2Vzc2lvbklkKTtcbiAgICAgICAgc2hvdWxkLm5vdC5leGlzdChyZXMuZXZlbnRzKTtcbiAgICAgICAgYXdhaXQgZW5kU2Vzc2lvbihzZXNzaW9uLnNlc3Npb25JZCk7XG4gICAgICB9KTtcbiAgICAgIGl0KCdzaG91bGQgYWRkIHN0YXJ0IHNlc3Npb24gdGltaW5ncycsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgbGV0IGNhcHMgPSBPYmplY3QuYXNzaWduKHt9LCBkZWZhdWx0Q2Fwcywge2V2ZW50VGltaW5nczogdHJ1ZX0pO1xuICAgICAgICBsZXQgc2Vzc2lvbiA9IGF3YWl0IHN0YXJ0U2Vzc2lvbihjYXBzKTtcbiAgICAgICAgbGV0IHJlcyA9IChhd2FpdCBnZXRTZXNzaW9uKHNlc3Npb24uc2Vzc2lvbklkKSkudmFsdWU7XG4gICAgICAgIHNob3VsZC5leGlzdChyZXMuZXZlbnRzKTtcbiAgICAgICAgc2hvdWxkLmV4aXN0KHJlcy5ldmVudHMubmV3U2Vzc2lvblJlcXVlc3RlZCk7XG4gICAgICAgIHNob3VsZC5leGlzdChyZXMuZXZlbnRzLm5ld1Nlc3Npb25TdGFydGVkKTtcbiAgICAgICAgcmVzLmV2ZW50cy5uZXdTZXNzaW9uUmVxdWVzdGVkWzBdLnNob3VsZC5iZS5hKCdudW1iZXInKTtcbiAgICAgICAgcmVzLmV2ZW50cy5uZXdTZXNzaW9uU3RhcnRlZFswXS5zaG91bGQuYmUuYSgnbnVtYmVyJyk7XG4gICAgICAgIGF3YWl0IGVuZFNlc3Npb24oc2Vzc2lvbi5zZXNzaW9uSWQpO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgfSk7XG59XG5cbmV4cG9ydCBkZWZhdWx0IGJhc2VEcml2ZXJFMkVUZXN0cztcbiJdLCJmaWxlIjoidGVzdC9iYXNlZHJpdmVyL2RyaXZlci1lMmUtdGVzdHMuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
