"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _chai = _interopRequireDefault(require("chai"));

var _path = _interopRequireDefault(require("path"));

var _chaiAsPromised = _interopRequireDefault(require("chai-as-promised"));

var _appiumSupport = require("appium-support");

var _helpers = require("../../lib/basedriver/helpers");

var _http = _interopRequireDefault(require("http"));

var _finalhandler = _interopRequireDefault(require("finalhandler"));

var _serveStatic = _interopRequireDefault(require("serve-static"));

var _contentDisposition = _interopRequireDefault(require("content-disposition"));

var _bluebird = _interopRequireDefault(require("bluebird"));

_chai.default.should();

_chai.default.use(_chaiAsPromised.default);

function getFixture(file) {
  return _path.default.resolve(__dirname, '..', '..', '..', 'test', 'basedriver', 'fixtures', file);
}

describe('app download and configuration', function () {
  describe('configureApp', function () {
    it('should get the path for a local .app', (0, _asyncToGenerator2.default)(function* () {
      let newAppPath = yield (0, _helpers.configureApp)(getFixture('FakeIOSApp.app'), '.app');
      newAppPath.should.contain('FakeIOSApp.app');
      let contents = yield _appiumSupport.fs.readFile(newAppPath, 'utf8');
      contents.should.eql('this is not really an app\n');
    }));
    it('should get the path for a local .apk', (0, _asyncToGenerator2.default)(function* () {
      let newAppPath = yield (0, _helpers.configureApp)(getFixture('FakeAndroidApp.apk'), '.apk');
      newAppPath.should.contain('FakeAndroidApp.apk');
      let contents = yield _appiumSupport.fs.readFile(newAppPath, 'utf8');
      contents.should.eql('this is not really an apk\n');
    }));
    it('should unzip and get the path for a local .app.zip', (0, _asyncToGenerator2.default)(function* () {
      let newAppPath = yield (0, _helpers.configureApp)(getFixture('FakeIOSApp.app.zip'), '.app');
      newAppPath.should.contain('FakeIOSApp.app');
      let contents = yield _appiumSupport.fs.readFile(newAppPath, 'utf8');
      contents.should.eql('this is not really an app\n');
    }));
    it('should unzip and get the path for a local .ipa', (0, _asyncToGenerator2.default)(function* () {
      let newAppPath = yield (0, _helpers.configureApp)(getFixture('FakeIOSApp.ipa'), '.app');
      newAppPath.should.contain('FakeIOSApp.app');
      let contents = yield _appiumSupport.fs.readFile(newAppPath, 'utf8');
      contents.should.eql('this is not really an app\n');
    }));
    it('should fail for a bad zip file', (0, _asyncToGenerator2.default)(function* () {
      yield (0, _helpers.configureApp)(getFixture('BadZippedApp.zip'), '.app').should.be.rejectedWith(/PK/);
    }));
    it('should fail if extensions do not match', (0, _asyncToGenerator2.default)(function* () {
      yield (0, _helpers.configureApp)(getFixture('FakeIOSApp.app'), '.wrong').should.be.rejectedWith(/did not have extension/);
    }));
    it('should fail if zip file does not contain an app whose extension matches', (0, _asyncToGenerator2.default)(function* () {
      yield (0, _helpers.configureApp)(getFixture('FakeIOSApp.app.zip'), '.wrong').should.be.rejectedWith(/did not have extension/);
    }));
    describe('should download an app from the web', function () {
      const port = 8000;
      const serverUrl = `http://localhost:${port}`;
      describe('server not available', function () {
        it('should handle server not available', (0, _asyncToGenerator2.default)(function* () {
          yield (0, _helpers.configureApp)(`${serverUrl}/FakeIOSApp.app.zip`, '.app').should.eventually.be.rejectedWith(/ECONNREFUSED/);
        }));
      });
      describe('server available', function () {
        let server;
        before(function () {
          const dir = _path.default.resolve(__dirname, '..', '..', '..', 'test', 'basedriver', 'fixtures');

          const serve = (0, _serveStatic.default)(dir, {
            index: false,
            setHeaders: (res, path) => {
              res.setHeader('Content-Disposition', (0, _contentDisposition.default)(path));
            }
          });
          server = _http.default.createServer(function (req, res) {
            if (req.url.indexOf('missing') !== -1) {
              res.writeHead(404);
              res.end();
              return;
            }

            if (req.url.indexOf('mime-zip') !== -1) {
              res.setHeader('content-type', 'application/zip');
            } else if (req.url.indexOf('mime-bip') !== 1) {
              res.setHeader('content-type', 'application/bip');
            }

            serve(req, res, (0, _finalhandler.default)(req, res));
          });
          const close = server.close.bind(server);
          server.close = (0, _asyncToGenerator2.default)(function* () {
            yield _bluebird.default.delay(1000);
            return yield new _bluebird.default((resolve, reject) => {
              server.on('close', resolve);
              close(err => {
                if (err) reject(err);
              });
            });
          });
          server.listen(port);
        });
        after((0, _asyncToGenerator2.default)(function* () {
          yield server.close();
        }));
        it('should download zip file', (0, _asyncToGenerator2.default)(function* () {
          let newAppPath = yield (0, _helpers.configureApp)(`${serverUrl}/FakeIOSApp.app.zip`, '.app');
          newAppPath.should.contain('FakeIOSApp.app');
          let contents = yield _appiumSupport.fs.readFile(newAppPath, 'utf8');
          contents.should.eql('this is not really an app\n');
        }));
        it('should download zip file with query string', (0, _asyncToGenerator2.default)(function* () {
          let newAppPath = yield (0, _helpers.configureApp)(`${serverUrl}/FakeIOSApp.app.zip?sv=abc&sr=def`, '.app');
          newAppPath.should.contain('.app');
          let contents = yield _appiumSupport.fs.readFile(newAppPath, 'utf8');
          contents.should.eql('this is not really an app\n');
        }));
        it('should download an app file', (0, _asyncToGenerator2.default)(function* () {
          let newAppPath = yield (0, _helpers.configureApp)(`${serverUrl}/FakeIOSApp.app`, '.app');
          newAppPath.should.contain('.app');
          let contents = yield _appiumSupport.fs.readFile(newAppPath, 'utf8');
          contents.should.eql('this is not really an app\n');
        }));
        it('should accept multiple extensions', (0, _asyncToGenerator2.default)(function* () {
          let newAppPath = yield (0, _helpers.configureApp)(`${serverUrl}/FakeIOSApp.app.zip`, ['.app', '.aab']);
          newAppPath.should.contain('FakeIOSApp.app');
          let contents = yield _appiumSupport.fs.readFile(newAppPath, 'utf8');
          contents.should.eql('this is not really an app\n');
        }));
        it('should download an apk file', (0, _asyncToGenerator2.default)(function* () {
          let newAppPath = yield (0, _helpers.configureApp)(`${serverUrl}/FakeAndroidApp.apk`, '.apk');
          newAppPath.should.contain('.apk');
          let contents = yield _appiumSupport.fs.readFile(newAppPath, 'utf8');
          contents.should.eql('this is not really an apk\n');
        }));
        it('should handle zip file that cannot be downloaded', (0, _asyncToGenerator2.default)(function* () {
          yield (0, _helpers.configureApp)(`${serverUrl}/missing/FakeIOSApp.app.zip`, '.app').should.eventually.be.rejectedWith(/Problem downloading app from url/);
        }));
        it('should handle invalid protocol', (0, _asyncToGenerator2.default)(function* () {
          yield (0, _helpers.configureApp)('file://C:/missing/FakeIOSApp.app.zip', '.app').should.eventually.be.rejectedWith(/is not supported/);
          yield (0, _helpers.configureApp)('ftp://localhost:8000/missing/FakeIOSApp.app.zip', '.app').should.eventually.be.rejectedWith(/is not supported/);
        }));
        it('should handle missing file in Windows path format', (0, _asyncToGenerator2.default)(function* () {
          yield (0, _helpers.configureApp)('C:\\missing\\FakeIOSApp.app.zip', '.app').should.eventually.be.rejectedWith(/does not exist or is not accessible/);
        }));
        it('should recognize zip mime types and unzip the downloaded file', (0, _asyncToGenerator2.default)(function* () {
          let newAppPath = yield (0, _helpers.configureApp)(`${serverUrl}/FakeAndroidApp.asd?mime-zip`, '.apk');
          newAppPath.should.contain('FakeAndroidApp.apk');
          newAppPath.should.not.contain('.asd');
          let contents = yield _appiumSupport.fs.readFile(newAppPath, 'utf8');
          contents.should.eql('this is not really an apk\n');
        }));
        it('should recognize zip mime types and unzip the downloaded file with query string', (0, _asyncToGenerator2.default)(function* () {
          let newAppPath = yield (0, _helpers.configureApp)(`${serverUrl}/FakeAndroidApp.asd?mime-zip&sv=abc&sr=def`, '.apk');
          newAppPath.should.contain('FakeAndroidApp.apk');
          newAppPath.should.not.contain('.asd');
          let contents = yield _appiumSupport.fs.readFile(newAppPath, 'utf8');
          contents.should.eql('this is not really an apk\n');
        }));
        it('should treat an unknown mime type as an app', (0, _asyncToGenerator2.default)(function* () {
          let newAppPath = yield (0, _helpers.configureApp)(`${serverUrl}/FakeAndroidApp.apk?mime-bip`, '.apk');
          newAppPath.should.contain('.apk');
          let contents = yield _appiumSupport.fs.readFile(newAppPath, 'utf8');
          contents.should.eql('this is not really an apk\n');
        }));
      });
    });
  });
});require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInRlc3QvYmFzZWRyaXZlci9oZWxwZXJzLWUyZS1zcGVjcy5qcyJdLCJuYW1lcyI6WyJjaGFpIiwic2hvdWxkIiwidXNlIiwiY2hhaUFzUHJvbWlzZWQiLCJnZXRGaXh0dXJlIiwiZmlsZSIsInBhdGgiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwiZGVzY3JpYmUiLCJpdCIsIm5ld0FwcFBhdGgiLCJjb250YWluIiwiY29udGVudHMiLCJmcyIsInJlYWRGaWxlIiwiZXFsIiwiYmUiLCJyZWplY3RlZFdpdGgiLCJwb3J0Iiwic2VydmVyVXJsIiwiZXZlbnR1YWxseSIsInNlcnZlciIsImJlZm9yZSIsImRpciIsInNlcnZlIiwiaW5kZXgiLCJzZXRIZWFkZXJzIiwicmVzIiwic2V0SGVhZGVyIiwiaHR0cCIsImNyZWF0ZVNlcnZlciIsInJlcSIsInVybCIsImluZGV4T2YiLCJ3cml0ZUhlYWQiLCJlbmQiLCJjbG9zZSIsImJpbmQiLCJCIiwiZGVsYXkiLCJyZWplY3QiLCJvbiIsImVyciIsImxpc3RlbiIsImFmdGVyIiwibm90Il0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQUEsY0FBS0MsTUFBTDs7QUFDQUQsY0FBS0UsR0FBTCxDQUFTQyx1QkFBVDs7QUFFQSxTQUFTQyxVQUFULENBQXFCQyxJQUFyQixFQUEyQjtBQUN6QixTQUFPQyxjQUFLQyxPQUFMLENBQWFDLFNBQWIsRUFBd0IsSUFBeEIsRUFBOEIsSUFBOUIsRUFBb0MsSUFBcEMsRUFBMEMsTUFBMUMsRUFBa0QsWUFBbEQsRUFBZ0UsVUFBaEUsRUFBNEVILElBQTVFLENBQVA7QUFDRDs7QUFFREksUUFBUSxDQUFDLGdDQUFELEVBQW1DLFlBQVk7QUFDckRBLEVBQUFBLFFBQVEsQ0FBQyxjQUFELEVBQWlCLFlBQVk7QUFDbkNDLElBQUFBLEVBQUUsQ0FBQyxzQ0FBRCxrQ0FBeUMsYUFBa0I7QUFDM0Qs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LDJCQUFjLEdBQUVTLFNBQVUsOEJBQTFCLEVBQXlELE1BQXpELENBQXZCO0FBQ0FULFVBQUFBLFVBQVUsQ0FBQ1YsTUFBWCxDQUFrQlcsT0FBbEIsQ0FBMEIsTUFBMUI7QUFDQSxjQUFJQyxRQUFRLFNBQVNDLGtCQUFHQyxRQUFILENBQVlKLFVBQVosRUFBd0IsTUFBeEIsQ0FBckI7QUFDQUUsVUFBQUEsUUFBUSxDQUFDWixNQUFULENBQWdCZSxHQUFoQixDQUFvQiw2QkFBcEI7QUFDRCxTQUxDLEVBQUY7QUFNRCxPQTNHTyxDQUFSO0FBNEdELEtBdEhPLENBQVI7QUF1SEQsR0E1Sk8sQ0FBUjtBQTZKRCxDQTlKTyxDQUFSIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNoYWkgZnJvbSAnY2hhaSc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCBjaGFpQXNQcm9taXNlZCBmcm9tICdjaGFpLWFzLXByb21pc2VkJztcbmltcG9ydCB7IGZzIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgY29uZmlndXJlQXBwIH0gZnJvbSAnLi4vLi4vbGliL2Jhc2Vkcml2ZXIvaGVscGVycyc7XG5pbXBvcnQgaHR0cCBmcm9tICdodHRwJztcbmltcG9ydCBmaW5hbGhhbmRsZXIgZnJvbSAnZmluYWxoYW5kbGVyJztcbmltcG9ydCBzZXJ2ZVN0YXRpYyBmcm9tICdzZXJ2ZS1zdGF0aWMnO1xuaW1wb3J0IGNvbnRlbnREaXNwb3NpdGlvbiBmcm9tICdjb250ZW50LWRpc3Bvc2l0aW9uJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcblxuXG5jaGFpLnNob3VsZCgpO1xuY2hhaS51c2UoY2hhaUFzUHJvbWlzZWQpO1xuXG5mdW5jdGlvbiBnZXRGaXh0dXJlIChmaWxlKSB7XG4gIHJldHVybiBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4nLCAnLi4nLCAnLi4nLCAndGVzdCcsICdiYXNlZHJpdmVyJywgJ2ZpeHR1cmVzJywgZmlsZSk7XG59XG5cbmRlc2NyaWJlKCdhcHAgZG93bmxvYWQgYW5kIGNvbmZpZ3VyYXRpb24nLCBmdW5jdGlvbiAoKSB7XG4gIGRlc2NyaWJlKCdjb25maWd1cmVBcHAnLCBmdW5jdGlvbiAoKSB7XG4gICAgaXQoJ3Nob3VsZCBnZXQgdGhlIHBhdGggZm9yIGEgbG9jYWwgLmFwcCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBuZXdBcHBQYXRoID0gYXdhaXQgY29uZmlndXJlQXBwKGdldEZpeHR1cmUoJ0Zha2VJT1NBcHAuYXBwJyksICcuYXBwJyk7XG4gICAgICBuZXdBcHBQYXRoLnNob3VsZC5jb250YWluKCdGYWtlSU9TQXBwLmFwcCcpO1xuICAgICAgbGV0IGNvbnRlbnRzID0gYXdhaXQgZnMucmVhZEZpbGUobmV3QXBwUGF0aCwgJ3V0ZjgnKTtcbiAgICAgIGNvbnRlbnRzLnNob3VsZC5lcWwoJ3RoaXMgaXMgbm90IHJlYWxseSBhbiBhcHBcXG4nKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIGdldCB0aGUgcGF0aCBmb3IgYSBsb2NhbCAuYXBrJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IG5ld0FwcFBhdGggPSBhd2FpdCBjb25maWd1cmVBcHAoZ2V0Rml4dHVyZSgnRmFrZUFuZHJvaWRBcHAuYXBrJyksICcuYXBrJyk7XG4gICAgICBuZXdBcHBQYXRoLnNob3VsZC5jb250YWluKCdGYWtlQW5kcm9pZEFwcC5hcGsnKTtcbiAgICAgIGxldCBjb250ZW50cyA9IGF3YWl0IGZzLnJlYWRGaWxlKG5ld0FwcFBhdGgsICd1dGY4Jyk7XG4gICAgICBjb250ZW50cy5zaG91bGQuZXFsKCd0aGlzIGlzIG5vdCByZWFsbHkgYW4gYXBrXFxuJyk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCB1bnppcCBhbmQgZ2V0IHRoZSBwYXRoIGZvciBhIGxvY2FsIC5hcHAuemlwJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgbGV0IG5ld0FwcFBhdGggPSBhd2FpdCBjb25maWd1cmVBcHAoZ2V0Rml4dHVyZSgnRmFrZUlPU0FwcC5hcHAuemlwJyksICcuYXBwJyk7XG4gICAgICBuZXdBcHBQYXRoLnNob3VsZC5jb250YWluKCdGYWtlSU9TQXBwLmFwcCcpO1xuICAgICAgbGV0IGNvbnRlbnRzID0gYXdhaXQgZnMucmVhZEZpbGUobmV3QXBwUGF0aCwgJ3V0ZjgnKTtcbiAgICAgIGNvbnRlbnRzLnNob3VsZC5lcWwoJ3RoaXMgaXMgbm90IHJlYWxseSBhbiBhcHBcXG4nKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIHVuemlwIGFuZCBnZXQgdGhlIHBhdGggZm9yIGEgbG9jYWwgLmlwYScsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgIGxldCBuZXdBcHBQYXRoID0gYXdhaXQgY29uZmlndXJlQXBwKGdldEZpeHR1cmUoJ0Zha2VJT1NBcHAuaXBhJyksICcuYXBwJyk7XG4gICAgICBuZXdBcHBQYXRoLnNob3VsZC5jb250YWluKCdGYWtlSU9TQXBwLmFwcCcpO1xuICAgICAgbGV0IGNvbnRlbnRzID0gYXdhaXQgZnMucmVhZEZpbGUobmV3QXBwUGF0aCwgJ3V0ZjgnKTtcbiAgICAgIGNvbnRlbnRzLnNob3VsZC5lcWwoJ3RoaXMgaXMgbm90IHJlYWxseSBhbiBhcHBcXG4nKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIGZhaWwgZm9yIGEgYmFkIHppcCBmaWxlJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgYXdhaXQgY29uZmlndXJlQXBwKGdldEZpeHR1cmUoJ0JhZFppcHBlZEFwcC56aXAnKSwgJy5hcHAnKVxuICAgICAgICAuc2hvdWxkLmJlLnJlamVjdGVkV2l0aCgvUEsvKTtcbiAgICB9KTtcbiAgICBpdCgnc2hvdWxkIGZhaWwgaWYgZXh0ZW5zaW9ucyBkbyBub3QgbWF0Y2gnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBhd2FpdCBjb25maWd1cmVBcHAoZ2V0Rml4dHVyZSgnRmFrZUlPU0FwcC5hcHAnKSwgJy53cm9uZycpXG4gICAgICAgIC5zaG91bGQuYmUucmVqZWN0ZWRXaXRoKC9kaWQgbm90IGhhdmUgZXh0ZW5zaW9uLyk7XG4gICAgfSk7XG4gICAgaXQoJ3Nob3VsZCBmYWlsIGlmIHppcCBmaWxlIGRvZXMgbm90IGNvbnRhaW4gYW4gYXBwIHdob3NlIGV4dGVuc2lvbiBtYXRjaGVzJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgYXdhaXQgY29uZmlndXJlQXBwKGdldEZpeHR1cmUoJ0Zha2VJT1NBcHAuYXBwLnppcCcpLCAnLndyb25nJylcbiAgICAgICAgLnNob3VsZC5iZS5yZWplY3RlZFdpdGgoL2RpZCBub3QgaGF2ZSBleHRlbnNpb24vKTtcbiAgICB9KTtcbiAgICBkZXNjcmliZSgnc2hvdWxkIGRvd25sb2FkIGFuIGFwcCBmcm9tIHRoZSB3ZWInLCBmdW5jdGlvbiAoKSB7XG4gICAgICBjb25zdCBwb3J0ID0gODAwMDtcbiAgICAgIGNvbnN0IHNlcnZlclVybCA9IGBodHRwOi8vbG9jYWxob3N0OiR7cG9ydH1gO1xuXG4gICAgICBkZXNjcmliZSgnc2VydmVyIG5vdCBhdmFpbGFibGUnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGl0KCdzaG91bGQgaGFuZGxlIHNlcnZlciBub3QgYXZhaWxhYmxlJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICAgIGF3YWl0IGNvbmZpZ3VyZUFwcChgJHtzZXJ2ZXJVcmx9L0Zha2VJT1NBcHAuYXBwLnppcGAsICcuYXBwJylcbiAgICAgICAgICAgIC5zaG91bGQuZXZlbnR1YWxseS5iZS5yZWplY3RlZFdpdGgoL0VDT05OUkVGVVNFRC8pO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgICAgZGVzY3JpYmUoJ3NlcnZlciBhdmFpbGFibGUnLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgIC8vIHVzZSBhIGxvY2FsIHNlcnZlciBzbyB0aGVyZSBpcyBubyBkZXBlbmRlbmN5IG9uIHRoZSBpbnRlcm5ldFxuICAgICAgICBsZXQgc2VydmVyO1xuICAgICAgICBiZWZvcmUoZnVuY3Rpb24gKCkge1xuICAgICAgICAgIGNvbnN0IGRpciA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICcuLicsICd0ZXN0JywgJ2Jhc2Vkcml2ZXInLCAnZml4dHVyZXMnKTtcbiAgICAgICAgICBjb25zdCBzZXJ2ZSA9IHNlcnZlU3RhdGljKGRpciwge1xuICAgICAgICAgICAgaW5kZXg6IGZhbHNlLFxuICAgICAgICAgICAgc2V0SGVhZGVyczogKHJlcywgcGF0aCkgPT4ge1xuICAgICAgICAgICAgICByZXMuc2V0SGVhZGVyKCdDb250ZW50LURpc3Bvc2l0aW9uJywgY29udGVudERpc3Bvc2l0aW9uKHBhdGgpKTtcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICBzZXJ2ZXIgPSBodHRwLmNyZWF0ZVNlcnZlcihmdW5jdGlvbiAocmVxLCByZXMpIHtcbiAgICAgICAgICAgIGlmIChyZXEudXJsLmluZGV4T2YoJ21pc3NpbmcnKSAhPT0gLTEpIHtcbiAgICAgICAgICAgICAgcmVzLndyaXRlSGVhZCg0MDQpO1xuICAgICAgICAgICAgICByZXMuZW5kKCk7XG4gICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIGZvciB0ZXN0aW5nIHppcCBmaWxlIGNvbnRlbnQgdHlwZXNcbiAgICAgICAgICAgIGlmIChyZXEudXJsLmluZGV4T2YoJ21pbWUtemlwJykgIT09IC0xKSB7XG4gICAgICAgICAgICAgIHJlcy5zZXRIZWFkZXIoJ2NvbnRlbnQtdHlwZScsICdhcHBsaWNhdGlvbi96aXAnKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAocmVxLnVybC5pbmRleE9mKCdtaW1lLWJpcCcpICE9PSAxKSB7XG4gICAgICAgICAgICAgIHJlcy5zZXRIZWFkZXIoJ2NvbnRlbnQtdHlwZScsICdhcHBsaWNhdGlvbi9iaXAnKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHNlcnZlKHJlcSwgcmVzLCBmaW5hbGhhbmRsZXIocmVxLCByZXMpKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBjb25zdCBjbG9zZSA9IHNlcnZlci5jbG9zZS5iaW5kKHNlcnZlcik7XG4gICAgICAgICAgc2VydmVyLmNsb3NlID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgLy8gcGF1c2UgYSBtb21lbnQgb3Igd2UgZ2V0IEVDT05SRVNFVCBlcnJvcnNcbiAgICAgICAgICAgIGF3YWl0IEIuZGVsYXkoMTAwMCk7XG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgICBzZXJ2ZXIub24oJ2Nsb3NlJywgcmVzb2x2ZSk7XG4gICAgICAgICAgICAgIGNsb3NlKChlcnIpID0+IHtcbiAgICAgICAgICAgICAgICBpZiAoZXJyKSByZWplY3QoZXJyKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjdXJseVxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH07XG4gICAgICAgICAgc2VydmVyLmxpc3Rlbihwb3J0KTtcbiAgICAgICAgfSk7XG4gICAgICAgIGFmdGVyKGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBhd2FpdCBzZXJ2ZXIuY2xvc2UoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaXQoJ3Nob3VsZCBkb3dubG9hZCB6aXAgZmlsZScsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBsZXQgbmV3QXBwUGF0aCA9IGF3YWl0IGNvbmZpZ3VyZUFwcChgJHtzZXJ2ZXJVcmx9L0Zha2VJT1NBcHAuYXBwLnppcGAsICcuYXBwJyk7XG4gICAgICAgICAgbmV3QXBwUGF0aC5zaG91bGQuY29udGFpbignRmFrZUlPU0FwcC5hcHAnKTtcbiAgICAgICAgICBsZXQgY29udGVudHMgPSBhd2FpdCBmcy5yZWFkRmlsZShuZXdBcHBQYXRoLCAndXRmOCcpO1xuICAgICAgICAgIGNvbnRlbnRzLnNob3VsZC5lcWwoJ3RoaXMgaXMgbm90IHJlYWxseSBhbiBhcHBcXG4nKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGl0KCdzaG91bGQgZG93bmxvYWQgemlwIGZpbGUgd2l0aCBxdWVyeSBzdHJpbmcnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgbGV0IG5ld0FwcFBhdGggPSBhd2FpdCBjb25maWd1cmVBcHAoYCR7c2VydmVyVXJsfS9GYWtlSU9TQXBwLmFwcC56aXA/c3Y9YWJjJnNyPWRlZmAsICcuYXBwJyk7XG4gICAgICAgICAgbmV3QXBwUGF0aC5zaG91bGQuY29udGFpbignLmFwcCcpO1xuICAgICAgICAgIGxldCBjb250ZW50cyA9IGF3YWl0IGZzLnJlYWRGaWxlKG5ld0FwcFBhdGgsICd1dGY4Jyk7XG4gICAgICAgICAgY29udGVudHMuc2hvdWxkLmVxbCgndGhpcyBpcyBub3QgcmVhbGx5IGFuIGFwcFxcbicpO1xuICAgICAgICB9KTtcbiAgICAgICAgaXQoJ3Nob3VsZCBkb3dubG9hZCBhbiBhcHAgZmlsZScsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBsZXQgbmV3QXBwUGF0aCA9IGF3YWl0IGNvbmZpZ3VyZUFwcChgJHtzZXJ2ZXJVcmx9L0Zha2VJT1NBcHAuYXBwYCwgJy5hcHAnKTtcbiAgICAgICAgICBuZXdBcHBQYXRoLnNob3VsZC5jb250YWluKCcuYXBwJyk7XG4gICAgICAgICAgbGV0IGNvbnRlbnRzID0gYXdhaXQgZnMucmVhZEZpbGUobmV3QXBwUGF0aCwgJ3V0ZjgnKTtcbiAgICAgICAgICBjb250ZW50cy5zaG91bGQuZXFsKCd0aGlzIGlzIG5vdCByZWFsbHkgYW4gYXBwXFxuJyk7XG4gICAgICAgIH0pO1xuICAgICAgICBpdCgnc2hvdWxkIGFjY2VwdCBtdWx0aXBsZSBleHRlbnNpb25zJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICAgIGxldCBuZXdBcHBQYXRoID0gYXdhaXQgY29uZmlndXJlQXBwKGAke3NlcnZlclVybH0vRmFrZUlPU0FwcC5hcHAuemlwYCwgWycuYXBwJywgJy5hYWInXSk7XG4gICAgICAgICAgbmV3QXBwUGF0aC5zaG91bGQuY29udGFpbignRmFrZUlPU0FwcC5hcHAnKTtcbiAgICAgICAgICBsZXQgY29udGVudHMgPSBhd2FpdCBmcy5yZWFkRmlsZShuZXdBcHBQYXRoLCAndXRmOCcpO1xuICAgICAgICAgIGNvbnRlbnRzLnNob3VsZC5lcWwoJ3RoaXMgaXMgbm90IHJlYWxseSBhbiBhcHBcXG4nKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGl0KCdzaG91bGQgZG93bmxvYWQgYW4gYXBrIGZpbGUnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgbGV0IG5ld0FwcFBhdGggPSBhd2FpdCBjb25maWd1cmVBcHAoYCR7c2VydmVyVXJsfS9GYWtlQW5kcm9pZEFwcC5hcGtgLCAnLmFwaycpO1xuICAgICAgICAgIG5ld0FwcFBhdGguc2hvdWxkLmNvbnRhaW4oJy5hcGsnKTtcbiAgICAgICAgICBsZXQgY29udGVudHMgPSBhd2FpdCBmcy5yZWFkRmlsZShuZXdBcHBQYXRoLCAndXRmOCcpO1xuICAgICAgICAgIGNvbnRlbnRzLnNob3VsZC5lcWwoJ3RoaXMgaXMgbm90IHJlYWxseSBhbiBhcGtcXG4nKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGl0KCdzaG91bGQgaGFuZGxlIHppcCBmaWxlIHRoYXQgY2Fubm90IGJlIGRvd25sb2FkZWQnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgYXdhaXQgY29uZmlndXJlQXBwKGAke3NlcnZlclVybH0vbWlzc2luZy9GYWtlSU9TQXBwLmFwcC56aXBgLCAnLmFwcCcpXG4gICAgICAgICAgICAuc2hvdWxkLmV2ZW50dWFsbHkuYmUucmVqZWN0ZWRXaXRoKC9Qcm9ibGVtIGRvd25sb2FkaW5nIGFwcCBmcm9tIHVybC8pO1xuICAgICAgICB9KTtcbiAgICAgICAgaXQoJ3Nob3VsZCBoYW5kbGUgaW52YWxpZCBwcm90b2NvbCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBhd2FpdCBjb25maWd1cmVBcHAoJ2ZpbGU6Ly9DOi9taXNzaW5nL0Zha2VJT1NBcHAuYXBwLnppcCcsICcuYXBwJylcbiAgICAgICAgICAgIC5zaG91bGQuZXZlbnR1YWxseS5iZS5yZWplY3RlZFdpdGgoL2lzIG5vdCBzdXBwb3J0ZWQvKTtcbiAgICAgICAgICBhd2FpdCBjb25maWd1cmVBcHAoJ2Z0cDovL2xvY2FsaG9zdDo4MDAwL21pc3NpbmcvRmFrZUlPU0FwcC5hcHAuemlwJywgJy5hcHAnKVxuICAgICAgICAgICAgLnNob3VsZC5ldmVudHVhbGx5LmJlLnJlamVjdGVkV2l0aCgvaXMgbm90IHN1cHBvcnRlZC8pO1xuICAgICAgICB9KTtcbiAgICAgICAgaXQoJ3Nob3VsZCBoYW5kbGUgbWlzc2luZyBmaWxlIGluIFdpbmRvd3MgcGF0aCBmb3JtYXQnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgYXdhaXQgY29uZmlndXJlQXBwKCdDOlxcXFxtaXNzaW5nXFxcXEZha2VJT1NBcHAuYXBwLnppcCcsICcuYXBwJylcbiAgICAgICAgICAgIC5zaG91bGQuZXZlbnR1YWxseS5iZS5yZWplY3RlZFdpdGgoL2RvZXMgbm90IGV4aXN0IG9yIGlzIG5vdCBhY2Nlc3NpYmxlLyk7XG4gICAgICAgIH0pO1xuICAgICAgICBpdCgnc2hvdWxkIHJlY29nbml6ZSB6aXAgbWltZSB0eXBlcyBhbmQgdW56aXAgdGhlIGRvd25sb2FkZWQgZmlsZScsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBsZXQgbmV3QXBwUGF0aCA9IGF3YWl0IGNvbmZpZ3VyZUFwcChgJHtzZXJ2ZXJVcmx9L0Zha2VBbmRyb2lkQXBwLmFzZD9taW1lLXppcGAsICcuYXBrJyk7XG4gICAgICAgICAgbmV3QXBwUGF0aC5zaG91bGQuY29udGFpbignRmFrZUFuZHJvaWRBcHAuYXBrJyk7XG4gICAgICAgICAgbmV3QXBwUGF0aC5zaG91bGQubm90LmNvbnRhaW4oJy5hc2QnKTtcbiAgICAgICAgICBsZXQgY29udGVudHMgPSBhd2FpdCBmcy5yZWFkRmlsZShuZXdBcHBQYXRoLCAndXRmOCcpO1xuICAgICAgICAgIGNvbnRlbnRzLnNob3VsZC5lcWwoJ3RoaXMgaXMgbm90IHJlYWxseSBhbiBhcGtcXG4nKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGl0KCdzaG91bGQgcmVjb2duaXplIHppcCBtaW1lIHR5cGVzIGFuZCB1bnppcCB0aGUgZG93bmxvYWRlZCBmaWxlIHdpdGggcXVlcnkgc3RyaW5nJywgYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgICAgIGxldCBuZXdBcHBQYXRoID0gYXdhaXQgY29uZmlndXJlQXBwKGAke3NlcnZlclVybH0vRmFrZUFuZHJvaWRBcHAuYXNkP21pbWUtemlwJnN2PWFiYyZzcj1kZWZgLCAnLmFwaycpO1xuICAgICAgICAgIG5ld0FwcFBhdGguc2hvdWxkLmNvbnRhaW4oJ0Zha2VBbmRyb2lkQXBwLmFwaycpO1xuICAgICAgICAgIG5ld0FwcFBhdGguc2hvdWxkLm5vdC5jb250YWluKCcuYXNkJyk7XG4gICAgICAgICAgbGV0IGNvbnRlbnRzID0gYXdhaXQgZnMucmVhZEZpbGUobmV3QXBwUGF0aCwgJ3V0ZjgnKTtcbiAgICAgICAgICBjb250ZW50cy5zaG91bGQuZXFsKCd0aGlzIGlzIG5vdCByZWFsbHkgYW4gYXBrXFxuJyk7XG4gICAgICAgIH0pO1xuICAgICAgICBpdCgnc2hvdWxkIHRyZWF0IGFuIHVua25vd24gbWltZSB0eXBlIGFzIGFuIGFwcCcsIGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICBsZXQgbmV3QXBwUGF0aCA9IGF3YWl0IGNvbmZpZ3VyZUFwcChgJHtzZXJ2ZXJVcmx9L0Zha2VBbmRyb2lkQXBwLmFwaz9taW1lLWJpcGAsICcuYXBrJyk7XG4gICAgICAgICAgbmV3QXBwUGF0aC5zaG91bGQuY29udGFpbignLmFwaycpO1xuICAgICAgICAgIGxldCBjb250ZW50cyA9IGF3YWl0IGZzLnJlYWRGaWxlKG5ld0FwcFBhdGgsICd1dGY4Jyk7XG4gICAgICAgICAgY29udGVudHMuc2hvdWxkLmVxbCgndGhpcyBpcyBub3QgcmVhbGx5IGFuIGFwa1xcbicpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcbn0pO1xuIl0sImZpbGUiOiJ0ZXN0L2Jhc2Vkcml2ZXIvaGVscGVycy1lMmUtc3BlY3MuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
