"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.commands = void 0;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _asyncbox = require("asyncbox");

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("../logger"));

const APP_EXTENSION = '.apk';
const APP_STATE_NOT_INSTALLED = 0;
const APP_STATE_NOT_RUNNING = 1;
const APP_STATE_RUNNING_IN_BACKGROUND = 3;
const APP_STATE_RUNNING_IN_FOREGROUND = 4;
let commands = {};
exports.commands = commands;

commands.isAppInstalled = function () {
  var _ref = (0, _asyncToGenerator2.default)(function* (appId) {
    return yield this.adb.isAppInstalled(appId);
  });

  return function (_x) {
    return _ref.apply(this, arguments);
  };
}();

commands.queryAppState = function () {
  var _ref2 = (0, _asyncToGenerator2.default)(function* (appId) {
    _logger.default.info(`Querying the state of '${appId}'`);

    if (!(yield this.adb.isAppInstalled(appId))) {
      return APP_STATE_NOT_INSTALLED;
    }

    if (!(yield this.adb.processExists(appId))) {
      return APP_STATE_NOT_RUNNING;
    }

    const output = yield this.adb.shell(['dumpsys', 'window', 'windows']);
    var _iteratorNormalCompletion = true;
    var _didIteratorError = false;
    var _iteratorError = undefined;

    try {
      for (var _iterator = output.split('\n')[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
        const line = _step.value;

        if (line.includes(appId) && (line.includes('mCurrentFocus') || line.includes('mFocusedApp'))) {
          return APP_STATE_RUNNING_IN_FOREGROUND;
        }
      }
    } catch (err) {
      _didIteratorError = true;
      _iteratorError = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion && _iterator.return != null) {
          _iterator.return();
        }
      } finally {
        if (_didIteratorError) {
          throw _iteratorError;
        }
      }
    }

    return APP_STATE_RUNNING_IN_BACKGROUND;
  });

  return function (_x2) {
    return _ref2.apply(this, arguments);
  };
}();

commands.activateApp = function () {
  var _ref3 = (0, _asyncToGenerator2.default)(function* (appId) {
    const cmd = ['monkey', '-p', appId, '-c', 'android.intent.category.LAUNCHER', '1'];
    let output = '';

    try {
      _logger.default.debug(`Activating '${appId}' with 'adb shell ${cmd.join(' ')}' command`);

      output = yield this.adb.shell(cmd);

      _logger.default.debug(`Command stdout: ${output}`);
    } catch (e) {
      _logger.default.errorAndThrow(`Cannot activate '${appId}'. Original error: ${e.message}`);
    }

    if (output.includes('monkey aborted')) {
      _logger.default.errorAndThrow(`Cannot activate '${appId}'. Are you sure it is installed?`);
    }
  });

  return function (_x3) {
    return _ref3.apply(this, arguments);
  };
}();

commands.removeApp = function () {
  var _ref4 = (0, _asyncToGenerator2.default)(function* (appId, options = {}) {
    return yield this.adb.uninstallApk(appId, options);
  });

  return function (_x4) {
    return _ref4.apply(this, arguments);
  };
}();

commands.terminateApp = function () {
  var _ref5 = (0, _asyncToGenerator2.default)(function* (appId, options = {}) {
    var _this = this;

    _logger.default.info(`Terminating '${appId}'`);

    if (!(yield this.adb.processExists(appId))) {
      _logger.default.info(`The app '${appId}' is not running`);

      return false;
    }

    yield this.adb.forceStop(appId);
    const timeout = _appiumSupport.util.hasValue(options.timeout) && !isNaN(options.timeout) ? parseInt(options.timeout, 10) : 500;

    try {
      yield (0, _asyncbox.waitForCondition)((0, _asyncToGenerator2.default)(function* () {
        return (yield _this.queryAppState(appId)) <= APP_STATE_NOT_RUNNING;
      }), {
        waitMs: timeout,
        intervalMs: 100
      });
    } catch (e) {
      _logger.default.errorAndThrow(`'${appId}' is still running after ${timeout}ms timeout`);
    }

    _logger.default.info(`'${appId}' has been successfully terminated`);

    return true;
  });

  return function (_x5) {
    return _ref5.apply(this, arguments);
  };
}();

commands.installApp = function () {
  var _ref7 = (0, _asyncToGenerator2.default)(function* (appPath, options = {}) {
    const localPath = yield this.helpers.configureApp(appPath, APP_EXTENSION);

    try {
      yield this.adb.install(localPath, options);
    } finally {
      if (localPath !== appPath) {
        yield _appiumSupport.fs.rimraf(localPath);
      }
    }
  });

  return function (_x6) {
    return _ref7.apply(this, arguments);
  };
}();

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9hcHAtbWFuYWdlbWVudC5qcyJdLCJuYW1lcyI6WyJBUFBfRVhURU5TSU9OIiwiQVBQX1NUQVRFX05PVF9JTlNUQUxMRUQiLCJBUFBfU1RBVEVfTk9UX1JVTk5JTkciLCJBUFBfU1RBVEVfUlVOTklOR19JTl9CQUNLR1JPVU5EIiwiQVBQX1NUQVRFX1JVTk5JTkdfSU5fRk9SRUdST1VORCIsImNvbW1hbmRzIiwiaXNBcHBJbnN0YWxsZWQiLCJhcHBJZCIsImFkYiIsInF1ZXJ5QXBwU3RhdGUiLCJsb2ciLCJpbmZvIiwicHJvY2Vzc0V4aXN0cyIsIm91dHB1dCIsInNoZWxsIiwic3BsaXQiLCJsaW5lIiwiaW5jbHVkZXMiLCJhY3RpdmF0ZUFwcCIsImNtZCIsImRlYnVnIiwiam9pbiIsImUiLCJlcnJvckFuZFRocm93IiwibWVzc2FnZSIsInJlbW92ZUFwcCIsIm9wdGlvbnMiLCJ1bmluc3RhbGxBcGsiLCJ0ZXJtaW5hdGVBcHAiLCJmb3JjZVN0b3AiLCJ0aW1lb3V0IiwidXRpbCIsImhhc1ZhbHVlIiwiaXNOYU4iLCJwYXJzZUludCIsIndhaXRNcyIsImludGVydmFsTXMiLCJpbnN0YWxsQXBwIiwiYXBwUGF0aCIsImxvY2FsUGF0aCIsImhlbHBlcnMiLCJjb25maWd1cmVBcHAiLCJpbnN0YWxsIiwiZnMiLCJyaW1yYWYiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsYUFBYSxHQUFHLE1BQXRCO0FBR0EsTUFBTUMsdUJBQXVCLEdBQUcsQ0FBaEM7QUFDQSxNQUFNQyxxQkFBcUIsR0FBRyxDQUE5QjtBQUNBLE1BQU1DLCtCQUErQixHQUFHLENBQXhDO0FBQ0EsTUFBTUMsK0JBQStCLEdBQUcsQ0FBeEM7QUFFQSxJQUFJQyxRQUFRLEdBQUcsRUFBZjs7O0FBUUFBLFFBQVEsQ0FBQ0MsY0FBVDtBQUFBLDZDQUEwQixXQUFnQkMsS0FBaEIsRUFBdUI7QUFDL0MsaUJBQWEsS0FBS0MsR0FB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MkI7QUFDekIsY0FBTUssa0JBQUdDLE1BQUgsQ0FBVUwsU0FBVixDQUFOO0FBQ0Q7QUFDRjtBQUNGLEdBVEQ7O0FBQUE7QUFBQTtBQUFBO0FBQUE7O2VBYWVsQyxRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgd2FpdEZvckNvbmRpdGlvbiB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCB7IGZzLCB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuXG5jb25zdCBBUFBfRVhURU5TSU9OID0gJy5hcGsnO1xuLy8gVGhlc2UgY29uc3RhbnRzIGFyZSBpbiBzeW5jIHdpdGhcbi8vIGh0dHBzOi8vZGV2ZWxvcGVyLmFwcGxlLmNvbS9kb2N1bWVudGF0aW9uL3hjdGVzdC94Y3VpYXBwbGljYXRpb25zdGF0ZS94Y3VpYXBwbGljYXRpb25zdGF0ZXJ1bm5pbmdiYWNrZ3JvdW5kP2xhbmd1YWdlPW9iamNcbmNvbnN0IEFQUF9TVEFURV9OT1RfSU5TVEFMTEVEID0gMDtcbmNvbnN0IEFQUF9TVEFURV9OT1RfUlVOTklORyA9IDE7XG5jb25zdCBBUFBfU1RBVEVfUlVOTklOR19JTl9CQUNLR1JPVU5EID0gMztcbmNvbnN0IEFQUF9TVEFURV9SVU5OSU5HX0lOX0ZPUkVHUk9VTkQgPSA0O1xuXG5sZXQgY29tbWFuZHMgPSB7fTtcblxuLyoqXG4gKiBWZXJpZnkgd2hldGhlciBhbiBhcHBsaWNhdGlvbiBpcyBpbnN0YWxsZWQgb3Igbm90XG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFwcElkIC0gQXBwbGljYXRpb24gcGFja2FnZSBpZGVudGlmaWVyXG4gKiBAcmV0dXJucyB7Ym9vbGVhbn0gdHJ1ZSBpZiB0aGUgYXBwIGlzIGluc3RhbGxlZFxuICovXG5jb21tYW5kcy5pc0FwcEluc3RhbGxlZCA9IGFzeW5jIGZ1bmN0aW9uIChhcHBJZCkge1xuICByZXR1cm4gYXdhaXQgdGhpcy5hZGIuaXNBcHBJbnN0YWxsZWQoYXBwSWQpO1xufTtcblxuLyoqXG4gKiBRdWVyaWVzIHRoZSBjdXJyZW50IHN0YXRlIG9mIHRoZSBhcHAuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFwcElkIC0gQXBwbGljYXRpb24gcGFja2FnZSBpZGVudGlmaWVyXG4gKiBAcmV0dXJucyB7bnVtYmVyfSBUaGUgY29ycmVzcG9uZGluZyBjb25zdGFudCwgd2hpY2ggZGVzY3JpYmVzXG4gKiAgICAgICAgICAgICAgICAgICB0aGUgY3VycmVudCBhcHBsaWNhdGlvbiBzdGF0ZTpcbiAqIDAgLSBpcyB0aGUgYXBwIGlzIG5vdCBpbnN0YWxsZWRcbiAqIDEgLSBpZiB0aGUgYXBwIGlzIGluc3RhbGxlZCwgYnV0IGlzIG5vdCBydW5uaW5nXG4gKiAzIC0gaWYgdGhlIGFwcCBpcyBydW5uaW5nIGluIHRoZSBiYWNrZ3JvdW5kXG4gKiA0IC0gaWYgdGhlIGFwcCBpcyBydW5uaW5nIGluIHRoZSBmb3JlZ3JvdW5kXG4gKi9cbmNvbW1hbmRzLnF1ZXJ5QXBwU3RhdGUgPSBhc3luYyBmdW5jdGlvbiAoYXBwSWQpIHtcbiAgbG9nLmluZm8oYFF1ZXJ5aW5nIHRoZSBzdGF0ZSBvZiAnJHthcHBJZH0nYCk7XG4gIGlmICghYXdhaXQgdGhpcy5hZGIuaXNBcHBJbnN0YWxsZWQoYXBwSWQpKSB7XG4gICAgcmV0dXJuIEFQUF9TVEFURV9OT1RfSU5TVEFMTEVEO1xuICB9XG4gIGlmICghYXdhaXQgdGhpcy5hZGIucHJvY2Vzc0V4aXN0cyhhcHBJZCkpIHtcbiAgICByZXR1cm4gQVBQX1NUQVRFX05PVF9SVU5OSU5HO1xuICB9XG4gIGNvbnN0IG91dHB1dCA9IGF3YWl0IHRoaXMuYWRiLnNoZWxsKFsnZHVtcHN5cycsICd3aW5kb3cnLCAnd2luZG93cyddKTtcbiAgZm9yIChjb25zdCBsaW5lIG9mIG91dHB1dC5zcGxpdCgnXFxuJykpIHtcbiAgICBpZiAobGluZS5pbmNsdWRlcyhhcHBJZCkgJiYgKGxpbmUuaW5jbHVkZXMoJ21DdXJyZW50Rm9jdXMnKSB8fCBsaW5lLmluY2x1ZGVzKCdtRm9jdXNlZEFwcCcpKSkge1xuICAgICAgcmV0dXJuIEFQUF9TVEFURV9SVU5OSU5HX0lOX0ZPUkVHUk9VTkQ7XG4gICAgfVxuICB9XG4gIHJldHVybiBBUFBfU1RBVEVfUlVOTklOR19JTl9CQUNLR1JPVU5EO1xufTtcblxuLyoqXG4gKiBBY3RpdmF0ZXMgdGhlIGdpdmVuIGFwcGxpY2F0aW9uIG9yIGxhdW5jaGVzIGl0IGlmIG5lY2Vzc2FyeS5cbiAqIFRoZSBhY3Rpb24gaXMgZG9uZSB3aXRoIG1vbmtleSB0b29sIGFuZCBsaXRlcmFsbHkgc2ltdWxhdGVzXG4gKiBjbGlja2luZyB0aGUgY29ycmVzcG9uZGluZyBhcHBsaWNhdGlvbiBpY29uIG9uIHRoZSBkYXNoYm9hcmQuXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFwcElkIC0gQXBwbGljYXRpb24gcGFja2FnZSBpZGVudGlmaWVyXG4gKi9cbmNvbW1hbmRzLmFjdGl2YXRlQXBwID0gYXN5bmMgZnVuY3Rpb24gKGFwcElkKSB7XG4gIGNvbnN0IGNtZCA9IFsnbW9ua2V5JyxcbiAgICAnLXAnLCBhcHBJZCxcbiAgICAnLWMnLCAnYW5kcm9pZC5pbnRlbnQuY2F0ZWdvcnkuTEFVTkNIRVInLFxuICAgICcxJ107XG4gIGxldCBvdXRwdXQgPSAnJztcbiAgdHJ5IHtcbiAgICBsb2cuZGVidWcoYEFjdGl2YXRpbmcgJyR7YXBwSWR9JyB3aXRoICdhZGIgc2hlbGwgJHtjbWQuam9pbignICcpfScgY29tbWFuZGApO1xuICAgIG91dHB1dCA9IGF3YWl0IHRoaXMuYWRiLnNoZWxsKGNtZCk7XG4gICAgbG9nLmRlYnVnKGBDb21tYW5kIHN0ZG91dDogJHtvdXRwdXR9YCk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgQ2Fubm90IGFjdGl2YXRlICcke2FwcElkfScuIE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgfVxuICBpZiAob3V0cHV0LmluY2x1ZGVzKCdtb25rZXkgYWJvcnRlZCcpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYENhbm5vdCBhY3RpdmF0ZSAnJHthcHBJZH0nLiBBcmUgeW91IHN1cmUgaXQgaXMgaW5zdGFsbGVkP2ApO1xuICB9XG59O1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFVuaW5zdGFsbE9wdGlvbnNcbiAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0aW1lb3V0IFsyMDAwMF0gLSBUaGUgY291bnQgb2YgbWlsbGlzZWNvbmRzIHRvIHdhaXQgdW50aWwgdGhlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwIGlzIHVuaW5zdGFsbGVkLlxuICogQHByb3BlcnR5IHtib29sZWFufSBrZWVwRGF0YSBbZmFsc2VdIC0gU2V0IHRvIHRydWUgaW4gb3JkZXIgdG8ga2VlcCB0aGVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcGxpY2F0aW9uIGRhdGEgYW5kIGNhY2hlIGZvbGRlcnMgYWZ0ZXIgdW5pbnN0YWxsLlxuICovXG5cbi8qKlxuICogUmVtb3ZlIHRoZSBjb3JyZXNwb25kaW5nIGFwcGxpY2F0aW9uIGlmIGlzIGluc3RhbGxlZC5cbiAqIFRoZSBjYWxsIGlzIGlnbm9yZWQgaWYgdGhlIGFwcCBpcyBub3QgaW5zdGFsbGVkLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcHBJZCAtIEFwcGxpY2F0aW9uIHBhY2thZ2UgaWRlbnRpZmllclxuICogQHBhcmFtIHs/VW5pbnN0YWxsT3B0aW9uc30gb3B0aW9ucyAtIFRoZSBzZXQgb2YgcmVtb3ZhbCBvcHRpb25zXG4gKiBAcmV0dXJucyB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgcGFja2FnZSB3YXMgZm91bmQgb24gdGhlIGRldmljZSBhbmRcbiAqICAgICAgICAgICAgICAgICAgICBzdWNjZXNzZnVsbHkgdW5pbnN0YWxsZWQuXG4gKi9cbmNvbW1hbmRzLnJlbW92ZUFwcCA9IGFzeW5jIGZ1bmN0aW9uIChhcHBJZCwgb3B0aW9ucyA9IHt9KSB7XG4gIHJldHVybiBhd2FpdCB0aGlzLmFkYi51bmluc3RhbGxBcGsoYXBwSWQsIG9wdGlvbnMpO1xufTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBUZXJtaW5hdGVPcHRpb25zXG4gKiBAcHJvcGVydHkge251bWJlcnxzdHJpbmd9IHRpbWVvdXQgWzUwMF0gLSBUaGUgY291bnQgb2YgbWlsbGlzZWNvbmRzIHRvIHdhaXQgdW50aWwgdGhlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAgaXMgdGVybWluYXRlZC5cbiAqL1xuXG4vKipcbiAqIFRlcm1pbmF0ZXMgdGhlIGFwcCBpZiBpdCBpcyBydW5uaW5nLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcHBJZCAtIEFwcGxpY2F0aW9uIHBhY2thZ2UgaWRlbnRpZmllclxuICogQHBhcmFtIHs/VGVybWluYXRlT3B0aW9uc30gb3B0aW9ucyAtIFRoZSBzZXQgb2YgYXBwbGljYXRpb24gdGVybWluYXRpb24gb3B0aW9uc1xuICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgdGhlIGFwcCBoYXMgYmVlbiBzdWNjZXNzZnVsbHkgdGVybWluYXRlZC5cbiAqIEB0aHJvd3Mge0Vycm9yfSBpZiB0aGUgYXBwIGhhcyBub3QgYmVlbiB0ZXJtaW5hdGVkIHdpdGhpbiB0aGUgZ2l2ZW4gdGltZW91dC5cbiAqL1xuY29tbWFuZHMudGVybWluYXRlQXBwID0gYXN5bmMgZnVuY3Rpb24gKGFwcElkLCBvcHRpb25zID0ge30pIHtcbiAgbG9nLmluZm8oYFRlcm1pbmF0aW5nICcke2FwcElkfSdgKTtcbiAgaWYgKCEoYXdhaXQgdGhpcy5hZGIucHJvY2Vzc0V4aXN0cyhhcHBJZCkpKSB7XG4gICAgbG9nLmluZm8oYFRoZSBhcHAgJyR7YXBwSWR9JyBpcyBub3QgcnVubmluZ2ApO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuICBhd2FpdCB0aGlzLmFkYi5mb3JjZVN0b3AoYXBwSWQpO1xuICBjb25zdCB0aW1lb3V0ID0gdXRpbC5oYXNWYWx1ZShvcHRpb25zLnRpbWVvdXQpICYmICFpc05hTihvcHRpb25zLnRpbWVvdXQpID8gcGFyc2VJbnQob3B0aW9ucy50aW1lb3V0LCAxMCkgOiA1MDA7XG4gIHRyeSB7XG4gICAgYXdhaXQgd2FpdEZvckNvbmRpdGlvbihhc3luYyAoKSA9PiBhd2FpdCB0aGlzLnF1ZXJ5QXBwU3RhdGUoYXBwSWQpIDw9IEFQUF9TVEFURV9OT1RfUlVOTklORyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgIHt3YWl0TXM6IHRpbWVvdXQsIGludGVydmFsTXM6IDEwMH0pO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYCcke2FwcElkfScgaXMgc3RpbGwgcnVubmluZyBhZnRlciAke3RpbWVvdXR9bXMgdGltZW91dGApO1xuICB9XG4gIGxvZy5pbmZvKGAnJHthcHBJZH0nIGhhcyBiZWVuIHN1Y2Nlc3NmdWxseSB0ZXJtaW5hdGVkYCk7XG4gIHJldHVybiB0cnVlO1xufTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBJbnN0YWxsT3B0aW9uc1xuICogQHByb3BlcnR5IHtudW1iZXJ9IHRpbWVvdXQgWzYwMDAwXSAtIFRoZSBjb3VudCBvZiBtaWxsaXNlY29uZHMgdG8gd2FpdCB1bnRpbCB0aGVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHAgaXMgaW5zdGFsbGVkLlxuICogQHByb3BlcnR5IHtib29sZWFufSBhbGxvd1Rlc3RQYWNrYWdlcyBbZmFsc2VdIC0gU2V0IHRvIHRydWUgaW4gb3JkZXIgdG8gYWxsb3cgdGVzdFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFja2FnZXMgaW5zdGFsbGF0aW9uLlxuICogQHByb3BlcnR5IHtib29sZWFufSB1c2VTZGNhcmQgW2ZhbHNlXSAtIFNldCB0byB0cnVlIHRvIGluc3RhbGwgdGhlIGFwcCBvbiBzZGNhcmRcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnN0ZWFkIG9mIHRoZSBkZXZpY2UgbWVtb3J5LlxuICogQHByb3BlcnR5IHtib29sZWFufSBncmFudFBlcm1pc3Npb25zIFtmYWxzZV0gLSBTZXQgdG8gdHJ1ZSBpbiBvcmRlciB0byBncmFudCBhbGwgdGhlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBlcm1pc3Npb25zIHJlcXVlc3RlZCBpbiB0aGUgYXBwbGljYXRpb24ncyBtYW5pZmVzdFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdXRvbWF0aWNhbGx5IGFmdGVyIHRoZSBpbnN0YWxsYXRpb24gaXMgY29tcGxldGVkXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVuZGVyIEFuZHJvaWQgNisuXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IHJlcGxhY2UgW3RydWVdIC0gU2V0IGl0IHRvIGZhbHNlIGlmIHlvdSBkb24ndCB3YW50XG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhlIGFwcGxpY2F0aW9uIHRvIGJlIHVwZ3JhZGVkL3JlaW5zdGFsbGVkXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgaXQgaXMgYWxyZWFkeSBwcmVzZW50IG9uIHRoZSBkZXZpY2UuXG4gKi9cblxuLyoqXG4gKiBJbnN0YWxscyB0aGUgZ2l2ZW4gYXBwbGljYXRpb24gdG8gdGhlIGRldmljZSB1bmRlciB0ZXN0XG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGFwcFBhdGggLSBUaGUgbG9jYWwgYXBrIHBhdGggb3IgYSByZW1vdGUgdXJsXG4gKiBAcGFyYW0gez9JbnN0YWxsT3B0aW9uc30gb3B0aW9ucyAtIFRoZSBzZXQgb2YgaW5zdGFsbGF0aW9uIG9wdGlvbnNcbiAqIEB0aHJvd3Mge0Vycm9yfSBpZiB0aGUgZ2l2ZW4gYXBrIGRvZXMgbm90IGV4aXN0IG9yIGlzIG5vdCByZWFjaGFibGVcbiAqL1xuY29tbWFuZHMuaW5zdGFsbEFwcCA9IGFzeW5jIGZ1bmN0aW9uIChhcHBQYXRoLCBvcHRpb25zID0ge30pIHtcbiAgY29uc3QgbG9jYWxQYXRoID0gYXdhaXQgdGhpcy5oZWxwZXJzLmNvbmZpZ3VyZUFwcChhcHBQYXRoLCBBUFBfRVhURU5TSU9OKTtcbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLmFkYi5pbnN0YWxsKGxvY2FsUGF0aCwgb3B0aW9ucyk7XG4gIH0gZmluYWxseSB7XG4gICAgaWYgKGxvY2FsUGF0aCAhPT0gYXBwUGF0aCkge1xuICAgICAgYXdhaXQgZnMucmltcmFmKGxvY2FsUGF0aCk7XG4gICAgfVxuICB9XG59O1xuXG5cbmV4cG9ydCB7IGNvbW1hbmRzIH07XG5leHBvcnQgZGVmYXVsdCBjb21tYW5kcztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL2FwcC1tYW5hZ2VtZW50LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
