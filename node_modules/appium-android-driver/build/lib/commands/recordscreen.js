"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.commands = void 0;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _lodash = _interopRequireDefault(require("lodash"));

var _fs2 = _interopRequireDefault(require("fs"));

var _url = _interopRequireDefault(require("url"));

var _asyncbox = require("asyncbox");

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("../logger"));

var _teen_process = require("teen_process");

var _path = _interopRequireDefault(require("path"));

var _v = _interopRequireDefault(require("v8"));

let commands = {},
    extensions = {};
exports.commands = commands;
const RETRY_PAUSE = 300;
const RETRY_TIMEOUT = 5000;
const MAX_RECORDING_TIME_SEC = 60 * 3;
const MAX_TIME_SEC = 60 * 30;
const DEFAULT_RECORDING_TIME_SEC = MAX_RECORDING_TIME_SEC;
const PROCESS_SHUTDOWN_TIMEOUT = 10 * 1000;
const SCREENRECORD_BINARY = 'screenrecord';
const DEFAULT_EXT = '.mp4';
const MIN_EMULATOR_API_LEVEL = 27;
const FFMPEG_BINARY = `ffmpeg${_appiumSupport.system.isWindows() ? '.exe' : ''}`;

function uploadRecordedMedia(_x, _x2) {
  return _uploadRecordedMedia.apply(this, arguments);
}

function _uploadRecordedMedia() {
  _uploadRecordedMedia = (0, _asyncToGenerator2.default)(function* (adb, localFile, remotePath = null, uploadOptions = {}) {
    const _ref3 = yield _appiumSupport.fs.stat(localFile),
          size = _ref3.size;

    _logger.default.debug(`The size of the resulting screen recording is ${_appiumSupport.util.toReadableSizeString(size)}`);

    if (_lodash.default.isEmpty(remotePath)) {
      const maxMemoryLimit = _v.default.getHeapStatistics().total_available_size / 2;

      if (size >= maxMemoryLimit) {
        _logger.default.info(`The file might be too large to fit into the process memory ` + `(${_appiumSupport.util.toReadableSizeString(size)} >= ${_appiumSupport.util.toReadableSizeString(maxMemoryLimit)}). ` + `Provide a link to a remote writable location for video upload ` + `(http(s) and ftp protocols are supported) if you experience Out Of Memory errors`);
      }

      return (yield _appiumSupport.fs.readFile(localFile)).toString('base64');
    }

    const remoteUrl = _url.default.parse(remotePath);

    let options = {};
    const user = uploadOptions.user,
          pass = uploadOptions.pass,
          method = uploadOptions.method;

    if (remoteUrl.protocol.startsWith('http')) {
      options = {
        url: remoteUrl.href,
        method: method || 'PUT',
        multipart: [{
          body: _fs2.default.createReadStream(localFile)
        }]
      };

      if (user && pass) {
        options.auth = {
          user,
          pass
        };
      }
    } else if (remoteUrl.protocol.startsWith('ftp')) {
      options = {
        host: remoteUrl.hostname,
        port: remoteUrl.port || 21
      };

      if (user && pass) {
        options.user = user;
        options.pass = pass;
      }
    }

    yield _appiumSupport.net.uploadFile(localFile, remotePath, options);
    return '';
  });
  return _uploadRecordedMedia.apply(this, arguments);
}

function verifyScreenRecordIsSupported(_x3, _x4) {
  return _verifyScreenRecordIsSupported.apply(this, arguments);
}

function _verifyScreenRecordIsSupported() {
  _verifyScreenRecordIsSupported = (0, _asyncToGenerator2.default)(function* (adb, isEmulator) {
    const apiLevel = yield adb.getApiLevel();

    if (isEmulator && apiLevel < MIN_EMULATOR_API_LEVEL) {
      throw new Error(`Screen recording does not work on emulators running Android API level less than ${MIN_EMULATOR_API_LEVEL}`);
    }

    if (apiLevel < 19) {
      throw new Error(`Screen recording not available on API Level ${apiLevel}. Minimum API Level is 19.`);
    }
  });
  return _verifyScreenRecordIsSupported.apply(this, arguments);
}

function scheduleScreenRecord(_x5, _x6) {
  return _scheduleScreenRecord.apply(this, arguments);
}

function _scheduleScreenRecord() {
  _scheduleScreenRecord = (0, _asyncToGenerator2.default)(function* (adb, recordingProperties) {
    if (recordingProperties.stopped) {
      return;
    }

    const startTimestamp = recordingProperties.startTimestamp,
          videoSize = recordingProperties.videoSize,
          bitRate = recordingProperties.bitRate,
          timeLimit = recordingProperties.timeLimit,
          bugReport = recordingProperties.bugReport;
    let currentTimeLimit = MAX_RECORDING_TIME_SEC;

    if (_appiumSupport.util.hasValue(recordingProperties.currentTimeLimit)) {
      const currentTimeLimitInt = parseInt(recordingProperties.currentTimeLimit, 10);

      if (!isNaN(currentTimeLimitInt) && currentTimeLimitInt < MAX_RECORDING_TIME_SEC) {
        currentTimeLimit = currentTimeLimitInt;
      }
    }

    const pathOnDevice = `/sdcard/${Math.floor(new Date())}${DEFAULT_EXT}`;
    const recordingProc = adb.screenrecord(pathOnDevice, {
      videoSize,
      bitRate,
      timeLimit: currentTimeLimit,
      bugReport
    });
    recordingProc.on('end', () => {
      if (recordingProperties.stopped || !_appiumSupport.util.hasValue(timeLimit)) {
        return;
      }

      const currentDuration = process.hrtime(startTimestamp)[0];

      _logger.default.debug(`The overall screen recording duration is ${currentDuration}s so far`);

      const timeLimitInt = parseInt(timeLimit, 10);

      if (isNaN(timeLimitInt) || currentDuration >= timeLimitInt) {
        _logger.default.debug('There is no need to start the next recording chunk');

        return;
      }

      recordingProperties.currentTimeLimit = timeLimitInt - currentDuration;
      const chunkDuration = recordingProperties.currentTimeLimit < MAX_RECORDING_TIME_SEC ? recordingProperties.currentTimeLimit : MAX_RECORDING_TIME_SEC;

      _logger.default.debug(`Starting the next ${chunkDuration}s-chunk ` + `of screen recording in order to achieve ${timeLimitInt}s total duration`);

      scheduleScreenRecord(adb, recordingProperties).catch(e => {
        _logger.default.error(e.stack);

        recordingProperties.stopped = true;
      });
    });
    yield recordingProc.start(0);

    try {
      yield (0, _asyncbox.waitForCondition)((0, _asyncToGenerator2.default)(function* () {
        return yield adb.fileExists(pathOnDevice);
      }), {
        waitMs: RETRY_TIMEOUT,
        intervalMs: RETRY_PAUSE
      });
    } catch (e) {
      throw new Error(`The expected screen record file '${pathOnDevice}' does not exist after ${RETRY_TIMEOUT}ms`);
    }

    recordingProperties.records.push(pathOnDevice);
    recordingProperties.recordingProcess = recordingProc;
  });
  return _scheduleScreenRecord.apply(this, arguments);
}

function mergeScreenRecords(_x7) {
  return _mergeScreenRecords.apply(this, arguments);
}

function _mergeScreenRecords() {
  _mergeScreenRecords = (0, _asyncToGenerator2.default)(function* (mediaFiles) {
    try {
      yield _appiumSupport.fs.which(FFMPEG_BINARY);
    } catch (e) {
      throw new Error(`${FFMPEG_BINARY} utility is not available in PATH. Please install it from https://www.ffmpeg.org/`);
    }

    const configContent = mediaFiles.map(x => `file '${x}'`).join('\n');

    const configFile = _path.default.resolve(_path.default.dirname(mediaFiles[0]), 'config.txt');

    yield _appiumSupport.fs.writeFile(configFile, configContent, 'utf8');

    _logger.default.debug(`Generated ffmpeg merging config '${configFile}' with items:\n${configContent}`);

    const result = _path.default.resolve(_path.default.dirname(mediaFiles[0]), `merge_${Math.floor(new Date())}${DEFAULT_EXT}`);

    const args = ['-safe', '0', '-f', 'concat', '-i', configFile, '-c', 'copy', result];

    _logger.default.info(`Initiating screen records merging using the command '${FFMPEG_BINARY} ${args.join(' ')}'`);

    yield (0, _teen_process.exec)(FFMPEG_BINARY, args);
    return result;
  });
  return _mergeScreenRecords.apply(this, arguments);
}

function terminateBackgroundScreenRecording(_x8) {
  return _terminateBackgroundScreenRecording.apply(this, arguments);
}

function _terminateBackgroundScreenRecording() {
  _terminateBackgroundScreenRecording = (0, _asyncToGenerator2.default)(function* (adb, force = true) {
    const pids = (yield adb.getPIDsByName(SCREENRECORD_BINARY)).map(p => `${p}`);

    if (_lodash.default.isEmpty(pids)) {
      return false;
    }

    try {
      yield adb.shell(['kill', force ? '-15' : '-2', ...pids]);
      yield (0, _asyncbox.waitForCondition)((0, _asyncToGenerator2.default)(function* () {
        return _lodash.default.isEmpty((yield adb.getPIDsByName(SCREENRECORD_BINARY)));
      }), {
        waitMs: PROCESS_SHUTDOWN_TIMEOUT,
        intervalMs: 500
      });
      return true;
    } catch (err) {
      throw new Error(`Unable to stop the background screen recording: ${err.message}`);
    }
  });
  return _terminateBackgroundScreenRecording.apply(this, arguments);
}

commands.startRecordingScreen = function () {
  var _ref = (0, _asyncToGenerator2.default)(function* (options = {}) {
    yield verifyScreenRecordIsSupported(this.adb, this.isEmulator());
    let result = '';
    const videoSize = options.videoSize,
          _options$timeLimit = options.timeLimit,
          timeLimit = _options$timeLimit === void 0 ? DEFAULT_RECORDING_TIME_SEC : _options$timeLimit,
          bugReport = options.bugReport,
          bitRate = options.bitRate,
          forceRestart = options.forceRestart;

    if (!forceRestart) {
      result = yield this.stopRecordingScreen(options);
    }

    if (yield terminateBackgroundScreenRecording(this.adb, true)) {
      _logger.default.warn(`There were some ${SCREENRECORD_BINARY} process leftovers running ` + `in the background. Make sure you stop screen recording each time after it is started, ` + `otherwise the recorded media might quickly exceed all the free space on the device under test.`);
    }

    if (!_lodash.default.isEmpty(this._screenRecordingProperties)) {
      var _iteratorNormalCompletion = true;
      var _didIteratorError = false;
      var _iteratorError = undefined;

      try {
        for (var _iterator = (this._screenRecordingProperties.records || [])[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          const record = _step.value;
          yield this.adb.rimraf(record);
        }
      } catch (err) {
        _didIteratorError = true;
        _iteratorError = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion && _iterator.return != null) {
            _iterator.return();
          }
        } finally {
          if (_didIteratorError) {
            throw _iteratorError;
          }
        }
      }

      this._screenRecordingProperties = null;
    }

    const timeout = parseFloat(timeLimit);

    if (isNaN(timeout) || timeout > MAX_TIME_SEC || timeout <= 0) {
      throw new Error(`The timeLimit value must be in range [1, ${MAX_TIME_SEC}] seconds. ` + `The value of '${timeLimit}' has been passed instead.`);
    }

    this._screenRecordingProperties = {
      startTimestamp: process.hrtime(),
      videoSize,
      timeLimit,
      currentTimeLimit: timeLimit,
      bitRate,
      bugReport,
      records: [],
      recordingProcess: null,
      stopped: false
    };
    yield scheduleScreenRecord(this.adb, this._screenRecordingProperties);
    return result;
  });

  return function () {
    return _ref.apply(this, arguments);
  };
}();

commands.stopRecordingScreen = function () {
  var _ref2 = (0, _asyncToGenerator2.default)(function* (options = {}) {
    yield verifyScreenRecordIsSupported(this.adb, this.isEmulator());

    if (!_lodash.default.isEmpty(this._screenRecordingProperties)) {
      this._screenRecordingProperties.stopped = true;
    }

    try {
      yield terminateBackgroundScreenRecording(this.adb, false);
    } catch (err) {
      _logger.default.warn(err.message);

      if (!_lodash.default.isEmpty(this._screenRecordingProperties)) {
        _logger.default.warn('The resulting video might be corrupted');
      }
    }

    if (_lodash.default.isEmpty(this._screenRecordingProperties)) {
      _logger.default.info(`Screen recording has not been previously started by Appium. There is nothing to stop`);

      return '';
    }

    if (this._screenRecordingProperties.recordingProcess && this._screenRecordingProperties.recordingProcess.isRunning) {
      try {
        yield this._screenRecordingProperties.recordingProcess.stop('SIGINT', PROCESS_SHUTDOWN_TIMEOUT);
      } catch (e) {
        _logger.default.errorAndThrow(`Unable to stop screen recording within ${PROCESS_SHUTDOWN_TIMEOUT}ms`);
      }

      this._screenRecordingProperties.recordingProcess = null;
    }

    if (_lodash.default.isEmpty(this._screenRecordingProperties.records)) {
      _logger.default.errorAndThrow(`No screen recordings have been stored on the device so far. ` + `Are you sure the ${SCREENRECORD_BINARY} utility works as expected?`);
    }

    const tmpRoot = yield _appiumSupport.tempDir.openDir();

    try {
      const localRecords = [];
      var _iteratorNormalCompletion2 = true;
      var _didIteratorError2 = false;
      var _iteratorError2 = undefined;

      try {
        for (var _iterator2 = this._screenRecordingProperties.records[Symbol.iterator](), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
          const pathOnDevice = _step2.value;
          localRecords.push(_path.default.resolve(tmpRoot, _path.default.posix.basename(pathOnDevice)));
          yield this.adb.pull(pathOnDevice, _lodash.default.last(localRecords));
          yield this.adb.rimraf(pathOnDevice);
        }
      } catch (err) {
        _didIteratorError2 = true;
        _iteratorError2 = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion2 && _iterator2.return != null) {
            _iterator2.return();
          }
        } finally {
          if (_didIteratorError2) {
            throw _iteratorError2;
          }
        }
      }

      let resultFilePath = _lodash.default.last(localRecords);

      if (localRecords.length > 1) {
        _logger.default.info(`Got ${localRecords.length} screen recordings. Trying to merge them`);

        try {
          resultFilePath = yield mergeScreenRecords(localRecords);
        } catch (e) {
          _logger.default.warn(`Cannot merge the recorded files. The most recent screen recording is going to be returned as the result. ` + `Original error: ${e.message}`);
        }
      }

      const remotePath = options.remotePath,
            user = options.user,
            pass = options.pass,
            method = options.method;
      return yield uploadRecordedMedia(this.adb, resultFilePath, remotePath, {
        user,
        pass,
        method
      });
    } finally {
      yield _appiumSupport.fs.rimraf(tmpRoot);
      this._screenRecordingProperties = null;
    }
  });

  return function () {
    return _ref2.apply(this, arguments);
  };
}();

Object.assign(extensions, commands);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9yZWNvcmRzY3JlZW4uanMiXSwibmFtZXMiOlsiY29tbWFuZHMiLCJleHRlbnNpb25zIiwiUkVUUllfUEFVU0UiLCJSRVRSWV9USU1FT1VUIiwiTUFYX1JFQ09SRElOR19USU1FX1NFQyIsIk1BWF9USU1FX1NFQyIsIkRFRkFVTFRfUkVDT1JESU5HX1RJTUVfU0VDIiwiUFJPQ0VTU19TSFVURE9XTl9USU1FT1VUIiwiU0NSRUVOUkVDT1JEX0JJTkFSWSIsIkRFRkFVTFRfRVhUIiwiTUlOX0VNVUxBVE9SX0FQSV9MRVZFTCIsIkZGTVBFR19CSU5BUlkiLCJzeXN0ZW0iLCJpc1dpbmRvd3MiLCJ1cGxvYWRSZWNvcmRlZE1lZGlhIiwiYWRiIiwibG9jYWxGaWxlIiwicmVtb3RlUGF0aCIsInVwbG9hZE9wdGlvbnMiLCJmcyIsInN0YXQiLCJzaXplIiwibG9nIiwiZGVidWciLCJ1dGlsIiwidG9SZWFkYWJsZVNpemVTdHJpbmciLCJfIiwiaXNFbXB0eSIsIm1heE1lbW9yeUxpbWl0IiwidjgiLCJnZXRIZWFwU3RhdGlzdGljcyIsInRvdGFsX2F2YWlsYWJsZV9zaXplIiwiaW5mbyIsInJlYWRGaWxlIiwidG9TdHJpbmciLCJyZW1vdGVVcmwiLCJ1cmwiLCJwYXJzZSIsIm9wdGlvbnMiLCJ1c2VyIiwicGFzcyIsIm1ldGhvZCIsInByb3RvY29sIiwic3RhcnRzV2l0aCIsImhyZWYiLCJtdWx0aXBhcnQiLCJib2R5IiwiX2ZzIiwiY3JlYXRlUmVhZFN0cmVhbSIsImF1dGgiLCJob3N0IiwiaG9zdG5hbWUiLCJwb3J0IiwibmV0IiwidXBsb2FkRmlsZSIsInZlcmlmeVNjcmVlblJlY29yZElzU3VwcG9ydGVkIiwiaXNFbXVsYXRvciIsImFwaUxldmVsIiwiZ2V0QXBpTGV2ZWwiLCJFcnJvciIsInNjaGVkdWxlU2NyZWVuUmVjb3JkIiwicmVjb3JkaW5nUHJvcGVydGllcyIsInN0b3BwZWQiLCJzdGFydFRpbWVzdGFtcCIsInZpZGVvU2l6ZSIsImJpdFJhdGUiLCJ0aW1lTGltaXQiLCJidWdSZXBvcnQiLCJjdXJyZW50VGltZUxpbWl0IiwiaGFzVmFsdWUiLCJjdXJyZW50VGltZUxpbWl0SW50IiwicGFyc2VJbnQiLCJpc05hTiIsInBhdGhPbkRldmljZSIsIk1hdGgiLCJmbG9vciIsIkRhdGUiLCJyZWNvcmRpbmdQcm9jIiwic2NyZWVucmVjb3JkIiwib24iLCJjdXJyZW50RHVyYXRpb24iLCJwcm9jZXNzIiwiaHJ0aW1lIiwidGltZUxpbWl0SW50IiwiY2h1bmtEdXJhdGlvbiIsImNhdGNoIiwiZSIsImVycm9yIiwic3RhY2siLCJzdGFydCIsImZpbGVFeGlzdHMiLCJ3YWl0TXMiLCJpbnRlcnZhbE1zIiwicmVjb3JkcyIsInB1c2giLCJyZWNvcmRpbmdQcm9jZXNzIiwibWVyZ2VTY3JlZW5SZWNvcmRzIiwibWVkaWFGaWxlcyIsIndoaWNoIiwiY29uZmlnQ29udGVudCIsIm1hcCIsIngiLCJqb2luIiwiY29uZmlnRmlsZSIsInBhdGgiLCJyZXNvbHZlIiwiZGlybmFtZSIsIndyaXRlRmlsZSIsInJlc3VsdCIsImFyZ3MiLCJ0ZXJtaW5hdGVCYWNrZ3JvdW5kU2NyZWVuUmVjb3JkaW5nIiwiZm9yY2UiLCJwaWRzIiwiZ2V0UElEc0J5TmFtZSIsInAiLCJzaGVsbCIsImVyciIsIm1lc3NhZ2UiLCJzdGFydFJlY29yZGluZ1NjcmVlbiIsImZvcmNlUmVzdGFydCIsInN0b3BSZWNvcmRpbmdTY3JlZW4iLCJ3YXJuIiwiX3NjcmVlblJlY29yZGluZ1Byb3BlcnRpZXMiLCJyZWNvcmQiLCJyaW1yYWYiLCJ0aW1lb3V0IiwicGFyc2VGbG9hdCIsImlzUnVubmluZyIsInN0b3AiLCJlcnJvckFuZFRocm93IiwidG1wUm9vdCIsInRlbXBEaXIiLCJvcGVuRGlyIiwibG9jYWxSZWNvcmRzIiwicG9zaXgiLCJiYXNlbmFtZSIsInB1bGwiLCJsYXN0IiwicmVzdWx0RmlsZVBhdGgiLCJsZW5ndGgiLCJPYmplY3QiLCJhc3NpZ24iXSwibWFwcGluZ3MiOiI7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QWIsT0FBdkMsQ0FBaEM7QUFDRCxLQW5CRCxTQW1CVTtBQUNSLFlBQU10QixrQkFBR3lHLE1BQUgsQ0FBVU0sT0FBVixDQUFOO0FBQ0EsV0FBS1IsMEJBQUwsR0FBa0MsSUFBbEM7QUFDRDtBQUNGLEdBM0REOztBQUFBO0FBQUE7QUFBQTtBQUFBOztBQThEQWtCLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjNUksVUFBZCxFQUEwQkQsUUFBMUI7ZUFFZUMsVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgX2ZzIGZyb20gJ2ZzJztcbmltcG9ydCB1cmwgZnJvbSAndXJsJztcbmltcG9ydCB7IHdhaXRGb3JDb25kaXRpb24gfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgeyB1dGlsLCBmcywgbmV0LCB0ZW1wRGlyLCBzeXN0ZW0gfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHY4IGZyb20gJ3Y4JztcblxuXG5sZXQgY29tbWFuZHMgPSB7fSwgZXh0ZW5zaW9ucyA9IHt9O1xuXG5jb25zdCBSRVRSWV9QQVVTRSA9IDMwMDtcbmNvbnN0IFJFVFJZX1RJTUVPVVQgPSA1MDAwO1xuY29uc3QgTUFYX1JFQ09SRElOR19USU1FX1NFQyA9IDYwICogMztcbmNvbnN0IE1BWF9USU1FX1NFQyA9IDYwICogMzA7XG5jb25zdCBERUZBVUxUX1JFQ09SRElOR19USU1FX1NFQyA9IE1BWF9SRUNPUkRJTkdfVElNRV9TRUM7XG5jb25zdCBQUk9DRVNTX1NIVVRET1dOX1RJTUVPVVQgPSAxMCAqIDEwMDA7XG5jb25zdCBTQ1JFRU5SRUNPUkRfQklOQVJZID0gJ3NjcmVlbnJlY29yZCc7XG5jb25zdCBERUZBVUxUX0VYVCA9ICcubXA0JztcbmNvbnN0IE1JTl9FTVVMQVRPUl9BUElfTEVWRUwgPSAyNztcbmNvbnN0IEZGTVBFR19CSU5BUlkgPSBgZmZtcGVnJHtzeXN0ZW0uaXNXaW5kb3dzKCkgPyAnLmV4ZScgOiAnJ31gO1xuXG5hc3luYyBmdW5jdGlvbiB1cGxvYWRSZWNvcmRlZE1lZGlhIChhZGIsIGxvY2FsRmlsZSwgcmVtb3RlUGF0aCA9IG51bGwsIHVwbG9hZE9wdGlvbnMgPSB7fSkge1xuICBjb25zdCB7c2l6ZX0gPSBhd2FpdCBmcy5zdGF0KGxvY2FsRmlsZSk7XG4gIGxvZy5kZWJ1ZyhgVGhlIHNpemUgb2YgdGhlIHJlc3VsdGluZyBzY3JlZW4gcmVjb3JkaW5nIGlzICR7dXRpbC50b1JlYWRhYmxlU2l6ZVN0cmluZyhzaXplKX1gKTtcbiAgaWYgKF8uaXNFbXB0eShyZW1vdGVQYXRoKSkge1xuICAgIGNvbnN0IG1heE1lbW9yeUxpbWl0ID0gdjguZ2V0SGVhcFN0YXRpc3RpY3MoKS50b3RhbF9hdmFpbGFibGVfc2l6ZSAvIDI7XG4gICAgaWYgKHNpemUgPj0gbWF4TWVtb3J5TGltaXQpIHtcbiAgICAgIGxvZy5pbmZvKGBUaGUgZmlsZSBtaWdodCBiZSB0b28gbGFyZ2UgdG8gZml0IGludG8gdGhlIHByb2Nlc3MgbWVtb3J5IGAgK1xuICAgICAgICBgKCR7dXRpbC50b1JlYWRhYmxlU2l6ZVN0cmluZyhzaXplKX0gPj0gJHt1dGlsLnRvUmVhZGFibGVTaXplU3RyaW5nKG1heE1lbW9yeUxpbWl0KX0pLiBgICtcbiAgICAgICAgYFByb3ZpZGUgYSBsaW5rIHRvIGEgcmVtb3RlIHdyaXRhYmxlIGxvY2F0aW9uIGZvciB2aWRlbyB1cGxvYWQgYCArXG4gICAgICAgIGAoaHR0cChzKSBhbmQgZnRwIHByb3RvY29scyBhcmUgc3VwcG9ydGVkKSBpZiB5b3UgZXhwZXJpZW5jZSBPdXQgT2YgTWVtb3J5IGVycm9yc2ApO1xuICAgIH1cbiAgICByZXR1cm4gKGF3YWl0IGZzLnJlYWRGaWxlKGxvY2FsRmlsZSkpLnRvU3RyaW5nKCdiYXNlNjQnKTtcbiAgfVxuXG4gIGNvbnN0IHJlbW90ZVVybCA9IHVybC5wYXJzZShyZW1vdGVQYXRoKTtcbiAgbGV0IG9wdGlvbnMgPSB7fTtcbiAgY29uc3Qge3VzZXIsIHBhc3MsIG1ldGhvZH0gPSB1cGxvYWRPcHRpb25zO1xuICBpZiAocmVtb3RlVXJsLnByb3RvY29sLnN0YXJ0c1dpdGgoJ2h0dHAnKSkge1xuICAgIG9wdGlvbnMgPSB7XG4gICAgICB1cmw6IHJlbW90ZVVybC5ocmVmLFxuICAgICAgbWV0aG9kOiBtZXRob2QgfHwgJ1BVVCcsXG4gICAgICBtdWx0aXBhcnQ6IFt7IGJvZHk6IF9mcy5jcmVhdGVSZWFkU3RyZWFtKGxvY2FsRmlsZSkgfV0sXG4gICAgfTtcbiAgICBpZiAodXNlciAmJiBwYXNzKSB7XG4gICAgICBvcHRpb25zLmF1dGggPSB7dXNlciwgcGFzc307XG4gICAgfVxuICB9IGVsc2UgaWYgKHJlbW90ZVVybC5wcm90b2NvbC5zdGFydHNXaXRoKCdmdHAnKSkge1xuICAgIG9wdGlvbnMgPSB7XG4gICAgICBob3N0OiByZW1vdGVVcmwuaG9zdG5hbWUsXG4gICAgICBwb3J0OiByZW1vdGVVcmwucG9ydCB8fCAyMSxcbiAgICB9O1xuICAgIGlmICh1c2VyICYmIHBhc3MpIHtcbiAgICAgIG9wdGlvbnMudXNlciA9IHVzZXI7XG4gICAgICBvcHRpb25zLnBhc3MgPSBwYXNzO1xuICAgIH1cbiAgfVxuICBhd2FpdCBuZXQudXBsb2FkRmlsZShsb2NhbEZpbGUsIHJlbW90ZVBhdGgsIG9wdGlvbnMpO1xuICByZXR1cm4gJyc7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHZlcmlmeVNjcmVlblJlY29yZElzU3VwcG9ydGVkIChhZGIsIGlzRW11bGF0b3IpIHtcbiAgY29uc3QgYXBpTGV2ZWwgPSBhd2FpdCBhZGIuZ2V0QXBpTGV2ZWwoKTtcbiAgaWYgKGlzRW11bGF0b3IgJiYgYXBpTGV2ZWwgPCBNSU5fRU1VTEFUT1JfQVBJX0xFVkVMKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBTY3JlZW4gcmVjb3JkaW5nIGRvZXMgbm90IHdvcmsgb24gZW11bGF0b3JzIHJ1bm5pbmcgQW5kcm9pZCBBUEkgbGV2ZWwgbGVzcyB0aGFuICR7TUlOX0VNVUxBVE9SX0FQSV9MRVZFTH1gKTtcbiAgfVxuICBpZiAoYXBpTGV2ZWwgPCAxOSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgU2NyZWVuIHJlY29yZGluZyBub3QgYXZhaWxhYmxlIG9uIEFQSSBMZXZlbCAke2FwaUxldmVsfS4gTWluaW11bSBBUEkgTGV2ZWwgaXMgMTkuYCk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gc2NoZWR1bGVTY3JlZW5SZWNvcmQgKGFkYiwgcmVjb3JkaW5nUHJvcGVydGllcykge1xuICBpZiAocmVjb3JkaW5nUHJvcGVydGllcy5zdG9wcGVkKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3Qge1xuICAgIHN0YXJ0VGltZXN0YW1wLFxuICAgIHZpZGVvU2l6ZSxcbiAgICBiaXRSYXRlLFxuICAgIHRpbWVMaW1pdCxcbiAgICBidWdSZXBvcnQsXG4gIH0gPSByZWNvcmRpbmdQcm9wZXJ0aWVzO1xuXG4gIGxldCBjdXJyZW50VGltZUxpbWl0ID0gTUFYX1JFQ09SRElOR19USU1FX1NFQztcbiAgaWYgKHV0aWwuaGFzVmFsdWUocmVjb3JkaW5nUHJvcGVydGllcy5jdXJyZW50VGltZUxpbWl0KSkge1xuICAgIGNvbnN0IGN1cnJlbnRUaW1lTGltaXRJbnQgPSBwYXJzZUludChyZWNvcmRpbmdQcm9wZXJ0aWVzLmN1cnJlbnRUaW1lTGltaXQsIDEwKTtcbiAgICBpZiAoIWlzTmFOKGN1cnJlbnRUaW1lTGltaXRJbnQpICYmIGN1cnJlbnRUaW1lTGltaXRJbnQgPCBNQVhfUkVDT1JESU5HX1RJTUVfU0VDKSB7XG4gICAgICBjdXJyZW50VGltZUxpbWl0ID0gY3VycmVudFRpbWVMaW1pdEludDtcbiAgICB9XG4gIH1cbiAgY29uc3QgcGF0aE9uRGV2aWNlID0gYC9zZGNhcmQvJHtNYXRoLmZsb29yKG5ldyBEYXRlKCkpfSR7REVGQVVMVF9FWFR9YDtcbiAgY29uc3QgcmVjb3JkaW5nUHJvYyA9IGFkYi5zY3JlZW5yZWNvcmQocGF0aE9uRGV2aWNlLCB7XG4gICAgdmlkZW9TaXplLFxuICAgIGJpdFJhdGUsXG4gICAgdGltZUxpbWl0OiBjdXJyZW50VGltZUxpbWl0LFxuICAgIGJ1Z1JlcG9ydCxcbiAgfSk7XG5cbiAgcmVjb3JkaW5nUHJvYy5vbignZW5kJywgKCkgPT4ge1xuICAgIGlmIChyZWNvcmRpbmdQcm9wZXJ0aWVzLnN0b3BwZWQgfHwgIXV0aWwuaGFzVmFsdWUodGltZUxpbWl0KSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBjdXJyZW50RHVyYXRpb24gPSBwcm9jZXNzLmhydGltZShzdGFydFRpbWVzdGFtcClbMF07XG4gICAgbG9nLmRlYnVnKGBUaGUgb3ZlcmFsbCBzY3JlZW4gcmVjb3JkaW5nIGR1cmF0aW9uIGlzICR7Y3VycmVudER1cmF0aW9ufXMgc28gZmFyYCk7XG4gICAgY29uc3QgdGltZUxpbWl0SW50ID0gcGFyc2VJbnQodGltZUxpbWl0LCAxMCk7XG4gICAgaWYgKGlzTmFOKHRpbWVMaW1pdEludCkgfHwgY3VycmVudER1cmF0aW9uID49IHRpbWVMaW1pdEludCkge1xuICAgICAgbG9nLmRlYnVnKCdUaGVyZSBpcyBubyBuZWVkIHRvIHN0YXJ0IHRoZSBuZXh0IHJlY29yZGluZyBjaHVuaycpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHJlY29yZGluZ1Byb3BlcnRpZXMuY3VycmVudFRpbWVMaW1pdCA9IHRpbWVMaW1pdEludCAtIGN1cnJlbnREdXJhdGlvbjtcbiAgICBjb25zdCBjaHVua0R1cmF0aW9uID0gcmVjb3JkaW5nUHJvcGVydGllcy5jdXJyZW50VGltZUxpbWl0IDwgTUFYX1JFQ09SRElOR19USU1FX1NFQ1xuICAgICAgPyByZWNvcmRpbmdQcm9wZXJ0aWVzLmN1cnJlbnRUaW1lTGltaXRcbiAgICAgIDogTUFYX1JFQ09SRElOR19USU1FX1NFQztcbiAgICBsb2cuZGVidWcoYFN0YXJ0aW5nIHRoZSBuZXh0ICR7Y2h1bmtEdXJhdGlvbn1zLWNodW5rIGAgK1xuICAgICAgYG9mIHNjcmVlbiByZWNvcmRpbmcgaW4gb3JkZXIgdG8gYWNoaWV2ZSAke3RpbWVMaW1pdEludH1zIHRvdGFsIGR1cmF0aW9uYCk7XG4gICAgc2NoZWR1bGVTY3JlZW5SZWNvcmQoYWRiLCByZWNvcmRpbmdQcm9wZXJ0aWVzKVxuICAgICAgLmNhdGNoKChlKSA9PiB7XG4gICAgICAgIGxvZy5lcnJvcihlLnN0YWNrKTtcbiAgICAgICAgcmVjb3JkaW5nUHJvcGVydGllcy5zdG9wcGVkID0gdHJ1ZTtcbiAgICAgIH0pO1xuICB9KTtcblxuICBhd2FpdCByZWNvcmRpbmdQcm9jLnN0YXJ0KDApO1xuICB0cnkge1xuICAgIGF3YWl0IHdhaXRGb3JDb25kaXRpb24oYXN5bmMgKCkgPT4gYXdhaXQgYWRiLmZpbGVFeGlzdHMocGF0aE9uRGV2aWNlKSxcbiAgICAgIHt3YWl0TXM6IFJFVFJZX1RJTUVPVVQsIGludGVydmFsTXM6IFJFVFJZX1BBVVNFfSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBleHBlY3RlZCBzY3JlZW4gcmVjb3JkIGZpbGUgJyR7cGF0aE9uRGV2aWNlfScgZG9lcyBub3QgZXhpc3QgYWZ0ZXIgJHtSRVRSWV9USU1FT1VUfW1zYCk7XG4gIH1cblxuICByZWNvcmRpbmdQcm9wZXJ0aWVzLnJlY29yZHMucHVzaChwYXRoT25EZXZpY2UpO1xuICByZWNvcmRpbmdQcm9wZXJ0aWVzLnJlY29yZGluZ1Byb2Nlc3MgPSByZWNvcmRpbmdQcm9jO1xufVxuXG5hc3luYyBmdW5jdGlvbiBtZXJnZVNjcmVlblJlY29yZHMgKG1lZGlhRmlsZXMpIHtcbiAgdHJ5IHtcbiAgICBhd2FpdCBmcy53aGljaChGRk1QRUdfQklOQVJZKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgJHtGRk1QRUdfQklOQVJZfSB1dGlsaXR5IGlzIG5vdCBhdmFpbGFibGUgaW4gUEFUSC4gUGxlYXNlIGluc3RhbGwgaXQgZnJvbSBodHRwczovL3d3dy5mZm1wZWcub3JnL2ApO1xuICB9XG4gIGNvbnN0IGNvbmZpZ0NvbnRlbnQgPSBtZWRpYUZpbGVzXG4gICAgLm1hcCgoeCkgPT4gYGZpbGUgJyR7eH0nYClcbiAgICAuam9pbignXFxuJyk7XG4gIGNvbnN0IGNvbmZpZ0ZpbGUgPSBwYXRoLnJlc29sdmUocGF0aC5kaXJuYW1lKG1lZGlhRmlsZXNbMF0pLCAnY29uZmlnLnR4dCcpO1xuICBhd2FpdCBmcy53cml0ZUZpbGUoY29uZmlnRmlsZSwgY29uZmlnQ29udGVudCwgJ3V0ZjgnKTtcbiAgbG9nLmRlYnVnKGBHZW5lcmF0ZWQgZmZtcGVnIG1lcmdpbmcgY29uZmlnICcke2NvbmZpZ0ZpbGV9JyB3aXRoIGl0ZW1zOlxcbiR7Y29uZmlnQ29udGVudH1gKTtcbiAgY29uc3QgcmVzdWx0ID0gcGF0aC5yZXNvbHZlKHBhdGguZGlybmFtZShtZWRpYUZpbGVzWzBdKSwgYG1lcmdlXyR7TWF0aC5mbG9vcihuZXcgRGF0ZSgpKX0ke0RFRkFVTFRfRVhUfWApO1xuICBjb25zdCBhcmdzID0gWyctc2FmZScsICcwJywgJy1mJywgJ2NvbmNhdCcsICctaScsIGNvbmZpZ0ZpbGUsICctYycsICdjb3B5JywgcmVzdWx0XTtcbiAgbG9nLmluZm8oYEluaXRpYXRpbmcgc2NyZWVuIHJlY29yZHMgbWVyZ2luZyB1c2luZyB0aGUgY29tbWFuZCAnJHtGRk1QRUdfQklOQVJZfSAke2FyZ3Muam9pbignICcpfSdgKTtcbiAgYXdhaXQgZXhlYyhGRk1QRUdfQklOQVJZLCBhcmdzKTtcbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gdGVybWluYXRlQmFja2dyb3VuZFNjcmVlblJlY29yZGluZyAoYWRiLCBmb3JjZSA9IHRydWUpIHtcbiAgY29uc3QgcGlkcyA9IChhd2FpdCBhZGIuZ2V0UElEc0J5TmFtZShTQ1JFRU5SRUNPUkRfQklOQVJZKSlcbiAgICAubWFwKChwKSA9PiBgJHtwfWApO1xuICBpZiAoXy5pc0VtcHR5KHBpZHMpKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgdHJ5IHtcbiAgICBhd2FpdCBhZGIuc2hlbGwoWydraWxsJywgZm9yY2UgPyAnLTE1JyA6ICctMicsIC4uLnBpZHNdKTtcbiAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKGFzeW5jICgpID0+IF8uaXNFbXB0eShhd2FpdCBhZGIuZ2V0UElEc0J5TmFtZShTQ1JFRU5SRUNPUkRfQklOQVJZKSksIHtcbiAgICAgIHdhaXRNczogUFJPQ0VTU19TSFVURE9XTl9USU1FT1VULFxuICAgICAgaW50ZXJ2YWxNczogNTAwLFxuICAgIH0pO1xuICAgIHJldHVybiB0cnVlO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFVuYWJsZSB0byBzdG9wIHRoZSBiYWNrZ3JvdW5kIHNjcmVlbiByZWNvcmRpbmc6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gIH1cbn1cblxuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IFN0YXJ0UmVjb3JkaW5nT3B0aW9uc1xuICpcbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gcmVtb3RlUGF0aCAtIFRoZSBwYXRoIHRvIHRoZSByZW1vdGUgbG9jYXRpb24sIHdoZXJlIHRoZSBjYXB0dXJlZCB2aWRlbyBzaG91bGQgYmUgdXBsb2FkZWQuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgZm9sbG93aW5nIHByb3RvY29scyBhcmUgc3VwcG9ydGVkOiBodHRwL2h0dHBzLCBmdHAuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBOdWxsIG9yIGVtcHR5IHN0cmluZyB2YWx1ZSAodGhlIGRlZmF1bHQgc2V0dGluZykgbWVhbnMgdGhlIGNvbnRlbnQgb2YgcmVzdWx0aW5nXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmaWxlIHNob3VsZCBiZSBlbmNvZGVkIGFzIEJhc2U2NCBhbmQgcGFzc2VkIGFzIHRoZSBlbmRwb3VudCByZXNwb25zZSB2YWx1ZS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIEFuIGV4Y2VwdGlvbiB3aWxsIGJlIHRocm93biBpZiB0aGUgZ2VuZXJhdGVkIG1lZGlhIGZpbGUgaXMgdG9vIGJpZyB0b1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZml0IGludG8gdGhlIGF2YWlsYWJsZSBwcm9jZXNzIG1lbW9yeS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoaXMgb3B0aW9uIG9ubHkgaGFzIGFuIGVmZmVjdCBpZiB0aGVyZSBpcyBzY3JlZW4gcmVjb3JkaW5nIHByb2Nlc3MgaW4gcHJvZ3JlZXNzXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhbmQgYGZvcmNlUmVzdGFydGAgcGFyYW1ldGVyIGlzIG5vdCBzZXQgdG8gYHRydWVgLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSB1c2VyIC0gVGhlIG5hbWUgb2YgdGhlIHVzZXIgZm9yIHRoZSByZW1vdGUgYXV0aGVudGljYXRpb24uIE9ubHkgd29ya3MgaWYgYHJlbW90ZVBhdGhgIGlzIHByb3ZpZGVkLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSBwYXNzIC0gVGhlIHBhc3N3b3JkIGZvciB0aGUgcmVtb3RlIGF1dGhlbnRpY2F0aW9uLiBPbmx5IHdvcmtzIGlmIGByZW1vdGVQYXRoYCBpcyBwcm92aWRlZC5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gbWV0aG9kIC0gVGhlIGh0dHAgbXVsdGlwYXJ0IHVwbG9hZCBtZXRob2QgbmFtZS4gVGhlICdQVVQnIG9uZSBpcyB1c2VkIGJ5IGRlZmF1bHQuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE9ubHkgd29ya3MgaWYgYHJlbW90ZVBhdGhgIGlzIHByb3ZpZGVkLlxuICogQHByb3BlcnR5IHs/c3RyaW5nfSB2aWRlb1NpemUgLSBUaGUgZm9ybWF0IGlzIHdpZHRoeGhlaWdodC5cbiAqICAgICAgICAgICAgICAgICAgVGhlIGRlZmF1bHQgdmFsdWUgaXMgdGhlIGRldmljZSdzIG5hdGl2ZSBkaXNwbGF5IHJlc29sdXRpb24gKGlmIHN1cHBvcnRlZCksXG4gKiAgICAgICAgICAgICAgICAgIDEyODB4NzIwIGlmIG5vdC4gRm9yIGJlc3QgcmVzdWx0cyxcbiAqICAgICAgICAgICAgICAgICAgdXNlIGEgc2l6ZSBzdXBwb3J0ZWQgYnkgeW91ciBkZXZpY2UncyBBZHZhbmNlZCBWaWRlbyBDb2RpbmcgKEFWQykgZW5jb2Rlci5cbiAqICAgICAgICAgICAgICAgICAgRm9yIGV4YW1wbGUsIFwiMTI4MHg3MjBcIlxuICogQHByb3BlcnR5IHs/Ym9vbGVhbn0gYnVnUmVwb3J0IC0gU2V0IGl0IHRvIGB0cnVlYCBpbiBvcmRlciB0byBkaXNwbGF5IGFkZGl0aW9uYWwgaW5mb3JtYXRpb24gb24gdGhlIHZpZGVvIG92ZXJsYXksXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWNoIGFzIGEgdGltZXN0YW1wLCB0aGF0IGlzIGhlbHBmdWwgaW4gdmlkZW9zIGNhcHR1cmVkIHRvIGlsbHVzdHJhdGUgYnVncy5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoaXMgb3B0aW9uIGlzIG9ubHkgc3VwcG9ydGVkIHNpbmNlIEFQSSBsZXZlbCAyNyAoQW5kcm9pZCBQKS5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ3xudW1iZXJ9IHRpbWVMaW1pdCAtIFRoZSBtYXhpbXVtIHJlY29yZGluZyB0aW1lLCBpbiBzZWNvbmRzLiBUaGUgZGVmYXVsdCB2YWx1ZSBpcyAxODAgKDMgbWludXRlcykuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgbWF4aW11bSB2YWx1ZSBpcyAxODAwICgzMCBtaW51dGVzKS4gSWYgdGhlIHBhc3NlZCB2YWx1ZSBpcyBncmVhdGVyIHRoYW4gMTgwIHRoZW5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoZSBhbGdvcml0aG0gd2lsbCB0cnkgdG8gc2NoZWR1bGUgbXVsdGlwbGUgc2NyZWVuIHJlY29yZGluZyBjaHVua3MgYW5kIG1lcmdlIHRoZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0aW5nIHZpZGVvcyBpbnRvIGEgc2luZ2xlIG1lZGlhIGZpbGUgdXNpbmcgYGZmbXBlZ2AgdXRpbGl0eS5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIElmIHRoZSB1dGlsaXR5IGlzIG5vdCBhdmFpbGFibGUgaW4gUEFUSCB0aGVuIHRoZSBtb3N0IHJlY2VudCBzY3JlZW4gcmVjb3JkaW5nIGNodW5rIGlzXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBnb2luZyB0byBiZSByZXR1cm5lZC5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ3xudW1iZXJ9IGJpdFJhdGUgLSBUaGUgdmlkZW8gYml0IHJhdGUgZm9yIHRoZSB2aWRlbywgaW4gbWVnYWJpdHMgcGVyIHNlY29uZC5cbiAqICAgICAgICAgICAgICAgIFRoZSBkZWZhdWx0IHZhbHVlIGlzIDQuIFlvdSBjYW4gaW5jcmVhc2UgdGhlIGJpdCByYXRlIHRvIGltcHJvdmUgdmlkZW8gcXVhbGl0eSxcbiAqICAgICAgICAgICAgICAgIGJ1dCBkb2luZyBzbyByZXN1bHRzIGluIGxhcmdlciBtb3ZpZSBmaWxlcy5cbiAqIEBwcm9wZXJ0eSB7P2Jvb2xlYW59IGZvcmNlUmVzdGFydCAtIFdoZXRoZXIgdG8gdHJ5IHRvIGNhdGNoIGFuZCB1cGxvYWQvcmV0dXJuIHRoZSBjdXJyZW50bHkgcnVubmluZyBzY3JlZW4gcmVjb3JkaW5nXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAoYGZhbHNlYCwgdGhlIGRlZmF1bHQgc2V0dGluZykgb3IgaWdub3JlIHRoZSByZXN1bHQgb2YgaXQgYW5kIHN0YXJ0IGEgbmV3IHJlY29yZGluZ1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW1tZWRpYXRlbHkgKGB0cnVlYCkuXG4gKi9cblxuLyoqXG4gKiBSZWNvcmQgdGhlIGRpc3BsYXkgb2YgYSByZWFsIGRldmljZXMgcnVubmluZyBBbmRyb2lkIDQuNCAoQVBJIGxldmVsIDE5KSBhbmQgaGlnaGVyLlxuICogRW11bGF0b3JzIGFyZSBzdXBwb3J0ZWQgc2luY2UgQVBJIGxldmVsIDI3IChBbmRyb2lkIFApLlxuICogSXQgcmVjb3JkcyBzY3JlZW4gYWN0aXZpdHkgdG8gYW4gTVBFRy00IGZpbGUuIEF1ZGlvIGlzIG5vdCByZWNvcmRlZCB3aXRoIHRoZSB2aWRlbyBmaWxlLlxuICogSWYgc2NyZWVuIHJlY29yZGluZyBoYXMgYmVlbiBhbHJlYWR5IHN0YXJ0ZWQgdGhlbiB0aGUgY29tbWFuZCB3aWxsIHN0b3AgaXQgZm9yY2VmdWxseSBhbmQgc3RhcnQgYSBuZXcgb25lLlxuICogVGhlIHByZXZpb3VzbHkgcmVjb3JkZWQgdmlkZW8gZmlsZSB3aWxsIGJlIGRlbGV0ZWQuXG4gKlxuICogQHBhcmFtIHs/U3RhcnRSZWNvcmRpbmdPcHRpb25zfSBvcHRpb25zIC0gVGhlIGF2YWlsYWJsZSBvcHRpb25zLlxuICogQHJldHVybnMge3N0cmluZ30gQmFzZTY0LWVuY29kZWQgY29udGVudCBvZiB0aGUgcmVjb3JkZWQgbWVkaWEgZmlsZSBpZlxuICogICAgICAgICAgICAgICAgICAgYW55IHNjcmVlbiByZWNvcmRpbmcgaXMgY3VycmVudGx5IHJ1bm5pbmcgb3IgYW4gZW1wdHkgc3RyaW5nLlxuICogQHRocm93cyB7RXJyb3J9IElmIHNjcmVlbiByZWNvcmRpbmcgaGFzIGZhaWxlZCB0byBzdGFydCBvciBpcyBub3Qgc3VwcG9ydGVkIG9uIHRoZSBkZXZpY2UgdW5kZXIgdGVzdC5cbiAqL1xuY29tbWFuZHMuc3RhcnRSZWNvcmRpbmdTY3JlZW4gPSBhc3luYyBmdW5jdGlvbiAob3B0aW9ucyA9IHt9KSB7XG4gIGF3YWl0IHZlcmlmeVNjcmVlblJlY29yZElzU3VwcG9ydGVkKHRoaXMuYWRiLCB0aGlzLmlzRW11bGF0b3IoKSk7XG5cbiAgbGV0IHJlc3VsdCA9ICcnO1xuICBjb25zdCB7dmlkZW9TaXplLCB0aW1lTGltaXQgPSBERUZBVUxUX1JFQ09SRElOR19USU1FX1NFQywgYnVnUmVwb3J0LCBiaXRSYXRlLCBmb3JjZVJlc3RhcnR9ID0gb3B0aW9ucztcbiAgaWYgKCFmb3JjZVJlc3RhcnQpIHtcbiAgICByZXN1bHQgPSBhd2FpdCB0aGlzLnN0b3BSZWNvcmRpbmdTY3JlZW4ob3B0aW9ucyk7XG4gIH1cblxuICBpZiAoYXdhaXQgdGVybWluYXRlQmFja2dyb3VuZFNjcmVlblJlY29yZGluZyh0aGlzLmFkYiwgdHJ1ZSkpIHtcbiAgICBsb2cud2FybihgVGhlcmUgd2VyZSBzb21lICR7U0NSRUVOUkVDT1JEX0JJTkFSWX0gcHJvY2VzcyBsZWZ0b3ZlcnMgcnVubmluZyBgICtcbiAgICAgIGBpbiB0aGUgYmFja2dyb3VuZC4gTWFrZSBzdXJlIHlvdSBzdG9wIHNjcmVlbiByZWNvcmRpbmcgZWFjaCB0aW1lIGFmdGVyIGl0IGlzIHN0YXJ0ZWQsIGAgK1xuICAgICAgYG90aGVyd2lzZSB0aGUgcmVjb3JkZWQgbWVkaWEgbWlnaHQgcXVpY2tseSBleGNlZWQgYWxsIHRoZSBmcmVlIHNwYWNlIG9uIHRoZSBkZXZpY2UgdW5kZXIgdGVzdC5gKTtcbiAgfVxuXG4gIGlmICghXy5pc0VtcHR5KHRoaXMuX3NjcmVlblJlY29yZGluZ1Byb3BlcnRpZXMpKSB7XG4gICAgZm9yIChjb25zdCByZWNvcmQgb2YgKHRoaXMuX3NjcmVlblJlY29yZGluZ1Byb3BlcnRpZXMucmVjb3JkcyB8fCBbXSkpIHtcbiAgICAgIGF3YWl0IHRoaXMuYWRiLnJpbXJhZihyZWNvcmQpO1xuICAgIH1cbiAgICB0aGlzLl9zY3JlZW5SZWNvcmRpbmdQcm9wZXJ0aWVzID0gbnVsbDtcbiAgfVxuXG4gIGNvbnN0IHRpbWVvdXQgPSBwYXJzZUZsb2F0KHRpbWVMaW1pdCk7XG4gIGlmIChpc05hTih0aW1lb3V0KSB8fCB0aW1lb3V0ID4gTUFYX1RJTUVfU0VDIHx8IHRpbWVvdXQgPD0gMCkge1xuICAgIHRocm93IG5ldyBFcnJvcihgVGhlIHRpbWVMaW1pdCB2YWx1ZSBtdXN0IGJlIGluIHJhbmdlIFsxLCAke01BWF9USU1FX1NFQ31dIHNlY29uZHMuIGAgK1xuICAgICAgYFRoZSB2YWx1ZSBvZiAnJHt0aW1lTGltaXR9JyBoYXMgYmVlbiBwYXNzZWQgaW5zdGVhZC5gKTtcbiAgfVxuXG4gIHRoaXMuX3NjcmVlblJlY29yZGluZ1Byb3BlcnRpZXMgPSB7XG4gICAgc3RhcnRUaW1lc3RhbXA6IHByb2Nlc3MuaHJ0aW1lKCksXG4gICAgdmlkZW9TaXplLFxuICAgIHRpbWVMaW1pdCxcbiAgICBjdXJyZW50VGltZUxpbWl0OiB0aW1lTGltaXQsXG4gICAgYml0UmF0ZSxcbiAgICBidWdSZXBvcnQsXG4gICAgcmVjb3JkczogW10sXG4gICAgcmVjb3JkaW5nUHJvY2VzczogbnVsbCxcbiAgICBzdG9wcGVkOiBmYWxzZSxcbiAgfTtcbiAgYXdhaXQgc2NoZWR1bGVTY3JlZW5SZWNvcmQodGhpcy5hZGIsIHRoaXMuX3NjcmVlblJlY29yZGluZ1Byb3BlcnRpZXMpO1xuICByZXR1cm4gcmVzdWx0O1xufTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBTdG9wUmVjb3JkaW5nT3B0aW9uc1xuICpcbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gcmVtb3RlUGF0aCAtIFRoZSBwYXRoIHRvIHRoZSByZW1vdGUgbG9jYXRpb24sIHdoZXJlIHRoZSByZXN1bHRpbmcgdmlkZW8gc2hvdWxkIGJlIHVwbG9hZGVkLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIGZvbGxvd2luZyBwcm90b2NvbHMgYXJlIHN1cHBvcnRlZDogaHR0cC9odHRwcywgZnRwLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTnVsbCBvciBlbXB0eSBzdHJpbmcgdmFsdWUgKHRoZSBkZWZhdWx0IHNldHRpbmcpIG1lYW5zIHRoZSBjb250ZW50IG9mIHJlc3VsdGluZ1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmlsZSBzaG91bGQgYmUgZW5jb2RlZCBhcyBCYXNlNjQgYW5kIHBhc3NlZCBhcyB0aGUgZW5kcG91bnQgcmVzcG9uc2UgdmFsdWUuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBBbiBleGNlcHRpb24gd2lsbCBiZSB0aHJvd24gaWYgdGhlIGdlbmVyYXRlZCBtZWRpYSBmaWxlIGlzIHRvbyBiaWcgdG9cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZpdCBpbnRvIHRoZSBhdmFpbGFibGUgcHJvY2VzcyBtZW1vcnkuXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHVzZXIgLSBUaGUgbmFtZSBvZiB0aGUgdXNlciBmb3IgdGhlIHJlbW90ZSBhdXRoZW50aWNhdGlvbi5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gcGFzcyAtIFRoZSBwYXNzd29yZCBmb3IgdGhlIHJlbW90ZSBhdXRoZW50aWNhdGlvbi5cbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gbWV0aG9kIC0gVGhlIGh0dHAgbXVsdGlwYXJ0IHVwbG9hZCBtZXRob2QgbmFtZS4gVGhlICdQVVQnIG9uZSBpcyB1c2VkIGJ5IGRlZmF1bHQuXG4gKi9cblxuLyoqXG4gKiBTdG9wIHJlY29yZGluZyB0aGUgc2NyZWVuLlxuICogSWYgbm8gc2NyZWVuIHJlY29yZGluZyBoYXMgYmVlbiBzdGFydGVkIGJlZm9yZSB0aGVuIHRoZSBtZXRob2QgcmV0dXJucyBhbiBlbXB0eSBzdHJpbmcuXG4gKlxuICogQHBhcmFtIHs/U3RvcFJlY29yZGluZ09wdGlvbnN9IG9wdGlvbnMgLSBUaGUgYXZhaWxhYmxlIG9wdGlvbnMuXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBCYXNlNjQtZW5jb2RlZCBjb250ZW50IG9mIHRoZSByZWNvcmRlZCBtZWRpYSBmaWxlIGlmICdyZW1vdGVQYXRoJ1xuICogICAgICAgICAgICAgICAgICAgcGFyYW1ldGVyIGlzIGZhbHN5IG9yIGFuIGVtcHR5IHN0cmluZy5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGVyZSB3YXMgYW4gZXJyb3Igd2hpbGUgZ2V0dGluZyB0aGUgbmFtZSBvZiBhIG1lZGlhIGZpbGVcbiAqICAgICAgICAgICAgICAgICBvciB0aGUgZmlsZSBjb250ZW50IGNhbm5vdCBiZSB1cGxvYWRlZCB0byB0aGUgcmVtb3RlIGxvY2F0aW9uXG4gKiAgICAgICAgICAgICAgICAgb3Igc2NyZWVuIHJlY29yZGluZyBpcyBub3Qgc3VwcG9ydGVkIG9uIHRoZSBkZXZpY2UgdW5kZXIgdGVzdC5cbiAqL1xuY29tbWFuZHMuc3RvcFJlY29yZGluZ1NjcmVlbiA9IGFzeW5jIGZ1bmN0aW9uIChvcHRpb25zID0ge30pIHtcbiAgYXdhaXQgdmVyaWZ5U2NyZWVuUmVjb3JkSXNTdXBwb3J0ZWQodGhpcy5hZGIsIHRoaXMuaXNFbXVsYXRvcigpKTtcblxuICBpZiAoIV8uaXNFbXB0eSh0aGlzLl9zY3JlZW5SZWNvcmRpbmdQcm9wZXJ0aWVzKSkge1xuICAgIHRoaXMuX3NjcmVlblJlY29yZGluZ1Byb3BlcnRpZXMuc3RvcHBlZCA9IHRydWU7XG4gIH1cblxuICB0cnkge1xuICAgIGF3YWl0IHRlcm1pbmF0ZUJhY2tncm91bmRTY3JlZW5SZWNvcmRpbmcodGhpcy5hZGIsIGZhbHNlKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLndhcm4oZXJyLm1lc3NhZ2UpO1xuICAgIGlmICghXy5pc0VtcHR5KHRoaXMuX3NjcmVlblJlY29yZGluZ1Byb3BlcnRpZXMpKSB7XG4gICAgICBsb2cud2FybignVGhlIHJlc3VsdGluZyB2aWRlbyBtaWdodCBiZSBjb3JydXB0ZWQnKTtcbiAgICB9XG4gIH1cblxuICBpZiAoXy5pc0VtcHR5KHRoaXMuX3NjcmVlblJlY29yZGluZ1Byb3BlcnRpZXMpKSB7XG4gICAgbG9nLmluZm8oYFNjcmVlbiByZWNvcmRpbmcgaGFzIG5vdCBiZWVuIHByZXZpb3VzbHkgc3RhcnRlZCBieSBBcHBpdW0uIFRoZXJlIGlzIG5vdGhpbmcgdG8gc3RvcGApO1xuICAgIHJldHVybiAnJztcbiAgfVxuXG4gIGlmICh0aGlzLl9zY3JlZW5SZWNvcmRpbmdQcm9wZXJ0aWVzLnJlY29yZGluZ1Byb2Nlc3MgJiYgdGhpcy5fc2NyZWVuUmVjb3JkaW5nUHJvcGVydGllcy5yZWNvcmRpbmdQcm9jZXNzLmlzUnVubmluZykge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLl9zY3JlZW5SZWNvcmRpbmdQcm9wZXJ0aWVzLnJlY29yZGluZ1Byb2Nlc3Muc3RvcCgnU0lHSU5UJywgUFJPQ0VTU19TSFVURE9XTl9USU1FT1VUKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhgVW5hYmxlIHRvIHN0b3Agc2NyZWVuIHJlY29yZGluZyB3aXRoaW4gJHtQUk9DRVNTX1NIVVRET1dOX1RJTUVPVVR9bXNgKTtcbiAgICB9XG4gICAgdGhpcy5fc2NyZWVuUmVjb3JkaW5nUHJvcGVydGllcy5yZWNvcmRpbmdQcm9jZXNzID0gbnVsbDtcbiAgfVxuXG4gIGlmIChfLmlzRW1wdHkodGhpcy5fc2NyZWVuUmVjb3JkaW5nUHJvcGVydGllcy5yZWNvcmRzKSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBObyBzY3JlZW4gcmVjb3JkaW5ncyBoYXZlIGJlZW4gc3RvcmVkIG9uIHRoZSBkZXZpY2Ugc28gZmFyLiBgICtcbiAgICAgIGBBcmUgeW91IHN1cmUgdGhlICR7U0NSRUVOUkVDT1JEX0JJTkFSWX0gdXRpbGl0eSB3b3JrcyBhcyBleHBlY3RlZD9gKTtcbiAgfVxuXG4gIGNvbnN0IHRtcFJvb3QgPSBhd2FpdCB0ZW1wRGlyLm9wZW5EaXIoKTtcbiAgdHJ5IHtcbiAgICBjb25zdCBsb2NhbFJlY29yZHMgPSBbXTtcbiAgICBmb3IgKGNvbnN0IHBhdGhPbkRldmljZSBvZiB0aGlzLl9zY3JlZW5SZWNvcmRpbmdQcm9wZXJ0aWVzLnJlY29yZHMpIHtcbiAgICAgIGxvY2FsUmVjb3Jkcy5wdXNoKHBhdGgucmVzb2x2ZSh0bXBSb290LCBwYXRoLnBvc2l4LmJhc2VuYW1lKHBhdGhPbkRldmljZSkpKTtcbiAgICAgIGF3YWl0IHRoaXMuYWRiLnB1bGwocGF0aE9uRGV2aWNlLCBfLmxhc3QobG9jYWxSZWNvcmRzKSk7XG4gICAgICBhd2FpdCB0aGlzLmFkYi5yaW1yYWYocGF0aE9uRGV2aWNlKTtcbiAgICB9XG4gICAgbGV0IHJlc3VsdEZpbGVQYXRoID0gXy5sYXN0KGxvY2FsUmVjb3Jkcyk7XG4gICAgaWYgKGxvY2FsUmVjb3Jkcy5sZW5ndGggPiAxKSB7XG4gICAgICBsb2cuaW5mbyhgR290ICR7bG9jYWxSZWNvcmRzLmxlbmd0aH0gc2NyZWVuIHJlY29yZGluZ3MuIFRyeWluZyB0byBtZXJnZSB0aGVtYCk7XG4gICAgICB0cnkge1xuICAgICAgICByZXN1bHRGaWxlUGF0aCA9IGF3YWl0IG1lcmdlU2NyZWVuUmVjb3Jkcyhsb2NhbFJlY29yZHMpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBsb2cud2FybihgQ2Fubm90IG1lcmdlIHRoZSByZWNvcmRlZCBmaWxlcy4gVGhlIG1vc3QgcmVjZW50IHNjcmVlbiByZWNvcmRpbmcgaXMgZ29pbmcgdG8gYmUgcmV0dXJuZWQgYXMgdGhlIHJlc3VsdC4gYCArXG4gICAgICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3Qge3JlbW90ZVBhdGgsIHVzZXIsIHBhc3MsIG1ldGhvZH0gPSBvcHRpb25zO1xuICAgIHJldHVybiBhd2FpdCB1cGxvYWRSZWNvcmRlZE1lZGlhKHRoaXMuYWRiLCByZXN1bHRGaWxlUGF0aCwgcmVtb3RlUGF0aCwge3VzZXIsIHBhc3MsIG1ldGhvZH0pO1xuICB9IGZpbmFsbHkge1xuICAgIGF3YWl0IGZzLnJpbXJhZih0bXBSb290KTtcbiAgICB0aGlzLl9zY3JlZW5SZWNvcmRpbmdQcm9wZXJ0aWVzID0gbnVsbDtcbiAgfVxufTtcblxuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzKTtcbmV4cG9ydCB7IGNvbW1hbmRzIH07XG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sImZpbGUiOiJsaWIvY29tbWFuZHMvcmVjb3Jkc2NyZWVuLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
