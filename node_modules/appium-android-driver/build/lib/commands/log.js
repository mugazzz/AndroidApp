"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.helpers = exports.commands = void 0;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _logger = _interopRequireDefault(require("../logger"));

var _os = _interopRequireDefault(require("os"));

var _lodash = _interopRequireDefault(require("lodash"));

var _ws = _interopRequireDefault(require("ws"));

var _appiumBaseDriver = require("appium-base-driver");

let commands = {},
    helpers = {},
    extensions = {};
exports.helpers = helpers;
exports.commands = commands;

const WEBSOCKET_ENDPOINT = sessionId => `${_appiumBaseDriver.DEFAULT_WS_PATHNAME_PREFIX}/session/${sessionId}/appium/device/logcat`;

function toLogRecord(timestamp, level, message) {
  return {
    timestamp,
    level,
    message
  };
}

extensions.supportedLogTypes = {
  logcat: {
    description: 'Logs for Android applications on real device and emulators via ADB',
    getter: function () {
      var _getter = (0, _asyncToGenerator2.default)(function* (self) {
        return yield self.adb.getLogcatLogs();
      });

      return function getter(_x) {
        return _getter.apply(this, arguments);
      };
    }()
  },
  bugreport: {
    description: `'adb bugreport' output for advanced issues diagnostic`,
    getter: function () {
      var _getter2 = (0, _asyncToGenerator2.default)(function* (self) {
        const output = yield self.adb.bugreport();
        const timestamp = Date.now();
        return output.split(_os.default.EOL).map(x => toLogRecord(timestamp, 'ALL', x));
      });

      return function getter(_x2) {
        return _getter2.apply(this, arguments);
      };
    }()
  },
  server: {
    description: 'Appium server logs',
    getter: self => {
      if (!self.relaxedSecurityEnabled) {
        throw new Error('Appium server must have relaxed security flag set ' + 'in order to be able to get server logs');
      }

      const timestamp = Date.now();
      return _logger.default.unwrap().record.map(x => toLogRecord(timestamp, 'ALL', _lodash.default.isEmpty(x.prefix) ? x.message : `[${x.prefix}] ${x.message}`));
    }
  }
};
commands.mobileStartLogsBroadcast = (0, _asyncToGenerator2.default)(function* () {
  const pathname = WEBSOCKET_ENDPOINT(this.sessionId);

  if (!_lodash.default.isEmpty((yield this.server.getWebSocketHandlers(pathname)))) {
    _logger.default.debug(`The logcat broadcasting web socket server is already listening at ${pathname}`);

    return;
  }

  _logger.default.info(`Assigning logcat broadcasting web socket server to ${pathname}`);

  const wss = new _ws.default.Server({
    noServer: true
  });
  wss.on('connection', (ws, req) => {
    if (req) {
      const remoteIp = _lodash.default.isEmpty(req.headers['x-forwarded-for']) ? req.connection.remoteAddress : req.headers['x-forwarded-for'];

      _logger.default.debug(`Established a new logcat listener web socket connection from ${remoteIp}`);
    } else {
      _logger.default.debug('Established a new logcat listener web socket connection');
    }

    if (_lodash.default.isEmpty(this._logcatWebsocketListener)) {
      this._logcatWebsocketListener = logRecord => {
        if (ws && ws.readyState === _ws.default.OPEN) {
          ws.send(logRecord.message);
        }
      };
    }

    this.adb.setLogcatListener(this._logcatWebsocketListener);
    ws.on('close', (code, reason) => {
      if (!_lodash.default.isEmpty(this._logcatWebsocketListener)) {
        try {
          this.adb.removeLogcatListener(this._logcatWebsocketListener);
        } catch (ign) {}

        this._logcatWebsocketListener = null;
      }

      let closeMsg = 'Logcat listener web socket is closed.';

      if (!_lodash.default.isEmpty(code)) {
        closeMsg += ` Code: ${code}.`;
      }

      if (!_lodash.default.isEmpty(reason)) {
        closeMsg += ` Reason: ${reason}.`;
      }

      _logger.default.debug(closeMsg);
    });
  });
  yield this.server.addWebSocketHandler(pathname, wss);
});
commands.mobileStopLogsBroadcast = (0, _asyncToGenerator2.default)(function* () {
  const pathname = WEBSOCKET_ENDPOINT(this.sessionId);

  if (_lodash.default.isEmpty((yield this.server.getWebSocketHandlers(pathname)))) {
    return;
  }

  _logger.default.debug('Stopping the logcat broadcasting web socket server');

  yield this.server.removeWebSocketHandler(pathname);
});
Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9sb2cuanMiXSwibmFtZXMiOlsiY29tbWFuZHMiLCJoZWxwZXJzIiwiZXh0ZW5zaW9ucyIsIldFQlNPQ0tFVF9FTkRQT0lOVCIsInNlc3Npb25JZCIsIkRFRkFVTFRfV1NfUEFUSE5BTUVfUFJFRklYIiwidG9Mb2dSZWNvcmQiLCJ0aW1lc3RhbXAiLCJsZXZlbCIsIm1lc3NhZ2UiLCJzdXBwb3J0ZWRMb2dUeXBlcyIsImxvZ2NhdCIsImRlc2NyaXB0aW9uIiwiZ2V0dGVyIiwic2VsZiIsImFkYiIsImdldExvZ2NhdExvZ3MiLCJidWdyZXBvcnQiLCJvdXRwdXQiLCJEYXRlIiwibm93Iiwic3BsaXQiLCJvcyIsIkVPTCIsIm1hcCIsIngiLCJzZXJ2ZXIiLCJyZWxheGVkU2VjdXJpdHlFbmFibGVkIiwiRXJyb3IiLCJsb2ciLCJ1bndyYXAiLCJyZWNvcmQiLCJfIiwiaXNFbXB0eSIsInByZWZpeCIsIm1vYmlsZVN0YXJ0TG9nc0Jyb2FkY2FzdCIsInBhdGhuYW1lIiwiZ2V0V2ViU29ja2V0SGFuZGxlcnMiLCJkZWJ1ZyIsImluZm8iLCJ3c3MiLCJXZWJTb2NrZXQiLCJTZXJ2ZXIiLCJub1NlcnZlciIsIm9uIiwid3MiLCJyZXEiLCJyZW1vdGVJcCIsImhlYWRlcnMiLCJjb25uZWN0aW9uIiwicmVtb3RlQWRkcmVzcyIsIl9sb2djYXRXZWJzb2NrZXRMaXN0ZW5lciIsImxvZ1JlY29yZCIsInJlYWR5U3RhdGUiLCJPUEVOIiwic2VuZCIsInNldExvZ2NhdExpc3RlbmVyIiwiY29kZSIsInJlYXNvbiIsInJlbW92ZUxvZ2NhdExpc3RlbmVyIiwiaWduIiwiY2xvc2VNc2ciLCJhZGRXZWJTb2NrZXRIYW5kbGVyIiwibW9iaWxlU3RvcExvZ3NCcm9hZGNhc3QiLCJyZW1vdmVXZWJTb2NrZXRIYW5kbGVyIiwiT2JqZWN0IiwiYXNzaWduIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVB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LENBQVV5QixNQUFWLENBQUwsRUFBd0I7QUFDdEJHLFFBQUFBLFFBQVEsSUFBSyxZQUFXSCxNQUFPLEdBQS9CO0FBQ0Q7O0FBQ0Q3QixzQkFBSVMsS0FBSixDQUFVdUIsUUFBVjtBQUNELEtBaEJEO0FBaUJELEdBcENEO0FBcUNBLFFBQU0sS0FBS25DLE1BQUwsQ0FBWW9DLG1CQUFaLENBQWdDMUIsUUFBaEMsRUFBMENJLEdBQTFDLENBQU47QUFDRCxDQWxERDtBQXdEQXhDLFFBQVEsQ0FBQytELHVCQUFULG1DQUFtQyxhQUFrQjtBQUNuRCxRQUFNM0IsUUFBUSxHQUFHakMsa0JBQWtCLENBQUMsS0FBS0MsU0FBTixDQUFuQzs7QUFDQSxNQUFJNEIsZ0JBQUVDLE9BQUYsUUFBZ0IsS0FBS1AsTUFBTCxDQUFZVyxvQkFBWixDQUFpQ0QsUUFBakMsQ0FBaEIsRUFBSixFQUFpRTtBQUMvRDtBQUNEOztBQUVEUCxrQkFBSVMsS0FBSixDQUFVLG9EQUFWOztBQUNBLFFBQU0sS0FBS1osTUFBTCxDQUFZc0Msc0JBQVosQ0FBbUM1QixRQUFuQyxDQUFOO0FBQ0QsQ0FSRDtBQVVBNkIsTUFBTSxDQUFDQyxNQUFQLENBQWNoRSxVQUFkLEVBQTBCRixRQUExQixFQUFvQ0MsT0FBcEM7ZUFFZUMsVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCBvcyBmcm9tICdvcyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IFdlYlNvY2tldCBmcm9tICd3cyc7XG5pbXBvcnQgeyBERUZBVUxUX1dTX1BBVEhOQU1FX1BSRUZJWCB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5cbmxldCBjb21tYW5kcyA9IHt9LCBoZWxwZXJzID0ge30sIGV4dGVuc2lvbnMgPSB7fTtcblxuY29uc3QgV0VCU09DS0VUX0VORFBPSU5UID0gKHNlc3Npb25JZCkgPT4gYCR7REVGQVVMVF9XU19QQVRITkFNRV9QUkVGSVh9L3Nlc3Npb24vJHtzZXNzaW9uSWR9L2FwcGl1bS9kZXZpY2UvbG9nY2F0YDtcblxuLy8gaHR0cHM6Ly9naXRodWIuY29tL1NlbGVuaXVtSFEvc2VsZW5pdW0vYmxvYi8wZDQyNTY3NmIzYzlkZjI2MWRkNjQxOTE3Zjg2N2Q0ZDVjZTc3NzRkL2phdmEvY2xpZW50L3NyYy9vcmcvb3BlbnFhL3NlbGVuaXVtL2xvZ2dpbmcvTG9nRW50cnkuamF2YVxuZnVuY3Rpb24gdG9Mb2dSZWNvcmQgKHRpbWVzdGFtcCwgbGV2ZWwsIG1lc3NhZ2UpIHtcbiAgcmV0dXJuIHtcbiAgICB0aW1lc3RhbXAsXG4gICAgbGV2ZWwsXG4gICAgbWVzc2FnZSxcbiAgfTtcbn1cblxuZXh0ZW5zaW9ucy5zdXBwb3J0ZWRMb2dUeXBlcyA9IHtcbiAgbG9nY2F0OiB7XG4gICAgZGVzY3JpcHRpb246ICdMb2dzIGZvciBBbmRyb2lkIGFwcGxpY2F0aW9ucyBvbiByZWFsIGRldmljZSBhbmQgZW11bGF0b3JzIHZpYSBBREInLFxuICAgIGdldHRlcjogYXN5bmMgKHNlbGYpID0+IGF3YWl0IHNlbGYuYWRiLmdldExvZ2NhdExvZ3MoKSxcbiAgfSxcbiAgYnVncmVwb3J0OiB7XG4gICAgZGVzY3JpcHRpb246IGAnYWRiIGJ1Z3JlcG9ydCcgb3V0cHV0IGZvciBhZHZhbmNlZCBpc3N1ZXMgZGlhZ25vc3RpY2AsXG4gICAgZ2V0dGVyOiBhc3luYyAoc2VsZikgPT4ge1xuICAgICAgY29uc3Qgb3V0cHV0ID0gYXdhaXQgc2VsZi5hZGIuYnVncmVwb3J0KCk7XG4gICAgICBjb25zdCB0aW1lc3RhbXAgPSBEYXRlLm5vdygpO1xuICAgICAgcmV0dXJuIG91dHB1dC5zcGxpdChvcy5FT0wpXG4gICAgICAgIC5tYXAoKHgpID0+IHRvTG9nUmVjb3JkKHRpbWVzdGFtcCwgJ0FMTCcsIHgpKTtcbiAgICB9LFxuICB9LFxuICBzZXJ2ZXI6IHtcbiAgICBkZXNjcmlwdGlvbjogJ0FwcGl1bSBzZXJ2ZXIgbG9ncycsXG4gICAgZ2V0dGVyOiAoc2VsZikgPT4ge1xuICAgICAgaWYgKCFzZWxmLnJlbGF4ZWRTZWN1cml0eUVuYWJsZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBcHBpdW0gc2VydmVyIG11c3QgaGF2ZSByZWxheGVkIHNlY3VyaXR5IGZsYWcgc2V0ICcgK1xuICAgICAgICAgICAgICAgICAgICAgICAgJ2luIG9yZGVyIHRvIGJlIGFibGUgdG8gZ2V0IHNlcnZlciBsb2dzJyk7XG4gICAgICB9XG4gICAgICBjb25zdCB0aW1lc3RhbXAgPSBEYXRlLm5vdygpO1xuICAgICAgcmV0dXJuIGxvZy51bndyYXAoKS5yZWNvcmRcbiAgICAgICAgLm1hcCgoeCkgPT4gdG9Mb2dSZWNvcmQodGltZXN0YW1wLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnQUxMJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXy5pc0VtcHR5KHgucHJlZml4KSA/IHgubWVzc2FnZSA6IGBbJHt4LnByZWZpeH1dICR7eC5tZXNzYWdlfWApXG4gICAgICAgICk7XG4gICAgfSxcbiAgfSxcbn07XG5cbi8qKlxuICogU3RhcnRzIEFuZHJvaWQgbG9nY2F0IGJyb2FkY2FzdCB3ZWJzb2NrZXQgb24gdGhlIHNhbWUgaG9zdCBhbmQgcG9ydFxuICogd2hlcmUgQXBwaXVtIHNlcnZlciBpcyBydW5uaW5nIGF0IGAvd3Mvc2Vzc2lvbi86c2Vzc2lvbklkOi9hcHBpdW0vbG9nY2F0YCBlbmRwb2ludC4gVGhlIG1ldGhvZFxuICogd2lsbCByZXR1cm4gaW1tZWRpYXRlbHkgaWYgdGhlIHdlYiBzb2NrZXQgaXMgYWxyZWFkeSBsaXN0ZW5pbmcuXG4gKlxuICogRWFjaCBjb25uZWN0ZWQgd2ViY29rZXQgbGlzdGVuZXIgd2lsbCByZWNlaXZlIGxvZ2NhdCBsb2cgbGluZXNcbiAqIGFzIHNvb24gYXMgdGhleSBhcmUgdmlzaWJsZSB0byBBcHBpdW0uXG4gKi9cbmNvbW1hbmRzLm1vYmlsZVN0YXJ0TG9nc0Jyb2FkY2FzdCA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgY29uc3QgcGF0aG5hbWUgPSBXRUJTT0NLRVRfRU5EUE9JTlQodGhpcy5zZXNzaW9uSWQpO1xuICBpZiAoIV8uaXNFbXB0eShhd2FpdCB0aGlzLnNlcnZlci5nZXRXZWJTb2NrZXRIYW5kbGVycyhwYXRobmFtZSkpKSB7XG4gICAgbG9nLmRlYnVnKGBUaGUgbG9nY2F0IGJyb2FkY2FzdGluZyB3ZWIgc29ja2V0IHNlcnZlciBpcyBhbHJlYWR5IGxpc3RlbmluZyBhdCAke3BhdGhuYW1lfWApO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGxvZy5pbmZvKGBBc3NpZ25pbmcgbG9nY2F0IGJyb2FkY2FzdGluZyB3ZWIgc29ja2V0IHNlcnZlciB0byAke3BhdGhuYW1lfWApO1xuICAvLyBodHRwczovL2dpdGh1Yi5jb20vd2Vic29ja2V0cy93cy9ibG9iL21hc3Rlci9kb2Mvd3MubWRcbiAgY29uc3Qgd3NzID0gbmV3IFdlYlNvY2tldC5TZXJ2ZXIoe1xuICAgIG5vU2VydmVyOiB0cnVlLFxuICB9KTtcbiAgd3NzLm9uKCdjb25uZWN0aW9uJywgKHdzLCByZXEpID0+IHtcbiAgICBpZiAocmVxKSB7XG4gICAgICBjb25zdCByZW1vdGVJcCA9IF8uaXNFbXB0eShyZXEuaGVhZGVyc1sneC1mb3J3YXJkZWQtZm9yJ10pXG4gICAgICAgID8gcmVxLmNvbm5lY3Rpb24ucmVtb3RlQWRkcmVzc1xuICAgICAgICA6IHJlcS5oZWFkZXJzWyd4LWZvcndhcmRlZC1mb3InXTtcbiAgICAgIGxvZy5kZWJ1ZyhgRXN0YWJsaXNoZWQgYSBuZXcgbG9nY2F0IGxpc3RlbmVyIHdlYiBzb2NrZXQgY29ubmVjdGlvbiBmcm9tICR7cmVtb3RlSXB9YCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5kZWJ1ZygnRXN0YWJsaXNoZWQgYSBuZXcgbG9nY2F0IGxpc3RlbmVyIHdlYiBzb2NrZXQgY29ubmVjdGlvbicpO1xuICAgIH1cblxuICAgIGlmIChfLmlzRW1wdHkodGhpcy5fbG9nY2F0V2Vic29ja2V0TGlzdGVuZXIpKSB7XG4gICAgICB0aGlzLl9sb2djYXRXZWJzb2NrZXRMaXN0ZW5lciA9IChsb2dSZWNvcmQpID0+IHtcbiAgICAgICAgaWYgKHdzICYmIHdzLnJlYWR5U3RhdGUgPT09IFdlYlNvY2tldC5PUEVOKSB7XG4gICAgICAgICAgd3Muc2VuZChsb2dSZWNvcmQubWVzc2FnZSk7XG4gICAgICAgIH1cbiAgICAgIH07XG4gICAgfVxuICAgIHRoaXMuYWRiLnNldExvZ2NhdExpc3RlbmVyKHRoaXMuX2xvZ2NhdFdlYnNvY2tldExpc3RlbmVyKTtcblxuICAgIHdzLm9uKCdjbG9zZScsIChjb2RlLCByZWFzb24pID0+IHtcbiAgICAgIGlmICghXy5pc0VtcHR5KHRoaXMuX2xvZ2NhdFdlYnNvY2tldExpc3RlbmVyKSkge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIHRoaXMuYWRiLnJlbW92ZUxvZ2NhdExpc3RlbmVyKHRoaXMuX2xvZ2NhdFdlYnNvY2tldExpc3RlbmVyKTtcbiAgICAgICAgfSBjYXRjaCAoaWduKSB7fVxuICAgICAgICB0aGlzLl9sb2djYXRXZWJzb2NrZXRMaXN0ZW5lciA9IG51bGw7XG4gICAgICB9XG5cbiAgICAgIGxldCBjbG9zZU1zZyA9ICdMb2djYXQgbGlzdGVuZXIgd2ViIHNvY2tldCBpcyBjbG9zZWQuJztcbiAgICAgIGlmICghXy5pc0VtcHR5KGNvZGUpKSB7XG4gICAgICAgIGNsb3NlTXNnICs9IGAgQ29kZTogJHtjb2RlfS5gO1xuICAgICAgfVxuICAgICAgaWYgKCFfLmlzRW1wdHkocmVhc29uKSkge1xuICAgICAgICBjbG9zZU1zZyArPSBgIFJlYXNvbjogJHtyZWFzb259LmA7XG4gICAgICB9XG4gICAgICBsb2cuZGVidWcoY2xvc2VNc2cpO1xuICAgIH0pO1xuICB9KTtcbiAgYXdhaXQgdGhpcy5zZXJ2ZXIuYWRkV2ViU29ja2V0SGFuZGxlcihwYXRobmFtZSwgd3NzKTtcbn07XG5cbi8qKlxuICogU3RvcHMgdGhlIHByZXZpb3VzbHkgc3RhcnRlZCBsb2djYXQgYnJvYWRjYXN0aW5nIHdlc29ja2V0IHNlcnZlci5cbiAqIFRoaXMgbWV0aG9kIHdpbGwgcmV0dXJuIGltbWVkaWF0ZWx5IGlmIG5vIHNlcnZlciBpcyBydW5uaW5nLlxuICovXG5jb21tYW5kcy5tb2JpbGVTdG9wTG9nc0Jyb2FkY2FzdCA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgY29uc3QgcGF0aG5hbWUgPSBXRUJTT0NLRVRfRU5EUE9JTlQodGhpcy5zZXNzaW9uSWQpO1xuICBpZiAoXy5pc0VtcHR5KGF3YWl0IHRoaXMuc2VydmVyLmdldFdlYlNvY2tldEhhbmRsZXJzKHBhdGhuYW1lKSkpIHtcbiAgICByZXR1cm47XG4gIH1cblxuICBsb2cuZGVidWcoJ1N0b3BwaW5nIHRoZSBsb2djYXQgYnJvYWRjYXN0aW5nIHdlYiBzb2NrZXQgc2VydmVyJyk7XG4gIGF3YWl0IHRoaXMuc2VydmVyLnJlbW92ZVdlYlNvY2tldEhhbmRsZXIocGF0aG5hbWUpO1xufTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5leHBvcnQgeyBjb21tYW5kcywgaGVscGVycyB9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9uczsiXSwiZmlsZSI6ImxpYi9jb21tYW5kcy9sb2cuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
