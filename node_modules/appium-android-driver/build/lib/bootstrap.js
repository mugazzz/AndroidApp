"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.COMMAND_TYPES = exports.AndroidBootstrap = void 0;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _uiautomator = _interopRequireDefault(require("./uiautomator"));

var _net = _interopRequireDefault(require("net"));

var _path = _interopRequireDefault(require("path"));

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumBaseDriver = require("appium-base-driver");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _appiumSupport = require("appium-support");

const log = _appiumSupport.logger.getLogger('AndroidBootstrap');

const COMMAND_TYPES = {
  ACTION: 'action',
  SHUTDOWN: 'shutdown'
};
exports.COMMAND_TYPES = COMMAND_TYPES;
const SEND_COMMAND_TIMEOUT = 1 * 60 * 1000;

class AndroidBootstrap {
  constructor(adb, systemPort = 4724, webSocket = undefined) {
    this.adb = adb;
    this.systemPort = systemPort;
    this.webSocket = webSocket;
    this.ignoreUnexpectedShutdown = false;
  }

  get onUnexpectedShutdown() {
    if (!this._onUnexpectedShutdownPromise) {
      let reject;
      this._onUnexpectedShutdownPromise = new _bluebird.default(function (_resolve, _reject) {
        reject = _reject;
      });
      this._onUnexpectedShutdownPromise.cancel = reject;
    }

    return this._onUnexpectedShutdownPromise;
  }

  start(appPackage, disableAndroidWatchers = false, acceptSslCerts = false) {
    var _this = this;

    return (0, _asyncToGenerator2.default)(function* () {
      try {
        const rootDir = _path.default.resolve(__dirname, '..', '..');

        const startDetector = s => {
          return /Appium Socket Server Ready/.test(s);
        };

        const bootstrapJar = _path.default.resolve(rootDir, 'bootstrap', 'bin', 'AppiumBootstrap.jar');

        yield _this.init();
        yield _this.adb.forwardPort(_this.systemPort, 4724);
        _this.process = yield _this.uiAutomator.start(bootstrapJar, 'io.appium.android.bootstrap.Bootstrap', startDetector, '-e', 'pkg', appPackage, '-e', 'disableAndroidWatchers', disableAndroidWatchers, '-e', 'acceptSslCerts', acceptSslCerts);

        _this.process.on('output', (stdout, stderr) => {
          const alertRe = /Emitting system alert message/;

          if (alertRe.test(stdout)) {
            log.debug('Emitting alert message...');

            if (_this.webSocket) {
              _this.webSocket.sockets.emit('alert', {
                message: stdout
              });
            }
          }

          let stdoutLines = (stdout || '').split('\n');
          const uiautoLog = /\[APPIUM-UIAUTO\](.+)\[\/APPIUM-UIAUTO\]/;
          var _iteratorNormalCompletion = true;
          var _didIteratorError = false;
          var _iteratorError = undefined;

          try {
            for (var _iterator = stdoutLines[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
              let line = _step.value;

              if (line.trim()) {
                if (uiautoLog.test(line)) {
                  let innerLine = uiautoLog.exec(line)[1].trim();
                  let logMethod = log.info.bind(log);

                  if (/\[debug\]/.test(innerLine)) {
                    logMethod = log.debug.bind(log);
                  }

                  logMethod(`[BOOTSTRAP LOG] ${innerLine}`);
                } else {
                  log.debug(`[UIAUTO STDOUT] ${line}`);
                }
              }
            }
          } catch (err) {
            _didIteratorError = true;
            _iteratorError = err;
          } finally {
            try {
              if (!_iteratorNormalCompletion && _iterator.return != null) {
                _iterator.return();
              }
            } finally {
              if (_didIteratorError) {
                throw _iteratorError;
              }
            }
          }

          let stderrLines = (stderr || '').split('\n');
          var _iteratorNormalCompletion2 = true;
          var _didIteratorError2 = false;
          var _iteratorError2 = undefined;

          try {
            for (var _iterator2 = stderrLines[Symbol.iterator](), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
              let line = _step2.value;

              if (line.trim()) {
                log.debug(`[UIAUTO STDERR] ${line}`);
              }
            }
          } catch (err) {
            _didIteratorError2 = true;
            _iteratorError2 = err;
          } finally {
            try {
              if (!_iteratorNormalCompletion2 && _iterator2.return != null) {
                _iterator2.return();
              }
            } finally {
              if (_didIteratorError2) {
                throw _iteratorError2;
              }
            }
          }
        });

        return yield new _bluebird.default((resolve, reject) => {
          try {
            _this.socketClient = _net.default.connect(_this.systemPort);

            _this.socketClient.on('error', err => {
              if (!_this.ignoreUnexpectedShutdown) {
                throw new Error(`Android bootstrap socket crashed: ${err}`);
              }
            });

            _this.socketClient.once('connect', () => {
              log.info("Android bootstrap socket is now connected");
              resolve();
            });
          } catch (err) {
            reject(err);
          }
        });
      } catch (err) {
        log.errorAndThrow(`Error occured while starting AndroidBootstrap. Original error: ${err}`);
      }
    })();
  }

  sendCommand(type, extra = {}) {
    var _this2 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      if (!_this2.socketClient) {
        throw new Error('Socket connection closed unexpectedly');
      }

      return yield new _bluebird.default((resolve, reject) => {
        let cmd = Object.assign({
          cmd: type
        }, extra);
        let cmdJson = `${JSON.stringify(cmd)} \n`;
        log.debug(`Sending command to android: ${_lodash.default.truncate(cmdJson, {
          length: 1000
        }).trim()}`);

        _this2.socketClient.write(cmdJson);

        _this2.socketClient.setEncoding('utf8');

        let streamData = '';
        let sendCommandTimeoutHandler = null;

        _this2.socketClient.on('data', data => {
          if (sendCommandTimeoutHandler) {
            clearTimeout(sendCommandTimeoutHandler);
          }

          log.debug('Received command result from bootstrap');

          try {
            streamData = JSON.parse(streamData + data);

            _this2.socketClient.removeAllListeners('data');

            if (streamData.status === 0) {
              return resolve(streamData.value);
            }

            reject((0, _appiumBaseDriver.errorFromCode)(streamData.status, streamData.value));
          } catch (err) {
            if (!_lodash.default.isString(streamData)) {
              log.error('Got an unexpected error inside socket listener');
              log.error(err.stack);
              return reject((0, _appiumBaseDriver.errorFromCode)(13, err.message));
            }

            log.debug(`Stream still not complete, waiting up to ${SEND_COMMAND_TIMEOUT}ms for the data to arrive`);
            streamData += data;
            sendCommandTimeoutHandler = setTimeout(() => {
              const errMsg = `Server socket stopped responding. The recent response was '${streamData}'`;
              log.error(errMsg);

              _this2.socketClient.removeAllListeners('data');

              reject((0, _appiumBaseDriver.errorFromCode)(13, errMsg));
            }, SEND_COMMAND_TIMEOUT);
          }
        });
      });
    })();
  }

  sendAction(action, params = {}) {
    var _this3 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      let extra = {
        action,
        params
      };
      return yield _this3.sendCommand(COMMAND_TYPES.ACTION, extra);
    })();
  }

  shutdown() {
    var _this4 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      if (!_this4.uiAutomator) {
        log.warn('Cannot shut down Android bootstrap; it has already shut down');
        return;
      }

      _this4.uiAutomator.removeAllListeners(_uiautomator.default.EVENT_CHANGED);

      if (_this4.socketClient) {
        yield _this4.sendCommand(COMMAND_TYPES.SHUTDOWN);
      }

      yield _this4.uiAutomator.shutdown();
      _this4.uiAutomator = null;
    })();
  }

  init() {
    var _this5 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      _this5.uiAutomator = new _uiautomator.default(_this5.adb);

      _this5.uiAutomator.on(_uiautomator.default.EVENT_CHANGED, msg => {
        if (msg.state === _uiautomator.default.STATE_STOPPED) {
          _this5.uiAutomator = null;

          _this5.onUnexpectedShutdown.cancel(new Error('UiAUtomator shut down unexpectedly'));
        }
      });
    })();
  }

  set ignoreUnexpectedShutdown(ignore) {
    log.debug(`${ignore ? 'Ignoring' : 'Watching for'} bootstrap disconnect`);
    this._ignoreUnexpectedShutdown = ignore;
  }

  get ignoreUnexpectedShutdown() {
    return this._ignoreUnexpectedShutdown;
  }

}

exports.AndroidBootstrap = AndroidBootstrap;
var _default = AndroidBootstrap;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9ib290c3RyYXAuanMiXSwibmFtZXMiOlsibG9nIiwibG9nZ2VyIiwiZ2V0TG9nZ2VyIiwiQ09NTUFORF9UWVBFUyIsIkFDVElPTiIsIlNIVVRET1dOIiwiU0VORF9DT01NQU5EX1RJTUVPVVQiLCJBbmRyb2lkQm9vdHN0cmFwIiwiY29uc3RydWN0b3IiLCJhZGIiLCJzeXN0ZW1Qb3J0Iiwid2ViU29ja2V0IiwidW5kZWZpbmVkIiwiaWdub3JlVW5leHBlY3RlZFNodXRkb3duIiwib25VbmV4cGVjdGVkU2h1dGRvd24iLCJfb25VbmV4cGVjdGVkU2h1dGRvd25Qcm9taXNlIiwicmVqZWN0IiwiQiIsIl9yZXNvbHZlIiwiX3JlamVjdCIsImNhbmNlbCIsInN0YXJ0IiwiYXBwUGFja2FnZSIsImRpc2FibGVBbmRyb2lkV2F0Y2hlcnMiLCJhY2NlcHRTc2xDZXJ0cyIsInJvb3REaXIiLCJwYXRoIiwicmVzb2x2ZSIsIl9fZGlybmFtZSIsInN0YXJ0RGV0ZWN0b3IiLCJzIiwidGVzdCIsImJvb3RzdHJhcEphciIsImluaXQiLCJmb3J3YXJkUG9ydCIsInByb2Nlc3MiLCJ1aUF1dG9tYXRvciIsIm9uIiwic3Rkb3V0Iiwic3RkZXJyIiwiYWxlcnRSZSIsImRlYnVnIiwic29ja2V0cyIsImVtaXQiLCJtZXNzYWdlIiwic3Rkb3V0TGluZXMiLCJzcGxpdCIsInVpYXV0b0xvZyIsImxpbmUiLCJ0cmltIiwiaW5uZXJMaW5lIiwiZXhlYyIsImxvZ01ldGhvZCIsImluZm8iLCJiaW5kIiwic3RkZXJyTGluZXMiLCJzb2NrZXRDbGllbnQiLCJuZXQiLCJjb25uZWN0IiwiZXJyIiwiRXJyb3IiLCJvbmNlIiwiZXJyb3JBbmRUaHJvdyIsInNlbmRDb21tYW5kIiwidHlwZSIsImV4dHJhIiwiY21kIiwiT2JqZWN0IiwiYXNzaWduIiwiY21kSnNvbiIsIkpTT04iLCJzdHJpbmdpZnkiLCJfIiwidHJ1bmNhdGUiLCJsZW5ndGgiLCJ3cml0ZSIsInNldEVuY29kaW5nIiwic3RyZWFtRGF0YSIsInNlbmRDb21tYW5kVGltZW91dEhhbmRsZXIiLCJkYXRhIiwiY2xlYXJUaW1lb3V0IiwicGFyc2UiLCJyZW1vdmVBbGxMaXN0ZW5lcnMiLCJzdGF0dXMiLCJ2YWx1ZSIsImlzU3RyaW5nIiwiZXJyb3IiLCJzdGFjayIsInNldFRpbWVvdXQiLCJlcnJNc2ciLCJzZW5kQWN0aW9uIiwiYWN0aW9uIiwicGFyYW1zIiwic2h1dGRvd24iLCJ3YXJuIiwiVWlBdXRvbWF0b3IiLCJFVkVOVF9DSEFOR0VEIiwibXNnIiwic3RhdGUiLCJTVEFURV9TVE9QUEVEIiwiaWdub3JlIiwiX2lnbm9yZVVuZXhwZWN0ZWRTaHV0ZG93biJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxNQUFNQSxHQUFHLEdBQUdDLHNCQUFPQyxTQUFQLENBQWlCLGtCQUFqQixDQUFaOztBQUNBLE1BQU1DLGFBQWEsR0FBRztBQUNwQkMsRUFBQUEsTUFBTSxFQUFFLFFBRFk7QUFFcEJDLEVBQUFBLFFBQVEsRUFBRTtBQUZVLENBQXRCOztBQUlBLE1BQU1DLG9CQUFvQixHQUFHLElBQUksRUFBSixHQUFTLElBQXRDOztBQUVBLE1BQU1DLGdCQUFOLENBQXVCO0FBQ3JCQyxFQUFBQSxXQUFXLENBQUVDLEdBQUYsRUFBT0MsVUFBVSxHQUFHLElBQXBCLEVBQTBCQyxTQUFTLEdBQUdDLFNBQXRDLEVBQWlEO0FBQzFELFNBQUtILEdBQUwsR0FBV0EsR0FBWDtBQUNBLFNBQUtDLFVBQUwsR0FBa0JBLFVBQWxCO0FBQ0EsU0FBS0MsU0FBTCxHQUFpQkEsU0FBakI7QUFDQSxTQUFLRSx3QkFBTCxHQUFnQyxLQUFoQztBQUNEOztBQUVELE1BQUlDLG9CQUFKLEdBQTRCO0FBQzFCLFFBQUksQ0FBQyxLQUFLQyw0QkFBVixFQUF3QztBQUN0QyxVQUFJQyxNQUFKO0FBQ0EsV0FBS0QsNEJBQUwsR0FBb0MsSUFBSUUsaUJBQUosQ0FBTSxVQUFVQyxRQUFW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b0JBQUosQ0FBZ0IsTUFBSSxDQUFDdEYsR0FBckIsQ0FBbkI7O0FBR0EsTUFBQSxNQUFJLENBQUMyQixXQUFMLENBQWlCQyxFQUFqQixDQUFvQjBELHFCQUFZQyxhQUFoQyxFQUFnREMsR0FBRCxJQUFTO0FBQ3RELFlBQUlBLEdBQUcsQ0FBQ0MsS0FBSixLQUFjSCxxQkFBWUksYUFBOUIsRUFBNkM7QUFDM0MsVUFBQSxNQUFJLENBQUMvRCxXQUFMLEdBQW1CLElBQW5COztBQUNBLFVBQUEsTUFBSSxDQUFDdEIsb0JBQUwsQ0FBMEJNLE1BQTFCLENBQWlDLElBQUl3QyxLQUFKLENBQVUsb0NBQVYsQ0FBakM7QUFDRDtBQUNGLE9BTEQ7QUFKWTtBQVViOztBQUVELE1BQUkvQyx3QkFBSixDQUE4QnVGLE1BQTlCLEVBQXNDO0FBQ3BDcEcsSUFBQUEsR0FBRyxDQUFDeUMsS0FBSixDQUFXLEdBQUUyRCxNQUFNLEdBQUcsVUFBSCxHQUFnQixjQUFlLHVCQUFsRDtBQUNBLFNBQUtDLHlCQUFMLEdBQWlDRCxNQUFqQztBQUNEOztBQUVELE1BQUl2Rix3QkFBSixHQUFnQztBQUM5QixXQUFPLEtBQUt3Rix5QkFBWjtBQUNEOztBQXRMb0I7OztlQTBMUjlGLGdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFVpQXV0b21hdG9yIGZyb20gJy4vdWlhdXRvbWF0b3InO1xuaW1wb3J0IG5ldCBmcm9tICduZXQnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgZXJyb3JGcm9tQ29kZSB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgeyBsb2dnZXIgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5cblxuY29uc3QgbG9nID0gbG9nZ2VyLmdldExvZ2dlcignQW5kcm9pZEJvb3RzdHJhcCcpO1xuY29uc3QgQ09NTUFORF9UWVBFUyA9IHtcbiAgQUNUSU9OOiAnYWN0aW9uJyxcbiAgU0hVVERPV046ICdzaHV0ZG93bidcbn07XG5jb25zdCBTRU5EX0NPTU1BTkRfVElNRU9VVCA9IDEgKiA2MCAqIDEwMDA7XG5cbmNsYXNzIEFuZHJvaWRCb290c3RyYXAge1xuICBjb25zdHJ1Y3RvciAoYWRiLCBzeXN0ZW1Qb3J0ID0gNDcyNCwgd2ViU29ja2V0ID0gdW5kZWZpbmVkKSB7XG4gICAgdGhpcy5hZGIgPSBhZGI7XG4gICAgdGhpcy5zeXN0ZW1Qb3J0ID0gc3lzdGVtUG9ydDtcbiAgICB0aGlzLndlYlNvY2tldCA9IHdlYlNvY2tldDtcbiAgICB0aGlzLmlnbm9yZVVuZXhwZWN0ZWRTaHV0ZG93biA9IGZhbHNlO1xuICB9XG5cbiAgZ2V0IG9uVW5leHBlY3RlZFNodXRkb3duICgpIHtcbiAgICBpZiAoIXRoaXMuX29uVW5leHBlY3RlZFNodXRkb3duUHJvbWlzZSkge1xuICAgICAgbGV0IHJlamVjdDtcbiAgICAgIHRoaXMuX29uVW5leHBlY3RlZFNodXRkb3duUHJvbWlzZSA9IG5ldyBCKGZ1bmN0aW9uIChfcmVzb2x2ZSwgX3JlamVjdCkge1xuICAgICAgICByZWplY3QgPSBfcmVqZWN0O1xuICAgICAgfSk7XG4gICAgICB0aGlzLl9vblVuZXhwZWN0ZWRTaHV0ZG93blByb21pc2UuY2FuY2VsID0gcmVqZWN0O1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5fb25VbmV4cGVjdGVkU2h1dGRvd25Qcm9taXNlO1xuICB9XG5cbiAgYXN5bmMgc3RhcnQgKGFwcFBhY2thZ2UsIGRpc2FibGVBbmRyb2lkV2F0Y2hlcnMgPSBmYWxzZSwgYWNjZXB0U3NsQ2VydHMgPSBmYWxzZSkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByb290RGlyID0gcGF0aC5yZXNvbHZlKF9fZGlybmFtZSwgJy4uJywgJy4uJyk7XG4gICAgICBjb25zdCBzdGFydERldGVjdG9yID0gKHMpID0+IHsgcmV0dXJuIC9BcHBpdW0gU29ja2V0IFNlcnZlciBSZWFkeS8udGVzdChzKTsgfTtcbiAgICAgIGNvbnN0IGJvb3RzdHJhcEphciA9IHBhdGgucmVzb2x2ZShyb290RGlyLCAnYm9vdHN0cmFwJywgJ2JpbicsICdBcHBpdW1Cb290c3RyYXAuamFyJyk7XG5cbiAgICAgIGF3YWl0IHRoaXMuaW5pdCgpO1xuICAgICAgYXdhaXQgdGhpcy5hZGIuZm9yd2FyZFBvcnQodGhpcy5zeXN0ZW1Qb3J0LCA0NzI0KTtcbiAgICAgIHRoaXMucHJvY2VzcyA9IGF3YWl0IHRoaXMudWlBdXRvbWF0b3Iuc3RhcnQoXG4gICAgICAgICAgICAgICAgICAgICAgIGJvb3RzdHJhcEphciwgJ2lvLmFwcGl1bS5hbmRyb2lkLmJvb3RzdHJhcC5Cb290c3RyYXAnLFxuICAgICAgICAgICAgICAgICAgICAgICBzdGFydERldGVjdG9yLCAnLWUnLCAncGtnJywgYXBwUGFja2FnZSxcbiAgICAgICAgICAgICAgICAgICAgICAgJy1lJywgJ2Rpc2FibGVBbmRyb2lkV2F0Y2hlcnMnLCBkaXNhYmxlQW5kcm9pZFdhdGNoZXJzLFxuICAgICAgICAgICAgICAgICAgICAgICAnLWUnLCAnYWNjZXB0U3NsQ2VydHMnLCBhY2NlcHRTc2xDZXJ0cyk7XG5cbiAgICAgIC8vIHByb2Nlc3MgdGhlIG91dHB1dFxuICAgICAgdGhpcy5wcm9jZXNzLm9uKCdvdXRwdXQnLCAoc3Rkb3V0LCBzdGRlcnIpID0+IHtcbiAgICAgICAgY29uc3QgYWxlcnRSZSA9IC9FbWl0dGluZyBzeXN0ZW0gYWxlcnQgbWVzc2FnZS87XG4gICAgICAgIGlmIChhbGVydFJlLnRlc3Qoc3Rkb3V0KSkge1xuICAgICAgICAgIGxvZy5kZWJ1ZygnRW1pdHRpbmcgYWxlcnQgbWVzc2FnZS4uLicpO1xuICAgICAgICAgIGlmICh0aGlzLndlYlNvY2tldCkge1xuICAgICAgICAgICAgdGhpcy53ZWJTb2NrZXQuc29ja2V0cy5lbWl0KCdhbGVydCcsIHttZXNzYWdlOiBzdGRvdXR9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyB0aGUgYm9vdHN0cmFwIGxvZ2dlciB3cmFwcyBpdHMgb3duIGxvZyBsaW5lcyB3aXRoXG4gICAgICAgIC8vIFtBUFBJVU0tVUlBVVRPXSAuLi4gW0FQUElVTS1VSUFVVE9dXG4gICAgICAgIC8vIGFuZCBsZWF2ZXMgYWN0dWFsIFVpQXV0b21hdG9yIGxvZ3MgYXMgdGhleSBhcmVcbiAgICAgICAgbGV0IHN0ZG91dExpbmVzID0gKHN0ZG91dCB8fCAnJykuc3BsaXQoJ1xcbicpO1xuICAgICAgICBjb25zdCB1aWF1dG9Mb2cgPSAvXFxbQVBQSVVNLVVJQVVUT1xcXSguKylcXFtcXC9BUFBJVU0tVUlBVVRPXFxdLztcbiAgICAgICAgZm9yIChsZXQgbGluZSBvZiBzdGRvdXRMaW5lcykge1xuICAgICAgICAgIGlmIChsaW5lLnRyaW0oKSkge1xuICAgICAgICAgICAgaWYgKHVpYXV0b0xvZy50ZXN0KGxpbmUpKSB7XG4gICAgICAgICAgICAgIGxldCBpbm5lckxpbmUgPSB1aWF1dG9Mb2cuZXhlYyhsaW5lKVsxXS50cmltKCk7XG4gICAgICAgICAgICAgIGxldCBsb2dNZXRob2QgPSBsb2cuaW5mby5iaW5kKGxvZyk7XG4gICAgICAgICAgICAgIC8vIGlmIHRoZSBib290c3RyYXAgbG9nIGNvbnNpZGVycyBzb21ldGhpbmcgZGVidWcsIGxvZyB0aGF0IGFzXG4gICAgICAgICAgICAgIC8vIGRlYnVnIGFuZCBub3QgaW5mb1xuICAgICAgICAgICAgICBpZiAoL1xcW2RlYnVnXFxdLy50ZXN0KGlubmVyTGluZSkpIHtcbiAgICAgICAgICAgICAgICBsb2dNZXRob2QgPSBsb2cuZGVidWcuYmluZChsb2cpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGxvZ01ldGhvZChgW0JPT1RTVFJBUCBMT0ddICR7aW5uZXJMaW5lfWApO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgbG9nLmRlYnVnKGBbVUlBVVRPIFNURE9VVF0gJHtsaW5lfWApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGxldCBzdGRlcnJMaW5lcyA9IChzdGRlcnIgfHwgJycpLnNwbGl0KCdcXG4nKTtcbiAgICAgICAgZm9yIChsZXQgbGluZSBvZiBzdGRlcnJMaW5lcykge1xuICAgICAgICAgIGlmIChsaW5lLnRyaW0oKSkge1xuICAgICAgICAgICAgbG9nLmRlYnVnKGBbVUlBVVRPIFNUREVSUl0gJHtsaW5lfWApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSk7XG5cbiAgICAgIC8vIG9ubHkgcmV0dXJuIHdoZW4gdGhlIHNvY2tldCBjbGllbnQgaGFzIGNvbm5lY3RlZFxuICAgICAgcmV0dXJuIGF3YWl0IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICB0aGlzLnNvY2tldENsaWVudCA9IG5ldC5jb25uZWN0KHRoaXMuc3lzdGVtUG9ydCk7XG4gICAgICAgICAgLy8gV2luZG93czogdGhlIHNvY2tldCBlcnJvcnMgb3V0IHdoZW4gQURCIHJlc3RhcnRzLiBMZXQncyBjYXRjaCBpdCB0byBhdm9pZCBjcmFzaGluZy5cbiAgICAgICAgICB0aGlzLnNvY2tldENsaWVudC5vbignZXJyb3InLCAoZXJyKSA9PiB7XG4gICAgICAgICAgICBpZiAoIXRoaXMuaWdub3JlVW5leHBlY3RlZFNodXRkb3duKSB7XG4gICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgQW5kcm9pZCBib290c3RyYXAgc29ja2V0IGNyYXNoZWQ6ICR7ZXJyfWApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICAgIHRoaXMuc29ja2V0Q2xpZW50Lm9uY2UoJ2Nvbm5lY3QnLCAoKSA9PiB7XG4gICAgICAgICAgICBsb2cuaW5mbyhcIkFuZHJvaWQgYm9vdHN0cmFwIHNvY2tldCBpcyBub3cgY29ubmVjdGVkXCIpO1xuICAgICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICByZWplY3QoZXJyKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cuZXJyb3JBbmRUaHJvdyhgRXJyb3Igb2NjdXJlZCB3aGlsZSBzdGFydGluZyBBbmRyb2lkQm9vdHN0cmFwLiBPcmlnaW5hbCBlcnJvcjogJHtlcnJ9YCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2VuZENvbW1hbmQgKHR5cGUsIGV4dHJhID0ge30pIHtcbiAgICBpZiAoIXRoaXMuc29ja2V0Q2xpZW50KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1NvY2tldCBjb25uZWN0aW9uIGNsb3NlZCB1bmV4cGVjdGVkbHknKTtcbiAgICB9XG5cbiAgICByZXR1cm4gYXdhaXQgbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgbGV0IGNtZCA9IE9iamVjdC5hc3NpZ24oe2NtZDogdHlwZX0sIGV4dHJhKTtcbiAgICAgIGxldCBjbWRKc29uID0gYCR7SlNPTi5zdHJpbmdpZnkoY21kKX0gXFxuYDtcbiAgICAgIGxvZy5kZWJ1ZyhgU2VuZGluZyBjb21tYW5kIHRvIGFuZHJvaWQ6ICR7Xy50cnVuY2F0ZShjbWRKc29uLCB7bGVuZ3RoOiAxMDAwfSkudHJpbSgpfWApO1xuICAgICAgdGhpcy5zb2NrZXRDbGllbnQud3JpdGUoY21kSnNvbik7XG4gICAgICB0aGlzLnNvY2tldENsaWVudC5zZXRFbmNvZGluZygndXRmOCcpO1xuICAgICAgbGV0IHN0cmVhbURhdGEgPSAnJztcbiAgICAgIGxldCBzZW5kQ29tbWFuZFRpbWVvdXRIYW5kbGVyID0gbnVsbDtcbiAgICAgIHRoaXMuc29ja2V0Q2xpZW50Lm9uKCdkYXRhJywgKGRhdGEpID0+IHtcbiAgICAgICAgaWYgKHNlbmRDb21tYW5kVGltZW91dEhhbmRsZXIpIHtcbiAgICAgICAgICBjbGVhclRpbWVvdXQoc2VuZENvbW1hbmRUaW1lb3V0SGFuZGxlcik7XG4gICAgICAgIH1cbiAgICAgICAgbG9nLmRlYnVnKCdSZWNlaXZlZCBjb21tYW5kIHJlc3VsdCBmcm9tIGJvb3RzdHJhcCcpO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIHN0cmVhbURhdGEgPSBKU09OLnBhcnNlKHN0cmVhbURhdGEgKyBkYXRhKTtcbiAgICAgICAgICAvLyB3ZSBzdWNjZXNzZnVsbHkgcGFyc2VkIEpTT04gc28gd2UndmUgZ290IGFsbCB0aGUgZGF0YSxcbiAgICAgICAgICAvLyByZW1vdmUgdGhlIHNvY2tldCBsaXN0ZW5lciBhbmQgZXZhbHVhdGVcbiAgICAgICAgICB0aGlzLnNvY2tldENsaWVudC5yZW1vdmVBbGxMaXN0ZW5lcnMoJ2RhdGEnKTtcbiAgICAgICAgICBpZiAoc3RyZWFtRGF0YS5zdGF0dXMgPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybiByZXNvbHZlKHN0cmVhbURhdGEudmFsdWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZWplY3QoZXJyb3JGcm9tQ29kZShzdHJlYW1EYXRhLnN0YXR1cywgc3RyZWFtRGF0YS52YWx1ZSkpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICBpZiAoIV8uaXNTdHJpbmcoc3RyZWFtRGF0YSkpIHtcbiAgICAgICAgICAgIGxvZy5lcnJvcignR290IGFuIHVuZXhwZWN0ZWQgZXJyb3IgaW5zaWRlIHNvY2tldCBsaXN0ZW5lcicpO1xuICAgICAgICAgICAgbG9nLmVycm9yKGVyci5zdGFjayk7XG4gICAgICAgICAgICByZXR1cm4gcmVqZWN0KGVycm9yRnJvbUNvZGUoMTMsIGVyci5tZXNzYWdlKSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGxvZy5kZWJ1ZyhgU3RyZWFtIHN0aWxsIG5vdCBjb21wbGV0ZSwgd2FpdGluZyB1cCB0byAke1NFTkRfQ09NTUFORF9USU1FT1VUfW1zIGZvciB0aGUgZGF0YSB0byBhcnJpdmVgKTtcbiAgICAgICAgICBzdHJlYW1EYXRhICs9IGRhdGE7XG4gICAgICAgICAgc2VuZENvbW1hbmRUaW1lb3V0SGFuZGxlciA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgZXJyTXNnID0gYFNlcnZlciBzb2NrZXQgc3RvcHBlZCByZXNwb25kaW5nLiBUaGUgcmVjZW50IHJlc3BvbnNlIHdhcyAnJHtzdHJlYW1EYXRhfSdgO1xuICAgICAgICAgICAgbG9nLmVycm9yKGVyck1zZyk7XG4gICAgICAgICAgICB0aGlzLnNvY2tldENsaWVudC5yZW1vdmVBbGxMaXN0ZW5lcnMoJ2RhdGEnKTtcbiAgICAgICAgICAgIHJlamVjdChlcnJvckZyb21Db2RlKDEzLCBlcnJNc2cpKTtcbiAgICAgICAgICB9LCBTRU5EX0NPTU1BTkRfVElNRU9VVCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgc2VuZEFjdGlvbiAoYWN0aW9uLCBwYXJhbXMgPSB7fSkge1xuICAgIGxldCBleHRyYSA9IHthY3Rpb24sIHBhcmFtc307XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuc2VuZENvbW1hbmQoQ09NTUFORF9UWVBFUy5BQ1RJT04sIGV4dHJhKTtcbiAgfVxuXG4gIGFzeW5jIHNodXRkb3duICgpIHtcbiAgICBpZiAoIXRoaXMudWlBdXRvbWF0b3IpIHtcbiAgICAgIGxvZy53YXJuKCdDYW5ub3Qgc2h1dCBkb3duIEFuZHJvaWQgYm9vdHN0cmFwOyBpdCBoYXMgYWxyZWFkeSBzaHV0IGRvd24nKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyByZW1vdmUgbGlzdG5lcnMgc28gd2UgZG9uJ3QgdHJpZ2dlciB1bmV4cGVjdGVkIHNodXRkb3duXG4gICAgdGhpcy51aUF1dG9tYXRvci5yZW1vdmVBbGxMaXN0ZW5lcnMoVWlBdXRvbWF0b3IuRVZFTlRfQ0hBTkdFRCk7XG4gICAgaWYgKHRoaXMuc29ja2V0Q2xpZW50KSB7XG4gICAgICBhd2FpdCB0aGlzLnNlbmRDb21tYW5kKENPTU1BTkRfVFlQRVMuU0hVVERPV04pO1xuICAgIH1cbiAgICBhd2FpdCB0aGlzLnVpQXV0b21hdG9yLnNodXRkb3duKCk7XG4gICAgdGhpcy51aUF1dG9tYXRvciA9IG51bGw7XG4gIH1cblxuICAvLyB0aGlzIGhlbHBlciBmdW5jdGlvbiBtYWtlcyB1bml0IHRlc3RpbmcgZWFzaWVyLlxuICBhc3luYyBpbml0ICgpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZXF1aXJlLWF3YWl0XG4gICAgdGhpcy51aUF1dG9tYXRvciA9IG5ldyBVaUF1dG9tYXRvcih0aGlzLmFkYik7XG5cbiAgICAvLyBIYW5kbGUgdW5leHBlY3RlZCBVaUF1dG9tYXRvciBzaHV0ZG93blxuICAgIHRoaXMudWlBdXRvbWF0b3Iub24oVWlBdXRvbWF0b3IuRVZFTlRfQ0hBTkdFRCwgKG1zZykgPT4ge1xuICAgICAgaWYgKG1zZy5zdGF0ZSA9PT0gVWlBdXRvbWF0b3IuU1RBVEVfU1RPUFBFRCkge1xuICAgICAgICB0aGlzLnVpQXV0b21hdG9yID0gbnVsbDtcbiAgICAgICAgdGhpcy5vblVuZXhwZWN0ZWRTaHV0ZG93bi5jYW5jZWwobmV3IEVycm9yKCdVaUFVdG9tYXRvciBzaHV0IGRvd24gdW5leHBlY3RlZGx5JykpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgc2V0IGlnbm9yZVVuZXhwZWN0ZWRTaHV0ZG93biAoaWdub3JlKSB7XG4gICAgbG9nLmRlYnVnKGAke2lnbm9yZSA/ICdJZ25vcmluZycgOiAnV2F0Y2hpbmcgZm9yJ30gYm9vdHN0cmFwIGRpc2Nvbm5lY3RgKTtcbiAgICB0aGlzLl9pZ25vcmVVbmV4cGVjdGVkU2h1dGRvd24gPSBpZ25vcmU7XG4gIH1cblxuICBnZXQgaWdub3JlVW5leHBlY3RlZFNodXRkb3duICgpIHtcbiAgICByZXR1cm4gdGhpcy5faWdub3JlVW5leHBlY3RlZFNodXRkb3duO1xuICB9XG59XG5cbmV4cG9ydCB7IEFuZHJvaWRCb290c3RyYXAsIENPTU1BTkRfVFlQRVMgfTtcbmV4cG9ydCBkZWZhdWx0IEFuZHJvaWRCb290c3RyYXA7XG4iXSwiZmlsZSI6ImxpYi9ib290c3RyYXAuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
