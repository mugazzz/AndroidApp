"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.helpers = exports.FINGERPRINT_UNLOCK = exports.PATTERN_UNLOCK = exports.PASSWORD_UNLOCK = exports.PIN_UNLOCK = void 0;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _logger = _interopRequireDefault(require("./logger"));

var _asyncbox = require("asyncbox");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

const PIN_UNLOCK = "pin";
exports.PIN_UNLOCK = PIN_UNLOCK;
const PASSWORD_UNLOCK = "password";
exports.PASSWORD_UNLOCK = PASSWORD_UNLOCK;
const PATTERN_UNLOCK = "pattern";
exports.PATTERN_UNLOCK = PATTERN_UNLOCK;
const FINGERPRINT_UNLOCK = "fingerprint";
exports.FINGERPRINT_UNLOCK = FINGERPRINT_UNLOCK;
const UNLOCK_TYPES = [PIN_UNLOCK, PASSWORD_UNLOCK, PATTERN_UNLOCK, FINGERPRINT_UNLOCK];
const KEYCODE_NUMPAD_ENTER = "66";
const UNLOCK_WAIT_TIME = 100;
const HIDE_KEYBOARD_WAIT_TIME = 100;
const INPUT_KEYS_WAIT_TIME = 100;
let helpers = {};
exports.helpers = helpers;

helpers.isValidUnlockType = function (type) {
  return UNLOCK_TYPES.indexOf(type) !== -1;
};

helpers.isValidKey = function (type, key) {
  if (_lodash.default.isUndefined(key)) {
    return false;
  }

  if (type === PIN_UNLOCK || type === FINGERPRINT_UNLOCK) {
    return /^[0-9]+$/.test(key.trim());
  }

  if (type === PATTERN_UNLOCK) {
    if (!/^[1-9]{2,9}$/.test(key.trim())) {
      return false;
    }

    return !/([1-9]).*?\1/.test(key.trim());
  }

  if (type === PASSWORD_UNLOCK) {
    return /.{4,}/g.test(key);
  }

  throw new Error(`Invalid unlock type ${type}`);
};

helpers.dismissKeyguard = function () {
  var _ref = (0, _asyncToGenerator2.default)(function* (driver, adb) {
    let isKeyboardShown = yield driver.isKeyboardShown();

    if (isKeyboardShown) {
      yield driver.hideKeyboard();
      yield (0, _asyncbox.sleep)(HIDE_KEYBOARD_WAIT_TIME);
    }

    _logger.default.info("Dismiss notifications from unlock view");

    yield adb.shell(["service", "call", "notification", "1"]);
    yield adb.back();

    if ((yield adb.getApiLevel()) > 21) {
      _logger.default.info("Trying to dismiss keyguard");

      yield adb.shell(["wm", "dismiss-keyguard"]);
      return;
    }

    _logger.default.info("Swiping up to dismiss keyguard");

    yield helpers.swipeUp(driver);
  });

  return function (_x, _x2) {
    return _ref.apply(this, arguments);
  };
}();

helpers.swipeUp = function () {
  var _ref2 = (0, _asyncToGenerator2.default)(function* (driver) {
    let windowSize = yield driver.getWindowSize();
    let x0 = parseInt(windowSize.x / 2, 10);
    let y0 = windowSize.y - 10;
    let yP = 100;
    let actions = [{
      action: 'press',
      options: {
        element: null,
        x: x0,
        y: y0
      }
    }, {
      action: 'moveTo',
      options: {
        element: null,
        x: x0,
        y: yP
      }
    }, {
      action: 'release'
    }];
    yield driver.performTouch(actions);
  });

  return function (_x3) {
    return _ref2.apply(this, arguments);
  };
}();

helpers.encodePassword = function (key) {
  return key.replace(/\s/ig, "%s");
};

helpers.stringKeyToArr = function (key) {
  return key.trim().replace(/\s+/g, '').split(/\s*/);
};

helpers.fingerprintUnlock = function () {
  var _ref3 = (0, _asyncToGenerator2.default)(function* (adb, driver, capabilities) {
    if ((yield adb.getApiLevel()) < 23) {
      throw new Error("Fingerprint unlock only works for Android 6+ emulators");
    }

    yield adb.fingerprint(capabilities.unlockKey);
    yield (0, _asyncbox.sleep)(UNLOCK_WAIT_TIME);
  });

  return function (_x4, _x5, _x6) {
    return _ref3.apply(this, arguments);
  };
}();

helpers.pinUnlock = function () {
  var _ref4 = (0, _asyncToGenerator2.default)(function* (adb, driver, capabilities) {
    _logger.default.info(`Trying to unlock device using pin ${capabilities.unlockKey}`);

    yield helpers.dismissKeyguard(driver, adb);
    let keys = helpers.stringKeyToArr(capabilities.unlockKey);

    if ((yield adb.getApiLevel()) >= 21) {
      let els = yield driver.findElOrEls("id", "com.android.systemui:id/digit_text", true);

      if (_lodash.default.isEmpty(els)) {
        throw new Error("Error finding unlock pin buttons!");
      }

      let pins = {};
      var _iteratorNormalCompletion = true;
      var _didIteratorError = false;
      var _iteratorError = undefined;

      try {
        for (var _iterator = els[Symbol.iterator](), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
          let el = _step.value;
          let text = yield driver.getAttribute("text", _appiumSupport.util.unwrapElement(el));
          pins[text] = el;
        }
      } catch (err) {
        _didIteratorError = true;
        _iteratorError = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion && _iterator.return != null) {
            _iterator.return();
          }
        } finally {
          if (_didIteratorError) {
            throw _iteratorError;
          }
        }
      }

      var _iteratorNormalCompletion2 = true;
      var _didIteratorError2 = false;
      var _iteratorError2 = undefined;

      try {
        for (var _iterator2 = keys[Symbol.iterator](), _step2; !(_iteratorNormalCompletion2 = (_step2 = _iterator2.next()).done); _iteratorNormalCompletion2 = true) {
          let pin = _step2.value;
          let el = pins[pin];
          yield driver.click(_appiumSupport.util.unwrapElement(el));
        }
      } catch (err) {
        _didIteratorError2 = true;
        _iteratorError2 = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion2 && _iterator2.return != null) {
            _iterator2.return();
          }
        } finally {
          if (_didIteratorError2) {
            throw _iteratorError2;
          }
        }
      }
    } else {
      var _iteratorNormalCompletion3 = true;
      var _didIteratorError3 = false;
      var _iteratorError3 = undefined;

      try {
        for (var _iterator3 = keys[Symbol.iterator](), _step3; !(_iteratorNormalCompletion3 = (_step3 = _iterator3.next()).done); _iteratorNormalCompletion3 = true) {
          let pin = _step3.value;
          let el = yield driver.findElOrEls('id', `com.android.keyguard:id/key${pin}`, false);

          if (el === null) {
            throw new Error(`Error finding unlock pin '${pin}' button!`);
          }

          yield driver.click(_appiumSupport.util.unwrapElement(el));
        }
      } catch (err) {
        _didIteratorError3 = true;
        _iteratorError3 = err;
      } finally {
        try {
          if (!_iteratorNormalCompletion3 && _iterator3.return != null) {
            _iterator3.return();
          }
        } finally {
          if (_didIteratorError3) {
            throw _iteratorError3;
          }
        }
      }
    }

    const el = yield driver.findElOrEls('xpath', "//*[contains(@resource-id, 'id/key_enter')]", false);
    yield driver.click(_appiumSupport.util.unwrapElement(el));
    yield (0, _asyncbox.sleep)(UNLOCK_WAIT_TIME);
  });

  return function (_x7, _x8, _x9) {
    return _ref4.apply(this, arguments);
  };
}();

helpers.passwordUnlock = function () {
  var _ref5 = (0, _asyncToGenerator2.default)(function* (adb, driver, capabilities) {
    _logger.default.info(`Trying to unlock device using password ${capabilities.unlockKey}`);

    yield helpers.dismissKeyguard(driver, adb);
    let key = capabilities.unlockKey;
    key = helpers.encodePassword(key);
    yield adb.shell(["input", "text", key]);
    yield (0, _asyncbox.sleep)(INPUT_KEYS_WAIT_TIME);
    yield adb.shell(["input", "keyevent", KEYCODE_NUMPAD_ENTER]);
    yield (0, _asyncbox.sleep)(UNLOCK_WAIT_TIME);
  });

  return function (_x10, _x11, _x12) {
    return _ref5.apply(this, arguments);
  };
}();

helpers.getPatternKeyPosition = function (key, initPos, piece) {
  const cols = 3;
  const pins = 9;

  let xPos = (key, x, piece) => {
    return Math.round(x + (key % cols || cols) * piece - piece / 2);
  };

  let yPos = (key, y, piece) => {
    return Math.round(y + (Math.ceil((key % pins || pins) / cols) * piece - piece / 2));
  };

  return {
    x: xPos(key, initPos.x, piece),
    y: yPos(key, initPos.y, piece)
  };
};

helpers.getPatternActions = function (keys, initPos, piece) {
  let actions = [];
  let lastPos;
  var _iteratorNormalCompletion4 = true;
  var _didIteratorError4 = false;
  var _iteratorError4 = undefined;

  try {
    for (var _iterator4 = keys[Symbol.iterator](), _step4; !(_iteratorNormalCompletion4 = (_step4 = _iterator4.next()).done); _iteratorNormalCompletion4 = true) {
      let key = _step4.value;
      let keyPos = helpers.getPatternKeyPosition(key, initPos, piece);

      if (key === keys[0]) {
        actions.push({
          action: 'press',
          options: {
            element: null,
            x: keyPos.x,
            y: keyPos.y
          }
        });
        lastPos = keyPos;
        continue;
      }

      let moveTo = {
        x: 0,
        y: 0
      };
      let diffX = keyPos.x - lastPos.x;

      if (diffX > 0) {
        moveTo.x = piece;

        if (Math.abs(diffX) > piece) {
          moveTo.x += piece;
        }
      } else if (diffX < 0) {
        moveTo.x = -1 * piece;

        if (Math.abs(diffX) > piece) {
          moveTo.x -= piece;
        }
      }

      let diffY = keyPos.y - lastPos.y;

      if (diffY > 0) {
        moveTo.y = piece;

        if (Math.abs(diffY) > piece) {
          moveTo.y += piece;
        }
      } else if (diffY < 0) {
        moveTo.y = -1 * piece;

        if (Math.abs(diffY) > piece) {
          moveTo.y -= piece;
        }
      }

      actions.push({
        action: 'moveTo',
        options: {
          element: null,
          x: moveTo.x,
          y: moveTo.y
        }
      });
      lastPos = keyPos;
    }
  } catch (err) {
    _didIteratorError4 = true;
    _iteratorError4 = err;
  } finally {
    try {
      if (!_iteratorNormalCompletion4 && _iterator4.return != null) {
        _iterator4.return();
      }
    } finally {
      if (_didIteratorError4) {
        throw _iteratorError4;
      }
    }
  }

  actions.push({
    action: 'release'
  });
  return actions;
};

helpers.patternUnlock = function () {
  var _ref6 = (0, _asyncToGenerator2.default)(function* (adb, driver, capabilities) {
    _logger.default.info(`Trying to unlock device using pattern ${capabilities.unlockKey}`);

    yield helpers.dismissKeyguard(driver, adb);
    let keys = helpers.stringKeyToArr(capabilities.unlockKey);
    let apiLevel = yield adb.getApiLevel();
    let el = yield driver.findElOrEls("id", `com.android.${apiLevel >= 21 ? 'systemui' : 'keyguard'}:id/lockPatternView`, false);
    let initPos = yield driver.getLocation(_appiumSupport.util.unwrapElement(el));
    let size = yield driver.getSize(_appiumSupport.util.unwrapElement(el));
    let actions = helpers.getPatternActions(keys, initPos, size.width / 3);
    yield driver.performTouch(actions);
    yield (0, _asyncbox.sleep)(UNLOCK_WAIT_TIME);
  });

  return function (_x13, _x14, _x15) {
    return _ref6.apply(this, arguments);
  };
}();

helpers.PIN_UNLOCK = PIN_UNLOCK;
helpers.PASSWORD_UNLOCK = PASSWORD_UNLOCK;
helpers.PATTERN_UNLOCK = PATTERN_UNLOCK;
helpers.FINGERPRINT_UNLOCK = FINGERPRINT_UNLOCK;
var _default = helpers;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi91bmxvY2staGVscGVycy5qcyJdLCJuYW1lcyI6WyJQSU5fVU5MT0NLIiwiUEFTU1dPUkRfVU5MT0NLIiwiUEFUVEVSTl9VTkxPQ0siLCJGSU5HRVJQUklOVF9VTkxPQ0siLCJVTkxPQ0tfVFlQRVMiLCJLRVlDT0RFX05VTVBBRF9FTlRFUiIsIlVOTE9DS19XQUlUX1RJTUUiLCJISURFX0tFWUJPQVJEX1dBSVRfVElNRSIsIklOUFVUX0tFWVNfV0FJVF9USU1FIiwiaGVscGVycyIsImlzVmFsaWRVbmxvY2tUeXBlIiwidHlwZSIsImluZGV4T2YiLCJpc1ZhbGlkS2V5Iiwia2V5IiwiXyIsImlzVW5kZWZpbmVkIiwidGVzdCIsInRyaW0iLCJFcnJvciIsImRpc21pc3NLZXlndWFyZCIsImRyaXZlciIsImFkYiIsImlzS2V5Ym9hcmRTaG93biIsImhpZGVLZXlib2FyZCIsImxvZ2dlciIsImluZm8iLCJzaGVsbCIsImJhY2siLCJnZXRBcGlMZXZlbCIsInN3aXBlVXAiLCJ3aW5kb3dTaXplIiwiZ2V0V2luZG93U2l6ZSIsIngwIiwicGFyc2VJbnQiLCJ4IiwieTAiLCJ5IiwieVAiLCJhY3Rpb25zIiwiYWN0aW9uIiwib3B0aW9ucyIsImVsZW1lbnQiLCJwZXJmb3JtVG91Y2giLCJlbmNvZGVQYXNzd29yZCIsInJlcGxhY2UiLCJzdHJpbmdLZXlUb0FyciIsInNwbGl0IiwiZmluZ2VycHJpbnRVbmxvY2siLCJjYXBhYmlsaXRpZXMiLCJmaW5nZXJwcmludCIsInVubG9ja0tleSIsInBpblVubG9jayIsImtleXMiLCJlbHMiLCJmaW5kRWxPckVscyIsImlzRW1wdHkiLCJwaW5zIiwiZWwiLCJ0ZXh0IiwiZ2V0QXR0cmlidXRlIiwidXRpbCIsInVud3JhcEVsZW1lbnQiLCJwaW4iLCJjbGljayIsInBhc3N3b3JkVW5sb2NrIiwiZ2V0UGF0dGVybktleVBvc2l0aW9uIiwiaW5pdFBvcyIsInBpZWNlIiwiY29scyIsInhQb3MiLCJNYXRoIiwicm91bmQiLCJ5UG9zIiwiY2VpbCIsImdldFBhdHRlcm5BY3Rpb25zIiwibGFzdFBvcyIsImtleVBvcyIsInB1c2giLCJtb3ZlVG8iLCJkaWZmWCIsImFicyIsImRpZmZZIiwicGF0dGVyblVubG9jayIsImFwaUxldmVsIiwiZ2V0TG9jYXRpb24iLCJzaXplIiwiZ2V0U2l6ZSIsIndpZHRoIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLE1BQU1BLFVBQVUsR0FBRyxLQUFuQjs7QUFDQSxNQUFNQyxlQUFlLEdBQUcsVUFBeEI7O0FBQ0EsTUFBTUMsY0FBYyxHQUFHLFNBQXZCOztBQUNBLE1BQU1DLGtCQUFrQixHQUFHLGFBQTNCOztBQUNBLE1BQU1DLFlBQVksR0FBRyxDQUFDSixVQUFELEVBQWFDLGVBQWIsRUFBOEJDLGNBQTlCLEVBQThDQyxrQkFBOUMsQ0FBckI7QUFDQSxNQUFNRSxvQkFBb0IsR0FBRyxJQUE3QjtBQUNBLE1BQU1DLGdCQUFnQixHQUFHLEdBQXpCO0FBQ0EsTUFBTUMsdUJBQXVCLEdBQUcsR0FBaEM7QUFDQSxNQUFNQyxvQkFBb0IsR0FBRyxHQUE3QjtBQUVBLElBQUlDLE9BQU8sR0FBRyxFQUFkOzs7QUFDQUEsT0FBTyxDQUFDQyxpQkFBUixHQUE0QixVQUFVQyxJQUFWLEVBQWdCO0FBQzFDLFNBQU9QLFlBQVksQ0FBQ1EsT0FBYixDQUFxQkQsSUFBckIsTUFBK0IsQ0FBQyxDQUF2QztBQUNELENBRkQ7O0FBSUFGLE9BQU8sQ0FBQ0ksVUFBUixHQUFxQixVQUFVRixJQUFWLEVBQWdCRyxHQUFoQixFQUFxQjtBQUN4QyxNQUFJQyxnQkFBRUMsV0FBRixDQUFjRixHQUFkLENBQUosRUFBd0I7QUFDdEIsV0FBTyxLQUFQO0FBQ0Q7O0FBQ0QsTUFBSUgsSUFBSSxLQUFLWCxVQUFULElBQXVCVyxJQUFJLEtBQUtSLGtCQUFwQyxFQUF3RDtBQUN0RCxXQUFPLFdBQVdjLElBQVgsQ0FBZ0JILEdBQUcsQ0FBQ0ksSUFBSixFQUFoQixDQUFQO0FBQ0Q7O0FB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QUFDQVEsT0FBTyxDQUFDUCxjQUFSLEdBQXlCQSxjQUF6QjtBQUNBTyxPQUFPLENBQUNOLGtCQUFSLEdBQTZCQSxrQkFBN0I7ZUFHZU0sTyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2dnZXIgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IHsgc2xlZXAgfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcblxuY29uc3QgUElOX1VOTE9DSyA9IFwicGluXCI7XG5jb25zdCBQQVNTV09SRF9VTkxPQ0sgPSBcInBhc3N3b3JkXCI7XG5jb25zdCBQQVRURVJOX1VOTE9DSyA9IFwicGF0dGVyblwiO1xuY29uc3QgRklOR0VSUFJJTlRfVU5MT0NLID0gXCJmaW5nZXJwcmludFwiO1xuY29uc3QgVU5MT0NLX1RZUEVTID0gW1BJTl9VTkxPQ0ssIFBBU1NXT1JEX1VOTE9DSywgUEFUVEVSTl9VTkxPQ0ssIEZJTkdFUlBSSU5UX1VOTE9DS107XG5jb25zdCBLRVlDT0RFX05VTVBBRF9FTlRFUiA9IFwiNjZcIjtcbmNvbnN0IFVOTE9DS19XQUlUX1RJTUUgPSAxMDA7XG5jb25zdCBISURFX0tFWUJPQVJEX1dBSVRfVElNRSA9IDEwMDtcbmNvbnN0IElOUFVUX0tFWVNfV0FJVF9USU1FID0gMTAwO1xuXG5sZXQgaGVscGVycyA9IHt9O1xuaGVscGVycy5pc1ZhbGlkVW5sb2NrVHlwZSA9IGZ1bmN0aW9uICh0eXBlKSB7XG4gIHJldHVybiBVTkxPQ0tfVFlQRVMuaW5kZXhPZih0eXBlKSAhPT0gLTE7XG59O1xuXG5oZWxwZXJzLmlzVmFsaWRLZXkgPSBmdW5jdGlvbiAodHlwZSwga2V5KSB7XG4gIGlmIChfLmlzVW5kZWZpbmVkKGtleSkpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbiAgaWYgKHR5cGUgPT09IFBJTl9VTkxPQ0sgfHwgdHlwZSA9PT0gRklOR0VSUFJJTlRfVU5MT0NLKSB7XG4gICAgcmV0dXJuIC9eWzAtOV0rJC8udGVzdChrZXkudHJpbSgpKTtcbiAgfVxuICBpZiAodHlwZSA9PT0gUEFUVEVSTl9VTkxPQ0spIHtcbiAgICBpZiAoIS9eWzEtOV17Miw5fSQvLnRlc3Qoa2V5LnRyaW0oKSkpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgcmV0dXJuICEoLyhbMS05XSkuKj9cXDEvLnRlc3Qoa2V5LnRyaW0oKSkpO1xuICB9XG4gIC8vIERvbnQgdHJpbSBwYXNzd29yZCBrZXksIHlvdSBjYW4gdXNlIGJsYW5rIHNwYWNlcyBpbiB5b3VyIGFuZHJvaWQgcGFzc3dvcmRcbiAgLy8gwq9cXF8o44OEKV8vwq9cbiAgaWYgKHR5cGUgPT09IFBBU1NXT1JEX1VOTE9DSykge1xuICAgIHJldHVybiAvLns0LH0vZy50ZXN0KGtleSk7XG4gIH1cbiAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHVubG9jayB0eXBlICR7dHlwZX1gKTtcbn07XG5cbmhlbHBlcnMuZGlzbWlzc0tleWd1YXJkID0gYXN5bmMgZnVuY3Rpb24gKGRyaXZlciwgYWRiKSB7XG4gIGxldCBpc0tleWJvYXJkU2hvd24gPSBhd2FpdCBkcml2ZXIuaXNLZXlib2FyZFNob3duKCk7XG4gIGlmIChpc0tleWJvYXJkU2hvd24pIHtcbiAgICBhd2FpdCBkcml2ZXIuaGlkZUtleWJvYXJkKCk7XG4gICAgLy8gV2FpdHMgYSBiaXQgZm9yIHRoZSBrZXlib2FyZCB0byBoaWRlXG4gICAgYXdhaXQgc2xlZXAoSElERV9LRVlCT0FSRF9XQUlUX1RJTUUpO1xuICB9XG4gIC8vIGRpc21pc3Mgbm90aWZpY2F0aW9uc1xuICBsb2dnZXIuaW5mbyhcIkRpc21pc3Mgbm90aWZpY2F0aW9ucyBmcm9tIHVubG9jayB2aWV3XCIpO1xuICBhd2FpdCBhZGIuc2hlbGwoW1wic2VydmljZVwiLCBcImNhbGxcIiwgXCJub3RpZmljYXRpb25cIiwgXCIxXCJdKTtcbiAgYXdhaXQgYWRiLmJhY2soKTtcbiAgaWYgKGF3YWl0IGFkYi5nZXRBcGlMZXZlbCgpID4gMjEpIHtcbiAgICBsb2dnZXIuaW5mbyhcIlRyeWluZyB0byBkaXNtaXNzIGtleWd1YXJkXCIpO1xuICAgIGF3YWl0IGFkYi5zaGVsbChbXCJ3bVwiLCBcImRpc21pc3Mta2V5Z3VhcmRcIl0pO1xuICAgIHJldHVybjtcbiAgfVxuICBsb2dnZXIuaW5mbyhcIlN3aXBpbmcgdXAgdG8gZGlzbWlzcyBrZXlndWFyZFwiKTtcbiAgYXdhaXQgaGVscGVycy5zd2lwZVVwKGRyaXZlcik7XG59O1xuXG5oZWxwZXJzLnN3aXBlVXAgPSBhc3luYyBmdW5jdGlvbiAoZHJpdmVyKSB7XG4gIGxldCB3aW5kb3dTaXplID0gYXdhaXQgZHJpdmVyLmdldFdpbmRvd1NpemUoKTtcbiAgbGV0IHgwID0gcGFyc2VJbnQod2luZG93U2l6ZS54IC8gMiwgMTApO1xuICBsZXQgeTAgPSB3aW5kb3dTaXplLnkgLSAxMDtcbiAgbGV0IHlQID0gMTAwO1xuICBsZXQgYWN0aW9ucyA9IFtcbiAgICB7YWN0aW9uOiAncHJlc3MnLCBvcHRpb25zOiB7ZWxlbWVudDogbnVsbCwgeDogeDAsIHk6IHkwfX0sXG4gICAge2FjdGlvbjogJ21vdmVUbycsIG9wdGlvbnM6IHtlbGVtZW50OiBudWxsLCB4OiB4MCwgeTogeVB9fSxcbiAgICB7YWN0aW9uOiAncmVsZWFzZSd9XG4gIF07XG4gIGF3YWl0IGRyaXZlci5wZXJmb3JtVG91Y2goYWN0aW9ucyk7XG59O1xuXG5oZWxwZXJzLmVuY29kZVBhc3N3b3JkID0gZnVuY3Rpb24gKGtleSkge1xuICByZXR1cm4ga2V5LnJlcGxhY2UoL1xccy9pZywgXCIlc1wiKTtcbn07XG5cbmhlbHBlcnMuc3RyaW5nS2V5VG9BcnIgPSBmdW5jdGlvbiAoa2V5KSB7XG4gIHJldHVybiBrZXkudHJpbSgpLnJlcGxhY2UoL1xccysvZywgJycpLnNwbGl0KC9cXHMqLyk7XG59O1xuXG5oZWxwZXJzLmZpbmdlcnByaW50VW5sb2NrID0gYXN5bmMgZnVuY3Rpb24gKGFkYiwgZHJpdmVyLCBjYXBhYmlsaXRpZXMpIHtcbiAgaWYgKGF3YWl0IGFkYi5nZXRBcGlMZXZlbCgpIDwgMjMpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJGaW5nZXJwcmludCB1bmxvY2sgb25seSB3b3JrcyBmb3IgQW5kcm9pZCA2KyBlbXVsYXRvcnNcIik7XG4gIH1cbiAgYXdhaXQgYWRiLmZpbmdlcnByaW50KGNhcGFiaWxpdGllcy51bmxvY2tLZXkpO1xuICBhd2FpdCBzbGVlcChVTkxPQ0tfV0FJVF9USU1FKTtcbn07XG5cbmhlbHBlcnMucGluVW5sb2NrID0gYXN5bmMgZnVuY3Rpb24gKGFkYiwgZHJpdmVyLCBjYXBhYmlsaXRpZXMpIHtcbiAgbG9nZ2VyLmluZm8oYFRyeWluZyB0byB1bmxvY2sgZGV2aWNlIHVzaW5nIHBpbiAke2NhcGFiaWxpdGllcy51bmxvY2tLZXl9YCk7XG4gIGF3YWl0IGhlbHBlcnMuZGlzbWlzc0tleWd1YXJkKGRyaXZlciwgYWRiKTtcbiAgbGV0IGtleXMgPSBoZWxwZXJzLnN0cmluZ0tleVRvQXJyKGNhcGFiaWxpdGllcy51bmxvY2tLZXkpO1xuICBpZiAoYXdhaXQgYWRiLmdldEFwaUxldmVsKCkgPj0gMjEpIHtcbiAgICBsZXQgZWxzID0gYXdhaXQgZHJpdmVyLmZpbmRFbE9yRWxzKFwiaWRcIiwgXCJjb20uYW5kcm9pZC5zeXN0ZW11aTppZC9kaWdpdF90ZXh0XCIsIHRydWUpO1xuICAgIGlmIChfLmlzRW1wdHkoZWxzKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRXJyb3IgZmluZGluZyB1bmxvY2sgcGluIGJ1dHRvbnMhXCIpO1xuICAgIH1cbiAgICBsZXQgcGlucyA9IHt9O1xuICAgIGZvciAobGV0IGVsIG9mIGVscykge1xuICAgICAgbGV0IHRleHQgPSBhd2FpdCBkcml2ZXIuZ2V0QXR0cmlidXRlKFwidGV4dFwiLCB1dGlsLnVud3JhcEVsZW1lbnQoZWwpKTtcbiAgICAgIHBpbnNbdGV4dF0gPSBlbDtcbiAgICB9XG4gICAgZm9yIChsZXQgcGluIG9mIGtleXMpIHtcbiAgICAgIGxldCBlbCA9IHBpbnNbcGluXTtcbiAgICAgIGF3YWl0IGRyaXZlci5jbGljayh1dGlsLnVud3JhcEVsZW1lbnQoZWwpKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgZm9yIChsZXQgcGluIG9mIGtleXMpIHtcbiAgICAgIGxldCBlbCA9IGF3YWl0IGRyaXZlci5maW5kRWxPckVscygnaWQnLCBgY29tLmFuZHJvaWQua2V5Z3VhcmQ6aWQva2V5JHtwaW59YCwgZmFsc2UpO1xuICAgICAgaWYgKGVsID09PSBudWxsKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgRXJyb3IgZmluZGluZyB1bmxvY2sgcGluICcke3Bpbn0nIGJ1dHRvbiFgKTtcbiAgICAgIH1cbiAgICAgIGF3YWl0IGRyaXZlci5jbGljayh1dGlsLnVud3JhcEVsZW1lbnQoZWwpKTtcbiAgICB9XG4gIH1cbiAgY29uc3QgZWwgPSBhd2FpdCBkcml2ZXIuZmluZEVsT3JFbHMoJ3hwYXRoJywgXCIvLypbY29udGFpbnMoQHJlc291cmNlLWlkLCAnaWQva2V5X2VudGVyJyldXCIsIGZhbHNlKTtcbiAgYXdhaXQgZHJpdmVyLmNsaWNrKHV0aWwudW53cmFwRWxlbWVudChlbCkpO1xuICAvLyBXYWl0cyBhIGJpdCBmb3IgdGhlIGRldmljZSB0byBiZSB1bmxvY2tlZFxuICBhd2FpdCBzbGVlcChVTkxPQ0tfV0FJVF9USU1FKTtcbn07XG5cbmhlbHBlcnMucGFzc3dvcmRVbmxvY2sgPSBhc3luYyBmdW5jdGlvbiAoYWRiLCBkcml2ZXIsIGNhcGFiaWxpdGllcykge1xuICBsb2dnZXIuaW5mbyhgVHJ5aW5nIHRvIHVubG9jayBkZXZpY2UgdXNpbmcgcGFzc3dvcmQgJHtjYXBhYmlsaXRpZXMudW5sb2NrS2V5fWApO1xuICBhd2FpdCBoZWxwZXJzLmRpc21pc3NLZXlndWFyZChkcml2ZXIsIGFkYik7XG4gIGxldCBrZXkgPSBjYXBhYmlsaXRpZXMudW5sb2NrS2V5O1xuICAvLyBSZXBsYWNlIGJsYW5rIHNwYWNlcyB3aXRoICVzXG4gIGtleSA9IGhlbHBlcnMuZW5jb2RlUGFzc3dvcmQoa2V5KTtcbiAgLy8gV2h5IGFkYiA/IEl0IHdhcyBsZXNzIGZsYWt5XG4gIGF3YWl0IGFkYi5zaGVsbChbXCJpbnB1dFwiLCBcInRleHRcIiwga2V5XSk7XG4gIC8vIFdoeSBzbGVlcHMgPyBBdm9pZCBzb21lIGZsYWt5bmVzcyB3YWl0aW5nIGZvciB0aGUgaW5wdXQgdG8gcmVjZWl2ZSB0aGUga2V5c1xuICBhd2FpdCBzbGVlcChJTlBVVF9LRVlTX1dBSVRfVElNRSk7XG4gIGF3YWl0IGFkYi5zaGVsbChbXCJpbnB1dFwiLCBcImtleWV2ZW50XCIsIEtFWUNPREVfTlVNUEFEX0VOVEVSXSk7XG4gIC8vIFdhaXRzIGEgYml0IGZvciB0aGUgZGV2aWNlIHRvIGJlIHVubG9ja2VkXG4gIGF3YWl0IHNsZWVwKFVOTE9DS19XQUlUX1RJTUUpO1xufTtcblxuaGVscGVycy5nZXRQYXR0ZXJuS2V5UG9zaXRpb24gPSBmdW5jdGlvbiAoa2V5LCBpbml0UG9zLCBwaWVjZSkge1xuICAvKlxuICBIb3cgdGhlIG1hdGggd29ya3M6XG4gIFdlIGhhdmUgOSBidXR0b25zIGRpdmlkZWQgaW4gMyBjb2x1bW5zIGFuZCAzIHJvd3MgaW5zaWRlIHRoZSBsb2NrUGF0dGVyblZpZXcsXG4gIGV2ZXJ5IGJ1dHRvbiBoYXMgYSBwb3NpdGlvbiBvbiB0aGUgc2NyZWVuIGNvcnJlc3BvbmRpbmcgdG8gdGhlIGxvY2tQYXR0ZXJuVmlldyBzaW5jZVxuICBpdCBpcyB0aGUgcGFyZW50IHZpZXcgcmlnaHQgYXQgdGhlIG1pZGRsZSBvZiBlYWNoIGNvbHVtbiBvciByb3cuXG4gICovXG4gIGNvbnN0IGNvbHMgPSAzO1xuICBjb25zdCBwaW5zID0gOTtcbiAgbGV0IHhQb3MgPSAoa2V5LCB4LCBwaWVjZSkgPT4ge1xuICAgIHJldHVybiBNYXRoLnJvdW5kKHggKyAoKGtleSAlIGNvbHMpIHx8IGNvbHMpICogcGllY2UgLSBwaWVjZSAvIDIpO1xuICB9O1xuICBsZXQgeVBvcyA9IChrZXksIHksIHBpZWNlKSA9PiB7XG4gICAgcmV0dXJuIE1hdGgucm91bmQoeSArIChNYXRoLmNlaWwoKChrZXkgJSBwaW5zKSB8fCBwaW5zKSAvIGNvbHMpICogcGllY2UgLSBwaWVjZSAvIDIpKTtcbiAgfTtcbiAgcmV0dXJuIHt4OiB4UG9zKGtleSwgaW5pdFBvcy54LCBwaWVjZSksIHk6IHlQb3Moa2V5LCBpbml0UG9zLnksIHBpZWNlKX07XG59O1xuXG5oZWxwZXJzLmdldFBhdHRlcm5BY3Rpb25zID0gZnVuY3Rpb24gKGtleXMsIGluaXRQb3MsIHBpZWNlKSB7XG4gIGxldCBhY3Rpb25zID0gW107XG4gIGxldCBsYXN0UG9zO1xuICBmb3IgKGxldCBrZXkgb2Yga2V5cykge1xuICAgIGxldCBrZXlQb3MgPSBoZWxwZXJzLmdldFBhdHRlcm5LZXlQb3NpdGlvbihrZXksIGluaXRQb3MsIHBpZWNlKTtcbiAgICBpZiAoa2V5ID09PSBrZXlzWzBdKSB7XG4gICAgICBhY3Rpb25zLnB1c2goe2FjdGlvbjogJ3ByZXNzJywgb3B0aW9uczoge2VsZW1lbnQ6IG51bGwsIHg6IGtleVBvcy54LCB5OiBrZXlQb3MueX19KTtcbiAgICAgIGxhc3RQb3MgPSBrZXlQb3M7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG4gICAgbGV0IG1vdmVUbyA9IHt4OiAwLCB5OiAwfTtcbiAgICBsZXQgZGlmZlggPSBrZXlQb3MueCAtIGxhc3RQb3MueDtcbiAgICBpZiAoZGlmZlggPiAwKSB7XG4gICAgICBtb3ZlVG8ueCA9IHBpZWNlO1xuICAgICAgaWYgKE1hdGguYWJzKGRpZmZYKSA+IHBpZWNlKSB7XG4gICAgICAgIG1vdmVUby54ICs9IHBpZWNlO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoZGlmZlggPCAwKSB7XG4gICAgICBtb3ZlVG8ueCA9IC0xICogcGllY2U7XG4gICAgICBpZiAoTWF0aC5hYnMoZGlmZlgpID4gcGllY2UpIHtcbiAgICAgICAgbW92ZVRvLnggLT0gcGllY2U7XG4gICAgICB9XG4gICAgfVxuICAgIGxldCBkaWZmWSA9IGtleVBvcy55IC0gbGFzdFBvcy55O1xuICAgIGlmIChkaWZmWSA+IDApIHtcbiAgICAgIG1vdmVUby55ID0gcGllY2U7XG4gICAgICBpZiAoTWF0aC5hYnMoZGlmZlkpID4gcGllY2UpIHtcbiAgICAgICAgbW92ZVRvLnkgKz0gcGllY2U7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChkaWZmWSA8IDApIHtcbiAgICAgIG1vdmVUby55ID0gLTEgKiBwaWVjZTtcbiAgICAgIGlmIChNYXRoLmFicyhkaWZmWSkgPiBwaWVjZSkge1xuICAgICAgICBtb3ZlVG8ueSAtPSBwaWVjZTtcbiAgICAgIH1cbiAgICB9XG4gICAgYWN0aW9ucy5wdXNoKHthY3Rpb246ICdtb3ZlVG8nLCBvcHRpb25zOiB7ZWxlbWVudDogbnVsbCwgeDogbW92ZVRvLngsIHk6IG1vdmVUby55fX0pO1xuICAgIGxhc3RQb3MgPSBrZXlQb3M7XG4gIH1cbiAgYWN0aW9ucy5wdXNoKHthY3Rpb246ICdyZWxlYXNlJ30pO1xuICByZXR1cm4gYWN0aW9ucztcbn07XG5cbmhlbHBlcnMucGF0dGVyblVubG9jayA9IGFzeW5jIGZ1bmN0aW9uIChhZGIsIGRyaXZlciwgY2FwYWJpbGl0aWVzKSB7XG4gIGxvZ2dlci5pbmZvKGBUcnlpbmcgdG8gdW5sb2NrIGRldmljZSB1c2luZyBwYXR0ZXJuICR7Y2FwYWJpbGl0aWVzLnVubG9ja0tleX1gKTtcbiAgYXdhaXQgaGVscGVycy5kaXNtaXNzS2V5Z3VhcmQoZHJpdmVyLCBhZGIpO1xuICBsZXQga2V5cyA9IGhlbHBlcnMuc3RyaW5nS2V5VG9BcnIoY2FwYWJpbGl0aWVzLnVubG9ja0tleSk7XG4gIC8qIFdlIHNldCB0aGUgZGV2aWNlIHBhdHRlcm4gYnV0dG9ucyBhcyBudW1iZXIgb2YgYSByZWd1bGFyIHBob25lXG4gICAqICB8IOKAoiDigKIg4oCiIHwgICAgIHwgMSAyIDMgfFxuICAgKiAgfCDigKIg4oCiIOKAoiB8IC0tPiB8IDQgNSA2IHxcbiAgICogIHwg4oCiIOKAoiDigKIgfCAgICAgfCA3IDggOSB8XG5cbiAgVGhlIHBhdHRlcm4gdmlldyBidXR0b25zIGFyZSBub3Qgc2VlaW5nIGJ5IHRoZSB1aWF1dG9tYXRvciBzaW5jZSB0aGV5IGFyZVxuICBpbmNsdWRlZCBpbnNpZGUgYSBGcmFtZUxheW91dCwgc28gd2UgYXJlIGdvaW5nIHRvIHRyeSBjbGlja2luZyBvbiB0aGUgYnV0dG9uc1xuICB1c2luZyB0aGUgcGFyZW50IHZpZXcgYm91bmRzIGFuZCBtYXRoLlxuICAqL1xuICBsZXQgYXBpTGV2ZWwgPSBhd2FpdCBhZGIuZ2V0QXBpTGV2ZWwoKTtcbiAgbGV0IGVsID0gYXdhaXQgZHJpdmVyLmZpbmRFbE9yRWxzKFwiaWRcIixcbiAgICBgY29tLmFuZHJvaWQuJHthcGlMZXZlbCA+PSAyMSA/ICdzeXN0ZW11aScgOiAna2V5Z3VhcmQnfTppZC9sb2NrUGF0dGVyblZpZXdgLFxuICAgIGZhbHNlXG4gICk7XG4gIGxldCBpbml0UG9zID0gYXdhaXQgZHJpdmVyLmdldExvY2F0aW9uKHV0aWwudW53cmFwRWxlbWVudChlbCkpO1xuICBsZXQgc2l6ZSA9IGF3YWl0IGRyaXZlci5nZXRTaXplKHV0aWwudW53cmFwRWxlbWVudChlbCkpO1xuICAvLyBHZXQgYWN0aW9ucyB0byBwZXJmb3JtXG4gIGxldCBhY3Rpb25zID0gaGVscGVycy5nZXRQYXR0ZXJuQWN0aW9ucyhrZXlzLCBpbml0UG9zLCBzaXplLndpZHRoIC8gMyk7XG4gIC8vIFBlcmZvcm0gZ2VzdHVyZVxuICBhd2FpdCBkcml2ZXIucGVyZm9ybVRvdWNoKGFjdGlvbnMpO1xuICAvLyBXYWl0cyBhIGJpdCBmb3IgdGhlIGRldmljZSB0byBiZSB1bmxvY2tlZFxuICBhd2FpdCBzbGVlcChVTkxPQ0tfV0FJVF9USU1FKTtcbn07XG5cbmhlbHBlcnMuUElOX1VOTE9DSyA9IFBJTl9VTkxPQ0s7XG5oZWxwZXJzLlBBU1NXT1JEX1VOTE9DSyA9IFBBU1NXT1JEX1VOTE9DSztcbmhlbHBlcnMuUEFUVEVSTl9VTkxPQ0sgPSBQQVRURVJOX1VOTE9DSztcbmhlbHBlcnMuRklOR0VSUFJJTlRfVU5MT0NLID0gRklOR0VSUFJJTlRfVU5MT0NLO1xuXG5leHBvcnQgeyBQSU5fVU5MT0NLLCBQQVNTV09SRF9VTkxPQ0ssIFBBVFRFUk5fVU5MT0NLLCBGSU5HRVJQUklOVF9VTkxPQ0ssIGhlbHBlcnMgfTtcbmV4cG9ydCBkZWZhdWx0IGhlbHBlcnM7XG4iXSwiZmlsZSI6ImxpYi91bmxvY2staGVscGVycy5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
