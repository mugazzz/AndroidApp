"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumBaseDriver = require("appium-base-driver");

var _asyncbox = require("asyncbox");

var _logger = _interopRequireDefault(require("./logger"));

var _appiumUiautomator2Server = require("appium-uiautomator2-server");

var _adbkit = _interopRequireDefault(require("adbkit"));

var _utils = require("./utils");

var _appiumSupport = require("appium-support");

const REQD_PARAMS = ['adb', 'tmpDir', 'host', 'systemPort', 'devicePort', 'disableWindowAnimation'];
const SERVER_LAUNCH_RETRIES = 20;
const SERVER_INSTALL_RETRIES = 20;
const INSTRUMENTATION_TARGET = 'io.appium.uiautomator2.server.test/android.support.test.runner.AndroidJUnitRunner';
const SERVER_PACKAGE_ID = 'io.appium.uiautomator2.server';
const SERVER_TEST_PACKAGE_ID = `${SERVER_PACKAGE_ID}.test`;

class UiAutomator2Server {
  constructor(opts = {}) {
    for (let req of REQD_PARAMS) {
      if (!opts || !_appiumSupport.util.hasValue(opts[req])) {
        throw new Error(`Option '${req}' is required!`);
      }

      this[req] = opts[req];
    }

    this.jwproxy = new _appiumBaseDriver.JWProxy({
      server: this.host,
      port: this.systemPort
    });
    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);
    this.client = _adbkit.default.createClient({
      port: this.adb.adbPort,
      host: this.host
    });
  }

  async installServerApk(installTimeout = SERVER_INSTALL_RETRIES * 1000) {
    const packagesInfo = [{
      appPath: _appiumUiautomator2Server.SERVER_APK_PATH,
      appId: SERVER_PACKAGE_ID
    }, {
      appPath: _appiumUiautomator2Server.TEST_APK_PATH,
      appId: SERVER_TEST_PACKAGE_ID
    }];
    let shouldUninstallServerPackages = false;

    for (const _ref of packagesInfo) {
      const {
        appId,
        appPath
      } = _ref;

      if (!(await this.adb.checkApkCert(appPath, appId))) {
        await this.adb.sign(appPath);
        shouldUninstallServerPackages = true;
      }
    }

    if (shouldUninstallServerPackages) {
      for (const _ref2 of packagesInfo) {
        const {
          appId
        } = _ref2;

        try {
          await this.adb.uninstallApk(appId);
        } catch (err) {
          _logger.default.warn(`Error uninstalling '${appId}': ${err.message}`);

          _logger.default.debug('Continuing');
        }
      }
    }

    for (const _ref3 of packagesInfo) {
      const {
        appPath,
        appId
      } = _ref3;
      await this.adb.installOrUpgrade(appPath, appId, {
        timeout: installTimeout
      });
    }

    let retries = (0, _utils.getRetries)('Server install', installTimeout, SERVER_INSTALL_RETRIES);

    _logger.default.debug(`Waiting up to ${retries * 1000}ms for instrumentation '${INSTRUMENTATION_TARGET}' to be available`);

    let output;

    try {
      await (0, _asyncbox.retryInterval)(retries, 1000, async () => {
        output = await this.adb.shell(['pm', 'list', 'instrumentation']);

        if (output.indexOf('Could not access the Package Manager') !== -1) {
          let err = new Error(`Problem running package manager: ${output}`);
          output = null;
          throw err;
        } else if (output.indexOf(INSTRUMENTATION_TARGET) === -1) {
          throw new Error('No instrumentation process found. Retrying...');
        }

        _logger.default.debug(`Instrumentation '${INSTRUMENTATION_TARGET}' available`);
      });
    } catch (err) {
      _logger.default.error(`Unable to find instrumentation target '${INSTRUMENTATION_TARGET}': ${err.message}`);

      if (output) {
        _logger.default.debug('Available targets:');

        for (let line of output.split('\n')) {
          _logger.default.debug(`    ${line.replace('instrumentation:', '')}`);
        }
      }
    }
  }

  async startSession(caps) {
    await this.killUiAutomatorOnDevice();

    _logger.default.info(`Starting uiautomator2 server ${_appiumUiautomator2Server.version}`);

    _logger.default.info(`Using UIAutomator2 server from '${_appiumUiautomator2Server.SERVER_APK_PATH}' and test from '${_appiumUiautomator2Server.TEST_APK_PATH}'`);

    await this.startSessionUsingAdbKit(caps.deviceUDID);
    let retries = (0, _utils.getRetries)('Server launch', caps.uiautomator2ServerLaunchTimeout, SERVER_LAUNCH_RETRIES);

    _logger.default.info(`Waiting up to ${retries * 1000}ms for UiAutomator2 to be online...`);

    await (0, _asyncbox.retryInterval)(retries, 1000, this.jwproxy.command.bind(this.jwproxy), '/status', 'GET');
    await this.jwproxy.command('/session', 'POST', {
      desiredCapabilities: caps
    });
  }

  async startSessionUsingAdbKit(deviceUDID) {
    let cmd = 'am instrument -w';

    if (this.disableWindowAnimation) {
      cmd = `${cmd} --no-window-animation`;
    }

    cmd = `${cmd} ${INSTRUMENTATION_TARGET}`;

    _logger.default.info(`Running command: 'adb -s ${deviceUDID} shell ${cmd}'`);

    this.client.shell(deviceUDID, cmd).then(_adbkit.default.util.readAll).then(function (output) {
      for (let line of output.toString().split('\n')) {
        if (line.length) {
          _logger.default.debug(`[UIAutomator2] ${line}`);
        }
      }
    }).catch(function (err) {
      _logger.default.error(`[UIAutomator2 Error] ${err.message}`);

      _logger.default.debug(`Full error: ${err.stack}`);
    });
  }

  async deleteSession() {
    _logger.default.debug('Deleting UiAutomator2 server session');

    try {
      await this.jwproxy.command('/', 'DELETE');
    } catch (err) {
      _logger.default.warn(`Did not get confirmation UiAutomator2 deleteSession worked; ` + `Error was: ${err}`);
    }
  }

  async killUiAutomatorOnDevice() {
    try {
      const pids = (await this.adb.getPIDsByName('uiautomator')).map(p => `${p}`);

      if (!_lodash.default.isEmpty(pids)) {
        const isRoot = await this.adb.root();

        try {
          await this.adb.shell(['kill', '-9', ...pids]);
        } finally {
          if (isRoot) {
            await this.adb.unroot();
          }
        }
      }
    } catch (err) {
      _logger.default.warn(`Unable to stop uiautomator process: ${err.message}`);
    }

    try {
      await this.adb.forceStop('io.appium.uiautomator2.server');
    } catch (ignore) {
      _logger.default.info("Unable to kill the io.appium.uiautomator2.server process, assuming it is already killed");
    }
  }

}

var _default = UiAutomator2Server;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi91aWF1dG9tYXRvcjIuanMiXSwibmFtZXMiOlsiUkVRRF9QQVJBTVMiLCJTRVJWRVJfTEFVTkNIX1JFVFJJRVMiLCJTRVJWRVJfSU5TVEFMTF9SRVRSSUVTIiwiSU5TVFJVTUVOVEFUSU9OX1RBUkdFVCIsIlNFUlZFUl9QQUNLQUdFX0lEIiwiU0VSVkVSX1RFU1RfUEFDS0FHRV9JRCIsIlVpQXV0b21hdG9yMlNlcnZlciIsImNvbnN0cnVjdG9yIiwib3B0cyIsInJlcSIsInV0aWwiLCJoYXNWYWx1ZSIsIkVycm9yIiwiandwcm94eSIsIkpXUHJveHkiLCJzZXJ2ZXIiLCJob3N0IiwicG9ydCIsInN5c3RlbVBvcnQiLCJwcm94eVJlcVJlcyIsImJpbmQiLCJjbGllbnQiLCJhZGJraXQiLCJjcmVhdGVDbGllbnQiLCJhZGIiLCJhZGJQb3J0IiwiaW5zdGFsbFNlcnZlckFwayIsImluc3RhbGxUaW1lb3V0IiwicGFja2FnZXNJbmZvIiwiYXBwUGF0aCIsImFwa1BhdGgiLCJhcHBJZCIsInRlc3RBcGtQYXRoIiwic2hvdWxkVW5pbnN0YWxsU2VydmVyUGFja2FnZXMiLCJjaGVja0Fwa0NlcnQiLCJzaWduIiwidW5pbnN0YWxsQXBrIiwiZXJyIiwibG9nZ2VyIiwid2FybiIsIm1lc3NhZ2UiLCJkZWJ1ZyIsImluc3RhbGxPclVwZ3JhZGUiLCJ0aW1lb3V0IiwicmV0cmllcyIsIm91dHB1dCIsInNoZWxsIiwiaW5kZXhPZiIsImVycm9yIiwibGluZSIsInNwbGl0IiwicmVwbGFjZSIsInN0YXJ0U2Vzc2lvbiIsImNhcHMiLCJraWxsVWlBdXRvbWF0b3JPbkRldmljZSIsImluZm8iLCJzZXJ2ZXJWZXJzaW9uIiwic3RhcnRTZXNzaW9uVXNpbmdBZGJLaXQiLCJkZXZpY2VVRElEIiwidWlhdXRvbWF0b3IyU2VydmVyTGF1bmNoVGltZW91dCIsImNvbW1hbmQiLCJkZXNpcmVkQ2FwYWJpbGl0aWVzIiwiY21kIiwiZGlzYWJsZVdpbmRvd0FuaW1hdGlvbiIsInRoZW4iLCJyZWFkQWxsIiwidG9TdHJpbmciLCJsZW5ndGgiLCJjYXRjaCIsInN0YWNrIiwiZGVsZXRlU2Vzc2lvbiIsInBpZHMiLCJnZXRQSURzQnlOYW1lIiwibWFwIiwicCIsIl8iLCJpc0VtcHR5IiwiaXNSb290Iiwicm9vdCIsInVucm9vdCIsImZvcmNlU3RvcCIsImlnbm9yZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxNQUFNQSxXQUFXLEdBQUcsQ0FBQyxLQUFELEVBQVEsUUFBUixFQUFrQixNQUFsQixFQUEwQixZQUExQixFQUF3QyxZQUF4QyxFQUFzRCx3QkFBdEQsQ0FBcEI7QUFDQSxNQUFNQyxxQkFBcUIsR0FBRyxFQUE5QjtBQUNBLE1BQU1DLHNCQUFzQixHQUFHLEVBQS9CO0FBQ0EsTUFBTUMsc0JBQXNCLEdBQUcsbUZBQS9CO0FBQ0EsTUFBTUMsaUJBQWlCLEdBQUcsK0JBQTFCO0FBQ0EsTUFBTUMsc0JBQXNCLEdBQUksR0FBRUQsaUJBQWtCLE9BQXBEOztBQUdBLE1BQU1FLGtCQUFOLENBQXlCO0FBQ3ZCQyxFQUFBQSxXQUFXLENBQUVDLElBQUksR0FBRyxFQUFULEVBQWE7QUFDdEIsU0FBSyxJQUFJQyxHQUFULElBQWdCVCxXQUFoQixFQUE2QjtBQUMzQixVQUFJLENBQUNRLElBQUQsSUFBUyxDQUFDRSxvQkFBS0MsUUFBTCxDQUFjSCxJQUFJLENBQUNDLEdBQUQsQ0FBbEIsQ0FBZCxFQUF3QztBQUN0QyxjQUFNLElBQUlHLEtBQUosQ0FBVyxXQUFVSCxHQUFJLGdCQUF6QixDQUFOO0FBQ0Q7O0FBQ0QsV0FBS0EsR0FBTCxJQUFZRCxJQUFJLENBQUNDLEdBQUQsQ0FBaEI7QUFDRDs7QUFDRCxTQUFLSSxPQUFMLEdBQWUsSUFBSUMseUJBQUosQ0FBWTtBQUFDQyxNQUFBQSxNQUFNLEVBQUUsS0FBS0MsSUFBZDtBQUFvQkMsTUFBQUEsSUFBSSxFQUFFLEtBQUtDO0FBQS9CLEtBQVosQ0FB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b20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgeyByZXRyeUludGVydmFsIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBTRVJWRVJfQVBLX1BBVEggYXMgYXBrUGF0aCwgVEVTVF9BUEtfUEFUSCBhcyB0ZXN0QXBrUGF0aCwgdmVyc2lvbiBhcyBzZXJ2ZXJWZXJzaW9uIH0gZnJvbSAnYXBwaXVtLXVpYXV0b21hdG9yMi1zZXJ2ZXInO1xuaW1wb3J0IGFkYmtpdCBmcm9tICdhZGJraXQnO1xuaW1wb3J0IHsgZ2V0UmV0cmllcyB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IHsgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcblxuXG5jb25zdCBSRVFEX1BBUkFNUyA9IFsnYWRiJywgJ3RtcERpcicsICdob3N0JywgJ3N5c3RlbVBvcnQnLCAnZGV2aWNlUG9ydCcsICdkaXNhYmxlV2luZG93QW5pbWF0aW9uJ107XG5jb25zdCBTRVJWRVJfTEFVTkNIX1JFVFJJRVMgPSAyMDtcbmNvbnN0IFNFUlZFUl9JTlNUQUxMX1JFVFJJRVMgPSAyMDtcbmNvbnN0IElOU1RSVU1FTlRBVElPTl9UQVJHRVQgPSAnaW8uYXBwaXVtLnVpYXV0b21hdG9yMi5zZXJ2ZXIudGVzdC9hbmRyb2lkLnN1cHBvcnQudGVzdC5ydW5uZXIuQW5kcm9pZEpVbml0UnVubmVyJztcbmNvbnN0IFNFUlZFUl9QQUNLQUdFX0lEID0gJ2lvLmFwcGl1bS51aWF1dG9tYXRvcjIuc2VydmVyJztcbmNvbnN0IFNFUlZFUl9URVNUX1BBQ0tBR0VfSUQgPSBgJHtTRVJWRVJfUEFDS0FHRV9JRH0udGVzdGA7XG5cblxuY2xhc3MgVWlBdXRvbWF0b3IyU2VydmVyIHtcbiAgY29uc3RydWN0b3IgKG9wdHMgPSB7fSkge1xuICAgIGZvciAobGV0IHJlcSBvZiBSRVFEX1BBUkFNUykge1xuICAgICAgaWYgKCFvcHRzIHx8ICF1dGlsLmhhc1ZhbHVlKG9wdHNbcmVxXSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBPcHRpb24gJyR7cmVxfScgaXMgcmVxdWlyZWQhYCk7XG4gICAgICB9XG4gICAgICB0aGlzW3JlcV0gPSBvcHRzW3JlcV07XG4gICAgfVxuICAgIHRoaXMuandwcm94eSA9IG5ldyBKV1Byb3h5KHtzZXJ2ZXI6IHRoaXMuaG9zdCwgcG9ydDogdGhpcy5zeXN0ZW1Qb3J0fSk7XG4gICAgdGhpcy5wcm94eVJlcVJlcyA9IHRoaXMuandwcm94eS5wcm94eVJlcVJlcy5iaW5kKHRoaXMuandwcm94eSk7XG5cbiAgICB0aGlzLmNsaWVudCA9IGFkYmtpdC5jcmVhdGVDbGllbnQoe1xuICAgICAgcG9ydDogdGhpcy5hZGIuYWRiUG9ydCxcbiAgICAgIGhvc3Q6IHRoaXMuaG9zdFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEluc3RhbGxzIHRoZSBhcGtzIG9uIHRvIHRoZSBkZXZpY2Ugb3IgZW11bGF0b3IuXG4gICAqXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBpbnN0YWxsVGltZW91dCAtIEluc3RhbGxhdGlvbiB0aW1lb3V0XG4gICAqL1xuICBhc3luYyBpbnN0YWxsU2VydmVyQXBrIChpbnN0YWxsVGltZW91dCA9IFNFUlZFUl9JTlNUQUxMX1JFVFJJRVMgKiAxMDAwKSB7XG4gICAgY29uc3QgcGFja2FnZXNJbmZvID0gW1xuICAgICAge1xuICAgICAgICBhcHBQYXRoOiBhcGtQYXRoLFxuICAgICAgICBhcHBJZDogU0VSVkVSX1BBQ0tBR0VfSUQsXG4gICAgICB9LCB7XG4gICAgICAgIGFwcFBhdGg6IHRlc3RBcGtQYXRoLFxuICAgICAgICBhcHBJZDogU0VSVkVSX1RFU1RfUEFDS0FHRV9JRCxcbiAgICAgIH0sXG4gICAgXTtcbiAgICBsZXQgc2hvdWxkVW5pbnN0YWxsU2VydmVyUGFja2FnZXMgPSBmYWxzZTtcbiAgICBmb3IgKGNvbnN0IHthcHBJZCwgYXBwUGF0aH0gb2YgcGFja2FnZXNJbmZvKSB7XG4gICAgICBpZiAoIWF3YWl0IHRoaXMuYWRiLmNoZWNrQXBrQ2VydChhcHBQYXRoLCBhcHBJZCkpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5hZGIuc2lnbihhcHBQYXRoKTtcbiAgICAgICAgc2hvdWxkVW5pbnN0YWxsU2VydmVyUGFja2FnZXMgPSB0cnVlO1xuICAgICAgfVxuICAgIH1cbiAgICBpZiAoc2hvdWxkVW5pbnN0YWxsU2VydmVyUGFja2FnZXMpIHtcbiAgICAgIGZvciAoY29uc3Qge2FwcElkfSBvZiBwYWNrYWdlc0luZm8pIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCB0aGlzLmFkYi51bmluc3RhbGxBcGsoYXBwSWQpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICBsb2dnZXIud2FybihgRXJyb3IgdW5pbnN0YWxsaW5nICcke2FwcElkfSc6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICAgICAgbG9nZ2VyLmRlYnVnKCdDb250aW51aW5nJyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgZm9yIChjb25zdCB7YXBwUGF0aCwgYXBwSWR9IG9mIHBhY2thZ2VzSW5mbykge1xuICAgICAgYXdhaXQgdGhpcy5hZGIuaW5zdGFsbE9yVXBncmFkZShhcHBQYXRoLCBhcHBJZCwge1xuICAgICAgICB0aW1lb3V0OiBpbnN0YWxsVGltZW91dCxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGxldCByZXRyaWVzID0gZ2V0UmV0cmllcygnU2VydmVyIGluc3RhbGwnLCBpbnN0YWxsVGltZW91dCwgU0VSVkVSX0lOU1RBTExfUkVUUklFUyk7XG5cbiAgICBsb2dnZXIuZGVidWcoYFdhaXRpbmcgdXAgdG8gJHtyZXRyaWVzICogMTAwMH1tcyBmb3IgaW5zdHJ1bWVudGF0aW9uICcke0lOU1RSVU1FTlRBVElPTl9UQVJHRVR9JyB0byBiZSBhdmFpbGFibGVgKTtcbiAgICBsZXQgb3V0cHV0O1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCByZXRyeUludGVydmFsKHJldHJpZXMsIDEwMDAsIGFzeW5jICgpID0+IHtcbiAgICAgICAgb3V0cHV0ID0gYXdhaXQgdGhpcy5hZGIuc2hlbGwoWydwbScsICdsaXN0JywgJ2luc3RydW1lbnRhdGlvbiddKTtcbiAgICAgICAgaWYgKG91dHB1dC5pbmRleE9mKCdDb3VsZCBub3QgYWNjZXNzIHRoZSBQYWNrYWdlIE1hbmFnZXInKSAhPT0gLTEpIHtcbiAgICAgICAgICBsZXQgZXJyID0gbmV3IEVycm9yKGBQcm9ibGVtIHJ1bm5pbmcgcGFja2FnZSBtYW5hZ2VyOiAke291dHB1dH1gKTtcbiAgICAgICAgICBvdXRwdXQgPSBudWxsOyAvLyByZW1vdmUgb3V0cHV0LCBzbyBpdCBpcyBub3QgcHJpbnRlZCBiZWxvd1xuICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgfSBlbHNlIGlmIChvdXRwdXQuaW5kZXhPZihJTlNUUlVNRU5UQVRJT05fVEFSR0VUKSA9PT0gLTEpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGluc3RydW1lbnRhdGlvbiBwcm9jZXNzIGZvdW5kLiBSZXRyeWluZy4uLicpO1xuICAgICAgICB9XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhgSW5zdHJ1bWVudGF0aW9uICcke0lOU1RSVU1FTlRBVElPTl9UQVJHRVR9JyBhdmFpbGFibGVgKTtcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nZ2VyLmVycm9yKGBVbmFibGUgdG8gZmluZCBpbnN0cnVtZW50YXRpb24gdGFyZ2V0ICcke0lOU1RSVU1FTlRBVElPTl9UQVJHRVR9JzogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIGlmIChvdXRwdXQpIHtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKCdBdmFpbGFibGUgdGFyZ2V0czonKTtcbiAgICAgICAgZm9yIChsZXQgbGluZSBvZiBvdXRwdXQuc3BsaXQoJ1xcbicpKSB7XG4gICAgICAgICAgbG9nZ2VyLmRlYnVnKGAgICAgJHtsaW5lLnJlcGxhY2UoJ2luc3RydW1lbnRhdGlvbjonLCAnJyl9YCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhc3luYyBzdGFydFNlc3Npb24gKGNhcHMpIHtcbiAgICAvLyBraWxsIGFueSB1aWF1dG9tYXRvciBleGlzdGluZyBwcm9jZXNzZXNcbiAgICBhd2FpdCB0aGlzLmtpbGxVaUF1dG9tYXRvck9uRGV2aWNlKCk7XG5cbiAgICBsb2dnZXIuaW5mbyhgU3RhcnRpbmcgdWlhdXRvbWF0b3IyIHNlcnZlciAke3NlcnZlclZlcnNpb259YCk7XG5cbiAgICBsb2dnZXIuaW5mbyhgVXNpbmcgVUlBdXRvbWF0b3IyIHNlcnZlciBmcm9tICcke2Fwa1BhdGh9JyBhbmQgdGVzdCBmcm9tICcke3Rlc3RBcGtQYXRofSdgKTtcblxuICAgIC8vIGxldCBjbWQgPSBbJ2FtJywgJ2luc3RydW1lbnQnLCAnLXcnLFxuICAgIC8vICAgJ2lvLmFwcGl1bS51aWF1dG9tYXRvcjIuc2VydmVyLnRlc3QvYW5kcm9pZC5zdXBwb3J0LnRlc3QucnVubmVyLkFuZHJvaWRKVW5pdFJ1bm5lciddO1xuICAgIC8vIHRoaXMuYWRiLnNoZWxsKGNtZCk7XG4gICAgLy8gdXNpbmcgM3JkIHBhcnR5IG1vZHVsZSBjYWxsZWQgJ2FkYktpdCcgZm9yIHRpbWUgYmVpbmcgYXMgdXNpbmcgJ2FwcGl1bS1hZGInXG4gICAgLy8gZmFjaW5nIElsbGVnYWxTdGF0ZUV4Y2VwdGlvbjogVWlBdXRvbWF0aW9uIG5vdCBjb25uZWN0ZWQgZXhjZXB0aW9uXG4gICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL2FwcGl1bS9hcHBpdW0tdWlhdXRvbWF0b3IyLWRyaXZlci9pc3N1ZXMvMTlcblxuICAgIGF3YWl0IHRoaXMuc3RhcnRTZXNzaW9uVXNpbmdBZGJLaXQoY2Fwcy5kZXZpY2VVRElEKTtcblxuICAgIGxldCByZXRyaWVzID0gZ2V0UmV0cmllcygnU2VydmVyIGxhdW5jaCcsIGNhcHMudWlhdXRvbWF0b3IyU2VydmVyTGF1bmNoVGltZW91dCwgU0VSVkVSX0xBVU5DSF9SRVRSSUVTKTtcblxuICAgIGxvZ2dlci5pbmZvKGBXYWl0aW5nIHVwIHRvICR7cmV0cmllcyAqIDEwMDB9bXMgZm9yIFVpQXV0b21hdG9yMiB0byBiZSBvbmxpbmUuLi5gKTtcbiAgICAvLyB3YWl0IGZvciBVaUF1dG9tYXRvcjIgdG8gYmUgb25saW5lXG4gICAgYXdhaXQgcmV0cnlJbnRlcnZhbChyZXRyaWVzLCAxMDAwLCB0aGlzLmp3cHJveHkuY29tbWFuZC5iaW5kKHRoaXMuandwcm94eSksICcvc3RhdHVzJywgJ0dFVCcpO1xuICAgIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKCcvc2Vzc2lvbicsICdQT1NUJywge2Rlc2lyZWRDYXBhYmlsaXRpZXM6IGNhcHN9KTtcbiAgfVxuXG4gIGFzeW5jIHN0YXJ0U2Vzc2lvblVzaW5nQWRiS2l0IChkZXZpY2VVRElEKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcmVxdWlyZS1hd2FpdFxuICAgIGxldCBjbWQgPSAnYW0gaW5zdHJ1bWVudCAtdyc7XG4gICAgaWYgKHRoaXMuZGlzYWJsZVdpbmRvd0FuaW1hdGlvbikge1xuICAgICAgY21kID0gYCR7Y21kfSAtLW5vLXdpbmRvdy1hbmltYXRpb25gO1xuICAgIH1cbiAgICBjbWQgPSBgJHtjbWR9ICR7SU5TVFJVTUVOVEFUSU9OX1RBUkdFVH1gO1xuICAgIGxvZ2dlci5pbmZvKGBSdW5uaW5nIGNvbW1hbmQ6ICdhZGIgLXMgJHtkZXZpY2VVRElEfSBzaGVsbCAke2NtZH0nYCk7XG4gICAgdGhpcy5jbGllbnQuc2hlbGwoZGV2aWNlVURJRCwgY21kKVxuICAgICAgLnRoZW4oYWRia2l0LnV0aWwucmVhZEFsbCkgLy8gZXNsaW50LWRpc2FibGUtbGluZSBwcm9taXNlL3ByZWZlci1hd2FpdC10by10aGVuXG4gICAgICAudGhlbihmdW5jdGlvbiAob3V0cHV0KSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcHJvbWlzZS9wcmVmZXItYXdhaXQtdG8tdGhlblxuICAgICAgICBmb3IgKGxldCBsaW5lIG9mIG91dHB1dC50b1N0cmluZygpLnNwbGl0KCdcXG4nKSkge1xuICAgICAgICAgIGlmIChsaW5lLmxlbmd0aCkge1xuICAgICAgICAgICAgbG9nZ2VyLmRlYnVnKGBbVUlBdXRvbWF0b3IyXSAke2xpbmV9YCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZXJyKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcHJvbWlzZS9wcmVmZXItYXdhaXQtdG8tY2FsbGJhY2tzXG4gICAgICAgIGxvZ2dlci5lcnJvcihgW1VJQXV0b21hdG9yMiBFcnJvcl0gJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKGBGdWxsIGVycm9yOiAke2Vyci5zdGFja31gKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlU2Vzc2lvbiAoKSB7XG4gICAgbG9nZ2VyLmRlYnVnKCdEZWxldGluZyBVaUF1dG9tYXRvcjIgc2VydmVyIHNlc3Npb24nKTtcbiAgICAvLyByZWx5IG9uIGp3cHJveHkncyBpbnRlbGxpZ2VuY2UgdG8ga25vdyB3aGF0IHdlJ3JlIHRhbGtpbmcgYWJvdXQgYW5kXG4gICAgLy8gZGVsZXRlIHRoZSBjdXJyZW50IHNlc3Npb25cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5qd3Byb3h5LmNvbW1hbmQoJy8nLCAnREVMRVRFJyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2dnZXIud2FybihgRGlkIG5vdCBnZXQgY29uZmlybWF0aW9uIFVpQXV0b21hdG9yMiBkZWxldGVTZXNzaW9uIHdvcmtlZDsgYCArXG4gICAgICAgICAgYEVycm9yIHdhczogJHtlcnJ9YCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMga2lsbFVpQXV0b21hdG9yT25EZXZpY2UgKCkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBwaWRzID0gKGF3YWl0IHRoaXMuYWRiLmdldFBJRHNCeU5hbWUoJ3VpYXV0b21hdG9yJykpLm1hcCgocCkgPT4gYCR7cH1gKTtcbiAgICAgIGlmICghXy5pc0VtcHR5KHBpZHMpKSB7XG4gICAgICAgIGNvbnN0IGlzUm9vdCA9IGF3YWl0IHRoaXMuYWRiLnJvb3QoKTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCB0aGlzLmFkYi5zaGVsbChbJ2tpbGwnLCAnLTknLCAuLi5waWRzXSk7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgaWYgKGlzUm9vdCkge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5hZGIudW5yb290KCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2dnZXIud2FybihgVW5hYmxlIHRvIHN0b3AgdWlhdXRvbWF0b3IgcHJvY2VzczogJHtlcnIubWVzc2FnZX1gKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5hZGIuZm9yY2VTdG9wKCdpby5hcHBpdW0udWlhdXRvbWF0b3IyLnNlcnZlcicpO1xuICAgIH0gY2F0Y2ggKGlnbm9yZSkge1xuICAgICAgbG9nZ2VyLmluZm8oXCJVbmFibGUgdG8ga2lsbCB0aGUgaW8uYXBwaXVtLnVpYXV0b21hdG9yMi5zZXJ2ZXIgcHJvY2VzcywgYXNzdW1pbmcgaXQgaXMgYWxyZWFkeSBraWxsZWRcIik7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IFVpQXV0b21hdG9yMlNlcnZlcjtcbiJdLCJmaWxlIjoibGliL3VpYXV0b21hdG9yMi5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
